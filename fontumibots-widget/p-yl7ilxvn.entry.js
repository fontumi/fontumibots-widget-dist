import{r as t,c as n,h as e,g as i}from"./p-52a791a5.js";function r(t){return"dark"===function(t){let n,e,i,r;return t.match(/^rgb/)?(n=(t=t.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/))[1],e=t[2],i=t[3]):(n=(t=+("0x"+t.slice(1).replace(t.length<5&&/./g,"$&$&")))>>16,e=t>>8&255,i=255&t),(r=Math.sqrt(n*n*.299+e*e*.587+i*i*.114))>127.5?"light":"dark"}(t)?"white":"black"}const u=class{constructor(e){t(this,e),this.toggleEvent=n(this,"toggled",7)}render(){return e("div",{id:"fontumibots-bubble-button",style:{background:this.color},onClick:()=>this.toggleEvent.emit()},(()=>{switch(this.icon){case"call":return e("fontumibots-icon-call",{fill:r(this.color)});case"message":return e("fontumibots-icon-messages",{height:20,width:20,fill:r(this.color)});default:return e("fontumibots-icon-close",{height:20,width:20,fill:r(this.color)})}})())}static get style(){return"#fontumibots-bubble-button{user-select:none;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;-webkit-box-shadow:var(--fontumibots-shadow);box-shadow:var(--fontumibots-shadow);border-radius:50%;height:55px;width:55px;z-index:var(--fontumibots-z-index);margin-left:5px;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center}"}};class s{constructor(t,n,e,i){this.id=t,this.name=n,this.title=e,this.values=i}props(){return this.values.property}question(){let t;switch(this.name){case"end":t="goodbye_text";break;case"start":t="welcome_text";break;default:t="question"}return{type:this.name,value:this.values.property[t].value||""}}}class o{constructor(t,n,e,i,r){this.id=t,this.originID=n,this.originSlot=e,this.targetID=i,this.targetSlot=r}}class a{constructor(t,n){this.blocks=[],this.links=[],n.map(t=>this.blocks.push(new s(t.id,t.name,t.title,t.values))),t.map(t=>this.links.push(new o(t.id,t.originID,t.originSlot,t.targetID,t.targetSlot))),this.startBlock=this.blockByName("start")[0],this.actualBlock=this.startBlock}blockByName(t){return this.blocks.filter(n=>n.name===t)}blockById(t){return this.blocks.find(n=>n.id===t)}next(t=0){if("end"===this.actualBlock.name)return;const n=this.links.find(n=>n.originID===this.actualBlock.id&&n.originSlot===t),e=this.blockById(n.targetID);return this.actualBlock=e,e}}var c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function h(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function f(t,n){return t(n={exports:{}},n.exports),n.exports}var l=function(t,n){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])})(t,n)},d=function(){return(d=Object.assign||function(t){for(var n,e=1,i=arguments.length;e<i;e++)for(var r in n=arguments[e])Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r]);return t}).apply(this,arguments)};function v(t){var n="function"==typeof Symbol&&t[Symbol.iterator],e=0;return n?n.call(t):{next:function(){return t&&e>=t.length&&(t=void 0),{value:t&&t[e++],done:!t}}}}function m(t,n){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var i,r,u=e.call(t),s=[];try{for(;(void 0===n||n-- >0)&&!(i=u.next()).done;)s.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(e=u.return)&&e.call(u)}finally{if(r)throw r.error}}return s}function w(t){return this instanceof w?(this.v=t,this):new w(t)}const b=Object.freeze({__extends:function(t,n){function e(){this.constructor=t}l(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)},get __assign(){return d},__rest:function(t,n){var e={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&n.indexOf(i)<0&&(e[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)n.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(e[i[r]]=t[i[r]])}return e},__decorate:function(t,n,e,i){var r,u=arguments.length,s=u<3?n:null===i?i=Object.getOwnPropertyDescriptor(n,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,n,e,i);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(s=(u<3?r(s):u>3?r(n,e,s):r(n,e))||s);return u>3&&s&&Object.defineProperty(n,e,s),s},__param:function(t,n){return function(e,i){n(e,i,t)}},__metadata:function(t,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,n)},__awaiter:function(t,n,e,i){return new(e||(e=Promise))((function(r,u){function s(t){try{a(i.next(t))}catch(t){u(t)}}function o(t){try{a(i.throw(t))}catch(t){u(t)}}function a(t){t.done?r(t.value):new e((function(n){n(t.value)})).then(s,o)}a((i=i.apply(t,n||[])).next())}))},__generator:function(t,n){var e,i,r,u,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return u={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function o(u){return function(o){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,i=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){s.label=u[1];break}if(6===u[0]&&s.label<r[1]){s.label=r[1],r=u;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(u);break}r[2]&&s.ops.pop(),s.trys.pop();continue}u=n.call(t,s)}catch(t){u=[6,t],i=0}finally{e=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,o])}}},__exportStar:function(t,n){for(var e in t)n.hasOwnProperty(e)||(n[e]=t[e])},__values:v,__read:m,__spread:function(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(m(arguments[n]));return t},__spreadArrays:function(){for(var t=0,n=0,e=arguments.length;n<e;n++)t+=arguments[n].length;var i=Array(t),r=0;for(n=0;n<e;n++)for(var u=arguments[n],s=0,o=u.length;s<o;s++,r++)i[r]=u[s];return i},__await:w,__asyncGenerator:function(t,n,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,r=e.apply(t,n||[]),u=[];return i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i;function s(t){r[t]&&(i[t]=function(n){return new Promise((function(e,i){u.push([t,n,e,i])>1||o(t,n)}))})}function o(t,n){try{!function(t){t.value instanceof w?Promise.resolve(t.value.v).then(a,c):h(u[0][2],t)}(r[t](n))}catch(t){h(u[0][3],t)}}function a(t){o("next",t)}function c(t){o("throw",t)}function h(t,n){t(n),u.shift(),u.length&&o(u[0][0],u[0][1])}},__asyncDelegator:function(t){var n,e;return n={},i("next"),i("throw",(function(t){throw t})),i("return"),n[Symbol.iterator]=function(){return this},n;function i(i,r){n[i]=t[i]?function(n){return(e=!e)?{value:w(t[i](n)),done:"return"===i}:r?r(n):n}:r}},__asyncValues:function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,e=t[Symbol.asyncIterator];return e?e.call(t):(t=v(t),n={},i("next"),i("throw"),i("return"),n[Symbol.asyncIterator]=function(){return this},n);function i(e){n[e]=t[e]&&function(n){return new Promise((function(i,r){!function(t,n,e,i){Promise.resolve(i).then((function(n){t({value:n,done:e})}),n)}(i,r,(n=t[e](n)).done,n.value)}))}}},__makeTemplateObject:function(t,n){return Object.defineProperty?Object.defineProperty(t,"raw",{value:n}):t.raw=n,t},__importStar:function(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var e in t)Object.hasOwnProperty.call(t,e)&&(n[e]=t[e]);return n.default=t,n},__importDefault:function(t){return t&&t.__esModule?t:{default:t}}});var p=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});var e={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},i=function(t,n){if(!t)throw r(n)},r=function(t){return new Error("Firebase Database ("+e.SDK_VERSION+") INTERNAL ASSERT FAILED: "+t)},u=function(t){for(var n=[],e=0,i=0;i<t.length;i++){var r=t.charCodeAt(i);r<128?n[e++]=r:r<2048?(n[e++]=r>>6|192,n[e++]=63&r|128):55296==(64512&r)&&i+1<t.length&&56320==(64512&t.charCodeAt(i+1))?(r=65536+((1023&r)<<10)+(1023&t.charCodeAt(++i)),n[e++]=r>>18|240,n[e++]=r>>12&63|128,n[e++]=r>>6&63|128,n[e++]=63&r|128):(n[e++]=r>>12|224,n[e++]=r>>6&63|128,n[e++]=63&r|128)}return n},s={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(t,n){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var e=n?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[],r=0;r<t.length;r+=3){var u=t[r],s=r+1<t.length,o=s?t[r+1]:0,a=r+2<t.length,c=a?t[r+2]:0,h=(15&o)<<2|c>>6,f=63&c;a||(f=64,s||(h=64)),i.push(e[u>>2],e[(3&u)<<4|o>>4],e[h],e[f])}return i.join("")},encodeString:function(t,n){return this.HAS_NATIVE_SUPPORT&&!n?btoa(t):this.encodeByteArray(u(t),n)},decodeString:function(t,n){return this.HAS_NATIVE_SUPPORT&&!n?atob(t):function(t){for(var n=[],e=0,i=0;e<t.length;){var r=t[e++];if(r<128)n[i++]=String.fromCharCode(r);else if(r>191&&r<224){var u=t[e++];n[i++]=String.fromCharCode((31&r)<<6|63&u)}else if(r>239&&r<365){var s=((7&r)<<18|(63&(u=t[e++]))<<12|(63&(o=t[e++]))<<6|63&t[e++])-65536;n[i++]=String.fromCharCode(55296+(s>>10)),n[i++]=String.fromCharCode(56320+(1023&s))}else{u=t[e++];var o=t[e++];n[i++]=String.fromCharCode((15&r)<<12|(63&u)<<6|63&o)}}return n.join("")}(this.decodeStringToByteArray(t,n))},decodeStringToByteArray:function(t,n){this.init_();for(var e=n?this.charToByteMapWebSafe_:this.charToByteMap_,i=[],r=0;r<t.length;){var u=e[t.charAt(r++)],s=r<t.length?e[t.charAt(r)]:0,o=++r<t.length?e[t.charAt(r)]:64,a=++r<t.length?e[t.charAt(r)]:64;if(++r,null==u||null==s||null==o||null==a)throw Error();i.push(u<<2|s>>4),64!==o&&(i.push(s<<4&240|o>>2),64!==a&&i.push(o<<6&192|a))}return i},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},o=function(t){try{return s.decodeString(t,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};function a(t,n){if(!(n instanceof Object))return n;switch(n.constructor){case Date:return new Date(n.getTime());case Object:void 0===t&&(t={});break;case Array:t=[];break;default:return n}for(var e in n)n.hasOwnProperty(e)&&(t[e]=a(t[e],n[e]));return t}var h=function(){function t(){var t=this;this.reject=function(){},this.resolve=function(){},this.promise=new Promise((function(n,e){t.resolve=n,t.reject=e}))}return t.prototype.wrapCallback=function(t){var n=this;return function(e,i){e?n.reject(e):n.resolve(i),"function"==typeof t&&(n.promise.catch((function(){})),1===t.length?t(e):t(e,i))}},t}();function f(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var l="FirebaseError",d=function(t){function n(e,i){var r=t.call(this,i)||this;return r.code=e,r.name=l,Object.setPrototypeOf(r,n.prototype),Error.captureStackTrace&&Error.captureStackTrace(r,v.prototype.create),r}return b.__extends(n,t),n}(Error),v=function(){function t(t,n,e){this.service=t,this.serviceName=n,this.errors=e}return t.prototype.create=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=n[0]||{},r=this.service+"/"+t,u=this.errors[t],s=u?m(u,i):"Error",o=this.serviceName+": "+s+" ("+r+").",a=new d(r,o),c=0,h=Object.keys(i);c<h.length;c++){var f=h[c];"_"!==f.slice(-1)&&(f in a&&console.warn('Overwriting FirebaseError base field "'+f+'" can cause unexpected behavior.'),a[f]=i[f])}return a},t}();function m(t,n){return t.replace(w,(function(t,e){var i=n[e];return null!=i?i.toString():"<"+e+"?>"}))}var w=/\{\$([^}]+)}/g;function p(t){return JSON.parse(t)}var g=function(t){var n={},e={},i={},r="";try{var u=t.split(".");n=p(o(u[0])||""),e=p(o(u[1])||""),r=u[2],i=e.d||{},delete e.d}catch(t){}return{header:n,claims:e,data:i,signature:r}},y=function(){function t(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=64,this.pad_[0]=128;for(var t=1;t<this.blockSize;++t)this.pad_[t]=0;this.reset()}return t.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},t.prototype.compress_=function(t,n){n||(n=0);var e=this.W_;if("string"==typeof t)for(var i=0;i<16;i++)e[i]=t.charCodeAt(n)<<24|t.charCodeAt(n+1)<<16|t.charCodeAt(n+2)<<8|t.charCodeAt(n+3),n+=4;else for(i=0;i<16;i++)e[i]=t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3],n+=4;for(i=16;i<80;i++)e[i]=4294967295&((f=e[i-3]^e[i-8]^e[i-14]^e[i-16])<<1|f>>>31);var r,u,s=this.chain_[0],o=this.chain_[1],a=this.chain_[2],c=this.chain_[3],h=this.chain_[4];for(i=0;i<80;i++){i<40?i<20?(r=c^o&(a^c),u=1518500249):(r=o^a^c,u=1859775393):i<60?(r=o&a|c&(o|a),u=2400959708):(r=o^a^c,u=3395469782);var f=(s<<5|s>>>27)+r+h+u+e[i]&4294967295;h=c,c=a,a=4294967295&(o<<30|o>>>2),o=s,s=f}this.chain_[0]=this.chain_[0]+s&4294967295,this.chain_[1]=this.chain_[1]+o&4294967295,this.chain_[2]=this.chain_[2]+a&4294967295,this.chain_[3]=this.chain_[3]+c&4294967295,this.chain_[4]=this.chain_[4]+h&4294967295},t.prototype.update=function(t,n){if(null!=t){void 0===n&&(n=t.length);for(var e=n-this.blockSize,i=0,r=this.buf_,u=this.inbuf_;i<n;){if(0===u)for(;i<=e;)this.compress_(t,i),i+=this.blockSize;if("string"==typeof t){for(;i<n;)if(r[u]=t.charCodeAt(i),++i,++u===this.blockSize){this.compress_(r),u=0;break}}else for(;i<n;)if(r[u]=t[i],++i,++u===this.blockSize){this.compress_(r),u=0;break}}this.inbuf_=u,this.total_+=n}},t.prototype.digest=function(){var t=[],n=8*this.total_;this.update(this.pad_,this.inbuf_<56?56-this.inbuf_:this.blockSize-(this.inbuf_-56));for(var e=this.blockSize-1;e>=56;e--)this.buf_[e]=255&n,n/=256;this.compress_(this.buf_);var i=0;for(e=0;e<5;e++)for(var r=24;r>=0;r-=8)t[i]=this.chain_[e]>>r&255,++i;return t},t}(),_=function(){function t(t,n){var e=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=n,this.task.then((function(){t(e)})).catch((function(t){e.error(t)}))}return t.prototype.next=function(t){this.forEachObserver((function(n){n.next(t)}))},t.prototype.error=function(t){this.forEachObserver((function(n){n.error(t)})),this.close(t)},t.prototype.complete=function(){this.forEachObserver((function(t){t.complete()})),this.close()},t.prototype.subscribe=function(t,n,e){var i,r=this;if(void 0===t&&void 0===n&&void 0===e)throw new Error("Missing Observer.");void 0===(i=function(t){if("object"!=typeof t||null===t)return!1;for(var n=0,e=["next","error","complete"];n<e.length;n++){var i=e[n];if(i in t&&"function"==typeof t[i])return!0}return!1}(t)?t:{next:t,error:n,complete:e}).next&&(i.next=O),void 0===i.error&&(i.error=O),void 0===i.complete&&(i.complete=O);var u=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then((function(){try{r.finalError?i.error(r.finalError):i.complete()}catch(t){}})),this.observers.push(i),u},t.prototype.unsubscribeOne=function(t){void 0!==this.observers&&void 0!==this.observers[t]&&(delete this.observers[t],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},t.prototype.forEachObserver=function(t){if(!this.finalized)for(var n=0;n<this.observers.length;n++)this.sendOne(n,t)},t.prototype.sendOne=function(t,n){var e=this;this.task.then((function(){if(void 0!==e.observers&&void 0!==e.observers[t])try{n(e.observers[t])}catch(t){"undefined"!=typeof console&&console.error&&console.error(t)}}))},t.prototype.close=function(t){var n=this;this.finalized||(this.finalized=!0,void 0!==t&&(this.finalError=t),this.task.then((function(){n.observers=void 0,n.onNoObservers=void 0})))},t}();function O(){}function k(t,n,e){var i="";switch(n){case 1:i=e?"first":"First";break;case 2:i=e?"second":"Second";break;case 3:i=e?"third":"Third";break;case 4:i=e?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}return t+" failed: "+(i+" argument ")}n.CONSTANTS=e,n.Deferred=h,n.ErrorFactory=v,n.FirebaseError=d,n.Sha1=y,n.assert=i,n.assertionError=r,n.async=function(t,n){return function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];Promise.resolve(!0).then((function(){t.apply(void 0,e)})).catch((function(t){n&&n(t)}))}},n.base64=s,n.base64Decode=o,n.base64Encode=function(t){var n=u(t);return s.encodeByteArray(n,!0)},n.contains=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},n.createSubscribe=function(t,n){var e=new _(t,n);return e.subscribe.bind(e)},n.decode=g,n.deepCopy=function(t){return a(void 0,t)},n.deepExtend=a,n.errorPrefix=k,n.getUA=f,n.isAdmin=function(t){var n=g(t).claims;return"object"==typeof n&&!0===n.admin},n.isBrowser=function(){return"object"==typeof self&&self.self===self},n.isEmpty=function(t){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n))return!1;return!0},n.isMobileCordova=function(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(f())},n.isNode=function(){try{return"[object process]"===Object.prototype.toString.call(c.process)}catch(t){return!1}},n.isNodeSdk=function(){return!0===e.NODE_CLIENT||!0===e.NODE_ADMIN},n.isReactNative=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},n.isValidFormat=function(t){var n=g(t).claims;return!!n&&"object"==typeof n&&n.hasOwnProperty("iat")},n.isValidTimestamp=function(t){var n=g(t).claims,e=Math.floor((new Date).getTime()/1e3),i=0,r=0;return"object"==typeof n&&(n.hasOwnProperty("nbf")?i=n.nbf:n.hasOwnProperty("iat")&&(i=n.iat),r=n.hasOwnProperty("exp")?n.exp:i+86400),!!e&&!!i&&!!r&&e>=i&&e<=r},n.issuedAtTime=function(t){var n=g(t).claims;return"object"==typeof n&&n.hasOwnProperty("iat")?n.iat:null},n.jsonEval=p,n.map=function(t,n,e){var i={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(i[r]=n.call(e,t[r],r,t));return i},n.querystring=function(t){for(var n=[],e=function(t,e){Array.isArray(e)?e.forEach((function(e){n.push(encodeURIComponent(t)+"="+encodeURIComponent(e))})):n.push(encodeURIComponent(t)+"="+encodeURIComponent(e))},i=0,r=Object.entries(t);i<r.length;i++){var u=r[i];e(u[0],u[1])}return n.length?"&"+n.join("&"):""},n.querystringDecode=function(t){var n={};return t.replace(/^\?/,"").split("&").forEach((function(t){if(t){var e=t.split("=");n[e[0]]=e[1]}})),n},n.safeGet=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)?t[n]:void 0},n.stringLength=function(t){for(var n=0,e=0;e<t.length;e++){var i=t.charCodeAt(e);i<128?n++:i<2048?n+=2:i>=55296&&i<=56319?(n+=4,e++):n+=3}return n},n.stringToByteArray=function(t){for(var n=[],e=0,r=0;r<t.length;r++){var u=t.charCodeAt(r);if(u>=55296&&u<=56319){var s=u-55296;i(++r<t.length,"Surrogate pair missing trail surrogate."),u=65536+(s<<10)+(t.charCodeAt(r)-56320)}u<128?n[e++]=u:u<2048?(n[e++]=u>>6|192,n[e++]=63&u|128):u<65536?(n[e++]=u>>12|224,n[e++]=u>>6&63|128,n[e++]=63&u|128):(n[e++]=u>>18|240,n[e++]=u>>12&63|128,n[e++]=u>>6&63|128,n[e++]=63&u|128)}return n},n.stringify=function(t){return JSON.stringify(t)},n.validateArgCount=function(t,n,e,i){var r;if(i<n?r="at least "+n:i>e&&(r=0===e?"none":"no more than "+e),r)throw new Error(t+" failed: Was called with "+i+(1===i?" argument.":" arguments.")+" Expects "+r+".")},n.validateCallback=function(t,n,e,i){if((!i||e)&&"function"!=typeof e)throw new Error(k(t,n,i)+"must be a valid function.")},n.validateContextObject=function(t,n,e,i){if((!i||e)&&("object"!=typeof e||null===e))throw new Error(k(t,n,i)+"must be a valid context object.")},n.validateNamespace=function(t,n,e,i){if((!i||e)&&"string"!=typeof e)throw new Error(k(t,n,i)+"must be a valid firebase namespace.")}}));h(p);var g,y=[];!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(g||(g={}));var _=g.INFO,O=function(t,n){for(var e=[],i=2;i<arguments.length;i++)e[i-2]=arguments[i];if(!(n<t.logLevel)){var r=(new Date).toISOString();switch(n){case g.DEBUG:case g.VERBOSE:console.log.apply(console,["["+r+"]  "+t.name+":"].concat(e));break;case g.INFO:console.info.apply(console,["["+r+"]  "+t.name+":"].concat(e));break;case g.WARN:console.warn.apply(console,["["+r+"]  "+t.name+":"].concat(e));break;case g.ERROR:console.error.apply(console,["["+r+"]  "+t.name+":"].concat(e));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+n+")")}}},k=function(){function t(t){this.name=t,this._logLevel=_,this._logHandler=O,y.push(this)}return Object.defineProperty(t.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in g))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),t.prototype.debug=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._logHandler.apply(this,[this,g.DEBUG].concat(t))},t.prototype.log=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._logHandler.apply(this,[this,g.VERBOSE].concat(t))},t.prototype.info=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._logHandler.apply(this,[this,g.INFO].concat(t))},t.prototype.warn=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._logHandler.apply(this,[this,g.WARN].concat(t))},t.prototype.error=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this._logHandler.apply(this,[this,g.ERROR].concat(t))},t}();const j=Object.freeze({get LogLevel(){return g},Logger:k,setLogLevel:function(t){y.forEach((function(n){n.logLevel=t}))}});var S=f((function(t,n){var e;Object.defineProperty(n,"__esModule",{value:!0});var i=((e={})["no-app"]="No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()",e["bad-app-name"]="Illegal App name: '{$appName}",e["duplicate-app"]="Firebase App named '{$appName}' already exists",e["app-deleted"]="Firebase App named '{$appName}' already deleted",e["invalid-app-argument"]="firebase.{$appName}() takes either no argument or a Firebase App instance.",e),r=new p.ErrorFactory("app","Firebase",i),u="[DEFAULT]",s=[],o=function(){function t(t,n,e){this.firebase_=e,this.isDeleted_=!1,this.services_={},this.name_=n.name,this.automaticDataCollectionEnabled_=n.automaticDataCollectionEnabled||!1,this.options_=p.deepCopy(t),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(t){s.push(t),setTimeout((function(){return t(null)}),0)},removeAuthTokenListener:function(t){s=s.filter((function(n){return n!==t}))}}}return Object.defineProperty(t.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this.automaticDataCollectionEnabled_},set:function(t){this.checkDestroyed_(),this.automaticDataCollectionEnabled_=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),t.prototype.delete=function(){var t=this;return new Promise((function(n){t.checkDestroyed_(),n()})).then((function(){t.firebase_.INTERNAL.removeApp(t.name_);for(var n=[],e=0,i=Object.keys(t.services_);e<i.length;e++)for(var r=i[e],u=0,s=Object.keys(t.services_[r]);u<s.length;u++)n.push(t.services_[r][s[u]]);return Promise.all(n.filter((function(t){return"INTERNAL"in t})).map((function(t){return t.INTERNAL.delete()})))})).then((function(){t.isDeleted_=!0,t.services_={}}))},t.prototype._getService=function(t,n){if(void 0===n&&(n=u),this.checkDestroyed_(),this.services_[t]||(this.services_[t]={}),!this.services_[t][n]){var e=n!==u?n:void 0,i=this.firebase_.INTERNAL.factories[t](this,this.extendApp.bind(this),e);this.services_[t][n]=i}return this.services_[t][n]},t.prototype._removeServiceInstance=function(t,n){void 0===n&&(n=u),this.services_[t]&&this.services_[t][n]&&delete this.services_[t][n]},t.prototype.extendApp=function(t){var n=this;p.deepExtend(this,t),t.INTERNAL&&t.INTERNAL.addAuthTokenListener&&(s.forEach((function(t){n.INTERNAL.addAuthTokenListener(t)})),s=[])},t.prototype.checkDestroyed_=function(){if(this.isDeleted_)throw r.create("app-deleted",{appName:this.name_})},t}();o.prototype.name&&o.prototype.options||o.prototype.delete||console.log("dc");var a=new j.Logger("@firebase/app");if(p.isBrowser()&&void 0!==self.firebase){a.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");var c=self.firebase.SDK_VERSION;c&&c.indexOf("LITE")>=0&&a.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}var h=function t(){var n=function(t){var n={},e={},i={},s={__esModule:!0,initializeApp:function(e,i){void 0===i&&(i={}),"object"==typeof i&&null!==i||(i={name:i});var o=i;void 0===o.name&&(o.name=u);var a=o.name;if("string"!=typeof a||!a)throw r.create("bad-app-name",{appName:String(a)});if(p.contains(n,a))throw r.create("duplicate-app",{appName:a});var c=new t(e,o,s);return n[a]=c,h(c,"create"),c},app:o,apps:null,SDK_VERSION:"6.6.2",INTERNAL:{registerService:function(n,u,h,f,l){if(void 0===l&&(l=!1),e[n])return a.debug("There were multiple attempts to register service "+n+"."),s[n];function d(t){if(void 0===t&&(t=o()),"function"!=typeof t[n])throw r.create("invalid-app-argument",{appName:n});return t[n]()}return e[n]=u,f&&(i[n]=f,c().forEach((function(t){f("create",t)}))),void 0!==h&&p.deepExtend(d,h),s[n]=d,t.prototype[n]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this._getService.bind(this,n);return i.apply(this,l?t:[])},d},removeApp:function(t){h(n[t],"delete"),delete n[t]},factories:e,useAsService:f}};function o(t){if(!p.contains(n,t=t||u))throw r.create("no-app",{appName:t});return n[t]}function c(){return Object.keys(n).map((function(t){return n[t]}))}function h(t,n){for(var r=0,u=Object.keys(e);r<u.length;r++){var s=f(0,u[r]);if(null===s)return;i[s]&&i[s](n,t)}}function f(t,n){return"serverAuth"===n?null:n}return s.default=s,Object.defineProperty(s,"apps",{get:c}),o.App=t,s}(o);return n.INTERNAL=b.__assign({},n.INTERNAL,{createFirebaseNamespace:t,extendNamespace:function(t){p.deepExtend(n,t)},createSubscribe:p.createSubscribe,ErrorFactory:p.ErrorFactory,deepExtend:p.deepExtend}),n}(),f=h.initializeApp;h.initializeApp=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return p.isNode()&&a.warn('\n      Warning: This is a browser-targeted Firebase bundle but it appears it is being\n      run in a Node environment.  If running in a Node environment, make sure you\n      are using the bundle specified by the "main" field in package.json.\n      \n      If you are using Webpack, you can specify "main" as the first item in\n      "resolve.mainFields":\n      https://webpack.js.org/configuration/resolve/#resolvemainfields\n      \n      If using Rollup, use the rollup-plugin-node-resolve plugin and specify "main"\n      as the first item in "mainFields", e.g. [\'main\', \'module\'].\n      https://github.com/rollup/rollup-plugin-node-resolve\n      '),f.apply(void 0,t)};var l=h;n.default=l,n.firebase=l}));h(S);var E,D,I=(E=S)&&"object"==typeof E&&"default"in E?E.default:E,M="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},A=A||{},T=M;function N(t){return"string"==typeof t}function x(t){return"number"==typeof t}function C(t,n){t=t.split("."),n=n||T;for(var e=0;e<t.length;e++)if(null==(n=n[t[e]]))return null;return n}function R(){}function F(t){var n=typeof t;if("object"==n){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return n;var e=Object.prototype.toString.call(t);if("[object Window]"==e)return"object";if("[object Array]"==e||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==e||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==n&&void 0===t.call)return"object";return n}function P(t){return"array"==F(t)}function U(t){var n=F(t);return"array"==n||"object"==n&&"number"==typeof t.length}function $(t){var n=typeof t;return"object"==n&&null!=t||"function"==n}var L="closure_uid_"+(1e9*Math.random()>>>0),q=0;function B(t,n,e){return t.call.apply(t.bind,arguments)}function z(t,n,e){if(!t)throw Error();if(2<arguments.length){var i=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,i),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function V(t,n,e){return(V=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?B:z).apply(null,arguments)}function W(t,n){var e=Array.prototype.slice.call(arguments,1);return function(){var n=e.slice();return n.push.apply(n,arguments),t.apply(this,n)}}var G=Date.now||function(){return+new Date};function Q(t,n){function e(){}e.prototype=n.prototype,t.N=n.prototype,t.prototype=new e,t.prototype.constructor=t,t.yb=function(t,e,i){for(var r=Array(arguments.length-2),u=2;u<arguments.length;u++)r[u-2]=arguments[u];return n.prototype[e].apply(t,r)}}function Y(){this.j=this.j,this.i=this.i}Y.prototype.j=!1,Y.prototype.la=function(){!this.j&&(this.j=!0,this.G(),0)&&(this[L]||(this[L]=++q))},Y.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var H=Array.prototype.indexOf?function(t,n){return Array.prototype.indexOf.call(t,n,void 0)}:function(t,n){if(N(t))return N(n)&&1==n.length?t.indexOf(n,0):-1;for(var e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1},J=Array.prototype.forEach?function(t,n,e){Array.prototype.forEach.call(t,n,e)}:function(t,n,e){for(var i=t.length,r=N(t)?t.split(""):t,u=0;u<i;u++)u in r&&n.call(e,r[u],u,t)};function K(t){return Array.prototype.concat.apply([],arguments)}function X(t){var n=t.length;if(0<n){for(var e=Array(n),i=0;i<n;i++)e[i]=t[i];return e}return[]}function Z(t){return/^[\s\xa0]*$/.test(t)}var tt,nt=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function et(t,n){return-1!=t.indexOf(n)}function it(t,n){return t<n?-1:t>n?1:0}t:{var rt=T.navigator;if(rt){var ut=rt.userAgent;if(ut){tt=ut;break t}}tt=""}function st(t,n,e){for(var i in t)n.call(e,t[i],i,t)}function ot(t){var n,e={};for(n in t)e[n]=t[n];return e}var at="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ct(t,n){for(var e,i,r=1;r<arguments.length;r++){for(e in i=arguments[r])t[e]=i[e];for(var u=0;u<at.length;u++)e=at[u],Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])}}function ht(t){return ht[" "](t),t}ht[" "]=R;var ft,lt,dt=et(tt,"Opera"),vt=et(tt,"Trident")||et(tt,"MSIE"),mt=et(tt,"Edge"),wt=mt||vt,bt=et(tt,"Gecko")&&!(et(tt.toLowerCase(),"webkit")&&!et(tt,"Edge"))&&!(et(tt,"Trident")||et(tt,"MSIE"))&&!et(tt,"Edge"),pt=et(tt.toLowerCase(),"webkit")&&!et(tt,"Edge");function gt(){var t=T.document;return t?t.documentMode:void 0}t:{var yt="",_t=(lt=tt,bt?/rv:([^\);]+)(\)|;)/.exec(lt):mt?/Edge\/([\d\.]+)/.exec(lt):vt?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(lt):pt?/WebKit\/(\S+)/.exec(lt):dt?/(?:Version)[ \/]?(\S+)/.exec(lt):void 0);if(_t&&(yt=_t?_t[1]:""),vt){var Ot=gt();if(null!=Ot&&Ot>parseFloat(yt)){ft=String(Ot);break t}}ft=yt}var kt,jt={};function St(t){return function(t,n){var e=jt;return Object.prototype.hasOwnProperty.call(e,t)?e[t]:e[t]=n()}(t,(function(){for(var n=0,e=nt(String(ft)).split("."),i=nt(String(t)).split("."),r=Math.max(e.length,i.length),u=0;0==n&&u<r;u++){var s=e[u]||"",o=i[u]||"";do{if(s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],0==s[0].length&&0==o[0].length)break;n=it(0==s[1].length?0:parseInt(s[1],10),0==o[1].length?0:parseInt(o[1],10))||it(0==s[2].length,0==o[2].length)||it(s[2],o[2]),s=s[3],o=o[3]}while(0==n)}return 0<=n}))}var Et=T.document;kt=Et&&vt?gt()||("CSS1Compat"==Et.compatMode?parseInt(ft,10):5):void 0;var Dt=!vt||9<=Number(kt),It=vt&&!St("9"),Mt=function(){if(!T.addEventListener||!Object.defineProperty)return!1;var t=!1,n=Object.defineProperty({},"passive",{get:function(){t=!0}});try{T.addEventListener("test",R,n),T.removeEventListener("test",R,n)}catch(t){}return t}();function At(t,n){this.type=t,this.a=this.target=n,this.Ja=!0}function Tt(t,n){if(At.call(this,t?t.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,t){var e=this.type=t.type,i=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.a=n,n=t.relatedTarget){if(bt){t:{try{ht(n.nodeName);var r=!0;break t}catch(t){}r=!1}r||(n=null)}}else"mouseover"==e?n=t.fromElement:"mouseout"==e&&(n=t.toElement);this.relatedTarget=n,i?(this.clientX=void 0!==i.clientX?i.clientX:i.pageX,this.clientY=void 0!==i.clientY?i.clientY:i.pageY,this.screenX=i.screenX||0,this.screenY=i.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=N(t.pointerType)?t.pointerType:Nt[t.pointerType]||"",this.c=t,t.defaultPrevented&&this.b()}}At.prototype.b=function(){this.Ja=!1},Q(Tt,At);var Nt={2:"touch",3:"pen",4:"mouse"};Tt.prototype.b=function(){Tt.N.b.call(this);var t=this.c;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,It)try{(t.ctrlKey||112<=t.keyCode&&123>=t.keyCode)&&(t.keyCode=-1)}catch(t){}};var xt="closure_listenable_"+(1e6*Math.random()|0),Ct=0;function Rt(t,n,e,i,r){this.listener=t,this.proxy=null,this.src=n,this.type=e,this.capture=!!i,this.da=r,this.key=++Ct,this.X=this.Z=!1}function Ft(t){t.X=!0,t.listener=null,t.proxy=null,t.src=null,t.da=null}function Pt(t){this.src=t,this.a={},this.b=0}function Ut(t,n){var e=n.type;if(e in t.a){var i,r=t.a[e],u=H(r,n);(i=0<=u)&&Array.prototype.splice.call(r,u,1),i&&(Ft(n),0==t.a[e].length&&(delete t.a[e],t.b--))}}function $t(t,n,e,i){for(var r=0;r<t.length;++r){var u=t[r];if(!u.X&&u.listener==n&&u.capture==!!e&&u.da==i)return r}return-1}Pt.prototype.add=function(t,n,e,i,r){var u=t.toString();(t=this.a[u])||(t=this.a[u]=[],this.b++);var s=$t(t,n,i,r);return-1<s?(n=t[s],e||(n.Z=!1)):((n=new Rt(n,this.src,u,!!i,r)).Z=e,t.push(n)),n};var Lt="closure_lm_"+(1e6*Math.random()|0),qt={};function Bt(t,n,e,i,r){if(i&&i.once)return function t(n,e,i,r,u){if(P(e)){for(var s=0;s<e.length;s++)t(n,e[s],i,r,u);return null}return i=Jt(i),n&&n[xt]?n.Ba(e,i,$(r)?!!r.capture:!!r,u):zt(n,e,i,!0,r,u)}(t,n,e,i,r);if(P(n)){for(var u=0;u<n.length;u++)Bt(t,n[u],e,i,r);return null}return e=Jt(e),t&&t[xt]?t.Aa(n,e,$(i)?!!i.capture:!!i,r):zt(t,n,e,!1,i,r)}function zt(t,n,e,i,r,u){if(!n)throw Error("Invalid event type");var s=$(r)?!!r.capture:!!r;if(s&&!Dt)return null;var o=Yt(t);if(o||(t[Lt]=o=new Pt(t)),(e=o.add(n,e,i,s,u)).proxy)return e;if(i=function(){var t=Qt,n=Dt?function(e){return t.call(n.src,n.listener,e)}:function(e){if(!(e=t.call(n.src,n.listener,e)))return e};return n}(),e.proxy=i,i.src=t,i.listener=e,t.addEventListener)Mt||(r=s),void 0===r&&(r=!1),t.addEventListener(n.toString(),i,r);else if(t.attachEvent)t.attachEvent(Wt(n.toString()),i);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(i)}return e}function Vt(t){if(!x(t)&&t&&!t.X){var n=t.src;if(n&&n[xt])Ut(n.c,t);else{var e=t.type,i=t.proxy;n.removeEventListener?n.removeEventListener(e,i,t.capture):n.detachEvent?n.detachEvent(Wt(e),i):n.addListener&&n.removeListener&&n.removeListener(i),(e=Yt(n))?(Ut(e,t),0==e.b&&(e.src=null,n[Lt]=null)):Ft(t)}}}function Wt(t){return t in qt?qt[t]:qt[t]="on"+t}function Gt(t,n){var e=t.listener,i=t.da||t.src;return t.Z&&Vt(t),e.call(i,n)}function Qt(t,n){return!!t.X||Gt(t,Dt?new Tt(n,this):n=new Tt(n||C("window.event"),this))}function Yt(t){return(t=t[Lt])instanceof Pt?t:null}var Ht="__closure_events_fn_"+(1e9*Math.random()>>>0);function Jt(t){return"function"==F(t)?t:(t[Ht]||(t[Ht]=function(n){return t.handleEvent(n)}),t[Ht])}function Kt(){Y.call(this),this.c=new Pt(this),this.J=this,this.B=null}function Xt(t,n,e,i){if(!(n=t.c.a[String(n)]))return!0;n=n.concat();for(var r=!0,u=0;u<n.length;++u){var s=n[u];if(s&&!s.X&&s.capture==e){var o=s.listener,a=s.da||s.src;s.Z&&Ut(t.c,s),r=!1!==o.call(a,i)&&r}}return r&&0!=i.Ja}Q(Kt,Y),Kt.prototype[xt]=!0,(D=Kt.prototype).addEventListener=function(t,n,e,i){Bt(this,t,n,e,i)},D.removeEventListener=function(t,n,e,i){!function t(n,e,i,r,u){if(P(e))for(var s=0;s<e.length;s++)t(n,e[s],i,r,u);else r=$(r)?!!r.capture:!!r,i=Jt(i),n&&n[xt]?(n=n.c,(e=String(e).toString())in n.a&&-1<(i=$t(s=n.a[e],i,r,u))&&(Ft(s[i]),Array.prototype.splice.call(s,i,1),0==s.length&&(delete n.a[e],n.b--))):n&&(n=Yt(n))&&(e=n.a[e.toString()],n=-1,e&&(n=$t(e,i,r,u)),(i=-1<n?e[n]:null)&&Vt(i))}(this,t,n,e,i)},D.dispatchEvent=function(t){var n,e=this.B;if(e)for(n=[];e;e=e.B)n.push(e);e=this.J;var i=t.type||t;if(N(t))t=new At(t,e);else if(t instanceof At)t.target=t.target||e;else{var r=t;ct(t=new At(i,e),r)}if(r=!0,n)for(var u=n.length-1;0<=u;u--){var s=t.a=n[u];r=Xt(s,i,!0,t)&&r}if(r=Xt(s=t.a=e,i,!0,t)&&r,r=Xt(s,i,!1,t)&&r,n)for(u=0;u<n.length;u++)r=Xt(s=t.a=n[u],i,!1,t)&&r;return r},D.G=function(){if(Kt.N.G.call(this),this.c){var t,n=this.c;for(t in n.a){for(var e=n.a[t],i=0;i<e.length;i++)Ft(e[i]);delete n.a[t],n.b--}}this.B=null},D.Aa=function(t,n,e,i){return this.c.add(String(t),n,!1,e,i)},D.Ba=function(t,n,e,i){return this.c.add(String(t),n,!0,e,i)};var Zt=T.JSON.stringify;function tn(t,n){this.c=t,this.f=n,this.b=0,this.a=null}function nn(){this.b=this.a=null}tn.prototype.get=function(){if(0<this.b){this.b--;var t=this.a;this.a=t.next,t.next=null}else t=this.c();return t};var en,rn=new tn((function(){return new sn}),(function(t){t.reset()}));function un(){var t=hn,n=null;return t.a&&(n=t.a,t.a=t.a.next,t.a||(t.b=null),n.next=null),n}function sn(){this.next=this.b=this.a=null}function on(t){T.setTimeout((function(){throw t}),0)}function an(t,n){en||function(){var t=T.Promise.resolve(void 0);en=function(){t.then(fn)}}(),cn||(en(),cn=!0),hn.add(t,n)}nn.prototype.add=function(t,n){var e=rn.get();e.set(t,n),this.b?this.b.next=e:this.a=e,this.b=e},sn.prototype.set=function(t,n){this.a=t,this.b=n,this.next=null},sn.prototype.reset=function(){this.next=this.b=this.a=null};var cn=!1,hn=new nn;function fn(){for(var t;t=un();){try{t.a.call(t.b)}catch(t){on(t)}var n=rn;n.f(t),100>n.b&&(n.b++,t.next=n.a,n.a=t)}cn=!1}function ln(t,n){Kt.call(this),this.b=t||1,this.a=n||T,this.f=V(this.gb,this),this.g=G()}function dn(t){t.ba=!1,t.L&&(t.a.clearTimeout(t.L),t.L=null)}function vn(t,n,e){if("function"==F(t))e&&(t=V(t,e));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=V(t.handleEvent,t)}return 2147483647<Number(n)?-1:T.setTimeout(t,n||0)}function mn(t,n,e){Y.call(this),this.f=null!=e?V(t,e):t,this.c=n,this.b=V(this.ab,this),this.a=[]}function wn(t){t.U=vn(t.b,t.c),t.f.apply(null,t.a)}function bn(t){Y.call(this),this.b=t,this.a={}}Q(ln,Kt),(D=ln.prototype).ba=!1,D.L=null,D.gb=function(){if(this.ba){var t=G()-this.g;0<t&&t<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-t):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(dn(this),this.start()))}},D.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=G())},D.G=function(){ln.N.G.call(this),dn(this),delete this.a},Q(mn,Y),(D=mn.prototype).ea=!1,D.U=null,D.Ua=function(t){this.a=arguments,this.U?this.ea=!0:wn(this)},D.G=function(){mn.N.G.call(this),this.U&&(T.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},D.ab=function(){this.U=null,this.ea&&(this.ea=!1,wn(this))},Q(bn,Y);var pn=[];function gn(t,n,e,i){P(e)||(e&&(pn[0]=e.toString()),e=pn);for(var r=0;r<e.length;r++){var u=Bt(n,e[r],i||t.handleEvent,!1,t.b||t);if(!u)break;t.a[u.key]=u}}function yn(t){st(t.a,(function(t,n){this.a.hasOwnProperty(n)&&Vt(t)}),t),t.a={}}function _n(){}bn.prototype.G=function(){bn.N.G.call(this),yn(this)},bn.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var On=new Kt;function kn(t){At.call(this,"serverreachability",t)}function jn(t){On.dispatchEvent(new kn(On,t))}function Sn(t){At.call(this,"statevent",t)}function En(t){On.dispatchEvent(new Sn(On,t))}function Dn(t){At.call(this,"timingevent",t)}function In(t,n){if("function"!=F(t))throw Error("Fn must not be null and must be a function");return T.setTimeout((function(){t()}),n)}Q(kn,At),Q(Sn,At),Q(Dn,At);var Mn={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},An={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};function Tn(){}function Nn(){}Tn.prototype.a=null;var xn,Cn={OPEN:"a",ib:"b",Na:"c",rb:"d"};function Rn(){At.call(this,"d")}function Fn(){At.call(this,"c")}function Pn(){}function Un(t,n,e){this.g=t,this.W=n,this.V=e||1,this.I=new bn(this),this.O=$n,this.P=new ln(t=wt?125:void 0),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}Q(Rn,At),Q(Fn,At),Q(Pn,Tn),xn=new Pn;var $n=45e3,Ln={},qn={};function Bn(t,n,e){t.F=1,t.f=de(se(n)),t.l=e,t.H=!0,Vn(t,null)}function zn(t,n,e,i){t.F=1,t.f=de(se(n)),t.l=null,t.H=e,Vn(t,i)}function Vn(t,n){t.v=G(),Qn(t),t.D=se(t.f),le(t.D,"t",t.V),t.A=0,t.a=t.g.$(t.g.Y()?n:null),0<t.J&&(t.B=new mn(V(t.Ka,t,t.a),t.J)),gn(t.I,t.a,"readystatechange",t.eb),n=t.h?ot(t.h):{},t.l?(t.w||(t.w="POST"),n["Content-Type"]="application/x-www-form-urlencoded",t.a.ca(t.D,t.w,t.l,n)):(t.w="GET",t.a.ca(t.D,t.w,null,n)),jn(1)}function Wn(t,n,e){for(var i=!0;!t.m&&t.A<e.length;){var r=Gn(t,e);if(r==qn){4==n&&(t.c=4,En(14),i=!1);break}if(r==Ln){t.c=4,En(15),i=!1;break}Xn(t,r)}4==n&&0==e.length&&(t.c=1,En(16),i=!1),t.b=t.b&&i,i||(Kn(t),Jn(t))}function Gn(t,n){var e=t.A,i=n.indexOf("\n",e);return-1==i?qn:(e=Number(n.substring(e,i)),isNaN(e)?Ln:(i+=1)+e>n.length?qn:(n=n.substr(i,e),t.A=i+e,n))}function Qn(t){t.R=G()+t.O,Yn(t,t.O)}function Yn(t,n){if(null!=t.i)throw Error("WatchDog timer not null");t.i=In(V(t.bb,t),n)}function Hn(t){t.i&&(T.clearTimeout(t.i),t.i=null)}function Jn(t){t.g.Da()||t.m||t.g.na(t)}function Kn(t){Hn(t);var n=t.B;n&&"function"==typeof n.la&&n.la(),t.B=null,dn(t.P),yn(t.I),t.a&&(n=t.a,t.a=null,n.abort(),n.la())}function Xn(t,n){try{t.g.Ga(t,n),jn(4)}catch(t){}}function Zn(t,n){if(t.forEach&&"function"==typeof t.forEach)t.forEach(n,void 0);else if(U(t)||N(t))J(t,n,void 0);else{if(t.K&&"function"==typeof t.K)var e=t.K();else if(t.C&&"function"==typeof t.C)e=void 0;else if(U(t)||N(t)){e=[];for(var i=t.length,r=0;r<i;r++)e.push(r)}else for(r in e=[],i=0,t)e[i++]=r;r=(i=function(t){if(t.C&&"function"==typeof t.C)return t.C();if(N(t))return t.split("");if(U(t)){for(var n=[],e=t.length,i=0;i<e;i++)n.push(t[i]);return n}for(i in n=[],e=0,t)n[e++]=t[i];return n}(t)).length;for(var u=0;u<r;u++)n.call(void 0,i[u],e&&e[u],t)}}function te(t,n){this.b={},this.a=[],this.c=0;var e=arguments.length;if(1<e){if(e%2)throw Error("Uneven number of arguments");for(var i=0;i<e;i+=2)this.set(arguments[i],arguments[i+1])}else if(t)if(t instanceof te)for(e=t.K(),i=0;i<e.length;i++)this.set(e[i],t.get(e[i]));else for(i in t)this.set(i,t[i])}function ne(t,n){ie(t.b,n)&&(delete t.b[n],t.c--,t.a.length>2*t.c&&ee(t))}function ee(t){if(t.c!=t.a.length){for(var n=0,e=0;n<t.a.length;){var i=t.a[n];ie(t.b,i)&&(t.a[e++]=i),n++}t.a.length=e}if(t.c!=t.a.length){var r={};for(e=n=0;n<t.a.length;)ie(r,i=t.a[n])||(t.a[e++]=i,r[i]=1),n++;t.a.length=e}}function ie(t,n){return Object.prototype.hasOwnProperty.call(t,n)}(D=Un.prototype).setTimeout=function(t){this.O=t},D.eb=function(t){t=t.target;var n=this.B;n&&3==ui(t)?n.Ua():this.Ka(t)},D.Ka=function(t){try{if(t==this.a)t:{var n=ui(this.a),e=this.a.ya(),i=this.a.T();if(!(3>n||3==n&&!wt&&!this.a.aa())){this.m||4!=n||7==e||jn(8==e||0>=i?3:2),Hn(this);var r=this.a.T();this.o=r;var u=this.a.aa();if(this.b=200==r){if(this.S&&!this.s){n:{if(this.a){var s=si(this.a,"X-HTTP-Initial-Response");if(s&&!Z(s)){var o=s;break n}}o=null}if(!o){this.b=!1,this.c=3,En(12),Kn(this),Jn(this);break t}this.s=!0,Xn(this,o)}this.H?(Wn(this,n,u),wt&&this.b&&3==n&&(gn(this.I,this.P,"tick",this.cb),this.P.start())):Xn(this,u),4==n&&Kn(this),this.b&&!this.m&&(4==n?this.g.na(this):(this.b=!1,Qn(this)))}else 400==r&&0<u.indexOf("Unknown SID")?(this.c=3,En(12)):(this.c=0,En(13)),Kn(this),Jn(this)}}}catch(t){}},D.cb=function(){if(this.a){var t=ui(this.a),n=this.a.aa();this.A<n.length&&(Hn(this),Wn(this,t,n),this.b&&4!=t&&Qn(this))}},D.cancel=function(){this.m=!0,Kn(this)},D.bb=function(){this.i=null;var t=G();0<=t-this.R?(2!=this.F&&(jn(3),En(17)),Kn(this),this.c=2,Jn(this)):Yn(this,this.R-t)},(D=te.prototype).C=function(){ee(this);for(var t=[],n=0;n<this.a.length;n++)t.push(this.b[this.a[n]]);return t},D.K=function(){return ee(this),this.a.concat()},D.get=function(t,n){return ie(this.b,t)?this.b[t]:n},D.set=function(t,n){ie(this.b,t)||(this.c++,this.a.push(t)),this.b[t]=n},D.forEach=function(t,n){for(var e=this.K(),i=0;i<e.length;i++){var r=e[i],u=this.get(r);t.call(n,u,r,this)}};var re=/^(?:([^:\/?#.]+):)?(?:\/\/(?:([^\/?#]*)@)?([^\/#?]*?)(?::([0-9]+))?(?=[\/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function ue(t,n){var e;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,t instanceof ue?(this.h=void 0!==n?n:t.h,oe(this,t.f),this.j=t.j,ae(this,t.b),ce(this,t.i),this.a=t.a,he(this,De(t.c)),this.g=t.g):t&&(e=String(t).match(re))?(this.h=!!n,oe(this,e[1]||"",!0),this.j=ve(e[2]||""),ae(this,e[3]||"",!0),ce(this,e[4]),this.a=ve(e[5]||"",!0),he(this,e[6]||"",!0),this.g=ve(e[7]||"")):(this.h=!!n,this.c=new Oe(null,this.h))}function se(t){return new ue(t)}function oe(t,n,e){t.f=e?ve(n,!0):n,t.f&&(t.f=t.f.replace(/:$/,""))}function ae(t,n,e){t.b=e?ve(n,!0):n}function ce(t,n){if(n){if(n=Number(n),isNaN(n)||0>n)throw Error("Bad port number "+n);t.i=n}else t.i=null}function he(t,n,e){n instanceof Oe?(t.c=n,function(t,n){n&&!t.f&&(ke(t),t.c=null,t.a.forEach((function(t,n){var e=n.toLowerCase();n!=e&&(je(this,n),Ee(this,e,t))}),t)),t.f=n}(t.c,t.h)):(e||(n=me(n,ye)),t.c=new Oe(n,t.h))}function fe(t,n,e){t.c.set(n,e)}function le(t,n,e){P(e)||(e=[String(e)]),Ee(t.c,n,e)}function de(t){return fe(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^G()).toString(36)),t}function ve(t,n){return t?n?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function me(t,n,e){return N(t)?(t=encodeURI(t).replace(n,we),e&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function we(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}ue.prototype.toString=function(){var t=[],n=this.f;n&&t.push(me(n,be,!0),":");var e=this.b;return(e||"file"==n)&&(t.push("//"),(n=this.j)&&t.push(me(n,be,!0),"@"),t.push(encodeURIComponent(String(e)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(e=this.i)&&t.push(":",String(e))),(e=this.a)&&(this.b&&"/"!=e.charAt(0)&&t.push("/"),t.push(me(e,"/"==e.charAt(0)?ge:pe,!0))),(e=this.c.toString())&&t.push("?",e),(e=this.g)&&t.push("#",me(e,_e)),t.join("")},ue.prototype.resolve=function(t){var n=se(this),e=!!t.f;e?oe(n,t.f):e=!!t.j,e?n.j=t.j:e=!!t.b,e?ae(n,t.b):e=null!=t.i;var i=t.a;if(e)ce(n,t.i);else if(e=!!t.a){if("/"!=i.charAt(0))if(this.b&&!this.a)i="/"+i;else{var r=n.a.lastIndexOf("/");-1!=r&&(i=n.a.substr(0,r+1)+i)}if(".."==(r=i)||"."==r)i="";else if(et(r,"./")||et(r,"/.")){i=0==r.lastIndexOf("/",0),r=r.split("/");for(var u=[],s=0;s<r.length;){var o=r[s++];"."==o?i&&s==r.length&&u.push(""):".."==o?((1<u.length||1==u.length&&""!=u[0])&&u.pop(),i&&s==r.length&&u.push("")):(u.push(o),i=!0)}i=u.join("/")}else i=r}return e?n.a=i:e=""!==t.c.toString(),e?he(n,De(t.c)):e=!!t.g,e&&(n.g=t.g),n};var be=/[#\/\?@]/g,pe=/[#\?:]/g,ge=/[#\?]/g,ye=/[#\?@]/g,_e=/#/g;function Oe(t,n){this.b=this.a=null,this.c=t||null,this.f=!!n}function ke(t){t.a||(t.a=new te,t.b=0,t.c&&function(t,n){if(t){t=t.split("&");for(var e=0;e<t.length;e++){var i=t[e].indexOf("="),r=null;if(0<=i){var u=t[e].substring(0,i);r=t[e].substring(i+1)}else u=t[e];n(u,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.c,(function(n,e){t.add(decodeURIComponent(n.replace(/\+/g," ")),e)})))}function je(t,n){ke(t),n=Ie(t,n),ie(t.a.b,n)&&(t.c=null,t.b-=t.a.get(n).length,ne(t.a,n))}function Se(t,n){return ke(t),n=Ie(t,n),ie(t.a.b,n)}function Ee(t,n,e){je(t,n),0<e.length&&(t.c=null,t.a.set(Ie(t,n),X(e)),t.b+=e.length)}function De(t){var n=new Oe;return n.c=t.c,t.a&&(n.a=new te(t.a),n.b=t.b),n}function Ie(t,n){return n=String(n),t.f&&(n=n.toLowerCase()),n}function Me(t){this.a=t,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function Ae(t){var n=t.a.F.a;if(null!=n)En(4),n?(En(10),pi(t.a,t,!1)):(En(11),pi(t.a,t,!0));else{t.b=new Un(t,void 0,void 0),t.b.h=t.h,n=ki(n=t.a,n.Y()?t.f:null,t.i),En(4),le(n,"TYPE","xmlhttp");var e=t.a.j,i=t.a.I;e&&i&&fe(n,e,i),zn(t.b,n,!1,t.f)}}function Te(){this.a=this.b=null}function Ne(){this.a=new te}function xe(t){var n=typeof t;return"object"==n&&t||"function"==n?"o"+(t[L]||(t[L]=++q)):n.charAt(0)+t}function Ce(t,n){this.b=t,this.a=n}function Re(t){this.g=t||Fe,t=T.PerformanceNavigationTiming?0<(t=T.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(T.ka&&T.ka.Ea&&T.ka.Ea()&&T.ka.Ea().zb),this.f=t?this.g:1,this.a=null,1<this.f&&(this.a=new Ne),this.b=null,this.c=[]}(D=Oe.prototype).add=function(t,n){ke(this),this.c=null,t=Ie(this,t);var e=this.a.get(t);return e||this.a.set(t,e=[]),e.push(n),this.b+=1,this},D.forEach=function(t,n){ke(this),this.a.forEach((function(e,i){J(e,(function(e){t.call(n,e,i,this)}),this)}),this)},D.K=function(){ke(this);for(var t=this.a.C(),n=this.a.K(),e=[],i=0;i<n.length;i++)for(var r=t[i],u=0;u<r.length;u++)e.push(n[i]);return e},D.C=function(t){ke(this);var n=[];if(N(t))Se(this,t)&&(n=K(n,this.a.get(Ie(this,t))));else{t=this.a.C();for(var e=0;e<t.length;e++)n=K(n,t[e])}return n},D.set=function(t,n){return ke(this),this.c=null,Se(this,t=Ie(this,t))&&(this.b-=this.a.get(t).length),this.a.set(t,[n]),this.b+=1,this},D.get=function(t,n){return t&&0<(t=this.C(t)).length?String(t[0]):n},D.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var t=[],n=this.a.K(),e=0;e<n.length;e++){var i=n[e],r=encodeURIComponent(String(i));i=this.C(i);for(var u=0;u<i.length;u++){var s=r;""!==i[u]&&(s+="="+encodeURIComponent(String(i[u]))),t.push(s)}}return this.c=t.join("&")},Q((function(){}),(function(){})),(D=Me.prototype).M=null,D.$=function(t){return this.a.$(t)},D.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},D.Da=function(){return!1},D.Ga=function(t,n){if(this.c=t.o,0==this.M){if(!this.a.o&&(t=t.a)){var e=si(t,"X-Client-Wire-Protocol");this.l=e||null,this.a.j&&(t=si(t,"X-HTTP-Session-Id"))&&(this.a.I=t)}if(n){try{var i=this.a.ja.a.parse(n)}catch(t){return(n=this.a).m=this.c,void _i(n,2)}this.f=i[0]}else(n=this.a).m=this.c,_i(n,2)}else 1==this.M&&(this.g?En(6):"11111"==n?(En(5),this.g=!0,(!vt||10<=Number(kt))&&(this.c=200,this.b.cancel(),En(11),pi(this.a,this,!0))):(En(7),this.g=!1))},D.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,Ae(this)):1==this.M&&(this.g?(En(11),pi(this.a,this,!0)):(En(10),pi(this.a,this,!1)));else{0==this.M?En(8):1==this.M&&En(9);var t=this.a;t.m=this.c,_i(t,2)}},D.Y=function(){return this.a.Y()},D.ma=function(){return this.a.ma()},Ne.prototype.add=function(t){this.a.set(xe(t),t)},Ne.prototype.C=function(){return this.a.C()};var Fe=10;function Pe(t,n){!t.a&&(et(n,"spdy")||et(n,"quic")||et(n,"h2"))&&(t.f=t.g,t.a=new Ne,t.b&&(qe(t,t.b),t.b=null))}function Ue(t){return!!t.b||!!t.a&&t.a.a.c>=t.f}function $e(t){return t.b?1:t.a?t.a.a.c:0}function Le(t,n){return t.b?t=t.b==n:t.a?(n=xe(n),t=ie(t.a.a.b,n)):t=!1,t}function qe(t,n){t.a?t.a.add(n):t.b=n}function Be(t,n){var e;t.b&&t.b==n?t.b=null:((e=t.a)&&(e=xe(n),e=ie(t.a.a.b,e)),e&&ne(t.a.a,xe(n)))}function ze(t){if(null!=t.b)return t.c.concat(t.b.j);if(null!=t.a&&0!=t.a.a.c){var n=t.c;return J(t.a.C(),(function(t){n=n.concat(t.j)})),n}return X(t.c)}function Ve(){}function We(){this.a=new Ve}function Ge(t,n,e){var i=e||"";try{Zn(t,(function(t,e){var r=t;$(t)&&(r=Zt(t)),n.push(i+e+"="+encodeURIComponent(r))}))}catch(t){throw n.push(i+"type="+encodeURIComponent("_badmap")),t}}function Qe(t,n,e,i,r){try{n.onload=null,n.onerror=null,n.onabort=null,n.ontimeout=null,r(i)}catch(t){}}Re.prototype.cancel=function(){this.c=ze(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(J(this.a.C(),(function(t){t.cancel()})),function(t){t.b={},t.a.length=0,t.c=0}(this.a.a))},Ve.prototype.stringify=function(t){return T.JSON.stringify(t,void 0)},Ve.prototype.parse=function(t){return T.JSON.parse(t,void 0)};var Ye=T.JSON.parse;function He(t){Kt.call(this),this.headers=new te,this.H=t||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Je,this.D=this.F=!1}Q(He,Kt);var Je="",Ke=/^https?$/i,Xe=["POST","PUT"];function Ze(t){return"content-type"==t.toLowerCase()}function ti(t,n){t.b=!1,t.a&&(t.g=!0,t.a.abort(),t.g=!1),t.f=n,t.h=5,ni(t),ii(t)}function ni(t){t.v||(t.v=!0,t.dispatchEvent("complete"),t.dispatchEvent("error"))}function ei(t){if(t.b&&void 0!==A&&(!t.s[1]||4!=ui(t)||2!=t.T()))if(t.l&&4==ui(t))vn(t.Fa,0,t);else if(t.dispatchEvent("readystatechange"),4==ui(t)){t.b=!1;try{var n,e=t.T();t:switch(e){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var i=!0;break t;default:i=!1}if(!(n=i)){var r;if(r=0===e){var u=String(t.A).match(re)[1]||null;if(!u&&T.self&&T.self.location){var s=T.self.location.protocol;u=s.substr(0,s.length-1)}r=!Ke.test(u?u.toLowerCase():"")}n=r}n?(t.dispatchEvent("complete"),t.dispatchEvent("success")):(t.h=6,t.f=t.za()+" ["+t.T()+"]",ni(t))}finally{ii(t)}}}function ii(t,n){if(t.a){ri(t);var e=t.a,i=t.s[0]?R:null;t.a=null,t.s=null,n||t.dispatchEvent("ready");try{e.onreadystatechange=i}catch(t){}}}function ri(t){t.a&&t.D&&(t.a.ontimeout=null),t.m&&(T.clearTimeout(t.m),t.m=null)}function ui(t){return t.a?t.a.readyState:0}function si(t,n){return t.a?t.a.getResponseHeader(n):null}function oi(t,n,e){t:{for(i in e){var i=!1;break t}i=!0}if(i)return t;if(e=function(t){var n="";return st(t,(function(t,e){n+=e,n+=":",n+=t,n+="\r\n"})),n}(e),N(t)){if(n=encodeURIComponent(String(n)),n+=e=null!=e?"="+encodeURIComponent(String(e)):""){if(0>(e=t.indexOf("#"))&&(e=t.length),0>(i=t.indexOf("?"))||i>e){i=e;var r=""}else r=t.substring(i+1,e);e=(t=[t.substr(0,i),r,t.substr(e)])[1],t[1]=n?e?e+"&"+n:n:e,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return fe(t,n,e),t}function ai(t){this.f=[],this.F=new Te,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!C("internalChannelParams.failFast",t),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=C("internalChannelParams.baseRetryDelayMs",t)||5e3,this.Sa=C("internalChannelParams.retryDelaySeedMs",t)||1e4,this.Qa=C("internalChannelParams.forwardChannelMaxRetries",t)||2,this.qa=C("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.La=t&&t.Ab||void 0,this.D=void 0,this.R=t&&t.supportsCrossDomainXhr||!1,this.H="",this.b=new Re(t&&t.concurrentRequestLimit),this.ja=new We,this.o=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.W=t&&t.fastHandshake||!1)&&!this.o&&(this.o=!0),t&&t.forceLongPolling&&(this.oa=!1),this.fa=void 0}function ci(t){if(hi(t),3==t.u){var n=t.P++,e=se(t.B);fe(e,"SID",t.H),fe(e,"RID",n),fe(e,"TYPE","terminate"),vi(t,e),(n=new Un(t,n,void 0)).F=2,n.f=de(se(e)),e=!1,T.navigator&&T.navigator.sendBeacon&&(e=T.navigator.sendBeacon(n.f.toString(),"")),!e&&T.Image&&((new Image).src=n.f,e=!0),e||(n.a=n.g.$(null),n.a.ca(n.f)),n.v=G(),Qn(n)}Oi(t)}function hi(t){t.w&&(t.w.abort(),t.w=null),t.a&&(t.a.cancel(),t.a=null),t.l&&(T.clearTimeout(t.l),t.l=null),gi(t),t.b.cancel(),t.h&&(x(t.h)&&T.clearTimeout(t.h),t.h=null)}function fi(t,n){t.f.push(new Ce(t.Ra++,n)),3==t.u&&li(t)}function li(t){Ue(t.b)||t.h||(t.h=!0,an(t.Ia,t),t.A=0)}function di(t,n){var e;e=n?n.W:t.P++;var i=se(t.B);fe(i,"SID",t.H),fe(i,"RID",e),fe(i,"AID",t.O),vi(t,i),t.g&&t.i&&oi(i,t.g,t.i),e=new Un(t,e,t.A+1),null===t.g&&(e.h=t.i),n&&(t.f=n.j.concat(t.f)),n=mi(t,e,1e3),e.setTimeout(Math.round(.5*t.qa)+Math.round(.5*t.qa*Math.random())),qe(t.b,e),Bn(e,i,n)}function vi(t,n){t.c&&Zn({},(function(t,e){fe(n,e,t)}))}function mi(t,n,e){e=Math.min(t.f.length,e);var i=t.c?V(t.c.Ta,t.c,t):null;t:for(var r=t.f,u=-1;;){var s=["count="+e];-1==u?0<e?s.push("ofs="+(u=r[0].b)):u=0:s.push("ofs="+u);for(var o=!0,a=0;a<e;a++){var c=r[a].b,h=r[a].a;if(0>(c-=u))u=Math.max(0,r[a].b-100),o=!1;else try{Ge(h,s,"req"+c+"_")}catch(t){i&&i(h)}}if(o){i=s.join("&");break t}}return t=t.f.splice(0,e),n.j=t,i}function wi(t){t.a||t.l||(t.S=1,an(t.Ha,t),t.v=0)}function bi(t){return!(t.a||t.l||3<=t.v||(t.S++,t.l=In(V(t.Ha,t),yi(t,t.v)),t.v++,0))}function pi(t,n,e){var i=n.l;i&&Pe(t.b,i),t.ia=t.oa&&e,t.m=n.c,t.B=ki(t,null,t.ha),li(t)}function gi(t){null!=t.s&&(T.clearTimeout(t.s),t.s=null)}function yi(t,n){var e=t.Oa+Math.floor(Math.random()*t.Sa);return t.ma()||(e*=2),e*n}function _i(t,n){if(2==n){var e=null;t.c&&(e=null);var i=V(t.fb,t);e||(e=new ue("//www.google.com/images/cleardot.gif"),T.location&&"http"==T.location.protocol||oe(e,"https"),de(e)),function(t,n){var e=new _n;if(T.Image){var i=new Image;i.onload=W(Qe,e,i,"TestLoadImage: loaded",!0,n),i.onerror=W(Qe,e,i,"TestLoadImage: error",!1,n),i.onabort=W(Qe,e,i,"TestLoadImage: abort",!1,n),i.ontimeout=W(Qe,e,i,"TestLoadImage: timeout",!1,n),T.setTimeout((function(){i.ontimeout&&i.ontimeout()}),1e4),i.src=t}else n(!1)}(e.toString(),i)}else En(2);t.u=0,t.c&&t.c.ta(n),Oi(t),hi(t)}function Oi(t){t.u=0,t.m=-1,t.c&&(0==ze(t.b).length&&0==t.f.length||(t.b.c.length=0,X(t.f),t.f.length=0),t.c.sa())}function ki(t,n,e){var i=function(t){return t instanceof ue?se(t):new ue(t,void 0)}(e);if(""!=i.b)n&&ae(i,n+"."+i.b),ce(i,i.i);else{var r=T.location;i=function(t,n,e,i){var r=new ue(null,void 0);return t&&oe(r,t),n&&ae(r,n),e&&ce(r,e),i&&(r.a=i),r}(r.protocol,n?n+"."+r.hostname:r.hostname,+r.port,e)}return t.V&&st(t.V,(function(t,n){fe(i,n,t)})),e=t.I,(n=t.j)&&e&&fe(i,n,e),fe(i,"VER",t.wa),vi(t,i),i}function ji(){}function Si(){if(vt&&!(10<=Number(kt)))throw Error("Environmental error: no available transport.")}function Ei(t,n){Kt.call(this),this.a=new ai(n),this.g=t,this.m=n&&n.testUrl?n.testUrl:function(t){for(var n=arguments[0],e=1;e<arguments.length;e++){var i,r=arguments[e];0==r.lastIndexOf("/",0)?n=r:((i=""==n)||(i=0<=(i=n.length-1)&&n.indexOf("/",i)==i),n+=i?r:"/"+r)}return n}(this.g,"test"),this.b=n&&n.messageUrlParams||null,t=n&&n.messageHeaders||null,n&&n.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.a.i=t,t=n&&n.initMessageHeaders||null,n&&n.messageContentType&&(t?t["X-WebChannel-Content-Type"]=n.messageContentType:t={"X-WebChannel-Content-Type":n.messageContentType}),n&&n.xa&&(t?t["X-WebChannel-Client-Profile"]=n.xa:t={"X-WebChannel-Client-Profile":n.xa}),this.a.J=t,(t=n&&n.httpHeadersOverwriteParam)&&!Z(t)&&(this.a.g=t),this.l=n&&n.supportsCrossDomainXhr||!1,this.h=n&&n.sendRawJson||!1,(n=n&&n.httpSessionIdParam)&&!Z(n)&&(this.a.j=n,null!==(t=this.b)&&n in t&&n in(t=this.b)&&delete t[n]),this.f=new Mi(this)}function Di(t){Rn.call(this);var n=t.__sm__;if(n){t:{for(var e in n){t=e;break t}t=void 0}(this.c=t)?(t=this.c,this.data=null!==n&&t in n?n[t]:void 0):this.data=n}else this.data=t}function Ii(){Fn.call(this),this.status=1}function Mi(t){this.a=t}(D=He.prototype).ca=function(t,n,e,i){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+t);n=n?n.toUpperCase():"GET",this.A=t,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=function(t){var n;return(n=t.a)||(n=t.a={}),n}(this.H?this.H:xn),this.a.onreadystatechange=V(this.Fa,this);try{this.w=!0,this.a.open(n,String(t),!0),this.w=!1}catch(t){return void ti(this,t)}t=e||"";var r=new te(this.headers);i&&Zn(i,(function(t,n){r.set(n,t)})),i=function(t){t:{for(var n=Ze,e=t.length,i=N(t)?t.split(""):t,r=0;r<e;r++)if(r in i&&n.call(void 0,i[r],r,t)){n=r;break t}n=-1}return 0>n?null:N(t)?t.charAt(n):t[n]}(r.K()),e=T.FormData&&t instanceof T.FormData,!(0<=H(Xe,n))||i||e||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,n){this.a.setRequestHeader(n,t)}),this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{ri(this),0<this.o&&((this.D=function(t){return vt&&St(9)&&x(t.timeout)&&void 0!==t.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=V(this.Ca,this)):this.m=vn(this.Ca,this.o,this)),this.l=!0,this.a.send(t),this.l=!1}catch(t){ti(this,t)}},D.Ca=function(){void 0!==A&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},D.abort=function(t){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),ii(this))},D.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),ii(this,!0)),He.N.G.call(this)},D.Fa=function(){this.j||(this.w||this.l||this.g?ei(this):this.$a())},D.$a=function(){ei(this)},D.T=function(){try{return 2<ui(this)?this.a.status:-1}catch(t){return-1}},D.za=function(){try{return 2<ui(this)?this.a.statusText:""}catch(t){return""}},D.aa=function(){try{return this.a?this.a.responseText:""}catch(t){return""}},D.Va=function(t){if(this.a){var n=this.a.responseText;return t&&0==n.indexOf(t)&&(n=n.substring(t.length)),Ye(n)}},D.ya=function(){return this.h},D.Ya=function(){return N(this.f)?this.f:String(this.f)},(D=ai.prototype).wa=8,D.u=1,D.Da=function(){return 0==this.u},D.Ia=function(t){if(this.h)if(this.h=null,1==this.u){if(!t){this.P=Math.floor(1e5*Math.random());var n,e=new Un(this,t=this.P++,void 0),i=this.i;if(this.J&&(i?ct(i=ot(i),this.J):i=this.J),null===this.g&&(e.h=i),this.W)t:{for(var r=n=0;r<this.f.length;r++){var u=this.f[r];if(void 0===(u="__data__"in u.a&&N(u=u.a.__data__)?u.length:void 0))break;if(4096<(n+=u)){n=r;break t}if(4096===n||r===this.f.length-1){n=r+1;break t}}n=1e3}else n=1e3;n=mi(this,e,n),fe(r=se(this.B),"RID",t),fe(r,"CVER",22),this.o&&this.j&&fe(r,"X-HTTP-Session-Id",this.j),vi(this,r),this.g&&i&&oi(r,this.g,i),qe(this.b,e),this.W?(fe(r,"$req",n),fe(r,"SID","null"),e.S=!0,Bn(e,r,null)):Bn(e,r,n),this.u=2}}else 3==this.u&&(t?di(this,t):0==this.f.length||Ue(this.b)||di(this))},D.Ha=function(){this.l=null,this.a=new Un(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var t=se(this.pa);fe(t,"RID","rpc"),fe(t,"SID",this.H),fe(t,"CI",this.ia?"0":"1"),fe(t,"AID",this.O),vi(this,t),fe(t,"TYPE","xmlhttp"),this.g&&this.i&&oi(t,this.g,this.i),this.D&&this.a.setTimeout(this.D),zn(this.a,t,!0,this.ga)},D.Ga=function(t,n){if(0!=this.u&&(this.a==t||Le(this.b,t)))if(this.m=t.o,!t.s&&Le(this.b,t)&&3==this.u){try{var e=this.ja.a.parse(n)}catch(t){e=null}if(P(e)&&3==e.length){if(0==(n=e)[0]){t:if(!this.l){if(this.a){if(!(this.a.v+3e3<t.v))break t;gi(this),this.a.cancel(),this.a=null}bi(this),En(18)}}else this.ra=n[1],0<this.ra-this.O&&37500>n[2]&&this.ia&&0==this.v&&!this.s&&(this.s=In(V(this.Za,this),6e3));if(1>=$e(this.b)&&this.fa){try{this.fa()}catch(t){}this.fa=void 0}}else _i(this,11)}else if((t.s||this.a==t)&&gi(this),!Z(n))for(n=e=this.ja.a.parse(n),e=0;e<n.length;e++){var i=n[e];if(this.O=i[0],i=i[1],2==this.u)if("c"==i[0]){this.H=i[1],this.ga=i[2];var r=i[3];null!=r&&(this.wa=r),null!=(i=i[5])&&x(i)&&0<i&&(this.D=1.5*i),this.o&&(i=t.a)&&((r=si(i,"X-Client-Wire-Protocol"))&&Pe(this.b,r),this.j&&(i=si(i,"X-HTTP-Session-Id")))&&(this.I=i,fe(this.B,this.j,i)),this.u=3,this.c&&this.c.va(),i=t,this.pa=ki(this,this.Y()?this.ga:null,this.ha),i.s?(Be(this.b,i),(r=this.D)&&i.setTimeout(r),i.i&&(Hn(i),Qn(i)),this.a=i):wi(this),0<this.f.length&&li(this)}else"stop"!=i[0]&&"close"!=i[0]||_i(this,7);else 3==this.u&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?_i(this,7):ci(this):"noop"!=i[0]&&this.c&&this.c.ua(i),this.v=0)}},D.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,bi(this),En(19))},D.na=function(t){var n=null;if(this.a==t){gi(this),this.a=null;var e=2}else{if(!Le(this.b,t))return;n=t.j,Be(this.b,t),e=1}if(this.m=t.o,0!=this.u)if(t.b)1==e?(n=G()-t.v,On.dispatchEvent(new Dn(On,t.l?t.l.length:0,n,this.A)),li(this)):wi(this);else{var i=t.c;if(3==i||0==i&&0<this.m||!(1==e&&function(t,n){return!($e(t.b)>=t.b.f-(t.h?1:0)||(t.h?(t.f=n.j.concat(t.f),0):1==t.u||2==t.u||t.A>=(t.Pa?0:t.Qa)||(t.h=In(V(t.Ia,t,n),yi(t,t.A)),t.A++,0)))}(this,t)||2==e&&bi(this)))switch(n&&0<n.length&&(t=this.b,t.c=t.c.concat(n)),i){case 1:_i(this,5);break;case 4:_i(this,10);break;case 3:_i(this,6);break;default:_i(this,2)}}},D.fb=function(t){En(t?2:1)},D.$=function(t){if(t&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new He(this.La)).F=this.R,t},D.ma=function(){return!!this.c&&!0},D.Y=function(){return this.R},(D=ji.prototype).va=function(){},D.ua=function(){},D.ta=function(){},D.sa=function(){},D.Ta=function(){},Si.prototype.a=function(t,n){return new Ei(t,n)},Q(Ei,Kt),(D=Ei.prototype).addEventListener=function(t,n,e,i){Ei.N.addEventListener.call(this,t,n,e,i)},D.removeEventListener=function(t,n,e,i){Ei.N.removeEventListener.call(this,t,n,e,i)},D.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var t=this.a,n=this.m,e=this.g,i=this.b||void 0;En(0),t.ha=e,t.V=i||{},t.o&&(t.F.b=[],t.F.a=!1),t.w=new Me(t),null===t.g&&(t.w.h=t.i),e=n,t.g&&t.i&&(e=oi(n,t.g,t.i)),(t=t.w).i=e,n=ki(t.a,null,t.i),En(3),null!=(e=t.a.F.b)?(t.f=e[0],t.M=1,Ae(t)):(le(n,"MODE","init"),!t.a.o&&t.a.j&&le(n,"X-HTTP-Session-Id",t.a.j),t.b=new Un(t,void 0,void 0),t.b.h=t.h,zn(t.b,n,!1,null),t.M=0)},D.close=function(){ci(this.a)},D.Xa=function(t){if(N(t)){var n={};n.__data__=t,fi(this.a,n)}else this.h?((n={}).__data__=Zt(t),fi(this.a,n)):fi(this.a,t)},D.G=function(){this.a.c=null,delete this.f,ci(this.a),delete this.a,Ei.N.G.call(this)},Q(Di,Rn),Q(Ii,Fn),Q(Mi,ji),Mi.prototype.va=function(){this.a.dispatchEvent("a")},Mi.prototype.ua=function(t){this.a.dispatchEvent(new Di(t))},Mi.prototype.ta=function(t){this.a.dispatchEvent(new Ii(t))},Mi.prototype.sa=function(){this.a.dispatchEvent("b")};var Ai=W((function(t,n){function e(){}e.prototype=t.prototype;var i=new e;return t.apply(i,Array.prototype.slice.call(arguments,1)),i}),Si);Si.prototype.createWebChannel=Si.prototype.a,Ei.prototype.send=Ei.prototype.Xa,Ei.prototype.open=Ei.prototype.Wa,Ei.prototype.close=Ei.prototype.close,Mn.NO_ERROR=0,Mn.TIMEOUT=8,Mn.HTTP_ERROR=6,An.COMPLETE="complete",Nn.EventType=Cn,Cn.OPEN="a",Cn.CLOSE="b",Cn.ERROR="c",Cn.MESSAGE="d",Kt.prototype.listen=Kt.prototype.Aa,He.prototype.listenOnce=He.prototype.Ba,He.prototype.getLastError=He.prototype.Ya,He.prototype.getLastErrorCode=He.prototype.ya,He.prototype.getStatus=He.prototype.T,He.prototype.getStatusText=He.prototype.za,He.prototype.getResponseJson=He.prototype.Va,He.prototype.getResponseText=He.prototype.aa,He.prototype.send=He.prototype.ca;var Ti={createWebChannelTransport:Ai,ErrorCode:Mn,EventType:An,WebChannel:Nn,XhrIo:He};h(f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});var e,i=S&&"object"==typeof S&&"default"in S?S.default:S,r=i.SDK_VERSION,u=new j.Logger("@firebase/firestore");function s(){return u.logLevel===j.LogLevel.DEBUG?e.DEBUG:u.logLevel===j.LogLevel.SILENT?e.SILENT:e.ERROR}function o(t){switch(t){case e.DEBUG:u.logLevel=j.LogLevel.DEBUG;break;case e.ERROR:u.logLevel=j.LogLevel.ERROR;break;case e.SILENT:u.logLevel=j.LogLevel.SILENT;break;default:u.error("Firestore ("+r+"): Invalid value passed to `setLogLevel`")}}function a(t,n){for(var e=[],i=2;i<arguments.length;i++)e[i-2]=arguments[i];if(u.logLevel<=j.LogLevel.DEBUG){var s=e.map(h);u.debug.apply(u,["Firestore ("+r+") ["+t+"]: "+n].concat(s))}}function c(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];if(u.logLevel<=j.LogLevel.ERROR){var i=n.map(h);u.error.apply(u,["Firestore ("+r+"): "+t].concat(i))}}function h(t){if("string"==typeof t)return t;var n=d.getPlatform();try{return n.formatJSON(t)}catch(n){return t}}function f(t){var n="FIRESTORE ("+r+") INTERNAL ASSERTION FAILED: "+t;throw c(n),new Error(n)}function l(t,n){t||f(n)}!function(t){t[t.DEBUG=0]="DEBUG",t[t.ERROR=1]="ERROR",t[t.SILENT=2]="SILENT"}(e||(e={}));var d=function(){function t(){}return t.setPlatform=function(n){t.platform&&f("Platform already defined"),t.platform=n},t.getPlatform=function(){return t.platform||f("Platform not set"),t.platform},t}();function v(){return d.getPlatform().emptyByteString}var m={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},w=function(t){function n(n,e){var i=t.call(this,e)||this;return i.code=n,i.message=e,i.name="FirebaseError",i.toString=function(){return i.name+": [code="+i.code+"]: "+i.message},i}return b.__extends(n,t),n}(Error);function g(t,n){function e(){var t="This constructor is private.";throw n&&(t+=" ",t+=n),new w(m.INVALID_ARGUMENT,t)}for(var i in e.prototype=t.prototype,t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e}function y(t,n){return Object.prototype.hasOwnProperty.call(t,n)}function _(t,n){return void 0!==t?t:n}function O(t,n){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)){var i=Number(e);isNaN(i)||n(i,t[e])}}function k(t,n){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&n(e,t[e])}function E(t){for(var n in l(null!=t&&"object"==typeof t,"isEmpty() expects object parameter."),t)if(Object.prototype.hasOwnProperty.call(t,n))return!1;return!0}function D(t,n){if(0!==n.length)throw new w(m.INVALID_ARGUMENT,"Function "+t+"() does not support arguments, but was called with "+V(n.length,"argument")+".")}function I(t,n,e){if(n.length!==e)throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires "+V(e,"argument")+", but was called with "+V(n.length,"argument")+".")}function M(t,n,e){if(n.length<e)throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires at least "+V(e,"argument")+", but was called with "+V(n.length,"argument")+".")}function A(t,n,e,i){if(n.length<e||n.length>i)throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires between "+e+" and "+i+" arguments, but was called with "+V(n.length,"argument")+".")}function T(t,n,e,i){P(t,n,z(e)+" argument",i)}function N(t,n,e,i){void 0!==i&&T(t,n,e,i)}function x(t,n,e,i){P(t,n,e+" option",i)}function C(t,n,e,i){void 0!==i&&x(t,n,e,i)}function R(t,n,e,i,r){void 0!==i&&function(t,n,e,i,r){for(var u=[],s=0,o=r;s<o.length;s++){var a=o[s];if(a===i)return;u.push($(a))}var c=$(i);throw new w(m.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+e+'". Acceptable values: '+u.join(", "))}(t,0,e,i,r)}function F(t,n,e,i){if(!n.some((function(t){return t===i})))throw new w(m.INVALID_ARGUMENT,"Invalid value "+$(i)+" provided to function "+t+"() for its "+z(e)+" argument. Acceptable values: "+n.join(", "))}function P(t,n,e,i){if(!("object"===n?U(i):"non-empty string"===n?"string"==typeof i&&""!==i:typeof i===n)){var r=$(i);throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" to be of type "+n+", but it was: "+r)}}function U(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function $(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var n=function(t){if(t.constructor){var n=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(n&&n.length>1)return n[1]}return null}(t);return n?"a custom "+n+" object":"an object"}return"function"==typeof t?"a function":f("Unknown wrong type: "+typeof t)}function L(t,n,e){if(void 0===e)throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+z(n)+" argument, but it was undefined.")}function q(t,n,e){k(n,(function(n){if(e.indexOf(n)<0)throw new w(m.INVALID_ARGUMENT,"Unknown option '"+n+"' passed to function "+t+"(). Available options: "+e.join(", "))}))}function B(t,n,e,i){var r=$(i);return new w(m.INVALID_ARGUMENT,"Function "+t+"() requires its "+z(e)+" argument to be a "+n+", but it was: "+r)}function z(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function V(t,n){return t+" "+n+(1===t?"":"s")}var W=function(){function t(){}return t.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",e=0;e<20;e++)n+=t.charAt(Math.floor(Math.random()*t.length));return l(20===n.length,"Invalid auto ID: "+n),n},t}();function G(t,n){return t<n?-1:t>n?1:0}function Q(t,n){if(t.length!==n.length)return!1;for(var e=0;e<t.length;e++)if(!t[e].isEqual(n[e]))return!1;return!0}function Y(t){return t+"\0"}function H(){if("undefined"==typeof Uint8Array)throw new w(m.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function J(){if(!d.getPlatform().base64Available)throw new w(m.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var K,X=function(){function t(t){J(),this._binaryString=t}return t.fromBase64String=function(n){I("Blob.fromBase64String",arguments,1),T("Blob.fromBase64String","string",1,n),J();try{var e=d.getPlatform().atob(n);return new t(e)}catch(t){throw new w(m.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},t.fromUint8Array=function(n){if(I("Blob.fromUint8Array",arguments,1),H(),!(n instanceof Uint8Array))throw B("Blob.fromUint8Array","Uint8Array",1,n);var e=Array.prototype.map.call(n,(function(t){return String.fromCharCode(t)})).join("");return new t(e)},t.prototype.toBase64=function(){return I("Blob.toBase64",arguments,0),J(),d.getPlatform().btoa(this._binaryString)},t.prototype.toUint8Array=function(){I("Blob.toUint8Array",arguments,0),H();for(var t=new Uint8Array(this._binaryString.length),n=0;n<this._binaryString.length;n++)t[n]=this._binaryString.charCodeAt(n);return t},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this._binaryString===t._binaryString},t.prototype._compareTo=function(t){return G(this._binaryString,t._binaryString)},t}(),Z=g(X,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),tt=function(t,n,e,i,r){this.databaseId=t,this.persistenceKey=n,this.host=e,this.ssl=i,this.forceLongPolling=r},nt="(default)",et=function(){function t(t,n){this.projectId=t,this.database=n||nt}return Object.defineProperty(t.prototype,"isDefaultDatabase",{get:function(){return this.database===nt},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(n){return n instanceof t&&n.projectId===this.projectId&&n.database===this.database},t.prototype.compareTo=function(t){return G(this.projectId,t.projectId)||G(this.database,t.database)},t}(),it=function(){function t(t,n){var e=this;this.previousValue=t,n&&(n.sequenceNumberHandler=function(t){return e.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return n.writeSequenceNumber(t)})}return t.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},t.INVALID=-1,t}(),rt=function(){function t(t,n,e){void 0===n?n=0:n>t.length&&f("offset "+n+" out of range "+t.length),void 0===e?e=t.length-n:e>t.length-n&&f("length "+e+" out of range "+(t.length-n)),this.segments=t,this.offset=n,this.len=e}return Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(n){return 0===t.comparator(this,n)},t.prototype.child=function(n){var e=this.segments.slice(this.offset,this.limit());return n instanceof t?n.forEach((function(t){e.push(t)})):e.push(n),this.construct(e)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.popFirst=function(t){return l(this.length>=(t=void 0===t?1:t),"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},t.prototype.popLast=function(){return l(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},t.prototype.firstSegment=function(){return l(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},t.prototype.lastSegment=function(){return this.get(this.length-1)},t.prototype.get=function(t){return l(t<this.length,"Index out of range"),this.segments[this.offset+t]},t.prototype.isEmpty=function(){return 0===this.length},t.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var n=0;n<this.length;n++)if(this.get(n)!==t.get(n))return!1;return!0},t.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var n=0;n<this.length;n++)if(this.get(n)!==t.get(n))return!1;return!0},t.prototype.forEach=function(t){for(var n=this.offset,e=this.limit();n<e;n++)t(this.segments[n])},t.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},t.comparator=function(t,n){for(var e=Math.min(t.length,n.length),i=0;i<e;i++){var r=t.get(i),u=n.get(i);if(r<u)return-1;if(r>u)return 1}return t.length<n.length?-1:t.length>n.length?1:0},t}(),ut=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.construct=function(t,e,i){return new n(t,e,i)},n.prototype.canonicalString=function(){return this.toArray().join("/")},n.prototype.toString=function(){return this.canonicalString()},n.fromString=function(t){if(t.indexOf("//")>=0)throw new w(m.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new n(t.split("/").filter((function(t){return t.length>0})))},n.EMPTY_PATH=new n([]),n}(rt),st=/^[_a-zA-Z][_a-zA-Z0-9]*$/,ot=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.construct=function(t,e,i){return new n(t,e,i)},n.isValidIdentifier=function(t){return st.test(t)},n.prototype.canonicalString=function(){return this.toArray().map((function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),n.isValidIdentifier(t)||(t="`"+t+"`"),t})).join(".")},n.prototype.toString=function(){return this.canonicalString()},n.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},n.keyField=function(){return new n(["__name__"])},n.fromServerFormat=function(t){for(var e=[],i="",r=0,u=function(){if(0===i.length)throw new w(m.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");e.push(i),i=""},s=!1;r<t.length;){var o=t[r];if("\\"===o){if(r+1===t.length)throw new w(m.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var a=t[r+1];if("\\"!==a&&"."!==a&&"`"!==a)throw new w(m.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);i+=a,r+=2}else"`"===o?(s=!s,r++):"."!==o||s?(i+=o,r++):(u(),r++)}if(u(),s)throw new w(m.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new n(e)},n.EMPTY_PATH=new n([]),n}(rt),at=function(){function t(n){this.path=n,l(t.isDocumentKey(n),"Invalid DocumentKey with an odd number of segments: "+n.toArray().join("/"))}return t.prototype.hasCollectionId=function(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t},t.prototype.isEqual=function(t){return null!==t&&0===ut.comparator(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.comparator=function(t,n){return ut.comparator(t.path,n.path)},t.isDocumentKey=function(t){return t.length%2==0},t.fromSegments=function(n){return new t(new ut(n.slice()))},t.fromPathString=function(n){return new t(ut.fromString(n))},t.EMPTY=new t(new ut([])),t}(),ct=function(){var t=this;this.promise=new Promise((function(n,e){t.resolve=n,t.reject=e}))};!function(t){t.All="all",t.ListenStreamIdle="listen_stream_idle",t.ListenStreamConnectionBackoff="listen_stream_connection_backoff",t.WriteStreamIdle="write_stream_idle",t.WriteStreamConnectionBackoff="write_stream_connection_backoff",t.OnlineStateTimeout="online_state_timeout",t.ClientMetadataRefresh="client_metadata_refresh",t.LruGarbageCollection="lru_garbage_collection",t.RetryTransaction="retry_transaction"}(K||(K={}));var ht=function(){function t(t,n,e,i,r){this.asyncQueue=t,this.timerId=n,this.targetTimeMs=e,this.op=i,this.removalCallback=r,this.deferred=new ct,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch((function(){}))}return t.createAndSchedule=function(n,e,i,r,u){var s=new t(n,e,Date.now()+i,r,u);return s.start(i),s},t.prototype.start=function(t){var n=this;this.timerHandle=setTimeout((function(){return n.handleDelayElapsed()}),t)},t.prototype.skipDelay=function(){return this.handleDelayElapsed()},t.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new w(m.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget((function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then((function(n){return t.deferred.resolve(n)}))):Promise.resolve()}))},t.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},t}(),ft=function(){function t(){this.tail=Promise.resolve(),this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[]}return Object.defineProperty(t.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!0,configurable:!0}),t.prototype.enqueueAndForget=function(t){this.enqueue(t)},t.prototype.enqueueAndForgetEvenAfterShutdown=function(t){this.verifyNotFailed(),this.enqueueInternal(t)},t.prototype.enqueueEvenAfterShutdown=function(t){return this.verifyNotFailed(),this.enqueueInternal(t)},t.prototype.enqueueAndInitiateShutdown=function(t){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(n){switch(n.label){case 0:return this.verifyNotFailed(),this._isShuttingDown?[3,2]:(this._isShuttingDown=!0,[4,this.enqueueEvenAfterShutdown(t)]);case 1:n.sent(),n.label=2;case 2:return[2]}}))}))},t.prototype.enqueue=function(t){return this.verifyNotFailed(),this._isShuttingDown?new Promise((function(){})):this.enqueueInternal(t)},t.prototype.enqueueInternal=function(t){var n=this,e=this.tail.then((function(){return n.operationInProgress=!0,t().catch((function(t){n.failure=t,n.operationInProgress=!1;var e=t.stack||t.message||"";throw c("INTERNAL UNHANDLED ERROR: ",e),e.indexOf("Firestore Test Simulated Error")<0&&setTimeout((function(){throw t}),0),t})).then((function(t){return n.operationInProgress=!1,t}))}));return this.tail=e,e},t.prototype.enqueueAfterDelay=function(t,n,e){var i=this;this.verifyNotFailed(),l(n>=0,"Attempted to schedule an operation with a negative delay of "+n),this.timerIdsToSkip.indexOf(t)>-1&&(n=0);var r=ht.createAndSchedule(this,t,n,e,(function(t){return i.removeDelayedOperation(t)}));return this.delayedOperations.push(r),r},t.prototype.verifyNotFailed=function(){this.failure&&f("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},t.prototype.verifyOperationInProgress=function(){l(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},t.prototype.drain=function(){return this.enqueueEvenAfterShutdown((function(){return Promise.resolve()}))},t.prototype.containsDelayedOperation=function(t){for(var n=0,e=this.delayedOperations;n<e.length;n++)if(e[n].timerId===t)return!0;return!1},t.prototype.runDelayedOperationsEarly=function(t){var n=this;return this.drain().then((function(){l(t===K.All||n.containsDelayedOperation(t),"Attempted to drain to missing operation "+t),n.delayedOperations.sort((function(t,n){return t.targetTimeMs-n.targetTimeMs}));for(var e=0,i=n.delayedOperations;e<i.length;e++){var r=i[e];if(r.skipDelay(),t!==K.All&&r.timerId===t)break}return n.drain()}))},t.prototype.skipDelaysForTimerId=function(t){this.timerIdsToSkip.push(t)},t.prototype.removeDelayedOperation=function(t){var n=this.delayedOperations.indexOf(t);l(n>=0,"Delayed operation not found."),this.delayedOperations.splice(n,1)},t}(),lt="",dt="",vt="",mt="";function wt(t){for(var n="",e=0;e<t.length;e++)n.length>0&&(n=pt(n)),n=bt(t.get(e),n);return pt(n)}function bt(t,n){for(var e=n,i=t.length,r=0;r<i;r++){var u=t.charAt(r);switch(u){case"\0":e+=lt+vt;break;case lt:e+=lt+mt;break;default:e+=u}}return e}function pt(t){return t+lt+dt}function gt(t){var n=t.length;if(l(n>=2,"Invalid path "+t),2===n)return l(t.charAt(0)===lt&&t.charAt(1)===dt,"Non-empty path "+t+" had length 2"),ut.EMPTY_PATH;for(var e=n-2,i=[],r="",u=0;u<n;){var s=t.indexOf(lt,u);switch((s<0||s>e)&&f('Invalid encoded resource path: "'+t+'"'),t.charAt(s+1)){case dt:var o=t.substring(u,s),a=void 0;0===r.length?a=o:(a=r+=o,r=""),i.push(a);break;case vt:r+=t.substring(u,s),r+="\0";break;case mt:r+=t.substring(u,s+1);break;default:f('Invalid encoded resource path: "'+t+'"')}u=s+2}return new ut(i)}var yt=function(){function t(t,n){if(this.seconds=t,this.nanoseconds=n,n<0)throw new w(m.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+n);if(n>=1e9)throw new w(m.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+n);if(t<-62135596800)throw new w(m.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new w(m.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(n){return t.fromMillis(n.getTime())},t.fromMillis=function(n){var e=Math.floor(n/1e3);return new t(e,1e6*(n-1e3*e))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype._compareTo=function(t){return this.seconds===t.seconds?G(this.nanoseconds,t.nanoseconds):G(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t}(),_t=function(){function t(t){this.timestamp=t}return t.fromMicroseconds=function(n){var e=Math.floor(n/1e6);return new t(new yt(e,n%1e6*1e3))},t.fromTimestamp=function(n){return new t(n)},t.forDeletedDoc=function(){return t.MIN},t.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.toTimestamp=function(){return this.timestamp},t.MIN=new t(new yt(0,0)),t}(),Ot=function(){function t(t,n){this.comparator=t,this.root=n||jt.EMPTY}return t.prototype.insert=function(n,e){return new t(this.comparator,this.root.insert(n,e,this.comparator).copy(null,null,jt.BLACK,null,null))},t.prototype.remove=function(n){return new t(this.comparator,this.root.remove(n,this.comparator).copy(null,null,jt.BLACK,null,null))},t.prototype.get=function(t){for(var n=this.root;!n.isEmpty();){var e=this.comparator(t,n.key);if(0===e)return n.value;e<0?n=n.left:e>0&&(n=n.right)}return null},t.prototype.indexOf=function(t){for(var n=0,e=this.root;!e.isEmpty();){var i=this.comparator(t,e.key);if(0===i)return n+e.left.size;i<0?e=e.left:(n+=e.left.size+1,e=e.right)}return-1},t.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),t.prototype.minKey=function(){return this.root.minKey()},t.prototype.maxKey=function(){return this.root.maxKey()},t.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},t.prototype.forEach=function(t){this.inorderTraversal((function(n,e){return t(n,e),!1}))},t.prototype.toString=function(){var t=[];return this.inorderTraversal((function(n,e){return t.push(n+":"+e),!1})),"{"+t.join(", ")+"}"},t.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},t.prototype.getIterator=function(){return new kt(this.root,null,this.comparator,!1)},t.prototype.getIteratorFrom=function(t){return new kt(this.root,t,this.comparator,!1)},t.prototype.getReverseIterator=function(){return new kt(this.root,null,this.comparator,!0)},t.prototype.getReverseIteratorFrom=function(t){return new kt(this.root,t,this.comparator,!0)},t}(),kt=function(){function t(t,n,e,i){this.isReverse=i,this.nodeStack=[];for(var r=1;!t.isEmpty();)if(r=n?e(t.key,n):1,i&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return t.prototype.getNext=function(){l(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),n={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return n},t.prototype.hasNext=function(){return this.nodeStack.length>0},t.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},t}(),jt=function(){function t(n,e,i,r,u){this.key=n,this.value=e,this.color=null!=i?i:t.RED,this.left=null!=r?r:t.EMPTY,this.right=null!=u?u:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(n,e,i,r,u){return new t(null!=n?n:this.key,null!=e?e:this.value,null!=i?i:this.color,null!=r?r:this.left,null!=u?u:this.right)},t.prototype.isEmpty=function(){return!1},t.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},t.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},t.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},t.prototype.minKey=function(){return this.min().key},t.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},t.prototype.insert=function(t,n,e){var i=this,r=e(t,i.key);return(i=r<0?i.copy(null,null,null,i.left.insert(t,n,e),null):0===r?i.copy(null,n,null,null,null):i.copy(null,null,null,null,i.right.insert(t,n,e))).fixUp()},t.prototype.removeMin=function(){if(this.left.isEmpty())return t.EMPTY;var n=this;return n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),(n=n.copy(null,null,null,n.left.removeMin(),null)).fixUp()},t.prototype.remove=function(n,e){var i,r=this;if(e(n,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(n,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(n,r.key)){if(r.right.isEmpty())return t.EMPTY;i=r.right.min(),r=r.copy(i.key,i.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(n,e))}return r.fixUp()},t.prototype.isRed=function(){return this.color},t.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},t.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},t.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},t.prototype.rotateLeft=function(){var n=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,n,null)},t.prototype.rotateRight=function(){var n=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,n)},t.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),n=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,n)},t.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},t.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw f("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw f("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw f("Black depths differ");return t+(this.isRed()?0:1)},t.EMPTY=null,t.RED=!0,t.BLACK=!1,t}(),St=function(){function t(){this.size=0}return Object.defineProperty(t.prototype,"key",{get:function(){throw f("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){throw f("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){throw f("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"left",{get:function(){throw f("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){throw f("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),t.prototype.copy=function(){return this},t.prototype.insert=function(t,n){return new jt(t,n)},t.prototype.remove=function(){return this},t.prototype.isEmpty=function(){return!0},t.prototype.inorderTraversal=function(){return!1},t.prototype.reverseTraversal=function(){return!1},t.prototype.minKey=function(){return null},t.prototype.maxKey=function(){return null},t.prototype.isRed=function(){return!1},t.prototype.checkMaxDepth=function(){return!0},t.prototype.check=function(){return 0},t}();jt.EMPTY=new St;var Et=function(){function t(t){this.comparator=t,this.data=new Ot(this.comparator)}return t.fromMapKeys=function(n){var e=new t(n.comparator);return n.forEach((function(t){e=e.add(t)})),e},t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.minKey()},t.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.inorderTraversal((function(n){return t(n),!1}))},t.prototype.forEachInRange=function(t,n){for(var e=this.data.getIteratorFrom(t[0]);e.hasNext();){var i=e.getNext();if(this.comparator(i.key,t[1])>=0)return;n(i.key)}},t.prototype.forEachWhile=function(t,n){var e;for(e=void 0!==n?this.data.getIteratorFrom(n):this.data.getIterator();e.hasNext();)if(!t(e.getNext().key))return},t.prototype.firstAfterOrEqual=function(t){var n=this.data.getIteratorFrom(t);return n.hasNext()?n.getNext().key:null},t.prototype.getIterator=function(){return new Dt(this.data.getIterator())},t.prototype.getIteratorFrom=function(t){return new Dt(this.data.getIteratorFrom(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.isEmpty=function(){return this.data.isEmpty()},t.prototype.unionWith=function(t){var n=this;return t.forEach((function(t){n=n.add(t)})),n},t.prototype.isEqual=function(n){if(!(n instanceof t))return!1;if(this.size!==n.size)return!1;for(var e=this.data.getIterator(),i=n.data.getIterator();e.hasNext();){var r=e.getNext().key,u=i.getNext().key;if(0!==this.comparator(r,u))return!1}return!0},t.prototype.toArray=function(){var t=[];return this.forEach((function(n){t.push(n)})),t},t.prototype.toString=function(){var t=[];return this.forEach((function(n){return t.push(n)})),"SortedSet("+t.toString()+")"},t.prototype.copy=function(n){var e=new t(this.comparator);return e.data=n,e},t}(),Dt=function(){function t(t){this.iter=t}return t.prototype.getNext=function(){return this.iter.getNext().key},t.prototype.hasNext=function(){return this.iter.hasNext()},t}(),It=new Ot(at.comparator);function Mt(){return It}function At(){return Mt()}var Tt=new Ot(at.comparator);function Nt(){return Tt}var xt=new Ot(at.comparator);function Ct(){return xt}var Rt=new Et(at.comparator);function Ft(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];for(var e=Rt,i=0,r=t;i<r.length;i++)e=e.add(r[i]);return e}var Pt=new Et(G);function Ut(){return Pt}var $t=function(){function t(t,n,e,i){this.batchId=t,this.localWriteTime=n,this.baseMutations=e,this.mutations=i,l(i.length>0,"Cannot create an empty mutation batch")}return t.prototype.applyToRemoteDocument=function(t,n,e){n&&l(n.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+n.key);var i=e.mutationResults;l(i.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+i.length+").");for(var r=0;r<this.mutations.length;r++){var u=this.mutations[r];u.key.isEqual(t)&&(n=u.applyToRemoteDocument(n,i[r]))}return n},t.prototype.applyToLocalView=function(t,n){n&&l(n.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+n.key);for(var e=0,i=this.baseMutations;e<i.length;e++)(o=i[e]).key.isEqual(t)&&(n=o.applyToLocalView(n,n,this.localWriteTime));for(var r=n,u=0,s=this.mutations;u<s.length;u++){var o;(o=s[u]).key.isEqual(t)&&(n=o.applyToLocalView(n,r,this.localWriteTime))}return n},t.prototype.applyToLocalDocumentSet=function(t){var n=this,e=t;return this.mutations.forEach((function(i){var r=n.applyToLocalView(i.key,t.get(i.key));r&&(e=e.insert(i.key,r))})),e},t.prototype.keys=function(){return this.mutations.reduce((function(t,n){return t.add(n.key)}),Ft())},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&Q(this.mutations,t.mutations)&&Q(this.baseMutations,t.baseMutations)},t}(),Lt=function(){function t(t,n,e,i,r){this.batch=t,this.commitVersion=n,this.mutationResults=e,this.streamToken=i,this.docVersions=r}return t.from=function(n,e,i,r){l(n.mutations.length===i.length,"Mutations sent "+n.mutations.length+" must equal results received "+i.length);for(var u=Ct(),s=n.mutations,o=0;o<s.length;o++)u=u.insert(s[o].key,i[o].version);return new t(n,e,i,r,u)},t}(),qt=function(){function t(t){var n=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((function(t){n.isDone=!0,n.result=t,n.nextCallback&&n.nextCallback(t)}),(function(t){n.isDone=!0,n.error=t,n.catchCallback&&n.catchCallback(t)}))}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(n,e){var i=this;return this.callbackAttached&&f("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(n,this.result):new t((function(t,r){i.nextCallback=function(e){i.wrapSuccess(n,e).next(t,r)},i.catchCallback=function(n){i.wrapFailure(e,n).next(t,r)}}))},t.prototype.toPromise=function(){var t=this;return new Promise((function(n,e){t.next(n,e)}))},t.prototype.wrapUserFunction=function(n){try{var e=n();return e instanceof t?e:t.resolve(e)}catch(n){return t.reject(n)}},t.prototype.wrapSuccess=function(n,e){return n?this.wrapUserFunction((function(){return n(e)})):t.resolve(e)},t.prototype.wrapFailure=function(n,e){return n?this.wrapUserFunction((function(){return n(e)})):t.reject(e)},t.resolve=function(n){return new t((function(t){t(n)}))},t.reject=function(n){return new t((function(t,e){e(n)}))},t.waitFor=function(n){return new t((function(t,e){var i=0,r=0,u=!1;n.forEach((function(n){++i,n.next((function(){++r,u&&r===i&&t()}),(function(t){return e(t)}))})),u=!0,r===i&&t()}))},t.or=function(n){for(var e=t.resolve(!1),i=function(n){e=e.next((function(e){return e?t.resolve(e):n()}))},r=0,u=n;r<u.length;r++)i(u[r]);return e},t.forEach=function(t,n){var e=this,i=[];return t.forEach((function(t,r){i.push(n.call(e,t,r))})),this.waitFor(i)},t}(),Bt=function(){function t(t,n,e,i){this.userId=t,this.serializer=n,this.indexManager=e,this.referenceDelegate=i,this.documentKeysByBatchId={}}return t.forUser=function(n,e,i,r){return l(""!==n.uid,"UserID must not be an empty string."),new t(n.isAuthenticated()?n.uid:"",e,i,r)},t.prototype.checkEmpty=function(t){var n=!0,e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Gt(t).iterate({index:se.userMutationsIndex,range:e},(function(t,e,i){n=!1,i.done()})).next((function(){return n}))},t.prototype.acknowledgeBatch=function(t,n,e){return this.getMutationQueueMetadata(t).next((function(n){return n.lastStreamToken=Wt(e),Yt(t).put(n)}))},t.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next((function(t){return t.lastStreamToken}))},t.prototype.setLastStreamToken=function(t,n){return this.getMutationQueueMetadata(t).next((function(e){return e.lastStreamToken=Wt(n),Yt(t).put(e)}))},t.prototype.addMutationBatch=function(t,n,e,i){var r=this,u=Qt(t),s=Gt(t);return s.add({}).next((function(o){l("number"==typeof o,"Auto-generated key is not a number");var a=new $t(o,n,e,i),c=r.serializer.toDbMutationBatch(r.userId,a);r.documentKeysByBatchId[o]=a.keys();for(var h=[],f=0,d=i;f<d.length;f++){var v=d[f],m=oe.key(r.userId,v.key.path,o);h.push(s.put(c)),h.push(u.put(m,oe.PLACEHOLDER)),h.push(r.indexManager.addToCollectionParentIndex(t,v.key.path.popLast()))}return qt.waitFor(h).next((function(){return a}))}))},t.prototype.lookupMutationBatch=function(t,n){var e=this;return Gt(t).get(n).next((function(t){return t?(l(t.userId===e.userId,"Unexpected user '"+t.userId+"' for mutation batch "+n),e.serializer.fromDbMutationBatch(t)):null}))},t.prototype.lookupMutationKeys=function(t,n){var e=this;return this.documentKeysByBatchId[n]?qt.resolve(this.documentKeysByBatchId[n]):this.lookupMutationBatch(t,n).next((function(t){if(t){var i=t.keys();return e.documentKeysByBatchId[n]=i,i}return null}))},t.prototype.getNextMutationBatchAfterBatchId=function(t,n){var e=this,i=n+1,r=IDBKeyRange.lowerBound([this.userId,i]),u=null;return Gt(t).iterate({index:se.userMutationsIndex,range:r},(function(t,n,r){n.userId===e.userId&&(l(n.batchId>=i,"Should have found mutation after "+i),u=e.serializer.fromDbMutationBatch(n)),r.done()})).next((function(){return u}))},t.prototype.getHighestUnacknowledgedBatchId=function(t){var n=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),e=-1;return Gt(t).iterate({index:se.userMutationsIndex,range:n,reverse:!0},(function(t,n,i){e=n.batchId,i.done()})).next((function(){return e}))},t.prototype.getAllMutationBatches=function(t){var n=this,e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Gt(t).loadAll(se.userMutationsIndex,e).next((function(t){return t.map((function(t){return n.serializer.fromDbMutationBatch(t)}))}))},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,n){var e=this,i=oe.prefixForPath(this.userId,n.path),r=IDBKeyRange.lowerBound(i),u=[];return Qt(t).iterate({range:r},(function(i,r,s){var o=i[0],a=i[2],c=gt(i[1]);if(o===e.userId&&n.path.isEqual(c))return Gt(t).get(a).next((function(t){if(!t)throw f("Dangling document-mutation reference found: "+i+" which points to "+a);l(t.userId===e.userId,"Unexpected user '"+t.userId+"' for mutation batch "+a),u.push(e.serializer.fromDbMutationBatch(t))}));s.done()})).next((function(){return u}))},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,n){var e=this,i=new Et(G),r=[];return n.forEach((function(n){var u=oe.prefixForPath(e.userId,n.path),s=IDBKeyRange.lowerBound(u),o=Qt(t).iterate({range:s},(function(t,r,u){var s=t[0],o=t[2],a=gt(t[1]);s===e.userId&&n.path.isEqual(a)?i=i.add(o):u.done()}));r.push(o)})),qt.waitFor(r).next((function(){return e.lookupMutationBatches(t,i)}))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,n){var e=this;l(!n.isDocumentQuery(),"Document queries shouldn't go down this path"),l(!n.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var i=n.path,r=i.length+1,u=oe.prefixForPath(this.userId,i),s=IDBKeyRange.lowerBound(u),o=new Et(G);return Qt(t).iterate({range:s},(function(t,n,u){var s=t[0],a=t[2],c=gt(t[1]);s===e.userId&&i.isPrefixOf(c)?c.length===r&&(o=o.add(a)):u.done()})).next((function(){return e.lookupMutationBatches(t,o)}))},t.prototype.lookupMutationBatches=function(t,n){var e=this,i=[],r=[];return n.forEach((function(n){r.push(Gt(t).get(n).next((function(t){if(null===t)throw f("Dangling document-mutation reference found, which points to "+n);l(t.userId===e.userId,"Unexpected user '"+t.userId+"' for mutation batch "+n),i.push(e.serializer.fromDbMutationBatch(t))})))})),qt.waitFor(r).next((function(){return i}))},t.prototype.removeMutationBatch=function(t,n){var e=this;return Vt(t.simpleDbTransaction,this.userId,n).next((function(i){return e.removeCachedMutationKeys(n.batchId),qt.forEach(i,(function(n){return e.referenceDelegate.removeMutationReference(t,n)}))}))},t.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},t.prototype.performConsistencyCheck=function(t){var n=this;return this.checkEmpty(t).next((function(e){if(!e)return qt.resolve();var i=IDBKeyRange.lowerBound(oe.prefixForUser(n.userId)),r=[];return Qt(t).iterate({range:i},(function(t,e,i){if(t[0]===n.userId){var u=gt(t[1]);r.push(u)}else i.done()})).next((function(){l(0===r.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+r.map((function(t){return t.canonicalString()})))}))}))},t.prototype.containsKey=function(t,n){return zt(t,this.userId,n)},t.prototype.getMutationQueueMetadata=function(t){var n=this;return Yt(t).get(this.userId).next((function(t){return t||new ue(n.userId,-1,"")}))},t}();function zt(t,n,e){var i=oe.prefixForPath(n,e.path),r=i[1],u=IDBKeyRange.lowerBound(i),s=!1;return Qt(t).iterate({range:u,keysOnly:!0},(function(t,e,i){t[0]===n&&t[1]===r&&(s=!0),i.done()})).next((function(){return s}))}function Vt(t,n,e){var i=t.store(se.store),r=t.store(oe.store),u=[],s=IDBKeyRange.only(e.batchId),o=0,a=i.iterate({range:s},(function(t,n,e){return o++,e.delete()}));u.push(a.next((function(){l(1===o,"Dangling document-mutation reference found: Missing batch "+e.batchId)})));for(var c=[],h=0,f=e.mutations;h<f.length;h++){var d=f[h],v=oe.key(n,d.key.path,e.batchId);u.push(r.delete(v)),c.push(d.key)}return qt.waitFor(u).next((function(){return c}))}function Wt(t){return t instanceof Uint8Array?(l("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function Gt(t){return Re.getStore(t,se.store)}function Qt(t){return Re.getStore(t,oe.store)}function Yt(t){return Re.getStore(t,ue.store)}var Ht,Jt=1;!function(t){t[t.QueryCache=0]="QueryCache",t[t.SyncEngine=1]="SyncEngine"}(Ht||(Ht={}));var Kt=function(){function t(t,n){this.generatorId=t,l((t&Jt)===t,"Generator ID "+t+" contains more than "+Jt+" reserved bits"),this.seek(void 0!==n?n:this.generatorId)}return t.prototype.next=function(){var t=this.nextId;return this.nextId+=1<<Jt,t},t.prototype.after=function(t){return this.seek(t+(1<<Jt)),this.next()},t.prototype.seek=function(t){l((t&Jt)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},t.forQueryCache=function(){return new t(Ht.QueryCache,2)},t.forSyncEngine=function(){return new t(Ht.SyncEngine)},t}(),Xt="SimpleDb",Zt=function(){function t(n){this.db=n,12.2===t.getIOSVersion(p.getUA())&&c("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return t.openOrCreate=function(n,e,i){return l(t.isAvailable(),"IndexedDB not supported in current environment."),a(Xt,"Opening database:",n),new qt((function(r,u){var s=window.indexedDB.open(n,e);s.onsuccess=function(n){r(new t(n.target.result))},s.onblocked=function(){u(new w(m.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=function(t){var n=t.target.error;u("VersionError"===n.name?new w(m.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh."):n)},s.onupgradeneeded=function(t){a(Xt,'Database "'+n+'" requires upgrade from version:',t.oldVersion);var e=t.target.result,r=new nn(s.transaction);i.createOrUpgrade(e,r,t.oldVersion,ne).next((function(){a(Xt,"Database upgrade to version "+ne+" complete")}))}})).toPromise()},t.delete=function(t){return a(Xt,"Removing database:",t),rn(window.indexedDB.deleteDatabase(t)).toPromise()},t.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var n=p.getUA(),e=t.getIOSVersion(n),i=0<e&&e<10,r=t.getAndroidVersion(n),u=0<r&&r<4.5;return!(n.indexOf("MSIE ")>0||n.indexOf("Trident/")>0||n.indexOf("Edge/")>0||i||u)},t.getStore=function(t,n){return t.store(n)},t.getIOSVersion=function(t){var n=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),e=n?n[1].split("_").slice(0,2).join("."):"-1";return Number(e)},t.getAndroidVersion=function(t){var n=t.match(/Android ([\d.]+)/i),e=n?n[1].split(".").slice(0,2).join("."):"-1";return Number(e)},t.prototype.setVersionChangeListener=function(t){this.db.onversionchange=function(n){return t(n)}},t.prototype.runTransaction=function(t,n,e){var i=nn.open(this.db,t,n),r=e(i).catch((function(t){return i.abort(t),qt.reject(t)})).toPromise();return r.catch((function(){})),i.completionPromise.then((function(){return r}))},t.prototype.close=function(){this.db.close()},t}(),tn=function(){function t(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(t.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),t.prototype.done=function(){this.shouldStop=!0},t.prototype.skip=function(t){this.nextKey=t},t.prototype.delete=function(){return rn(this.dbCursor.delete())},t}(),nn=function(){function t(t){var n=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new ct,this.transaction.oncomplete=function(){n.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?n.completionDeferred.reject(t.error):n.completionDeferred.resolve()},this.transaction.onerror=function(t){var e=sn(t.target.error);n.completionDeferred.reject(e)}}return t.open=function(n,e,i){return new t(n.transaction(i,e))},Object.defineProperty(t.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),t.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(a(Xt,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var n=this.transaction.objectStore(t);return l(!!n,"Object store not part of transaction: "+t),new en(n)},t}(),en=function(){function t(t){this.store=t}return t.prototype.put=function(t,n){var e;return void 0!==n?(a(Xt,"PUT",this.store.name,t,n),e=this.store.put(n,t)):(a(Xt,"PUT",this.store.name,"<auto-key>",t),e=this.store.put(t)),rn(e)},t.prototype.add=function(t){return a(Xt,"ADD",this.store.name,t,t),rn(this.store.add(t))},t.prototype.get=function(t){var n=this;return rn(this.store.get(t)).next((function(e){return void 0===e&&(e=null),a(Xt,"GET",n.store.name,t,e),e}))},t.prototype.delete=function(t){return a(Xt,"DELETE",this.store.name,t),rn(this.store.delete(t))},t.prototype.count=function(){return a(Xt,"COUNT",this.store.name),rn(this.store.count())},t.prototype.loadAll=function(t,n){var e=this.cursor(this.options(t,n)),i=[];return this.iterateCursor(e,(function(t,n){i.push(n)})).next((function(){return i}))},t.prototype.deleteAll=function(t,n){a(Xt,"DELETE ALL",this.store.name);var e=this.options(t,n);e.keysOnly=!1;var i=this.cursor(e);return this.iterateCursor(i,(function(t,n,e){return e.delete()}))},t.prototype.iterate=function(t,n){var e;n?e=t:(e={},n=t);var i=this.cursor(e);return this.iterateCursor(i,n)},t.prototype.iterateSerial=function(t){var n=this.cursor({});return new qt((function(e,i){n.onerror=function(t){var n=sn(t.target.error);i(n)},n.onsuccess=function(n){var i=n.target.result;i?t(i.primaryKey,i.value).next((function(t){t?i.continue():e()})):e()}}))},t.prototype.iterateCursor=function(t,n){var e=[];return new qt((function(i,r){t.onerror=function(t){r(t.target.error)},t.onsuccess=function(t){var r=t.target.result;if(r){var u=new tn(r),s=n(r.primaryKey,r.value,u);if(s instanceof qt){var o=s.catch((function(t){return u.done(),qt.reject(t)}));e.push(o)}u.isDone?i():null===u.skipToKey?r.continue():r.continue(u.skipToKey)}else i()}})).next((function(){return qt.waitFor(e)}))},t.prototype.options=function(t,n){var e=void 0;return void 0!==t&&("string"==typeof t?e=t:(l(void 0===n,"3rd argument must not be defined if 2nd is a range."),n=t)),{index:e,range:n}},t.prototype.cursor=function(t){var n="next";if(t.reverse&&(n="prev"),t.index){var e=this.store.index(t.index);return t.keysOnly?e.openKeyCursor(t.range,n):e.openCursor(t.range,n)}return this.store.openCursor(t.range,n)},t}();function rn(t){return new qt((function(n,e){t.onsuccess=function(t){n(t.target.result)},t.onerror=function(t){var n=sn(t.target.error);e(n)}}))}var un=!1;function sn(t){var n=Zt.getIOSVersion(p.getUA());if(n>=12.2&&n<13){var e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){var i=new w("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+e+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return un||(un=!0,setTimeout((function(){throw i}),0)),i}}return t}var on=function(){function t(t,n){this.referenceDelegate=t,this.serializer=n,this.targetIdGenerator=Kt.forQueryCache()}return t.prototype.allocateTargetId=function(t){var n=this;return this.retrieveMetadata(t).next((function(e){return e.highestTargetId=n.targetIdGenerator.after(e.highestTargetId),n.saveMetadata(t,e).next((function(){return e.highestTargetId}))}))},t.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next((function(t){return _t.fromTimestamp(new yt(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))}))},t.prototype.getHighestSequenceNumber=function(t){return hn(t.simpleDbTransaction)},t.prototype.setTargetsMetadata=function(t,n,e){var i=this;return this.retrieveMetadata(t).next((function(r){return r.highestListenSequenceNumber=n,e&&(r.lastRemoteSnapshotVersion=e.toTimestamp()),n>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=n),i.saveMetadata(t,r)}))},t.prototype.addQueryData=function(t,n){var e=this;return this.saveQueryData(t,n).next((function(){return e.retrieveMetadata(t).next((function(i){return i.targetCount+=1,e.updateMetadataFromQueryData(n,i),e.saveMetadata(t,i)}))}))},t.prototype.updateQueryData=function(t,n){return this.saveQueryData(t,n)},t.prototype.removeQueryData=function(t,n){var e=this;return this.removeMatchingKeysForTargetId(t,n.targetId).next((function(){return an(t).delete(n.targetId)})).next((function(){return e.retrieveMetadata(t)})).next((function(n){return l(n.targetCount>0,"Removing from an empty query cache"),n.targetCount-=1,e.saveMetadata(t,n)}))},t.prototype.removeTargets=function(t,n,e){var i=this,r=0,u=[];return an(t).iterate((function(s,o){var a=i.serializer.fromDbTarget(o);a.sequenceNumber<=n&&void 0===e[a.targetId]&&(r++,u.push(i.removeQueryData(t,a)))})).next((function(){return qt.waitFor(u)})).next((function(){return r}))},t.prototype.forEachTarget=function(t,n){var e=this;return an(t).iterate((function(t,i){var r=e.serializer.fromDbTarget(i);n(r)}))},t.prototype.retrieveMetadata=function(t){return cn(t.simpleDbTransaction)},t.prototype.saveMetadata=function(t,n){return(e=t,Re.getStore(e,ve.store)).put(ve.key,n);var e},t.prototype.saveQueryData=function(t,n){return an(t).put(this.serializer.toDbTarget(n))},t.prototype.updateMetadataFromQueryData=function(t,n){var e=!1;return t.targetId>n.highestTargetId&&(n.highestTargetId=t.targetId,e=!0),t.sequenceNumber>n.highestListenSequenceNumber&&(n.highestListenSequenceNumber=t.sequenceNumber,e=!0),e},t.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next((function(t){return t.targetCount}))},t.prototype.getQueryData=function(t,n){var e=this,i=n.canonicalId(),r=IDBKeyRange.bound([i,Number.NEGATIVE_INFINITY],[i,Number.POSITIVE_INFINITY]),u=null;return an(t).iterate({range:r,index:le.queryTargetsIndexName},(function(t,i,r){var s=e.serializer.fromDbTarget(i);n.isEqual(s.query)&&(u=s,r.done())})).next((function(){return u}))},t.prototype.addMatchingKeys=function(t,n,e){var i=this,r=[],u=fn(t);return n.forEach((function(n){var s=wt(n.path);r.push(u.put(new de(e,s))),r.push(i.referenceDelegate.addReference(t,n))})),qt.waitFor(r)},t.prototype.removeMatchingKeys=function(t,n,e){var i=this,r=fn(t);return qt.forEach(n,(function(n){var u=wt(n.path);return qt.waitFor([r.delete([e,u]),i.referenceDelegate.removeReference(t,n)])}))},t.prototype.removeMatchingKeysForTargetId=function(t,n){var e=fn(t),i=IDBKeyRange.bound([n],[n+1],!1,!0);return e.delete(i)},t.prototype.getMatchingKeysForTargetId=function(t,n){var e=IDBKeyRange.bound([n],[n+1],!1,!0),i=fn(t),r=Ft();return i.iterate({range:e,keysOnly:!0},(function(t){var n=gt(t[1]),e=new at(n);r=r.add(e)})).next((function(){return r}))},t.prototype.containsKey=function(t,n){var e=wt(n.path),i=IDBKeyRange.bound([e],[Y(e)],!1,!0),r=0;return fn(t).iterate({index:de.documentTargetsIndex,keysOnly:!0,range:i},(function(t,n,e){0!==t[0]&&(r++,e.done())})).next((function(){return r>0}))},t.prototype.getQueryDataForTarget=function(t,n){var e=this;return an(t).get(n).next((function(t){return t?e.serializer.fromDbTarget(t):null}))},t}();function an(t){return Re.getStore(t,le.store)}function cn(t){return Zt.getStore(t,ve.store).get(ve.key).next((function(t){return l(null!==t,"Missing metadata row."),t}))}function hn(t){return cn(t).next((function(t){return t.highestListenSequenceNumber}))}function fn(t){return Re.getStore(t,de.store)}var ln,dn=function(){function t(t){this.fields=t}return t.fromSet=function(n){return new t(n)},t.fromArray=function(n){var e=new Et(ot.comparator);return n.forEach((function(t){return e=e.add(t)})),new t(e)},t.prototype.covers=function(t){var n=!1;return this.fields.forEach((function(e){e.isPrefixOf(t)&&(n=!0)})),n},t.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},t}(),vn=function(){function t(t,n){this.field=t,this.transform=n}return t.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},t}(),mn=function(t,n){this.version=t,this.transformResults=n};!function(t){t[t.Set=0]="Set",t[t.Patch=1]="Patch",t[t.Transform=2]="Transform",t[t.Delete=3]="Delete"}(ln||(ln={}));var wn,bn,pn=function(){function t(t,n){this.updateTime=t,this.exists=n,l(void 0===t||void 0===n,'Precondition can specify "exists" or "updateTime" but not both')}return t.exists=function(n){return new t(void 0,n)},t.updateTime=function(n){return new t(n)},Object.defineProperty(t.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),t.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof qn&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof qn:(l(this.isNone,"Precondition should be empty"),!0)},t.prototype.isEqual=function(t){return e=t.updateTime,(null!=(n=this.updateTime)?!(!e||!n.isEqual(e)):n===e)&&this.exists===t.exists;var n,e},t.NONE=new t,t}(),gn=function(){function t(){}return t.prototype.verifyKeyMatches=function(t){null!=t&&l(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},t.getPostMutationVersion=function(t){return t instanceof qn?t.version:_t.MIN},t}(),yn=function(t){function n(n,e,i){var r=t.call(this)||this;return r.key=n,r.value=e,r.precondition=i,r.type=ln.Set,r}return b.__extends(n,t),n.prototype.applyToRemoteDocument=function(t,n){return this.verifyKeyMatches(t),l(null==n.transformResults,"Transform results received by SetMutation."),new qn(this.key,n.version,{hasCommittedMutations:!0},this.value)},n.prototype.applyToLocalView=function(t){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var n=gn.getPostMutationVersion(t);return new qn(this.key,n,{hasLocalMutations:!0},this.value)},n.prototype.extractBaseValue=function(){return null},n.prototype.isEqual=function(t){return t instanceof n&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},n}(gn),_n=function(t){function n(n,e,i,r){var u=t.call(this)||this;return u.key=n,u.data=e,u.fieldMask=i,u.precondition=r,u.type=ln.Patch,u}return b.__extends(n,t),n.prototype.applyToRemoteDocument=function(t,n){if(this.verifyKeyMatches(t),l(null==n.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new zn(this.key,n.version);var e=this.patchDocument(t);return new qn(this.key,n.version,{hasCommittedMutations:!0},e)},n.prototype.applyToLocalView=function(t){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var n=gn.getPostMutationVersion(t),e=this.patchDocument(t);return new qn(this.key,n,{hasLocalMutations:!0},e)},n.prototype.extractBaseValue=function(){return null},n.prototype.isEqual=function(t){return t instanceof n&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},n.prototype.patchDocument=function(t){var n;return n=t instanceof qn?t.data():Un.EMPTY,this.patchObject(n)},n.prototype.patchObject=function(t){var n=this;return this.fieldMask.fields.forEach((function(e){if(!e.isEmpty()){var i=n.data.field(e);t=null!==i?t.set(e,i):t.delete(e)}})),t},n}(gn),On=function(t){function n(n,e){var i=t.call(this)||this;return i.key=n,i.fieldTransforms=e,i.type=ln.Transform,i.precondition=pn.exists(!0),i}return b.__extends(n,t),n.prototype.applyToRemoteDocument=function(t,n){if(this.verifyKeyMatches(t),l(null!=n.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new zn(this.key,n.version);var e=this.requireDocument(t),i=this.serverTransformResults(t,n.transformResults),r=n.version,u=this.transformObject(e.data(),i);return new qn(this.key,r,{hasCommittedMutations:!0},u)},n.prototype.applyToLocalView=function(t,n,e){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var i=this.requireDocument(t),r=this.localTransformResults(e,t,n),u=this.transformObject(i.data(),r);return new qn(this.key,i.version,{hasLocalMutations:!0},u)},n.prototype.extractBaseValue=function(t){for(var n=null,e=0,i=this.fieldTransforms;e<i.length;e++){var r=i[e],u=t instanceof qn?t.field(r.field):void 0,s=r.transform.computeBaseValue(u||null);null!=s&&(n=null==n?Un.EMPTY.set(r.field,s):n.set(r.field,s))}return n},n.prototype.isEqual=function(t){return t instanceof n&&this.key.isEqual(t.key)&&Q(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},n.prototype.requireDocument=function(t){l(t instanceof qn,"Unknown MaybeDocument type "+t);var n=t;return l(n.key.isEqual(this.key),"Can only transform a document with the same key"),n},n.prototype.serverTransformResults=function(t,n){var e=[];l(this.fieldTransforms.length===n.length,"server transform result count ("+n.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var i=0;i<n.length;i++){var r=this.fieldTransforms[i],u=r.transform,s=null;t instanceof qn&&(s=t.field(r.field)),e.push(u.applyToRemoteDocument(s,n[i]))}return e},n.prototype.localTransformResults=function(t,n,e){for(var i=[],r=0,u=this.fieldTransforms;r<u.length;r++){var s=u[r],o=s.transform,a=null;n instanceof qn&&(a=n.field(s.field)),null===a&&e instanceof qn&&(a=e.field(s.field)),i.push(o.applyToLocalView(a,t))}return i},n.prototype.transformObject=function(t,n){l(n.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var e=0;e<this.fieldTransforms.length;e++)t=t.set(this.fieldTransforms[e].field,n[e]);return t},n}(gn),kn=function(t){function n(n,e){var i=t.call(this)||this;return i.key=n,i.precondition=e,i.type=ln.Delete,i}return b.__extends(n,t),n.prototype.applyToRemoteDocument=function(t,n){return this.verifyKeyMatches(t),l(null==n.transformResults,"Transform results received by DeleteMutation."),new Bn(this.key,n.version,{hasCommittedMutations:!0})},n.prototype.applyToLocalView=function(t){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&l(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new Bn(this.key,_t.forDeletedDoc())):t},n.prototype.extractBaseValue=function(){return null},n.prototype.isEqual=function(t){return t instanceof n&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},n}(gn);!function(t){t[t.NullValue=0]="NullValue",t[t.BooleanValue=1]="BooleanValue",t[t.NumberValue=2]="NumberValue",t[t.TimestampValue=3]="TimestampValue",t[t.StringValue=4]="StringValue",t[t.BlobValue=5]="BlobValue",t[t.RefValue=6]="RefValue",t[t.GeoPointValue=7]="GeoPointValue",t[t.ArrayValue=8]="ArrayValue",t[t.ObjectValue=9]="ObjectValue"}(wn||(wn={})),function(t){t[t.Default=0]="Default",t[t.Estimate=1]="Estimate",t[t.Previous=2]="Previous"}(bn||(bn={}));var jn=function(){function t(t,n){this.serverTimestampBehavior=t,this.timestampsInSnapshots=n}return t.fromSnapshotOptions=function(n,e){switch(n.serverTimestamps){case"estimate":return new t(bn.Estimate,e);case"previous":return new t(bn.Previous,e);case"none":case void 0:return new t(bn.Default,e);default:return f("fromSnapshotOptions() called with invalid options.")}},t}(),Sn=function(){function t(){}return t.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},t.prototype.defaultCompareTo=function(t){return l(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type."),G(this.typeOrder,t.typeOrder)},t}(),En=function(t){function n(){var n=t.call(this)||this;return n.typeOrder=wn.NullValue,n.internalValue=null,n}return b.__extends(n,t),n.prototype.value=function(){return null},n.prototype.isEqual=function(t){return t instanceof n},n.prototype.compareTo=function(t){return t instanceof n?0:this.defaultCompareTo(t)},n.INSTANCE=new n,n}(Sn),Dn=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.BooleanValue,e}return b.__extends(n,t),n.prototype.value=function(){return this.internalValue},n.prototype.isEqual=function(t){return t instanceof n&&this.internalValue===t.internalValue},n.prototype.compareTo=function(t){return t instanceof n?G(this,t):this.defaultCompareTo(t)},n.of=function(t){return t?n.TRUE:n.FALSE},n.TRUE=new n(!0),n.FALSE=new n(!1),n}(Sn),In=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.NumberValue,e}return b.__extends(n,t),n.prototype.value=function(){return this.internalValue},n.prototype.compareTo=function(t){return t instanceof n?(e=this.internalValue)<(i=t.internalValue)?-1:e>i?1:e===i?0:isNaN(e)?isNaN(i)?0:-1:1:this.defaultCompareTo(t);var e,i},n}(Sn);function Mn(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}var An=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.isEqual=function(t){return t instanceof n&&Mn(this.internalValue,t.internalValue)},n}(In),Tn=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.isEqual=function(t){return t instanceof n&&Mn(this.internalValue,t.internalValue)},n.NAN=new n(NaN),n.POSITIVE_INFINITY=new n(1/0),n.NEGATIVE_INFINITY=new n(-1/0),n}(In),Nn=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.StringValue,e}return b.__extends(n,t),n.prototype.value=function(){return this.internalValue},n.prototype.isEqual=function(t){return t instanceof n&&this.internalValue===t.internalValue},n.prototype.compareTo=function(t){return t instanceof n?G(this.internalValue,t.internalValue):this.defaultCompareTo(t)},n}(Sn),xn=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.TimestampValue,e}return b.__extends(n,t),n.prototype.value=function(t){return!t||t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},n.prototype.isEqual=function(t){return t instanceof n&&this.internalValue.isEqual(t.internalValue)},n.prototype.compareTo=function(t){return t instanceof n?this.internalValue._compareTo(t.internalValue):t instanceof Cn?-1:this.defaultCompareTo(t)},n}(Sn),Cn=function(t){function n(n,e){var i=t.call(this)||this;return i.localWriteTime=n,i.previousValue=e,i.typeOrder=wn.TimestampValue,i}return b.__extends(n,t),n.prototype.value=function(t){return t&&t.serverTimestampBehavior===bn.Estimate?new xn(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===bn.Previous&&this.previousValue?this.previousValue.value(t):null},n.prototype.isEqual=function(t){return t instanceof n&&this.localWriteTime.isEqual(t.localWriteTime)},n.prototype.compareTo=function(t){return t instanceof n?this.localWriteTime._compareTo(t.localWriteTime):t instanceof xn?1:this.defaultCompareTo(t)},n.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},n}(Sn),Rn=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.BlobValue,e}return b.__extends(n,t),n.prototype.value=function(){return this.internalValue},n.prototype.isEqual=function(t){return t instanceof n&&this.internalValue.isEqual(t.internalValue)},n.prototype.compareTo=function(t){return t instanceof n?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},n}(Sn),Fn=function(t){function n(n,e){var i=t.call(this)||this;return i.databaseId=n,i.key=e,i.typeOrder=wn.RefValue,i}return b.__extends(n,t),n.prototype.value=function(){return this.key},n.prototype.isEqual=function(t){return t instanceof n&&this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId)},n.prototype.compareTo=function(t){if(t instanceof n){var e=this.databaseId.compareTo(t.databaseId);return 0!==e?e:at.comparator(this.key,t.key)}return this.defaultCompareTo(t)},n}(Sn),Pn=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.GeoPointValue,e}return b.__extends(n,t),n.prototype.value=function(){return this.internalValue},n.prototype.isEqual=function(t){return t instanceof n&&this.internalValue.isEqual(t.internalValue)},n.prototype.compareTo=function(t){return t instanceof n?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},n}(Sn),Un=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.ObjectValue,e}return b.__extends(n,t),n.prototype.value=function(t){var n={};return this.internalValue.inorderTraversal((function(e,i){n[e]=i.value(t)})),n},n.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},n.prototype.isEqual=function(t){if(t instanceof n){for(var e=this.internalValue.getIterator(),i=t.internalValue.getIterator();e.hasNext()&&i.hasNext();){var r=e.getNext(),u=i.getNext();if(r.key!==u.key||!r.value.isEqual(u.value))return!1}return!e.hasNext()&&!i.hasNext()}return!1},n.prototype.compareTo=function(t){if(t instanceof n){for(var e=this.internalValue.getIterator(),i=t.internalValue.getIterator();e.hasNext()&&i.hasNext();){var r=e.getNext(),u=i.getNext(),s=G(r.key,u.key)||r.value.compareTo(u.value);if(s)return s}return G(e.hasNext(),i.hasNext())}return this.defaultCompareTo(t)},n.prototype.set=function(t,e){if(l(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),e);var i=this.child(t.firstSegment());i instanceof n||(i=n.EMPTY);var r=i.set(t.popFirst(),e);return this.setChild(t.firstSegment(),r)},n.prototype.delete=function(t){if(l(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new n(this.internalValue.remove(t.firstSegment()));var e=this.child(t.firstSegment());if(e instanceof n){var i=e.delete(t.popFirst());return new n(this.internalValue.insert(t.firstSegment(),i))}return this},n.prototype.contains=function(t){return null!==this.field(t)},n.prototype.field=function(t){l(!t.isEmpty(),"Can't get field of empty path");var e=this;return t.forEach((function(t){e=e instanceof n?e.internalValue.get(t):null})),e},n.prototype.fieldMask=function(){var t=new Et(ot.comparator);return this.internalValue.forEach((function(e,i){var r=new ot([e]);if(i instanceof n){var u=i.fieldMask().fields;u.isEmpty()?t=t.add(r):u.forEach((function(n){t=t.add(r.child(n))}))}else t=t.add(r)})),dn.fromSet(t)},n.prototype.toString=function(){return this.internalValue.toString()},n.prototype.child=function(t){return this.internalValue.get(t)||void 0},n.prototype.setChild=function(t,e){return new n(this.internalValue.insert(t,e))},n.EMPTY=new n(new Ot(G)),n}(Sn),$n=function(t){function n(n){var e=t.call(this)||this;return e.internalValue=n,e.typeOrder=wn.ArrayValue,e}return b.__extends(n,t),n.prototype.value=function(t){return this.internalValue.map((function(n){return n.value(t)}))},n.prototype.contains=function(t){for(var n=0,e=this.internalValue;n<e.length;n++)if(e[n].isEqual(t))return!0;return!1},n.prototype.forEach=function(t){this.internalValue.forEach(t)},n.prototype.isEqual=function(t){if(t instanceof n){if(this.internalValue.length!==t.internalValue.length)return!1;for(var e=0;e<this.internalValue.length;e++)if(!this.internalValue[e].isEqual(t.internalValue[e]))return!1;return!0}return!1},n.prototype.compareTo=function(t){if(t instanceof n){for(var e=Math.min(this.internalValue.length,t.internalValue.length),i=0;i<e;i++){var r=this.internalValue[i].compareTo(t.internalValue[i]);if(r)return r}return G(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},n.prototype.toString=function(){return"["+this.internalValue.map((function(t){return t.toString()})).join(",")+"]"},n}(Sn),Ln=function(){function t(t,n){this.key=t,this.version=n}return t.compareByKey=function(t,n){return at.comparator(t.key,n.key)},t}(),qn=function(t){function n(n,e,i,r,u,s){var o=t.call(this,n,e)||this;return o.objectValue=r,o.proto=u,o.converter=s,l(void 0!==o.objectValue||void 0!==o.proto&&void 0!==o.converter,"If objectValue is not defined, proto and converter need to be set."),o.hasLocalMutations=!!i.hasLocalMutations,o.hasCommittedMutations=!!i.hasCommittedMutations,o}return b.__extends(n,t),n.prototype.field=function(t){if(this.objectValue)return this.objectValue.field(t);this.fieldValueCache||(this.fieldValueCache=new Map);var n=t.canonicalString(),e=this.fieldValueCache.get(n);if(void 0===e){var i=this.getProtoField(t);e=void 0===i?null:this.converter(i),this.fieldValueCache.set(n,e)}return e},n.prototype.data=function(){var t=this;if(!this.objectValue){var n=Un.EMPTY;k(this.proto.fields,(function(e,i){n=n.set(new ot([e]),t.converter(i))})),this.objectValue=n,this.fieldValueCache=void 0}return this.objectValue},n.prototype.value=function(){return this.data().value()},n.prototype.isEqual=function(t){return t instanceof n&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())},n.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(n.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),n.prototype.getProtoField=function(t){l(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var n=this.proto.fields[t.firstSegment()],e=1;e<t.length;++e){if(!n||!n.mapValue)return;n=n.mapValue.fields[t.get(e)]}return n},n.compareByField=function(t,n,e){var i=n.field(t),r=e.field(t);return null!==i&&null!==r?i.compareTo(r):f("Trying to compare documents on fields that don't exist")},n}(Ln),Bn=function(t){function n(n,e,i){var r=t.call(this,n,e)||this;return r.hasCommittedMutations=!(!i||!i.hasCommittedMutations),r}return b.__extends(n,t),n.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(n.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),n.prototype.isEqual=function(t){return t instanceof n&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},n}(Ln),zn=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(n.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),n.prototype.isEqual=function(t){return t instanceof n&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},n}(Ln),Vn=function(){function t(t){this.mapKeyFn=t,this.inner={}}return t.prototype.get=function(t){var n=this.mapKeyFn(t),e=this.inner[n];if(void 0!==e)for(var i=0,r=e;i<r.length;i++){var u=r[i],s=u[1];if(u[0].isEqual(t))return s}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,n){var e=this.mapKeyFn(t),i=this.inner[e];if(void 0!==i){for(var r=0;r<i.length;r++)if(i[r][0].isEqual(t))return void(i[r]=[t,n]);i.push([t,n])}else this.inner[e]=[[t,n]]},t.prototype.delete=function(t){var n=this.mapKeyFn(t),e=this.inner[n];if(void 0===e)return!1;for(var i=0;i<e.length;i++)if(e[i][0].isEqual(t))return 1===e.length?delete this.inner[n]:e.splice(i,1),!0;return!1},t.prototype.forEach=function(t){k(this.inner,(function(n,e){for(var i=0,r=e;i<r.length;i++){var u=r[i];t(u[0],u[1])}}))},t.prototype.isEmpty=function(){return E(this.inner)},t}(),Wn=function(){function t(){this.changes=new Vn((function(t){return t.toString()})),this.changesApplied=!1}return t.prototype.addEntry=function(t){this.assertNotApplied(),this.changes.set(t.key,t)},t.prototype.removeEntry=function(t){this.assertNotApplied(),this.changes.set(t,null)},t.prototype.getEntry=function(t,n){this.assertNotApplied();var e=this.changes.get(n);return void 0!==e?qt.resolve(e):this.getFromCache(t,n)},t.prototype.getEntries=function(t,n){return this.getAllFromCache(t,n)},t.prototype.apply=function(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)},t.prototype.assertNotApplied=function(){l(!this.changesApplied,"Changes have already been applied.")},t}(),Gn="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Qn=function(){function t(t,n,e){this.serializer=t,this.indexManager=n,this.keepDocumentChangeLog=e,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(t.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),t.prototype.start=function(t){var n=Zt.getStore(t,pe.store);return this.synchronizeLastDocumentChangeId(n)},t.prototype.addEntry=function(t,n,e){var i=this;return Hn(t).put(Kn(n),e).next((function(){i.indexManager.addToCollectionParentIndex(t,n.path.popLast())}))},t.prototype.removeEntry=function(t,n){var e=Hn(t),i=Kn(n);return e.delete(i)},t.prototype.updateMetadata=function(t,n,e){var i=this;return this.getMetadata(t).next((function(r){return r.byteSize+=e,i.setMetadata(t,r).next((function(){if(i.keepDocumentChangeLog)return Jn(t).put({changes:i.serializer.toDbResourcePaths(n)})}))}))},t.prototype.getEntry=function(t,n){var e=this;return Hn(t).get(Kn(n)).next((function(t){return t?e.serializer.fromDbRemoteDocument(t):null}))},t.prototype.getSizedEntry=function(t,n){var e=this;return Hn(t).get(Kn(n)).next((function(t){return t?{maybeDocument:e.serializer.fromDbRemoteDocument(t),size:Xn(t)}:null}))},t.prototype.getEntries=function(t,n){var e=this,i=At();return this.forEachDbEntry(t,n,(function(t,n){i=i.insert(t,n?e.serializer.fromDbRemoteDocument(n):null)})).next((function(){return i}))},t.prototype.getSizedEntries=function(t,n){var e=this,i=At(),r=new Ot(at.comparator);return this.forEachDbEntry(t,n,(function(t,n){n?(i=i.insert(t,e.serializer.fromDbRemoteDocument(n)),r=r.insert(t,Xn(n))):(i=i.insert(t,null),r=r.insert(t,0))})).next((function(){return{maybeDocuments:i,sizeMap:r}}))},t.prototype.forEachDbEntry=function(t,n,e){if(n.isEmpty())return qt.resolve();var i=IDBKeyRange.bound(n.first().path.toArray(),n.last().path.toArray()),r=n.getIterator(),u=r.getNext();return Hn(t).iterate({range:i},(function(t,n,i){for(var s=at.fromSegments(t);u&&at.comparator(u,s)<0;)e(u,null),u=r.getNext();u&&u.isEqual(s)&&(e(u,n),u=r.hasNext()?r.getNext():null),u?i.skip(u.path.toArray()):i.done()})).next((function(){for(;u;)e(u,null),u=r.hasNext()?r.getNext():null}))},t.prototype.getDocumentsMatchingQuery=function(t,n){var e=this;l(!n.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var i=Nt(),r=n.path.length+1,u=n.path.toArray(),s=IDBKeyRange.lowerBound(u);return Hn(t).iterate({range:s},(function(t,u,s){if(t.length===r){var o=e.serializer.fromDbRemoteDocument(u);n.path.isPrefixOf(o.key.path)?o instanceof qn&&n.matches(o)&&(i=i.insert(o.key,o)):s.done()}})).next((function(){return i}))},t.prototype.getNewDocumentChanges=function(t){var n=this;l(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var e=Ft(),i=Mt(),r=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),u=!0,s=Jn(t);return s.iterate({range:r},(function(t,i){if(u&&(u=!1,n._lastProcessedDocumentChangeId+1!==i.id))return n.synchronizeLastDocumentChangeId(s).next((function(){return qt.reject(new w(m.DATA_LOSS,Gn))}));e=e.unionWith(n.serializer.fromDbResourcePaths(i.changes)),n._lastProcessedDocumentChangeId=i.id})).next((function(){var r=[];return e.forEach((function(e){r.push(n.getEntry(t,e).next((function(t){var n=t||new Bn(e,_t.forDeletedDoc());i=i.insert(e,n)})))})),qt.waitFor(r)})).next((function(){return i}))},t.prototype.removeDocumentChangesThroughChangeId=function(t,n){var e=IDBKeyRange.upperBound(n);return Jn(t).delete(e)},t.prototype.synchronizeLastDocumentChangeId=function(t){var n=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},(function(t,e,i){n._lastProcessedDocumentChangeId=t,i.done()}))},t.prototype.newChangeBuffer=function(){return new t.RemoteDocumentChangeBuffer(this)},t.prototype.getSize=function(t){return this.getMetadata(t).next((function(t){return t.byteSize}))},t.prototype.getMetadata=function(t){return Yn(t).get(fe.key).next((function(t){return l(!!t,"Missing document cache metadata"),t}))},t.prototype.setMetadata=function(t,n){return Yn(t).put(fe.key,n)},t.RemoteDocumentChangeBuffer=function(t){function n(n){var e=t.call(this)||this;return e.documentCache=n,e.documentSizes=new Vn((function(t){return t.toString()})),e}return b.__extends(n,t),n.prototype.applyChanges=function(t){var n=this,e=[],i=0,r=Ft();return this.changes.forEach((function(u,s){var o=n.documentSizes.get(u);if(l(void 0!==o,"Cannot modify a document that wasn't read (for "+u+")"),s){var a=n.documentCache.serializer.toDbRemoteDocument(s),c=Xn(a);i+=c-o,e.push(n.documentCache.addEntry(t,u,a))}else i-=o,e.push(n.documentCache.removeEntry(t,u));r=r.add(u)})),e.push(this.documentCache.updateMetadata(t,r,i)),qt.waitFor(e)},n.prototype.getFromCache=function(t,n){var e=this;return this.documentCache.getSizedEntry(t,n).next((function(t){return null===t?(e.documentSizes.set(n,0),null):(e.documentSizes.set(n,t.size),t.maybeDocument)}))},n.prototype.getAllFromCache=function(t,n){var e=this;return this.documentCache.getSizedEntries(t,n).next((function(t){var n=t.maybeDocuments;return t.sizeMap.forEach((function(t,n){e.documentSizes.set(t,n)})),n}))},n}(Wn),t}();function Yn(t){return Re.getStore(t,fe.store)}function Hn(t){return Re.getStore(t,he.store)}function Jn(t){return Re.getStore(t,pe.store)}function Kn(t){return t.path.toArray()}function Xn(t){var n;if(t.document)n=t.document;else if(t.unknownDocument)n=t.unknownDocument;else{if(!t.noDocument)throw f("Unknown remote document type");n=t.noDocument}return JSON.stringify(n).length}var Zn=function(){function t(){this.collectionParentIndex=new te}return t.prototype.addToCollectionParentIndex=function(t,n){return this.collectionParentIndex.add(n),qt.resolve()},t.prototype.getCollectionParents=function(t,n){return qt.resolve(this.collectionParentIndex.getEntries(n))},t}(),te=function(){function t(){this.index={}}return t.prototype.add=function(t){l(t.length%2==1,"Expected a collection path.");var n=t.lastSegment(),e=t.popLast(),i=this.index[n]||new Et(ut.comparator),r=!i.has(e);return this.index[n]=i.add(e),r},t.prototype.getEntries=function(t){return(this.index[t]||new Et(ut.comparator)).toArray()},t}(),ne=8,ee=function(){function t(t){this.serializer=t}return t.prototype.createOrUpgrade=function(t,n,e,i){var r=this;l(e<i&&e>=0&&i<=ne,"Unexpected schema upgrade from v"+e+" to v{toVersion}."),e<1&&i>=1&&(function(t){t.createObjectStore(re.store)}(t),function(t){t.createObjectStore(ue.store,{keyPath:ue.keyPath}),t.createObjectStore(se.store,{keyPath:se.keyPath,autoIncrement:!0}).createIndex(se.userMutationsIndex,se.userMutationsKeyPath,{unique:!0}),t.createObjectStore(oe.store)}(t),we(t),function(t){t.createObjectStore(he.store)}(t));var u=qt.resolve();return e<3&&i>=3&&(0!==e&&(function(t){t.deleteObjectStore(de.store),t.deleteObjectStore(le.store),t.deleteObjectStore(ve.store)}(t),we(t)),u=u.next((function(){return function(t){var n=t.store(ve.store),e=new ve(0,0,_t.MIN.toTimestamp(),0);return n.put(ve.key,e)}(n)}))),e<4&&i>=4&&(0!==e&&(u=u.next((function(){return function(t,n){return n.store(se.store).loadAll().next((function(e){t.deleteObjectStore(se.store),t.createObjectStore(se.store,{keyPath:se.keyPath,autoIncrement:!0}).createIndex(se.userMutationsIndex,se.userMutationsKeyPath,{unique:!0});var i=n.store(se.store),r=e.map((function(t){return i.put(t)}));return qt.waitFor(r)}))}(t,n)}))),u=u.next((function(){!function(t){t.createObjectStore(ge.store,{keyPath:ge.keyPath})}(t),function(t){t.createObjectStore(pe.store,{keyPath:"id",autoIncrement:!0})}(t)}))),e<5&&i>=5&&(u=u.next((function(){return r.removeAcknowledgedMutations(n)}))),e<6&&i>=6&&(u=u.next((function(){return function(t){t.createObjectStore(fe.store)}(t),r.addDocumentGlobal(n)}))),e<7&&i>=7&&(u=u.next((function(){return r.ensureSequenceNumbers(n)}))),e<8&&i>=8&&(u=u.next((function(){return r.createCollectionParentIndex(t,n)}))),u},t.prototype.addDocumentGlobal=function(t){var n=0;return t.store(he.store).iterate((function(t,e){n+=Xn(e)})).next((function(){var e=new fe(n);return t.store(fe.store).put(fe.key,e)}))},t.prototype.removeAcknowledgedMutations=function(t){var n=this,e=t.store(ue.store),i=t.store(se.store);return e.loadAll().next((function(e){return qt.forEach(e,(function(e){var r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return i.loadAll(se.userMutationsIndex,r).next((function(i){return qt.forEach(i,(function(i){l(i.userId===e.userId,"Cannot process batch "+i.batchId+" from unexpected user");var r=n.serializer.fromDbMutationBatch(i);return Vt(t,e.userId,r).next((function(){}))}))}))}))}))},t.prototype.ensureSequenceNumbers=function(t){var n=t.store(de.store),e=t.store(he.store);return hn(t).next((function(t){var i=[];return e.iterate((function(e){var r=new ut(e),u=function(t){return[0,wt(t)]}(r);i.push(n.get(u).next((function(e){return e?qt.resolve():function(e){return n.put(new de(0,wt(e),t))}(r)})))})).next((function(){return qt.waitFor(i)}))}))},t.prototype.createCollectionParentIndex=function(t,n){t.createObjectStore(me.store,{keyPath:me.keyPath});var e=n.store(me.store),i=new te,r=function(t){if(i.add(t)){var n=t.lastSegment(),r=t.popLast();return e.put({collectionId:n,parent:wt(r)})}};return n.store(he.store).iterate({keysOnly:!0},(function(t){var n=new ut(t);return r(n.popLast())})).next((function(){return n.store(oe.store).iterate({keysOnly:!0},(function(t){var n=gt(t[1]);return r(n.popLast())}))}))},t}(),ie=function(t,n){this.seconds=t,this.nanoseconds=n},re=function(){function t(t,n,e){this.ownerId=t,this.allowTabSynchronization=n,this.leaseTimestampMs=e}return t.store="owner",t.key="owner",t}(),ue=function(){function t(t,n,e){this.userId=t,this.lastAcknowledgedBatchId=n,this.lastStreamToken=e}return t.store="mutationQueues",t.keyPath="userId",t}(),se=function(){function t(t,n,e,i,r){this.userId=t,this.batchId=n,this.localWriteTimeMs=e,this.baseMutations=i,this.mutations=r}return t.store="mutations",t.keyPath="batchId",t.userMutationsIndex="userMutationsIndex",t.userMutationsKeyPath=["userId","batchId"],t}(),oe=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,n){return[t,wt(n)]},t.key=function(t,n,e){return[t,wt(n),e]},t.store="documentMutations",t.PLACEHOLDER=new t,t}(),ae=function(t,n){this.path=t,this.readTime=n},ce=function(t,n){this.path=t,this.version=n},he=function(){function t(t,n,e,i){this.unknownDocument=t,this.noDocument=n,this.document=e,this.hasCommittedMutations=i}return t.store="remoteDocuments",t}(),fe=function(){function t(t){this.byteSize=t}return t.store="remoteDocumentGlobal",t.key="remoteDocumentGlobalKey",t}(),le=function(){function t(t,n,e,i,r,u){this.targetId=t,this.canonicalId=n,this.readTime=e,this.resumeToken=i,this.lastListenSequenceNumber=r,this.query=u}return t.store="targets",t.keyPath="targetId",t.queryTargetsIndexName="queryTargetsIndex",t.queryTargetsKeyPath=["canonicalId","targetId"],t}(),de=function(){function t(t,n,e){this.targetId=t,this.path=n,this.sequenceNumber=e,l(0===t==(void 0!==e),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return t.store="targetDocuments",t.keyPath=["targetId","path"],t.documentTargetsIndex="documentTargetsIndex",t.documentTargetsKeyPath=["path","targetId"],t}(),ve=function(){function t(t,n,e,i){this.highestTargetId=t,this.highestListenSequenceNumber=n,this.lastRemoteSnapshotVersion=e,this.targetCount=i}return t.key="targetGlobalKey",t.store="targetGlobal",t}(),me=function(){function t(t,n){this.collectionId=t,this.parent=n}return t.store="collectionParents",t.keyPath=["collectionId","parent"],t}();function we(t){t.createObjectStore(de.store,{keyPath:de.keyPath}).createIndex(de.documentTargetsIndex,de.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(le.store,{keyPath:le.keyPath}).createIndex(le.queryTargetsIndexName,le.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(ve.store)}var be,pe=function(){function t(t){this.changes=t}return t.store="remoteDocumentChanges",t.keyPath="id",t}(),ge=function(){function t(t,n,e,i,r){this.clientId=t,this.updateTimeMs=n,this.networkEnabled=e,this.inForeground=i,this.lastProcessedDocumentChangeId=r}return t.store="clientMetadata",t.keyPath="clientId",t}(),ye=[ue.store,se.store,oe.store,he.store,le.store,re.store,ve.store,de.store].concat([ge.store,pe.store]).concat([fe.store]).concat([me.store]),_e=function(){function t(){this.collectionParentsCache=new te}return t.prototype.addToCollectionParentIndex=function(t,n){if(l(n.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(n)){l(n.length>=1,"Invalid collection path.");var e=n.lastSegment(),i=n.popLast();return Oe(t).put({collectionId:e,parent:wt(i)})}return qt.resolve()},t.prototype.getCollectionParents=function(t,n){var e=[],i=IDBKeyRange.bound([n,""],[Y(n),""],!1,!0);return Oe(t).loadAll(i).next((function(t){for(var i=0,r=t;i<r.length;i++){var u=r[i];if(u.collectionId!==n)break;e.push(gt(u.parent))}return e}))},t}();function Oe(t){return Re.getStore(t,me.store)}!function(t){t[t.Listen=0]="Listen",t[t.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",t[t.LimboResolution=2]="LimboResolution"}(be||(be={}));var ke=function(){function t(t,n,e,i,r,u){void 0===r&&(r=_t.MIN),void 0===u&&(u=v()),this.query=t,this.targetId=n,this.purpose=e,this.sequenceNumber=i,this.snapshotVersion=r,this.resumeToken=u}return t.prototype.withSequenceNumber=function(n){return new t(this.query,this.targetId,this.purpose,n,this.snapshotVersion,this.resumeToken)},t.prototype.withResumeToken=function(n,e){return new t(this.query,this.targetId,this.purpose,this.sequenceNumber,e,n)},t.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},t}(),je=function(){function t(t){this.remoteSerializer=t}return t.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var n=at.fromSegments(t.noDocument.path),e=this.fromDbTimestamp(t.noDocument.readTime);return new Bn(n,e,{hasCommittedMutations:!!t.hasCommittedMutations})}return t.unknownDocument?(n=at.fromSegments(t.unknownDocument.path),e=this.fromDbTimestamp(t.unknownDocument.version),new zn(n,e)):f("Unexpected DbRemoteDocument")},t.prototype.toDbRemoteDocument=function(t){if(t instanceof qn){var n=t.proto?t.proto:this.remoteSerializer.toDocument(t);return new he(null,null,n,r=t.hasCommittedMutations)}if(t instanceof Bn){var e=t.key.path.toArray(),i=this.toDbTimestamp(t.version),r=t.hasCommittedMutations;return new he(null,new ae(e,i),null,r)}return t instanceof zn?(e=t.key.path.toArray(),i=this.toDbTimestamp(t.version),new he(new ce(e,i),null,null,!0)):f("Unexpected MaybeDocumment")},t.prototype.toDbTimestamp=function(t){var n=t.toTimestamp();return new ie(n.seconds,n.nanoseconds)},t.prototype.fromDbTimestamp=function(t){var n=new yt(t.seconds,t.nanoseconds);return _t.fromTimestamp(n)},t.prototype.toDbMutationBatch=function(t,n){var e=this,i=n.baseMutations.map((function(t){return e.remoteSerializer.toMutation(t)})),r=n.mutations.map((function(t){return e.remoteSerializer.toMutation(t)}));return new se(t,n.batchId,n.localWriteTime.toMillis(),i,r)},t.prototype.fromDbMutationBatch=function(t){var n=this,e=(t.baseMutations||[]).map((function(t){return n.remoteSerializer.fromMutation(t)})),i=t.mutations.map((function(t){return n.remoteSerializer.fromMutation(t)})),r=yt.fromMillis(t.localWriteTimeMs);return new $t(t.batchId,r,e,i)},t.prototype.toDbResourcePaths=function(t){var n=[];return t.forEach((function(t){n.push(wt(t.path))})),n},t.prototype.fromDbResourcePaths=function(t){for(var n=Ft(),e=0,i=t;e<i.length;e++)n=n.add(new at(gt(i[e])));return n},t.prototype.fromDbTarget=function(t){var n,e=this.fromDbTimestamp(t.readTime);return n=void 0!==t.query.documents?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new ke(n,t.targetId,be.Listen,t.lastListenSequenceNumber,e,t.resumeToken)},t.prototype.toDbTarget=function(t){l(be.Listen===t.purpose,"Only queries with purpose "+be.Listen+" may be stored, got "+t.purpose);var n,e,i=this.toDbTimestamp(t.snapshotVersion);return n=t.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(t.query):this.remoteSerializer.toQueryTarget(t.query),t.resumeToken instanceof Uint8Array?(l("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),e=t.resumeToken.toString()):e=t.resumeToken,new le(t.targetId,t.query.canonicalId(),i,e,t.sequenceNumber,n)},t}();function Se(t,n){var e=t[1],i=n[1],r=G(t[0],n[0]);return 0===r?G(e,i):r}var Ee=function(){function t(t){this.maxElements=t,this.buffer=new Et(Se),this.previousIndex=0}return t.prototype.nextIndex=function(){return++this.previousIndex},t.prototype.addElement=function(t){var n=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(n);else{var e=this.buffer.last();Se(n,e)<0&&(this.buffer=this.buffer.delete(e).add(n))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),t}(),De={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Ie=function(){function t(t,n,e){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=n,this.maximumSequenceNumbersToCollect=e}return t.withCacheSize=function(n){return new t(n,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},t.COLLECTION_DISABLED=-1,t.MINIMUM_CACHE_SIZE_BYTES=1048576,t.DEFAULT=new t(t.DEFAULT_CACHE_SIZE_BYTES=41943040,t.DEFAULT_COLLECTION_PERCENTILE=10,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),t.DISABLED=new t(t.COLLECTION_DISABLED,0,0),t}(),Me=function(){function t(t,n,e){this.garbageCollector=t,this.asyncQueue=n,this.localStore=e,this.hasRun=!1,this.gcTask=null}return t.prototype.start=function(){l(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==Ie.COLLECTION_DISABLED&&this.scheduleGC()},t.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(t.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),t.prototype.scheduleGC=function(){var t=this;l(null===this.gcTask,"Cannot schedule GC while a task is pending");var n=this.hasRun?3e5:6e4;a("LruGarbageCollector","Garbage collection scheduled in "+n+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(K.LruGarbageCollection,n,(function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then((function(){return t.scheduleGC()})).catch(Fe)}))},t}(),Ae=function(){function t(t,n){this.delegate=t,this.params=n}return t.prototype.calculateTargetCount=function(t,n){return this.delegate.getSequenceNumberCount(t).next((function(t){return Math.floor(n/100*t)}))},t.prototype.nthSequenceNumber=function(t,n){var e=this;if(0===n)return qt.resolve(it.INVALID);var i=new Ee(n);return this.delegate.forEachTarget(t,(function(t){return i.addElement(t.sequenceNumber)})).next((function(){return e.delegate.forEachOrphanedDocumentSequenceNumber(t,(function(t){return i.addElement(t)}))})).next((function(){return i.maxValue}))},t.prototype.removeTargets=function(t,n,e){return this.delegate.removeTargets(t,n,e)},t.prototype.removeOrphanedDocuments=function(t,n){return this.delegate.removeOrphanedDocuments(t,n)},t.prototype.collect=function(t,n){var e=this;return this.params.cacheSizeCollectionThreshold===Ie.COLLECTION_DISABLED?(a("LruGarbageCollector","Garbage collection skipped; disabled"),qt.resolve(De)):this.getCacheSize(t).next((function(i){return i<e.params.cacheSizeCollectionThreshold?(a("LruGarbageCollector","Garbage collection skipped; Cache size "+i+" is lower than threshold "+e.params.cacheSizeCollectionThreshold),De):e.runGarbageCollection(t,n)}))},t.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},t.prototype.runGarbageCollection=function(t,n){var i,r,u,o,c,h,f,l=this,d=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((function(n){return n>l.params.maximumSequenceNumbersToCollect?(a("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+l.params.maximumSequenceNumbersToCollect+" from "+n),r=l.params.maximumSequenceNumbersToCollect):r=n,o=Date.now(),l.nthSequenceNumber(t,r)})).next((function(e){return i=e,c=Date.now(),l.removeTargets(t,i,n)})).next((function(n){return u=n,h=Date.now(),l.removeOrphanedDocuments(t,i)})).next((function(t){return f=Date.now(),s()<=e.DEBUG&&a("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(o-d)+"ms\n\tDetermined least recently used "+r+" in "+(c-o)+"ms\n\tRemoved "+u+" targets in "+(h-c)+"ms\n\tRemoved "+t+" documents in "+(f-h)+"ms\nTotal Duration: "+(f-d)+"ms"),qt.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:u,documentsRemoved:t})}))},t}(),Te="IndexedDbPersistence",Ne="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",xe="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",Ce=function(t){function n(n,e){var i=t.call(this)||this;return i.simpleDbTransaction=n,i.currentSequenceNumber=e,i}return b.__extends(n,t),n}((function(){})),Re=function(){function t(n,e,i,r,u,s,o,a){if(this.allowTabSynchronization=n,this.persistenceKey=e,this.clientId=i,this.queue=s,this.sequenceNumberSyncer=a,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(){return Promise.resolve()},this.referenceDelegate=new $e(this,u),this.dbName=e+t.MAIN_DATABASE,this.serializer=new je(o),this.document=r.document,this.queryCache=new on(this.referenceDelegate,this.serializer),this.indexManager=new _e,this.remoteDocumentCache=new Qn(this.serializer,this.indexManager,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new w(m.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}return t.getStore=function(t,n){if(t instanceof Ce)return Zt.getStore(t.simpleDbTransaction,n);throw f("IndexedDbPersistence must use instances of IndexedDbTransaction")},t.createIndexedDbPersistence=function(n){return b.__awaiter(this,void 0,void 0,(function(){var e;return b.__generator(this,(function(i){switch(i.label){case 0:if(!t.isAvailable())throw new w(m.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");return[4,(e=new t(n.allowTabSynchronization,n.persistenceKey,n.clientId,n.platform,n.lruParams,n.queue,n.serializer,n.sequenceNumberSyncer)).start()];case 1:return i.sent(),[2,e]}}))}))},t.prototype.start=function(){var t=this;return l(!this.started,"IndexedDbPersistence double-started!"),l(null!==this.window,"Expected 'window' to be defined"),Zt.openOrCreate(this.dbName,ne,new ee(this.serializer)).then((function(n){return t.simpleDb=n,t.updateClientMetadataAndTryBecomePrimary()})).then((function(){return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.scheduleClientMetadataAndPrimaryLeaseRefreshes(),t.startRemoteDocumentCache()})).then((function(){return t.simpleDb.runTransaction("readonly",[ve.store],(function(n){return hn(n).next((function(n){t.listenSequence=new it(n,t.sequenceNumberSyncer)}))}))})).then((function(){t._started=!0})).catch((function(n){return t.simpleDb&&t.simpleDb.close(),Promise.reject(n)}))},t.prototype.startRemoteDocumentCache=function(){var t=this;return this.simpleDb.runTransaction("readonly",ye,(function(n){return t.remoteDocumentCache.start(n)}))},t.prototype.setPrimaryStateListener=function(t){var n=this;return this.primaryStateListener=function(e){return b.__awaiter(n,void 0,void 0,(function(){return b.__generator(this,(function(){return this.started?[2,t(e)]:[2]}))}))},t(this.isPrimary)},t.prototype.setDatabaseDeletedListener=function(t){var n=this;this.simpleDb.setVersionChangeListener((function(e){return b.__awaiter(n,void 0,void 0,(function(){return b.__generator(this,(function(n){switch(n.label){case 0:return null!==e.newVersion?[3,2]:[4,t()];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))}))},t.prototype.setNetworkEnabled=function(t){var n=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget((function(){return b.__awaiter(n,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))})))},t.prototype.updateClientMetadataAndTryBecomePrimary=function(){var t=this;return this.simpleDb.runTransaction("readwrite",ye,(function(n){return Ue(n).put(new ge(t.clientId,Date.now(),t.networkEnabled,t.inForeground,t.remoteDocumentCache.lastProcessedDocumentChangeId)).next((function(){if(t.isPrimary)return t.verifyPrimaryLease(n).next((function(n){n||(t.isPrimary=!1,t.queue.enqueueAndForget((function(){return t.primaryStateListener(!1)})))}))})).next((function(){return t.canActAsPrimary(n)})).next((function(e){var i=t.isPrimary;return t.isPrimary=e,i!==t.isPrimary&&t.queue.enqueueAndForget((function(){return t.primaryStateListener(t.isPrimary)})),i&&!t.isPrimary?t.releasePrimaryLeaseIfHeld(n):t.isPrimary?t.acquireOrExtendPrimaryLease(n):void 0}))}))},t.prototype.verifyPrimaryLease=function(t){var n=this;return Pe(t).get(re.key).next((function(t){return qt.resolve(n.isLocalClient(t))}))},t.prototype.removeClientMetadata=function(t){return Ue(t).delete(this.clientId)},t.prototype.maybeGarbageCollectMultiClientState=function(){return b.__awaiter(this,void 0,void 0,(function(){var n,e,i=this;return b.__generator(this,(function(r){switch(r.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),e=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(function(r){var u=t.getStore(r,ge.store);return u.loadAll().next((function(t){n=i.filterActiveClients(t,18e5),e=t.filter((function(t){return-1===n.indexOf(t)}))})).next((function(){return qt.forEach(e,(function(t){return u.delete(t.clientId)}))})).next((function(){if((n=n.filter((function(t){return t.clientId!==i.clientId}))).length>0){var t=n.map((function(t){return t.lastProcessedDocumentChangeId||0})),e=Math.min.apply(Math,t);return i.remoteDocumentCache.removeDocumentChangesThroughChangeId(r,e)}}))}))]);case 1:r.sent(),e.forEach((function(t){i.window.localStorage.removeItem(i.zombiedClientLocalStorageKey(t.clientId))})),r.label=2;case 2:return[2]}}))}))},t.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(K.ClientMetadataRefresh,4e3,(function(){return t.updateClientMetadataAndTryBecomePrimary().then((function(){return t.maybeGarbageCollectMultiClientState()})).then((function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()}))}))},t.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.canActAsPrimary=function(t){var n=this;return Pe(t).get(re.key).next((function(e){if(null!==e&&n.isWithinAge(e.leaseTimestampMs,5e3)&&!n.isClientZombied(e.ownerId)){if(n.isLocalClient(e)&&n.networkEnabled)return!0;if(!n.isLocalClient(e)){if(!e.allowTabSynchronization)throw new w(m.FAILED_PRECONDITION,xe);return!1}}return!(!n.networkEnabled||!n.inForeground)||Ue(t).loadAll().next((function(t){return void 0===n.filterActiveClients(t,5e3).find((function(t){return!(n.clientId===t.clientId||!(!n.networkEnabled&&t.networkEnabled||!n.inForeground&&t.inForeground&&n.networkEnabled===t.networkEnabled))}))}))})).next((function(t){return n.isPrimary!==t&&a(Te,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t}))},t.prototype.shutdown=function(){return b.__awaiter(this,void 0,void 0,(function(){var t=this;return b.__generator(this,(function(n){switch(n.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[re.store,ge.store],(function(n){return t.releasePrimaryLeaseIfHeld(n).next((function(){return t.removeClientMetadata(n)}))}))];case 1:return n.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}}))}))},t.prototype.filterActiveClients=function(t,n){var e=this;return t.filter((function(t){return e.isWithinAge(t.updateTimeMs,n)&&!e.isClientZombied(t.clientId)}))},t.prototype.getActiveClients=function(){var t=this;return this.simpleDb.runTransaction("readonly",[ge.store],(function(n){return Ue(n).loadAll().next((function(n){return t.filterActiveClients(n,18e5).map((function(t){return t.clientId}))}))}))},t.clearPersistence=function(n){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(e){switch(e.label){case 0:return t.isAvailable()?[4,Zt.delete(n+t.MAIN_DATABASE)]:[2,Promise.resolve()];case 1:return e.sent(),[2]}}))}))},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getMutationQueue=function(t){return l(this.started,"Cannot initialize MutationQueue before persistence is started."),Bt.forUser(t,this.serializer,this.indexManager,this.referenceDelegate)},t.prototype.getQueryCache=function(){return l(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},t.prototype.getRemoteDocumentCache=function(){return l(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},t.prototype.getIndexManager=function(){return l(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},t.prototype.runTransaction=function(t,n,e){var i=this;return a(Te,"Starting transaction:",t),this.simpleDb.runTransaction("readonly"===n?"readonly":"readwrite",ye,(function(r){return"readwrite-primary"===n?i.verifyPrimaryLease(r).next((function(n){if(!n)throw c("Failed to obtain primary lease for action '"+t+"'."),i.isPrimary=!1,i.queue.enqueueAndForget((function(){return i.primaryStateListener(!1)})),new w(m.FAILED_PRECONDITION,Ne);return e(new Ce(r,i.listenSequence.next()))})).next((function(t){return i.acquireOrExtendPrimaryLease(r).next((function(){return t}))})):i.verifyAllowTabSynchronization(r).next((function(){return e(new Ce(r,i.listenSequence.next()))}))}))},t.prototype.verifyAllowTabSynchronization=function(t){var n=this;return Pe(t).get(re.key).next((function(t){if(null!==t&&n.isWithinAge(t.leaseTimestampMs,5e3)&&!n.isClientZombied(t.ownerId)&&!n.isLocalClient(t)&&!t.allowTabSynchronization)throw new w(m.FAILED_PRECONDITION,xe)}))},t.prototype.acquireOrExtendPrimaryLease=function(t){var n=new re(this.clientId,this.allowTabSynchronization,Date.now());return Pe(t).put(re.key,n)},t.isAvailable=function(){return Zt.isAvailable()},t.buildStoragePrefix=function(t){var n=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(n+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+n+"/"},t.prototype.releasePrimaryLeaseIfHeld=function(t){var n=this,e=Pe(t);return e.get(re.key).next((function(t){return n.isLocalClient(t)?(a(Te,"Releasing primary lease."),e.delete(re.key)):qt.resolve()}))},t.prototype.isWithinAge=function(t,n){var e=Date.now();return!(t<e-n||t>e&&(c("Detected an update time that is in the future: "+t+" > "+e),1))},t.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget((function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()}))},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},t.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(l(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},t.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget((function(){return t.shutdown()}))},this.window.addEventListener("unload",this.windowUnloadHandler))},t.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(l("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},t.prototype.isClientZombied=function(t){try{var n=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return a(Te,"Client '"+t+"' "+(n?"is":"is not")+" zombied in LocalStorage"),n}catch(t){return c(Te,"Failed to get zombied client id.",t),!1}},t.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){c("Failed to set zombie client id.",t)}},t.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},t.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},t.MAIN_DATABASE="main",t}();function Fe(t){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){if(!function(t){return t.code===m.FAILED_PRECONDITION&&t.message===Ne}(t))throw t;return a(Te,"Unexpectedly lost primary lease"),[2]}))}))}function Pe(t){return t.store(re.store)}function Ue(t){return t.store(ge.store)}var $e=function(){function t(t,n){this.db=t,this.inMemoryPins=null,this.garbageCollector=new Ae(this,n)}return t.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next((function(t){return n.next((function(n){return t+n}))}))},t.prototype.orphanedDocmentCount=function(t){var n=0;return this.forEachOrphanedDocumentSequenceNumber(t,(function(){n++})).next((function(){return n}))},t.prototype.forEachTarget=function(t,n){return this.db.getQueryCache().forEachTarget(t,n)},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,n){return this.forEachOrphanedDocument(t,(function(t,e){return n(e)}))},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,n){return Le(t,n)},t.prototype.removeReference=function(t,n){return Le(t,n)},t.prototype.removeTargets=function(t,n,e){return this.db.getQueryCache().removeTargets(t,n,e)},t.prototype.removeMutationReference=function(t,n){return Le(t,n)},t.prototype.isPinned=function(t,n){return this.inMemoryPins.containsKey(n)?qt.resolve(!0):function(t,n){var e=!1;return Yt(t).iterateSerial((function(i){return zt(t,i,n).next((function(t){return t&&(e=!0),qt.resolve(!t)}))})).next((function(){return e}))}(t,n)},t.prototype.removeOrphanedDocuments=function(t,n){var e=this,i=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],u=0;return this.forEachOrphanedDocument(t,(function(s,o){if(o<=n){var a=e.isPinned(t,s).next((function(n){if(!n)return u++,i.getEntry(t,s).next((function(){return i.removeEntry(s),fn(t).delete([0,wt(s.path)])}))}));r.push(a)}})).next((function(){return qt.waitFor(r)})).next((function(){return i.apply(t)})).next((function(){return u}))},t.prototype.removeTarget=function(t,n){var e=n.withSequenceNumber(t.currentSequenceNumber);return this.db.getQueryCache().updateQueryData(t,e)},t.prototype.updateLimboDocument=function(t,n){return Le(t,n)},t.prototype.forEachOrphanedDocument=function(t,n){var e,i=fn(t),r=it.INVALID;return i.iterate({index:de.documentTargetsIndex},(function(t,i){var u=i.path,s=i.sequenceNumber;0===t[0]?(r!==it.INVALID&&n(new at(gt(e)),r),r=s,e=u):r=it.INVALID})).next((function(){r!==it.INVALID&&n(new at(gt(e)),r)}))},t.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},t}();function Le(t,n){return fn(t).put(function(t,n){return new de(0,wt(t.path),n)}(n,t.currentSequenceNumber))}var qe=function(){function t(t,n,e){this.remoteDocumentCache=t,this.mutationQueue=n,this.indexManager=e}return t.prototype.getDocument=function(t,n){var e=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,n).next((function(i){return e.getDocumentInternal(t,n,i)}))},t.prototype.getDocumentInternal=function(t,n,e){return this.remoteDocumentCache.getEntry(t,n).next((function(t){for(var i=0,r=e;i<r.length;i++)t=r[i].applyToLocalView(n,t);return t}))},t.prototype.applyLocalMutationsToDocuments=function(t,n,e){var i=At();return n.forEach((function(t,n){for(var r=0,u=e;r<u.length;r++)n=u[r].applyToLocalView(t,n);i=i.insert(t,n)})),i},t.prototype.getDocuments=function(t,n){var e=this;return this.remoteDocumentCache.getEntries(t,n).next((function(n){return e.getLocalViewOfDocuments(t,n)}))},t.prototype.getLocalViewOfDocuments=function(t,n){var e=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,n).next((function(i){var r=e.applyLocalMutationsToDocuments(t,n,i),u=Mt();return r.forEach((function(t,n){n||(n=new Bn(t,_t.forDeletedDoc())),u=u.insert(t,n)})),u}))},t.prototype.getDocumentsMatchingQuery=function(t,n){return n.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(t,n.path):n.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(t,n):this.getDocumentsMatchingCollectionQuery(t,n)},t.prototype.getDocumentsMatchingDocumentQuery=function(t,n){return this.getDocument(t,new at(n)).next((function(t){var n=Nt();return t instanceof qn&&(n=n.insert(t.key,t)),n}))},t.prototype.getDocumentsMatchingCollectionGroupQuery=function(t,n){var e=this;l(n.path.isEmpty(),"Currently we only support collection group queries at the root.");var i=n.collectionGroup,r=Nt();return this.indexManager.getCollectionParents(t,i).next((function(u){return qt.forEach(u,(function(u){var s=n.asCollectionQueryAtPath(u.child(i));return e.getDocumentsMatchingCollectionQuery(t,s).next((function(t){t.forEach((function(t,n){r=r.insert(t,n)}))}))})).next((function(){return r}))}))},t.prototype.getDocumentsMatchingCollectionQuery=function(t,n){var e,i,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,n).next((function(i){return e=i,r.mutationQueue.getAllMutationBatchesAffectingQuery(t,n)})).next((function(n){return r.addMissingBaseDocuments(t,i=n,e).next((function(t){e=t;for(var n=0,r=i;n<r.length;n++)for(var u=r[n],s=0,o=u.mutations;s<o.length;s++){var a=o[s],c=a.key,h=e.get(c),f=a.applyToLocalView(h,h,u.localWriteTime);e=f instanceof qn?e.insert(c,f):e.remove(c)}}))})).next((function(){return e.forEach((function(t,i){n.matches(i)||(e=e.remove(t))})),e}))},t.prototype.addMissingBaseDocuments=function(t,n,e){for(var i=Ft(),r=0,u=n;r<u.length;r++)for(var s=0,o=u[r].mutations;s<o.length;s++){var a=o[s];a instanceof _n&&null===e.get(a.key)&&(i=i.add(a.key))}var c=e;return this.remoteDocumentCache.getEntries(t,i).next((function(t){return t.forEach((function(t,n){null!==n&&n instanceof qn&&(c=c.insert(t,n))})),c}))},t}(),Be=function(){function t(){this.refsByKey=new Et(ze.compareByKey),this.refsByTarget=new Et(ze.compareByTargetId)}return t.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},t.prototype.addReference=function(t,n){var e=new ze(t,n);this.refsByKey=this.refsByKey.add(e),this.refsByTarget=this.refsByTarget.add(e)},t.prototype.addReferences=function(t,n){var e=this;t.forEach((function(t){return e.addReference(t,n)}))},t.prototype.removeReference=function(t,n){this.removeRef(new ze(t,n))},t.prototype.removeReferences=function(t,n){var e=this;t.forEach((function(t){return e.removeReference(t,n)}))},t.prototype.removeReferencesForId=function(t){var n=this,e=at.EMPTY,i=new ze(e,t),r=new ze(e,t+1),u=[];return this.refsByTarget.forEachInRange([i,r],(function(t){n.removeRef(t),u.push(t.key)})),u},t.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach((function(n){return t.removeRef(n)}))},t.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},t.prototype.referencesForId=function(t){var n=at.EMPTY,e=new ze(n,t),i=new ze(n,t+1),r=Ft();return this.refsByTarget.forEachInRange([e,i],(function(t){r=r.add(t.key)})),r},t.prototype.containsKey=function(t){var n=new ze(t,0),e=this.refsByKey.firstAfterOrEqual(n);return null!==e&&t.isEqual(e.key)},t}(),ze=function(){function t(t,n){this.key=t,this.targetOrBatchId=n}return t.compareByKey=function(t,n){return at.comparator(t.key,n.key)||G(t.targetOrBatchId,n.targetOrBatchId)},t.compareByTargetId=function(t,n){return G(t.targetOrBatchId,n.targetOrBatchId)||at.comparator(t.key,n.key)},t}(),Ve=function(){function t(t,n){this.persistence=t,this.localViewReferences=new Be,this.queryDataByTarget={},l(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(n),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new qe(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}return t.prototype.handleUserChange=function(t){var n=this;return this.persistence.runTransaction("Handle user change","readonly",(function(e){var i;return n.mutationQueue.getAllMutationBatches(e).next((function(r){return i=r,n.mutationQueue=n.persistence.getMutationQueue(t),n.localDocuments=new qe(n.remoteDocuments,n.mutationQueue,n.persistence.getIndexManager()),n.mutationQueue.getAllMutationBatches(e)})).next((function(t){for(var r=[],u=[],s=Ft(),o=0,a=i;o<a.length;o++){r.push((d=a[o]).batchId);for(var c=0,h=d.mutations;c<h.length;c++)s=s.add(h[c].key)}for(var f=0,l=t;f<l.length;f++){var d;u.push((d=l[f]).batchId);for(var v=0,m=d.mutations;v<m.length;v++)s=s.add(m[v].key)}return n.localDocuments.getDocuments(e,s).next((function(t){return{affectedDocuments:t,removedBatchIds:r,addedBatchIds:u}}))}))}))},t.prototype.localWrite=function(t){var n=this,e=yt.now(),i=t.reduce((function(t,n){return t.add(n.key)}),Ft());return this.persistence.runTransaction("Locally write mutations","readwrite",(function(r){return n.localDocuments.getDocuments(r,i).next((function(i){for(var u=[],s=0,o=t;s<o.length;s++){var a=o[s],c=a.extractBaseValue(i.get(a.key));null!=c&&u.push(new _n(a.key,c,c.fieldMask(),pn.exists(!0)))}return n.mutationQueue.addMutationBatch(r,e,u,t).next((function(t){var n=t.applyToLocalDocumentSet(i);return{batchId:t.batchId,changes:n}}))}))}))},t.prototype.lookupMutationDocuments=function(t){var n=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",(function(e){return n.mutationQueue.lookupMutationKeys(e,t).next((function(t){return t?n.localDocuments.getDocuments(e,t):qt.resolve(null)}))}))},t.prototype.acknowledgeBatch=function(t){var n=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",(function(e){var i=t.batch.keys(),r=n.remoteDocuments.newChangeBuffer();return n.mutationQueue.acknowledgeBatch(e,t.batch,t.streamToken).next((function(){return n.applyWriteToRemoteDocuments(e,t,r)})).next((function(){return r.apply(e)})).next((function(){return n.mutationQueue.performConsistencyCheck(e)})).next((function(){return n.localDocuments.getDocuments(e,i)}))}))},t.prototype.rejectBatch=function(t){var n=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",(function(e){var i;return n.mutationQueue.lookupMutationBatch(e,t).next((function(t){return l(null!==t,"Attempt to reject nonexistent batch!"),i=t.keys(),n.mutationQueue.removeMutationBatch(e,t)})).next((function(){return n.mutationQueue.performConsistencyCheck(e)})).next((function(){return n.localDocuments.getDocuments(e,i)}))}))},t.prototype.getHighestUnacknowledgedBatchId=function(){var t=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(function(n){return t.mutationQueue.getHighestUnacknowledgedBatchId(n)}))},t.prototype.getLastStreamToken=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly",(function(n){return t.mutationQueue.getLastStreamToken(n)}))},t.prototype.setLastStreamToken=function(t){var n=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",(function(e){return n.mutationQueue.setLastStreamToken(e,t)}))},t.prototype.getLastRemoteSnapshotVersion=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",(function(n){return t.queryCache.getLastRemoteSnapshotVersion(n)}))},t.prototype.applyRemoteEvent=function(n){var e=this,i=this.remoteDocuments.newChangeBuffer(),r=n.snapshotVersion;return this.persistence.runTransaction("Apply remote event","readwrite-primary",(function(u){var s=[];O(n.targetChanges,(function(n,i){var o=e.queryDataByTarget[n];if(o){s.push(e.queryCache.removeMatchingKeys(u,i.removedDocuments,n).next((function(){return e.queryCache.addMatchingKeys(u,i.addedDocuments,n)})));var a=i.resumeToken;if(a.length>0){var c=o.withResumeToken(a,r);e.queryDataByTarget[n]=c,t.shouldPersistQueryData(o,c,i)&&s.push(e.queryCache.updateQueryData(u,c))}}}));var o=Mt(),h=Ft();if(n.documentUpdates.forEach((function(t){h=h.add(t)})),s.push(i.getEntries(u,h).next((function(t){n.documentUpdates.forEach((function(r,h){var f=t.get(r);h instanceof Bn&&h.version.isEqual(_t.MIN)?(i.removeEntry(r),o=o.insert(r,h)):null==f||h.version.compareTo(f.version)>0||0===h.version.compareTo(f.version)&&f.hasPendingWrites?(_t.MIN.isEqual(n.snapshotVersion)&&c("LocalStore","Cannot add a document when the remote version is zero"),i.addEntry(h),o=o.insert(r,h)):a("LocalStore","Ignoring outdated watch update for ",r,". Current version:",f.version," Watch version:",h.version),n.resolvedLimboDocuments.has(r)&&s.push(e.persistence.referenceDelegate.updateLimboDocument(u,r))}))}))),!r.isEqual(_t.MIN)){var f=e.queryCache.getLastRemoteSnapshotVersion(u).next((function(t){return l(r.compareTo(t)>=0,"Watch stream reverted to previous snapshot?? "+r+" < "+t),e.queryCache.setTargetsMetadata(u,u.currentSequenceNumber,r)}));s.push(f)}return qt.waitFor(s).next((function(){return i.apply(u)})).next((function(){return e.localDocuments.getLocalViewOfDocuments(u,o)}))}))},t.shouldPersistQueryData=function(t,n,e){return l(n.resumeToken.length>0,"Attempted to persist query data with no resume token"),0===t.resumeToken.length||n.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size>0},t.prototype.notifyLocalViewChanges=function(t){var n=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",(function(e){return qt.forEach(t,(function(t){return n.localViewReferences.addReferences(t.addedKeys,t.targetId),n.localViewReferences.removeReferences(t.removedKeys,t.targetId),qt.forEach(t.removedKeys,(function(t){return n.persistence.referenceDelegate.removeReference(e,t)}))}))}))},t.prototype.nextMutationBatch=function(t){var n=this;return this.persistence.runTransaction("Get next mutation batch","readonly",(function(e){return void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)}))},t.prototype.readDocument=function(t){var n=this;return this.persistence.runTransaction("read document","readonly",(function(e){return n.localDocuments.getDocument(e,t)}))},t.prototype.allocateQuery=function(t){var n=this;return this.persistence.runTransaction("Allocate query","readwrite",(function(e){var i;return n.queryCache.getQueryData(e,t).next((function(r){return r?(i=r,qt.resolve()):n.queryCache.allocateTargetId(e).next((function(r){return i=new ke(t,r,be.Listen,e.currentSequenceNumber),n.queryCache.addQueryData(e,i)}))})).next((function(){return l(!n.queryDataByTarget[i.targetId],"Tried to allocate an already allocated query: "+t),n.queryDataByTarget[i.targetId]=i,i}))}))},t.prototype.releaseQuery=function(t,n){var e=this;return this.persistence.runTransaction("Release query",n?"readwrite":"readwrite-primary",(function(i){return e.queryCache.getQueryData(i,t).next((function(r){l(null!=r,"Tried to release nonexistent query: "+t);var u=r.targetId,s=e.queryDataByTarget[u],o=e.localViewReferences.removeReferencesForId(u);return delete e.queryDataByTarget[u],n?qt.resolve():qt.forEach(o,(function(t){return e.persistence.referenceDelegate.removeReference(i,t)})).next((function(){return e.persistence.referenceDelegate.removeTarget(i,s)}))}))}))},t.prototype.executeQuery=function(t){var n=this;return this.persistence.runTransaction("Execute query","readonly",(function(e){return n.localDocuments.getDocumentsMatchingQuery(e,t)}))},t.prototype.remoteDocumentKeys=function(t){var n=this;return this.persistence.runTransaction("Remote document keys","readonly",(function(e){return n.queryCache.getMatchingKeysForTargetId(e,t)}))},t.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},t.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},t.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},t.prototype.applyWriteToRemoteDocuments=function(t,n,e){var i=this,r=n.batch,u=r.keys(),s=qt.resolve();return u.forEach((function(i){s=s.next((function(){return e.getEntry(t,i)})).next((function(t){var u=t,s=n.docVersions.get(i);l(null!==s,"ackVersions should contain every doc in the write."),(!u||u.version.compareTo(s)<0)&&((u=r.applyToRemoteDocument(i,u,n))?e.addEntry(u):l(!t,"Mutation batch "+r+" applied to document "+t+" resulted in null"))}))})),s.next((function(){return i.mutationQueue.removeMutationBatch(t,r)}))},t.prototype.collectGarbage=function(t){var n=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",(function(e){return t.collect(e,n.queryDataByTarget)}))},t.prototype.getQueryForTarget=function(t){var n=this;return this.queryDataByTarget[t]?Promise.resolve(this.queryDataByTarget[t].query):this.persistence.runTransaction("Get query data","readonly",(function(e){return n.queryCache.getQueryDataForTarget(e,t).next((function(t){return t?t.query:null}))}))},t.prototype.getNewDocumentChanges=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly",(function(n){return t.remoteDocuments.getNewDocumentChanges(n)}))},t.RESUME_TOKEN_MAX_AGE_MICROS=3e8,t}(),We=function(){function t(t,n){this.indexManager=t,this.referenceDelegate=n,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=v(),this.batchesByDocumentKey=new Et(ze.compareByKey)}return t.prototype.checkEmpty=function(){return qt.resolve(0===this.mutationQueue.length)},t.prototype.acknowledgeBatch=function(t,n,e){var i=n.batchId,r=this.indexOfExistingBatchId(i,"acknowledged");l(0===r,"Can only acknowledge the first batch in the mutation queue");var u=this.mutationQueue[r];return l(i===u.batchId,"Queue ordering failure: expected batch "+i+", got batch "+u.batchId),this.lastStreamToken=e,qt.resolve()},t.prototype.getLastStreamToken=function(){return qt.resolve(this.lastStreamToken)},t.prototype.setLastStreamToken=function(t,n){return this.lastStreamToken=n,qt.resolve()},t.prototype.addMutationBatch=function(t,n,e,i){l(0!==i.length,"Mutation batches should not be empty");var r=this.nextBatchId;this.nextBatchId++,this.mutationQueue.length>0&&l(this.mutationQueue[this.mutationQueue.length-1].batchId<r,"Mutation batchIDs must be monotonically increasing order");var u=new $t(r,n,e,i);this.mutationQueue.push(u);for(var s=0,o=i;s<o.length;s++){var a=o[s];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new ze(a.key,r)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast())}return qt.resolve(u)},t.prototype.lookupMutationBatch=function(t,n){return qt.resolve(this.findMutationBatch(n))},t.prototype.lookupMutationKeys=function(t,n){var e=this.findMutationBatch(n);return l(null!=e,"Failed to find local mutation batch."),qt.resolve(e.keys())},t.prototype.getNextMutationBatchAfterBatchId=function(t,n){var e=this.indexOfBatchId(n+1),i=e<0?0:e;return qt.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},t.prototype.getHighestUnacknowledgedBatchId=function(){return qt.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},t.prototype.getAllMutationBatches=function(){return qt.resolve(this.mutationQueue.slice())},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,n){var e=this,i=new ze(n,0),r=new ze(n,Number.POSITIVE_INFINITY),u=[];return this.batchesByDocumentKey.forEachInRange([i,r],(function(t){l(n.isEqual(t.key),"Should only iterate over a single key's batches");var i=e.findMutationBatch(t.targetOrBatchId);l(null!==i,"Batches in the index must exist in the main table"),u.push(i)})),qt.resolve(u)},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,n){var e=this,i=new Et(G);return n.forEach((function(t){var n=new ze(t,0),r=new ze(t,Number.POSITIVE_INFINITY);e.batchesByDocumentKey.forEachInRange([n,r],(function(n){l(t.isEqual(n.key),"For each key, should only iterate over a single key's batches"),i=i.add(n.targetOrBatchId)}))})),qt.resolve(this.findMutationBatches(i))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,n){l(!n.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var e=n.path,i=e.length+1,r=e;at.isDocumentKey(r)||(r=r.child(""));var u=new ze(new at(r),0),s=new Et(G);return this.batchesByDocumentKey.forEachWhile((function(t){var n=t.key.path;return!!e.isPrefixOf(n)&&(n.length===i&&(s=s.add(t.targetOrBatchId)),!0)}),u),qt.resolve(this.findMutationBatches(s))},t.prototype.findMutationBatches=function(t){var n=this,e=[];return t.forEach((function(t){var i=n.findMutationBatch(t);null!==i&&e.push(i)})),e},t.prototype.removeMutationBatch=function(t,n){var e=this;l(0===this.indexOfExistingBatchId(n.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var i=this.batchesByDocumentKey;return qt.forEach(n.mutations,(function(r){var u=new ze(r.key,n.batchId);return i=i.delete(u),e.referenceDelegate.removeMutationReference(t,r.key)})).next((function(){e.batchesByDocumentKey=i}))},t.prototype.removeCachedMutationKeys=function(){},t.prototype.containsKey=function(t,n){var e=new ze(n,0),i=this.batchesByDocumentKey.firstAfterOrEqual(e);return qt.resolve(n.isEqual(i&&i.key))},t.prototype.performConsistencyCheck=function(){return 0===this.mutationQueue.length&&l(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),qt.resolve()},t.prototype.indexOfExistingBatchId=function(t,n){var e=this.indexOfBatchId(t);return l(e>=0&&e<this.mutationQueue.length,"Batches must exist to be "+n),e},t.prototype.indexOfBatchId=function(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId},t.prototype.findMutationBatch=function(t){var n=this.indexOfBatchId(t);if(n<0||n>=this.mutationQueue.length)return null;var e=this.mutationQueue[n];return l(e.batchId===t,"If found batch must match"),e},t}(),Ge=function(){function t(t){this.persistence=t,this.queries=new Vn((function(t){return t.canonicalId()})),this.lastRemoteSnapshotVersion=_t.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new Be,this.targetCount=0,this.targetIdGenerator=Kt.forQueryCache()}return t.prototype.getTargetCount=function(){return qt.resolve(this.targetCount)},t.prototype.forEachTarget=function(t,n){return this.queries.forEach((function(t,e){return n(e)})),qt.resolve()},t.prototype.getLastRemoteSnapshotVersion=function(){return qt.resolve(this.lastRemoteSnapshotVersion)},t.prototype.getHighestSequenceNumber=function(){return qt.resolve(this.highestSequenceNumber)},t.prototype.allocateTargetId=function(){var t=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=t,qt.resolve(t)},t.prototype.setTargetsMetadata=function(t,n,e){return e&&(this.lastRemoteSnapshotVersion=e),n>this.highestSequenceNumber&&(this.highestSequenceNumber=n),qt.resolve()},t.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var n=t.targetId;n>this.highestTargetId&&(this.highestTargetId=n),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},t.prototype.addQueryData=function(t,n){return l(!this.queries.has(n.query),"Adding a query that already exists"),this.saveQueryData(n),this.targetCount+=1,qt.resolve()},t.prototype.updateQueryData=function(t,n){return l(this.queries.has(n.query),"Updating a non-existent query"),this.saveQueryData(n),qt.resolve()},t.prototype.removeQueryData=function(t,n){return l(this.targetCount>0,"Removing a target from an empty cache"),l(this.queries.has(n.query),"Removing a non-existent target from the cache"),this.queries.delete(n.query),this.references.removeReferencesForId(n.targetId),this.targetCount-=1,qt.resolve()},t.prototype.removeTargets=function(t,n,e){var i=this,r=0,u=[];return this.queries.forEach((function(s,o){o.sequenceNumber<=n&&!e[o.targetId]&&(i.queries.delete(s),u.push(i.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),qt.waitFor(u).next((function(){return r}))},t.prototype.getQueryCount=function(){return qt.resolve(this.targetCount)},t.prototype.getQueryData=function(t,n){var e=this.queries.get(n)||null;return qt.resolve(e)},t.prototype.getQueryDataForTarget=function(){return f("Not yet implemented.")},t.prototype.addMatchingKeys=function(t,n,e){this.references.addReferences(n,e);var i=this.persistence.referenceDelegate,r=[];return i&&n.forEach((function(n){r.push(i.addReference(t,n))})),qt.waitFor(r)},t.prototype.removeMatchingKeys=function(t,n,e){this.references.removeReferences(n,e);var i=this.persistence.referenceDelegate,r=[];return i&&n.forEach((function(n){r.push(i.removeReference(t,n))})),qt.waitFor(r)},t.prototype.removeMatchingKeysForTargetId=function(t,n){return this.references.removeReferencesForId(n),qt.resolve()},t.prototype.getMatchingKeysForTargetId=function(t,n){var e=this.references.referencesForId(n);return qt.resolve(e)},t.prototype.containsKey=function(t,n){return qt.resolve(this.references.containsKey(n))},t}(),Qe=function(){function t(t,n){this.indexManager=t,this.sizer=n,this.docs=new Ot(at.comparator),this.newDocumentChanges=Ft(),this.size=0}return t.prototype.addEntry=function(t,n){var e=n.key,i=this.docs.get(e),r=i?i.size:0,u=this.sizer(n);return this.docs=this.docs.insert(e,{maybeDocument:n,size:u}),this.newDocumentChanges=this.newDocumentChanges.add(e),this.size+=u-r,this.indexManager.addToCollectionParentIndex(t,e.path.popLast())},t.prototype.removeEntry=function(t){var n=this.docs.get(t);n&&(this.docs=this.docs.remove(t),this.size-=n.size)},t.prototype.getEntry=function(t,n){var e=this.docs.get(n);return qt.resolve(e?e.maybeDocument:null)},t.prototype.getEntries=function(t,n){var e=this,i=At();return n.forEach((function(t){var n=e.docs.get(t);i=i.insert(t,n?n.maybeDocument:null)})),qt.resolve(i)},t.prototype.getDocumentsMatchingQuery=function(t,n){l(!n.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var e=Nt(),i=new at(n.path.child("")),r=this.docs.getIteratorFrom(i);r.hasNext();){var u=r.getNext(),s=u.value.maybeDocument;if(!n.path.isPrefixOf(u.key.path))break;s instanceof qn&&n.matches(s)&&(e=e.insert(s.key,s))}return qt.resolve(e)},t.prototype.forEachDocumentKey=function(t,n){return qt.forEach(this.docs,(function(t){return n(t)}))},t.prototype.getNewDocumentChanges=function(){var t=this,n=Mt();return this.newDocumentChanges.forEach((function(e){var i=t.docs.get(e),r=i?i.maybeDocument:new Bn(e,_t.forDeletedDoc());n=n.insert(e,r)})),this.newDocumentChanges=Ft(),qt.resolve(n)},t.prototype.newChangeBuffer=function(){return new t.RemoteDocumentChangeBuffer(this)},t.prototype.getSize=function(){return qt.resolve(this.size)},t.RemoteDocumentChangeBuffer=function(t){function n(n){var e=t.call(this)||this;return e.documentCache=n,e}return b.__extends(n,t),n.prototype.applyChanges=function(t){var n=this,e=[];return this.changes.forEach((function(i,r){r?e.push(n.documentCache.addEntry(t,r)):n.documentCache.removeEntry(i)})),qt.waitFor(e)},n.prototype.getFromCache=function(t,n){return this.documentCache.getEntry(t,n)},n.prototype.getAllFromCache=function(t,n){return this.documentCache.getEntries(t,n)},n}(Wn),t}(),Ye=function(){function t(t,n){var e=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new it(0),this._started=!1,this._started=!0,this.referenceDelegate=n(this),this.queryCache=new Ge(this),this.indexManager=new Zn,this.remoteDocumentCache=new Qe(this.indexManager,(function(t){return e.referenceDelegate.documentSize(t)}))}return t.createLruPersistence=function(n,e,i){return new t(n,(function(t){return new Ke(t,new je(e),i)}))},t.createEagerPersistence=function(n){return new t(n,(function(t){return new Je(t)}))},t.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getActiveClients=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return[2,[this.clientId]]}))}))},t.prototype.setPrimaryStateListener=function(t){return t(!0)},t.prototype.setDatabaseDeletedListener=function(){},t.prototype.setNetworkEnabled=function(){},t.prototype.getIndexManager=function(){return this.indexManager},t.prototype.getMutationQueue=function(t){var n=this.mutationQueues[t.toKey()];return n||(n=new We(this.indexManager,this.referenceDelegate),this.mutationQueues[t.toKey()]=n),n},t.prototype.getQueryCache=function(){return this.queryCache},t.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},t.prototype.runTransaction=function(t,n,e){var i=this;a("MemoryPersistence","Starting transaction:",t);var r=new He(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),e(r).next((function(t){return i.referenceDelegate.onTransactionCommitted(r).next((function(){return t}))})).toPromise()},t.prototype.mutationQueuesContainKey=function(t,n){return qt.or((e=this.mutationQueues,i=[],k(e,(function(t,n){return i.push(n)})),i).map((function(e){return function(){return e.containsKey(t,n)}})));var e,i},t}(),He=function(t){this.currentSequenceNumber=t},Je=function(){function t(t){this.persistence=t,this.inMemoryPins=null,this._orphanedDocuments=null}return Object.defineProperty(t.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw f("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,n){return this.orphanedDocuments.delete(n),qt.resolve()},t.prototype.removeReference=function(t,n){return this.orphanedDocuments.add(n),qt.resolve()},t.prototype.removeMutationReference=function(t,n){return this.orphanedDocuments.add(n),qt.resolve()},t.prototype.removeTarget=function(t,n){var e=this,i=this.persistence.getQueryCache();return i.getMatchingKeysForTargetId(t,n.targetId).next((function(t){t.forEach((function(t){return e.orphanedDocuments.add(t)}))})).next((function(){return i.removeQueryData(t,n)}))},t.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},t.prototype.onTransactionCommitted=function(t){var n=this,e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return qt.forEach(this.orphanedDocuments,(function(i){return n.isReferenced(t,i).next((function(t){t||e.removeEntry(i)}))})).next((function(){return n._orphanedDocuments=null,e.apply(t)}))},t.prototype.updateLimboDocument=function(t,n){var e=this;return this.isReferenced(t,n).next((function(t){t?e.orphanedDocuments.delete(n):e.orphanedDocuments.add(n)}))},t.prototype.documentSize=function(){return 0},t.prototype.isReferenced=function(t,n){var e=this;return qt.or([function(){return e.persistence.getQueryCache().containsKey(t,n)},function(){return e.persistence.mutationQueuesContainKey(t,n)},function(){return qt.resolve(e.inMemoryPins.containsKey(n))}])},t}(),Ke=function(){function t(t,n,e){this.persistence=t,this.serializer=n,this.inMemoryPins=null,this.orphanedSequenceNumbers=new Vn((function(t){return wt(t.path)})),this.garbageCollector=new Ae(this,e)}return t.prototype.onTransactionStarted=function(){},t.prototype.onTransactionCommitted=function(){return qt.resolve()},t.prototype.forEachTarget=function(t,n){return this.persistence.getQueryCache().forEachTarget(t,n)},t.prototype.getSequenceNumberCount=function(t){var n=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next((function(t){return n.next((function(n){return t+n}))}))},t.prototype.orphanedDocumentCount=function(t){var n=0;return this.forEachOrphanedDocumentSequenceNumber(t,(function(){n++})).next((function(){return n}))},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,n){var e=this;return qt.forEach(this.orphanedSequenceNumbers,(function(i,r){return e.isPinned(t,i,r).next((function(t){return t?qt.resolve():n(r)}))}))},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.removeTargets=function(t,n,e){return this.persistence.getQueryCache().removeTargets(t,n,e)},t.prototype.removeOrphanedDocuments=function(t,n){var e=this,i=0,r=this.persistence.getRemoteDocumentCache(),u=r.newChangeBuffer();return r.forEachDocumentKey(t,(function(r){return e.isPinned(t,r,n).next((function(t){t||(i++,u.removeEntry(r))}))})).next((function(){return u.apply(t)})).next((function(){return i}))},t.prototype.removeMutationReference=function(t,n){return this.orphanedSequenceNumbers.set(n,t.currentSequenceNumber),qt.resolve()},t.prototype.removeTarget=function(t,n){var e=n.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getQueryCache().updateQueryData(t,e)},t.prototype.addReference=function(t,n){return this.orphanedSequenceNumbers.set(n,t.currentSequenceNumber),qt.resolve()},t.prototype.removeReference=function(t,n){return this.orphanedSequenceNumbers.set(n,t.currentSequenceNumber),qt.resolve()},t.prototype.updateLimboDocument=function(t,n){return this.orphanedSequenceNumbers.set(n,t.currentSequenceNumber),qt.resolve()},t.prototype.documentSize=function(t){var n,e=this.serializer.toDbRemoteDocument(t);if(e.document)n=e.document;else if(e.unknownDocument)n=e.unknownDocument;else{if(!e.noDocument)throw f("Unknown remote document type");n=e.noDocument}return JSON.stringify(n).length},t.prototype.isPinned=function(t,n,e){var i=this;return qt.or([function(){return i.persistence.mutationQueuesContainKey(t,n)},function(){return qt.resolve(i.inMemoryPins.containsKey(n))},function(){return i.persistence.getQueryCache().containsKey(t,n)},function(){var t=i.orphanedSequenceNumbers.get(n);return qt.resolve(void 0!==t&&t>e)}])},t.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},t}(),Xe=Number,Ze=Xe.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),ti=Xe.MAX_SAFE_INTEGER||Math.pow(2,53)-1,ni=Xe.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t};function ei(t){return null==t}function ii(t){return ni(t)&&t<=ti&&t>=Ze}var ri,ui=1e3,si=1.5,oi=6e4,ai=function(){function t(t,n,e,i,r){void 0===e&&(e=ui),void 0===i&&(i=si),void 0===r&&(r=oi),this.queue=t,this.timerId=n,this.initialDelayMs=e,this.backoffFactor=i,this.maxDelayMs=r,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return t.prototype.reset=function(){this.currentBaseMs=0},t.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},t.prototype.backoffAndRun=function(t){var n=this;this.cancel();var e=Math.floor(this.currentBaseMs+this.jitterDelayMs()),i=Math.max(0,Date.now()-this.lastAttemptTime),r=Math.max(0,e-i);this.currentBaseMs>0&&a("ExponentialBackoff","Backing off for "+r+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+e+" ms, last attempt: "+i+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,r,(function(){return n.lastAttemptTime=Date.now(),t()})),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},t.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},t.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},t}();!function(t){t[t.Initial=0]="Initial",t[t.Starting=1]="Starting",t[t.Open=2]="Open",t[t.Error=3]="Error",t[t.Backoff=4]="Backoff"}(ri||(ri={}));var ci,hi,fi=function(){function t(t,n,e,i,r,u){this.queue=t,this.idleTimerId=e,this.connection=i,this.credentialsProvider=r,this.listener=u,this.state=ri.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new ai(t,n)}return t.prototype.isStarted=function(){return this.state===ri.Starting||this.state===ri.Open||this.state===ri.Backoff},t.prototype.isOpen=function(){return this.state===ri.Open},t.prototype.start=function(){this.state!==ri.Error?(l(this.state===ri.Initial,"Already started"),this.auth()):this.performBackoff()},t.prototype.stop=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(ri.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.inhibitBackoff=function(){l(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=ri.Initial,this.backoff.reset()},t.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,(function(){return t.handleIdleCloseTimer()})))},t.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},t.prototype.handleIdleCloseTimer=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return this.isOpen()?[2,this.close(ri.Initial)]:[2]}))}))},t.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},t.prototype.close=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(e){switch(e.label){case 0:return l(this.isStarted(),"Only started streams should be closed."),l(t===ri.Error||ei(n),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,t!==ri.Error?this.backoff.reset():n&&n.code===m.RESOURCE_EXHAUSTED?(c(n.toString()),c("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):n&&n.code===m.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(n)];case 1:return e.sent(),[2]}}))}))},t.prototype.tearDown=function(){},t.prototype.auth=function(){var t=this;l(this.state===ri.Initial,"Must be in initial state to auth"),this.state=ri.Starting;var n=this.getCloseGuardedDispatcher(this.closeCount),e=this.closeCount;this.credentialsProvider.getToken().then((function(n){t.closeCount===e&&t.startStream(n)}),(function(e){n((function(){var n=new w(m.UNKNOWN,"Fetching auth token failed: "+e.message);return t.handleStreamClose(n)}))}))},t.prototype.startStream=function(t){var n=this;l(this.state===ri.Starting,"Trying to start stream in a non-starting state");var e=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen((function(){e((function(){return l(n.state===ri.Starting,"Expected stream to be in state Starting, but was "+n.state),n.state=ri.Open,n.listener.onOpen()}))})),this.stream.onClose((function(t){e((function(){return n.handleStreamClose(t)}))})),this.stream.onMessage((function(t){e((function(){return n.onMessage(t)}))}))},t.prototype.performBackoff=function(){var t=this;l(this.state===ri.Error,"Should only perform backoff when in Error state"),this.state=ri.Backoff,this.backoff.backoffAndRun((function(){return b.__awaiter(t,void 0,void 0,(function(){return b.__generator(this,(function(){return l(this.state===ri.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=ri.Initial,this.start(),l(this.isStarted(),"PersistentStream should have started"),[2]}))}))}))},t.prototype.handleStreamClose=function(t){return l(this.isStarted(),"Can't handle server close on non-started stream"),a("PersistentStream","close with error: "+t),this.stream=null,this.close(ri.Error,t)},t.prototype.getCloseGuardedDispatcher=function(t){var n=this;return function(e){n.queue.enqueueAndForget((function(){return n.closeCount===t?e():(a("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}},t}(),li=function(t){function n(n,e,i,r,u){var s=t.call(this,n,K.ListenStreamConnectionBackoff,K.ListenStreamIdle,e,i,u)||this;return s.serializer=r,s}return b.__extends(n,t),n.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},n.prototype.onMessage=function(t){this.backoff.reset();var n=this.serializer.fromWatchChange(t),e=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(n,e)},n.prototype.watch=function(t){var n={};n.database=this.serializer.encodedDatabaseId,n.addTarget=this.serializer.toTarget(t);var e=this.serializer.toListenRequestLabels(t);e&&(n.labels=e),this.sendRequest(n)},n.prototype.unwatch=function(t){var n={};n.database=this.serializer.encodedDatabaseId,n.removeTarget=t,this.sendRequest(n)},n}(fi),di=function(t){function n(n,e,i,r,u){var s=t.call(this,n,K.WriteStreamConnectionBackoff,K.WriteStreamIdle,e,i,u)||this;return s.serializer=r,s.handshakeComplete_=!1,s.lastStreamToken=v(),s}return b.__extends(n,t),Object.defineProperty(n.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),n.prototype.start=function(){this.handshakeComplete_=!1,t.prototype.start.call(this)},n.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},n.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},n.prototype.onMessage=function(t){if(l(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var n=this.serializer.fromWriteResults(t.writeResults,t.commitTime),e=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(e,n)}return l(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},n.prototype.writeHandshake=function(){l(this.isOpen(),"Writing handshake requires an opened stream"),l(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},n.prototype.writeMutations=function(t){var n=this;l(this.isOpen(),"Writing mutations requires an opened stream"),l(this.handshakeComplete_,"Handshake must be complete before writing mutations"),l(this.lastStreamToken.length>0,"Trying to write mutation without a token");var e={streamToken:this.lastStreamToken,writes:t.map((function(t){return n.serializer.toMutation(t)}))};this.sendRequest(e)},n}(fi),vi=function(){function t(t,n,e,i){this.queue=t,this.connection=n,this.credentials=e,this.serializer=i}return t.prototype.newPersistentWriteStream=function(t){return new di(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.newPersistentWatchStream=function(t){return new li(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.commit=function(t){var n=this,e={database:this.serializer.encodedDatabaseId,writes:t.map((function(t){return n.serializer.toMutation(t)}))};return this.invokeRPC("Commit",e).then((function(t){return n.serializer.fromWriteResults(t.writeResults,t.commitTime)}))},t.prototype.lookup=function(t){var n=this,e={database:this.serializer.encodedDatabaseId,documents:t.map((function(t){return n.serializer.toName(t)}))};return this.invokeStreamingRPC("BatchGetDocuments",e).then((function(e){var i=Mt();e.forEach((function(t){var e=n.serializer.fromMaybeDocument(t);i=i.insert(e.key,e)}));var r=[];return t.forEach((function(t){var n=i.get(t);l(!!n,"Missing entity in write response for "+t),r.push(n)})),r}))},t.prototype.invokeRPC=function(t,n){var e=this;return this.credentials.getToken().then((function(i){return e.connection.invokeRPC(t,n,i)})).catch((function(t){throw t.code===m.UNAUTHENTICATED&&e.credentials.invalidateToken(),t}))},t.prototype.invokeStreamingRPC=function(t,n){var e=this;return this.credentials.getToken().then((function(i){return e.connection.invokeStreamingRPC(t,n,i)})).catch((function(t){throw t.code===m.UNAUTHENTICATED&&e.credentials.invalidateToken(),t}))},t}(),mi=function(){function t(t){this.datastore=t,this.readVersions=Ct(),this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}return t.prototype.lookup=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e=this;return b.__generator(this,(function(i){switch(i.label){case 0:if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new w(m.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.datastore.lookup(t)];case 1:return(n=i.sent()).forEach((function(t){t instanceof Bn||t instanceof qn?e.recordVersion(t):f("Document in a transaction was a "+t.constructor.name)})),[2,n]}}))}))},t.prototype.set=function(t,n){this.write(n.toMutations(t,this.precondition(t))),this.writtenDocs.add(t)},t.prototype.update=function(t,n){try{this.write(n.toMutations(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t)},t.prototype.delete=function(t){this.write([new kn(t,this.precondition(t))]),this.writtenDocs.add(t)},t.prototype.commit=function(){return b.__awaiter(this,void 0,void 0,(function(){var t;return b.__generator(this,(function(n){switch(n.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;if(t=this.readVersions,this.mutations.forEach((function(n){t=t.remove(n.key)})),!t.isEmpty())throw new w(m.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return[4,this.datastore.commit(this.mutations)];case 1:return n.sent(),this.committed=!0,[2]}}))}))},t.prototype.recordVersion=function(t){var n;if(t instanceof qn)n=t.version;else{if(!(t instanceof Bn))throw f("Document in a transaction was a "+t.constructor.name);n=_t.forDeletedDoc()}var e=this.readVersions.get(t.key);if(null!==e){if(!n.isEqual(e))throw new w(m.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,n)},t.prototype.precondition=function(t){var n=this.readVersions.get(t);return!this.writtenDocs.has(t)&&n?pn.updateTime(n):pn.NONE},t.prototype.preconditionForUpdate=function(t){var n=this.readVersions.get(t);if(!this.writtenDocs.has(t)&&n){if(n.isEqual(_t.forDeletedDoc()))throw new w(m.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return pn.updateTime(n)}return pn.exists(!0)},t.prototype.write=function(t){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(t)},t.prototype.ensureCommitNotCalled=function(){l(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},t}();!function(t){t[t.Unknown=0]="Unknown",t[t.Online=1]="Online",t[t.Offline=2]="Offline"}(ci||(ci={})),function(t){t[t.RemoteStore=0]="RemoteStore",t[t.SharedClientState=1]="SharedClientState"}(hi||(hi={}));var wi,bi=function(){function t(t,n){this.asyncQueue=t,this.onlineStateHandler=n,this.state=ci.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return t.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(ci.Unknown),l(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(K.OnlineStateTimeout,1e4,(function(){return t.onlineStateTimer=null,l(t.state===ci.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(ci.Offline),Promise.resolve()})))},t.prototype.handleWatchStreamFailure=function(t){this.state===ci.Online?(this.setAndBroadcast(ci.Unknown),l(0===this.watchStreamFailures,"watchStreamFailures must be 0"),l(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(ci.Offline)))},t.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===ci.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},t.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},t.prototype.logClientOfflineWarningIfNecessary=function(t){var n="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(c(n),this.shouldWarnClientIsOffline=!1):a("OnlineStateTracker",n)},t.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},t}();function pi(t){switch(t){case m.OK:return f("Treated status OK as error");case m.CANCELLED:case m.UNKNOWN:case m.DEADLINE_EXCEEDED:case m.RESOURCE_EXHAUSTED:case m.INTERNAL:case m.UNAVAILABLE:case m.UNAUTHENTICATED:return!1;case m.INVALID_ARGUMENT:case m.NOT_FOUND:case m.ALREADY_EXISTS:case m.PERMISSION_DENIED:case m.FAILED_PRECONDITION:case m.ABORTED:case m.OUT_OF_RANGE:case m.UNIMPLEMENTED:case m.DATA_LOSS:return!0;default:return f("Unknown status code: "+t)}}function gi(t){if(void 0===t)return c("GRPC error has no .code"),m.UNKNOWN;switch(t){case wi.OK:return m.OK;case wi.CANCELLED:return m.CANCELLED;case wi.UNKNOWN:return m.UNKNOWN;case wi.DEADLINE_EXCEEDED:return m.DEADLINE_EXCEEDED;case wi.RESOURCE_EXHAUSTED:return m.RESOURCE_EXHAUSTED;case wi.INTERNAL:return m.INTERNAL;case wi.UNAVAILABLE:return m.UNAVAILABLE;case wi.UNAUTHENTICATED:return m.UNAUTHENTICATED;case wi.INVALID_ARGUMENT:return m.INVALID_ARGUMENT;case wi.NOT_FOUND:return m.NOT_FOUND;case wi.ALREADY_EXISTS:return m.ALREADY_EXISTS;case wi.PERMISSION_DENIED:return m.PERMISSION_DENIED;case wi.FAILED_PRECONDITION:return m.FAILED_PRECONDITION;case wi.ABORTED:return m.ABORTED;case wi.OUT_OF_RANGE:return m.OUT_OF_RANGE;case wi.UNIMPLEMENTED:return m.UNIMPLEMENTED;case wi.DATA_LOSS:return m.DATA_LOSS;default:return f("Unknown status code: "+t)}}function yi(t){if(void 0===t)return wi.OK;switch(t){case m.OK:return wi.OK;case m.CANCELLED:return wi.CANCELLED;case m.UNKNOWN:return wi.UNKNOWN;case m.DEADLINE_EXCEEDED:return wi.DEADLINE_EXCEEDED;case m.RESOURCE_EXHAUSTED:return wi.RESOURCE_EXHAUSTED;case m.INTERNAL:return wi.INTERNAL;case m.UNAVAILABLE:return wi.UNAVAILABLE;case m.UNAUTHENTICATED:return wi.UNAUTHENTICATED;case m.INVALID_ARGUMENT:return wi.INVALID_ARGUMENT;case m.NOT_FOUND:return wi.NOT_FOUND;case m.ALREADY_EXISTS:return wi.ALREADY_EXISTS;case m.PERMISSION_DENIED:return wi.PERMISSION_DENIED;case m.FAILED_PRECONDITION:return wi.FAILED_PRECONDITION;case m.ABORTED:return wi.ABORTED;case m.OUT_OF_RANGE:return wi.OUT_OF_RANGE;case m.UNIMPLEMENTED:return wi.UNIMPLEMENTED;case m.DATA_LOSS:return wi.DATA_LOSS;default:return f("Unknown status code: "+t)}}!function(t){t[t.OK=0]="OK",t[t.CANCELLED=1]="CANCELLED",t[t.UNKNOWN=2]="UNKNOWN",t[t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",t[t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",t[t.NOT_FOUND=5]="NOT_FOUND",t[t.ALREADY_EXISTS=6]="ALREADY_EXISTS",t[t.PERMISSION_DENIED=7]="PERMISSION_DENIED",t[t.UNAUTHENTICATED=16]="UNAUTHENTICATED",t[t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",t[t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",t[t.ABORTED=10]="ABORTED",t[t.OUT_OF_RANGE=11]="OUT_OF_RANGE",t[t.UNIMPLEMENTED=12]="UNIMPLEMENTED",t[t.INTERNAL=13]="INTERNAL",t[t.UNAVAILABLE=14]="UNAVAILABLE",t[t.DATA_LOSS=15]="DATA_LOSS"}(wi||(wi={}));var _i,Oi,ki=function(){function t(t){this.comparator=t?function(n,e){return t(n,e)||at.comparator(n.key,e.key)}:function(t,n){return at.comparator(t.key,n.key)},this.keyedMap=Nt(),this.sortedSet=new Ot(this.comparator)}return t.emptySet=function(n){return new t(n.comparator)},t.prototype.has=function(t){return null!=this.keyedMap.get(t)},t.prototype.get=function(t){return this.keyedMap.get(t)},t.prototype.first=function(){return this.sortedSet.minKey()},t.prototype.last=function(){return this.sortedSet.maxKey()},t.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},t.prototype.indexOf=function(t){var n=this.keyedMap.get(t);return n?this.sortedSet.indexOf(n):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){this.sortedSet.inorderTraversal((function(n){return t(n),!1}))},t.prototype.add=function(t){var n=this.delete(t.key);return n.copy(n.keyedMap.insert(t.key,t),n.sortedSet.insert(t,null))},t.prototype.delete=function(t){var n=this.get(t);return n?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(n)):this},t.prototype.isEqual=function(n){if(!(n instanceof t))return!1;if(this.size!==n.size)return!1;for(var e=this.sortedSet.getIterator(),i=n.sortedSet.getIterator();e.hasNext();){var r=e.getNext().key,u=i.getNext().key;if(!r.isEqual(u))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach((function(n){t.push(n.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(n,e){var i=new t;return i.comparator=this.comparator,i.keyedMap=n,i.sortedSet=e,i},t}();!function(t){t[t.Added=0]="Added",t[t.Removed=1]="Removed",t[t.Modified=2]="Modified",t[t.Metadata=3]="Metadata"}(_i||(_i={})),function(t){t[t.Local=0]="Local",t[t.Synced=1]="Synced"}(Oi||(Oi={}));var ji,Si=function(){function t(){this.changeMap=new Ot(at.comparator)}return t.prototype.track=function(t){var n=t.doc.key,e=this.changeMap.get(n);e?t.type!==_i.Added&&e.type===_i.Metadata?this.changeMap=this.changeMap.insert(n,t):t.type===_i.Metadata&&e.type!==_i.Removed?this.changeMap=this.changeMap.insert(n,{type:e.type,doc:t.doc}):t.type===_i.Modified&&e.type===_i.Modified?this.changeMap=this.changeMap.insert(n,{type:_i.Modified,doc:t.doc}):t.type===_i.Modified&&e.type===_i.Added?this.changeMap=this.changeMap.insert(n,{type:_i.Added,doc:t.doc}):t.type===_i.Removed&&e.type===_i.Added?this.changeMap=this.changeMap.remove(n):t.type===_i.Removed&&e.type===_i.Modified?this.changeMap=this.changeMap.insert(n,{type:_i.Removed,doc:e.doc}):t.type===_i.Added&&e.type===_i.Removed?this.changeMap=this.changeMap.insert(n,{type:_i.Modified,doc:t.doc}):f("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(e)):this.changeMap=this.changeMap.insert(n,t)},t.prototype.getChanges=function(){var t=[];return this.changeMap.inorderTraversal((function(n,e){t.push(e)})),t},t}(),Ei=function(){function t(t,n,e,i,r,u,s,o){this.query=t,this.docs=n,this.oldDocs=e,this.docChanges=i,this.mutatedKeys=r,this.fromCache=u,this.syncStateChanged=s,this.excludesMetadataChanges=o}return t.fromInitialDocuments=function(n,e,i,r){var u=[];return e.forEach((function(t){u.push({type:_i.Added,doc:t})})),new t(n,e,ki.emptySet(e),u,i,r,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var n=this.docChanges,e=t.docChanges;if(n.length!==e.length)return!1;for(var i=0;i<n.length;i++)if(n[i].type!==e[i].type||!n[i].doc.isEqual(e[i].doc))return!1;return!0},t}(),Di=function(){function t(t,n,e,i,r){this.snapshotVersion=t,this.targetChanges=n,this.targetMismatches=e,this.documentUpdates=i,this.resolvedLimboDocuments=r}return t.createSynthesizedRemoteEventForCurrentChange=function(n,e){var i,r=((i={})[n]=Ii.createSynthesizedTargetChangeForCurrentChange(n,e),i);return new t(_t.MIN,r,Ut(),Mt(),Ft())},t}(),Ii=function(){function t(t,n,e,i,r){this.resumeToken=t,this.current=n,this.addedDocuments=e,this.modifiedDocuments=i,this.removedDocuments=r}return t.createSynthesizedTargetChangeForCurrentChange=function(n,e){return new t(v(),e,Ft(),Ft(),Ft())},t}(),Mi=function(t,n,e,i){this.updatedTargetIds=t,this.removedTargetIds=n,this.key=e,this.newDoc=i},Ai=function(t,n){this.targetId=t,this.existenceFilter=n};!function(t){t[t.NoChange=0]="NoChange",t[t.Added=1]="Added",t[t.Removed=2]="Removed",t[t.Current=3]="Current",t[t.Reset=4]="Reset"}(ji||(ji={}));var Ni=function(t,n,e,i){void 0===e&&(e=v()),void 0===i&&(i=null),this.state=t,this.targetIds=n,this.resumeToken=e,this.cause=i},xi=function(){function t(){this.pendingResponses=0,this.documentChanges=Fi(),this._resumeToken=v(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(t.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),t.prototype.updateResumeToken=function(t){t.length>0&&(this._hasPendingChanges=!0,this._resumeToken=t)},t.prototype.toTargetChange=function(){var t=Ft(),n=Ft(),e=Ft();return this.documentChanges.forEach((function(i,r){switch(r){case _i.Added:t=t.add(i);break;case _i.Modified:n=n.add(i);break;case _i.Removed:e=e.add(i);break;default:f("Encountered invalid change type: "+r)}})),new Ii(this._resumeToken,this._current,t,n,e)},t.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Fi()},t.prototype.addDocumentChange=function(t,n){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,n)},t.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},t.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},t.prototype.recordTargetResponse=function(){this.pendingResponses-=1},t.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},t}(),Ci=function(){function t(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=Mt(),this.pendingDocumentTargetMapping=Ri(),this.pendingTargetResets=new Et(G)}return t.prototype.handleDocumentChange=function(t){for(var n=0,e=t.updatedTargetIds;n<e.length;n++){var i=e[n];t.newDoc instanceof qn?this.addDocumentToTarget(i,t.newDoc):t.newDoc instanceof Bn&&this.removeDocumentFromTarget(i,t.key,t.newDoc)}for(var r=0,u=t.removedTargetIds;r<u.length;r++)this.removeDocumentFromTarget(i=u[r],t.key,t.newDoc)},t.prototype.handleTargetChange=function(t){var n=this;this.forEachTarget(t,(function(e){var i=n.ensureTargetState(e);switch(t.state){case ji.NoChange:n.isActiveTarget(e)&&i.updateResumeToken(t.resumeToken);break;case ji.Added:i.recordTargetResponse(),i.isPending||i.clearPendingChanges(),i.updateResumeToken(t.resumeToken);break;case ji.Removed:i.recordTargetResponse(),i.isPending||n.removeTarget(e),l(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case ji.Current:n.isActiveTarget(e)&&(i.markCurrent(),i.updateResumeToken(t.resumeToken));break;case ji.Reset:n.isActiveTarget(e)&&(n.resetTarget(e),i.updateResumeToken(t.resumeToken));break;default:f("Unknown target watch change state: "+t.state)}}))},t.prototype.forEachTarget=function(t,n){t.targetIds.length>0?t.targetIds.forEach(n):O(this.targetStates,n)},t.prototype.handleExistenceFilter=function(t){var n=t.targetId,e=t.existenceFilter.count,i=this.queryDataForActiveTarget(n);if(i){var r=i.query;if(r.isDocumentQuery())if(0===e){var u=new at(r.path);this.removeDocumentFromTarget(n,u,new Bn(u,_t.forDeletedDoc()))}else l(1===e,"Single document existence filter with count: "+e);else this.getCurrentDocumentCountForTarget(n)!==e&&(this.resetTarget(n),this.pendingTargetResets=this.pendingTargetResets.add(n))}},t.prototype.createRemoteEvent=function(t){var n=this,e={};O(this.targetStates,(function(i,r){var u=n.queryDataForActiveTarget(i);if(u){if(r.current&&u.query.isDocumentQuery()){var s=new at(u.query.path);null!==n.pendingDocumentUpdates.get(s)||n.targetContainsDocument(i,s)||n.removeDocumentFromTarget(i,s,new Bn(s,t))}r.hasPendingChanges&&(e[i]=r.toTargetChange(),r.clearPendingChanges())}}));var i=Ft();this.pendingDocumentTargetMapping.forEach((function(t,e){var r=!0;e.forEachWhile((function(t){var e=n.queryDataForActiveTarget(t);return!e||e.purpose===be.LimboResolution||(r=!1,!1)})),r&&(i=i.add(t))}));var r=new Di(t,e,this.pendingTargetResets,this.pendingDocumentUpdates,i);return this.pendingDocumentUpdates=Mt(),this.pendingDocumentTargetMapping=Ri(),this.pendingTargetResets=new Et(G),r},t.prototype.addDocumentToTarget=function(t,n){if(this.isActiveTarget(t)){var e=this.targetContainsDocument(t,n.key)?_i.Modified:_i.Added;this.ensureTargetState(t).addDocumentChange(n.key,e),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(n.key,n),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(n.key,this.ensureDocumentTargetMapping(n.key).add(t))}},t.prototype.removeDocumentFromTarget=function(t,n,e){if(this.isActiveTarget(t)){var i=this.ensureTargetState(t);this.targetContainsDocument(t,n)?i.addDocumentChange(n,_i.Removed):i.removeDocumentChange(n),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(n,this.ensureDocumentTargetMapping(n).delete(t)),e&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(n,e))}},t.prototype.removeTarget=function(t){delete this.targetStates[t]},t.prototype.getCurrentDocumentCountForTarget=function(t){var n=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+n.addedDocuments.size-n.removedDocuments.size},t.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},t.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new xi),this.targetStates[t]},t.prototype.ensureDocumentTargetMapping=function(t){var n=this.pendingDocumentTargetMapping.get(t);return n||(n=new Et(G),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,n)),n},t.prototype.isActiveTarget=function(t){var n=null!==this.queryDataForActiveTarget(t);return n||a("WatchChangeAggregator","Detected inactive target",t),n},t.prototype.queryDataForActiveTarget=function(t){var n=this.targetStates[t];return n&&n.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},t.prototype.resetTarget=function(t){var n=this;l(!this.targetStates[t].isPending,"Should only reset active targets"),this.targetStates[t]=new xi,this.metadataProvider.getRemoteKeysForTarget(t).forEach((function(e){n.removeDocumentFromTarget(t,e,null)}))},t.prototype.targetContainsDocument=function(t,n){return this.metadataProvider.getRemoteKeysForTarget(t).has(n)},t}();function Ri(){return new Ot(at.comparator)}function Fi(){return new Ot(at.comparator)}var Pi="RemoteStore",Ui=function(){function t(t,n,e,i,r){var u=this;this.localStore=t,this.datastore=n,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=r,this.connectivityMonitor.addCallback((function(){e.enqueueAndForget((function(){return b.__awaiter(u,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.canUseNetwork()?(a(Pi,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}))})),this.onlineStateTracker=new bi(e,i),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return t.prototype.start=function(){return this.enableNetwork()},t.prototype.enableNetwork=function(){return b.__awaiter(this,void 0,void 0,(function(){var t;return b.__generator(this,(function(n){switch(n.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(t=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return t.lastStreamToken=n.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(ci.Unknown),[4,this.fillWritePipeline()];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))},t.prototype.disableNetwork=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(ci.Offline),[2]}}))}))},t.prototype.disableNetworkInternal=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),this.writePipeline.length>0&&(a(Pi,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}}))}))},t.prototype.shutdown=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return a(Pi,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(ci.Unknown),[2]}}))}))},t.prototype.listen=function(t){l(!y(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},t.prototype.unlisten=function(t){l(y(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),E(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(ci.Unknown))},t.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},t.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},t.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},t.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},t.prototype.startWatchStream=function(){l(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new Ci(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},t.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!E(this.listenTargets)},t.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},t.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},t.prototype.onWatchStreamOpen=function(){return b.__awaiter(this,void 0,void 0,(function(){var t=this;return b.__generator(this,(function(){return O(this.listenTargets,(function(n,e){t.sendWatchRequest(e)})),[2]}))}))},t.prototype.onWatchStreamClose=function(t){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return void 0===t&&l(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(ci.Unknown),[2]}))}))},t.prototype.onWatchStreamChange=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e;return b.__generator(this,(function(i){switch(i.label){case 0:return this.onlineStateTracker.set(ci.Online),t instanceof Ni&&t.state===ji.Removed&&t.cause?[2,this.handleTargetError(t)]:(t instanceof Mi?this.watchChangeAggregator.handleDocumentChange(t):t instanceof Ai?this.watchChangeAggregator.handleExistenceFilter(t):(l(t instanceof Ni,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(t)),n.isEqual(_t.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return e=i.sent(),n.compareTo(e)>=0?[4,this.raiseWatchSnapshot(n)]:[3,3];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))},t.prototype.raiseWatchSnapshot=function(t){var n=this;l(!t.isEqual(_t.MIN),"Can't raise event for unknown SnapshotVersion");var e=this.watchChangeAggregator.createRemoteEvent(t);return O(e.targetChanges,(function(e,i){if(i.resumeToken.length>0){var r=n.listenTargets[e];r&&(n.listenTargets[e]=r.withResumeToken(i.resumeToken,t))}})),e.targetMismatches.forEach((function(t){var e=n.listenTargets[t];if(e){n.listenTargets[t]=e.withResumeToken(v(),e.snapshotVersion),n.sendUnwatchRequest(t);var i=new ke(e.query,t,be.ExistenceFilterMismatch,e.sequenceNumber);n.sendWatchRequest(i)}})),this.syncEngine.applyRemoteEvent(e)},t.prototype.handleTargetError=function(t){var n=this;l(!!t.cause,"Handling target error without a cause");var e=t.cause,i=Promise.resolve();return t.targetIds.forEach((function(t){i=i.then((function(){return b.__awaiter(n,void 0,void 0,(function(){return b.__generator(this,(function(){return y(this.listenTargets,t)?(delete this.listenTargets[t],this.watchChangeAggregator.removeTarget(t),[2,this.syncEngine.rejectListen(t,e)]):[2]}))}))}))})),i},t.prototype.fillWritePipeline=function(){return b.__awaiter(this,void 0,void 0,(function(){var t;return b.__generator(this,(function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?[4,this.localStore.nextMutationBatch(this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:-1)]:[3,4];case 1:return null!==(t=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(t),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}}))}))},t.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},t.prototype.outstandingWrites=function(){return this.writePipeline.length},t.prototype.addToWritePipeline=function(t){l(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},t.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},t.prototype.startWriteStream=function(){l(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},t.prototype.onWriteStreamOpen=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return this.writeStream.writeHandshake(),[2]}))}))},t.prototype.onWriteHandshakeComplete=function(){var t=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then((function(){for(var n=0,e=t.writePipeline;n<e.length;n++)t.writeStream.writeMutations(e[n].mutations)})).catch(Fe)},t.prototype.onMutationResult=function(t,n){var e=this;l(this.writePipeline.length>0,"Got result for empty write pipeline");var i=this.writePipeline.shift(),r=Lt.from(i,t,n,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(r).then((function(){return e.fillWritePipeline()}))},t.prototype.onWriteStreamClose=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n=this;return b.__generator(this,(function(){return void 0===t&&l(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&this.writePipeline.length>0?[2,(this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t)).then((function(){n.shouldStartWriteStream()&&n.startWriteStream()}))]:[2]}))}))},t.prototype.handleHandshakeError=function(t){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return pi(t.code)?(a(Pi,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=v(),[2,this.localStore.setLastStreamToken(v()).catch(Fe)]):[2]}))}))},t.prototype.handleWriteError=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e=this;return b.__generator(this,(function(){return pi(i=t.code)&&i!==m.ABORTED?(n=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(n.batchId,t).then((function(){return e.fillWritePipeline()}))]):[2];var i}))}))},t.prototype.createTransaction=function(){return new mi(this.datastore)},t.prototype.restartNetwork=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(ci.Unknown),[4,this.enableNetwork()];case 2:return t.sent(),[2]}}))}))},t.prototype.handleCredentialChange=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.canUseNetwork()?(a(Pi,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.applyPrimaryState=function(t){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(n){switch(n.label){case 0:return this.isPrimary=t,t&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return n.sent(),[3,4];case 2:return t?[3,4]:[4,this.disableNetworkInternal()];case 3:n.sent(),this.onlineStateTracker.set(ci.Unknown),n.label=4;case 4:return[2]}}))}))},t}(),$i=function(){function t(t,n){if(I("GeoPoint",arguments,2),T("GeoPoint","number",1,t),T("GeoPoint","number",2,n),!isFinite(t)||t<-90||t>90)throw new w(m.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(n)||n<-180||n>180)throw new w(m.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+n);this._lat=t,this._long=n}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},t.prototype._compareTo=function(t){return G(this._lat,t._lat)||G(this._long,t._long)},t}(),Li=function(){function t(t,n,e,i,r,u,s){void 0===n&&(n=null),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===r&&(r=null),void 0===u&&(u=null),void 0===s&&(s=null),this.path=t,this.collectionGroup=n,this.explicitOrderBy=e,this.filters=i,this.limit=r,this.startAt=u,this.endAt=s,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return t.atPath=function(n){return new t(n)},Object.defineProperty(t.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),n=this.getFirstOrderByField();if(null!==t&&null===n)this.memoizedOrderBy=t.isKeyField()?[Ki]:[new Ji(t),Ki];else{l(null===t||null!==n&&t.isEqual(n),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var e=!1,i=0,r=this.explicitOrderBy;i<r.length;i++){var u=r[i];this.memoizedOrderBy.push(u),u.field.isKeyField()&&(e=!0)}e||this.memoizedOrderBy.push((this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Yi.ASCENDING)===Yi.ASCENDING?Ki:Xi)}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),t.prototype.addFilter=function(n){l(null==this.getInequalityFilterField()||!(n instanceof Bi)||!n.isInequality()||n.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),l(!this.isDocumentQuery(),"No filtering allowed for document query");var e=this.filters.concat([n]);return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),e,this.limit,this.startAt,this.endAt)},t.prototype.addOrderBy=function(n){l(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var e=this.explicitOrderBy.concat([n]);return new t(this.path,this.collectionGroup,e,this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.withLimit=function(n){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),n,this.startAt,this.endAt)},t.prototype.withStartAt=function(n){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,n,this.endAt)},t.prototype.withEndAt=function(n){return new t(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,n)},t.prototype.asCollectionQueryAtPath=function(n){return new t(n,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();this.isCollectionGroupQuery()&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(var n=0,e=this.filters;n<e.length;n++)t+=e[n].canonicalId(),t+=",";t+="|ob:";for(var i=0,r=this.orderBy;i<r.length;i++)t+=r[i].canonicalId(),t+=",";ei(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},t.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(t+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(t+=", filters: ["+this.filters.join(", ")+"]"),ei(this.limit)||(t+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},t.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var n=0;n<this.orderBy.length;n++)if(!this.orderBy[n].isEqual(t.orderBy[n]))return!1;if(this.filters.length!==t.filters.length)return!1;for(n=0;n<this.filters.length;n++)if(!this.filters[n].isEqual(t.filters[n]))return!1;return this.collectionGroup===t.collectionGroup&&!!this.path.isEqual(t.path)&&!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)},t.prototype.docComparator=function(t,n){for(var e=!1,i=0,r=this.orderBy;i<r.length;i++){var u=r[i],s=u.compare(t,n);if(0!==s)return s;e=e||u.field.isKeyField()}return l(e,"orderBy used that doesn't compare on key field"),0},t.prototype.matches=function(t){return this.matchesPathAndCollectionGroup(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},t.prototype.hasLimit=function(){return!ei(this.limit)},t.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},t.prototype.getInequalityFilterField=function(){for(var t=0,n=this.filters;t<n.length;t++){var e=n[t];if(e instanceof Bi&&e.isInequality())return e.field}return null},t.prototype.findFilterOperator=function(t){for(var n=0,e=this.filters;n<e.length;n++){var i=e[n];if(i instanceof Bi&&t.indexOf(i.op)>=0)return i.op}return null},t.prototype.isDocumentQuery=function(){return at.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},t.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},t.prototype.matchesPathAndCollectionGroup=function(t){var n=t.key.path;return null!==this.collectionGroup?t.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(n):at.isDocumentKey(this.path)?this.path.isEqual(n):this.path.isImmediateParentOf(n)},t.prototype.matchesOrderBy=function(t){for(var n=0,e=this.explicitOrderBy;n<e.length;n++){var i=e[n];if(!i.field.isKeyField()&&null===t.field(i.field))return!1}return!0},t.prototype.matchesFilters=function(t){for(var n=0,e=this.filters;n<e.length;n++)if(!e[n].matches(t))return!1;return!0},t.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,t))},t.prototype.assertValidBound=function(t){l(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},t}(),qi=function(){function t(t){this.name=t}return t.fromString=function(n){switch(n){case"<":return t.LESS_THAN;case"<=":return t.LESS_THAN_OR_EQUAL;case"==":return t.EQUAL;case">=":return t.GREATER_THAN_OR_EQUAL;case">":return t.GREATER_THAN;case"array-contains":return t.ARRAY_CONTAINS;case"in":return t.IN;case"array-contains-any":return t.ARRAY_CONTAINS_ANY;default:return f("Unknown FieldFilter operator: "+n)}},t.prototype.toString=function(){return this.name},t.prototype.isEqual=function(t){return this.name===t.name},t.LESS_THAN=new t("<"),t.LESS_THAN_OR_EQUAL=new t("<="),t.EQUAL=new t("=="),t.GREATER_THAN=new t(">"),t.GREATER_THAN_OR_EQUAL=new t(">="),t.ARRAY_CONTAINS=new t("array-contains"),t.IN=new t("in"),t.ARRAY_CONTAINS_ANY=new t("array-contains-any"),t}(),Bi=function(t){function n(n,e,i){var r=t.call(this)||this;return r.field=n,r.op=e,r.value=i,r}return b.__extends(n,t),n.create=function(t,e,i){if(t.isKeyField())return e===qi.IN?(l(i instanceof $n,"Comparing on key with IN, but filter value not an ArrayValue"),l(i.internalValue.every((function(t){return t instanceof Fn})),"Comparing on key with IN, but an array value was not a RefValue"),new Vi(t,i)):(l(i instanceof Fn,"Comparing on key, but filter value not a RefValue"),l(e!==qi.ARRAY_CONTAINS&&e!==qi.ARRAY_CONTAINS_ANY,"'"+e.toString()+"' queries don't make sense on document keys."),new zi(t,e,i));if(i.isEqual(En.INSTANCE)){if(e!==qi.EQUAL)throw new w(m.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new n(t,e,i)}if(i.isEqual(Tn.NAN)){if(e!==qi.EQUAL)throw new w(m.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new n(t,e,i)}return e===qi.ARRAY_CONTAINS?new Wi(t,i):e===qi.IN?(l(i instanceof $n,"IN filter has invalid value: "+i.toString()),new Gi(t,i)):e===qi.ARRAY_CONTAINS_ANY?(l(i instanceof $n,"ARRAY_CONTAINS_ANY filter has invalid value: "+i.toString()),new Qi(t,i)):new n(t,e,i)},n.prototype.matches=function(t){var n=t.field(this.field);return null!==n&&this.value.typeOrder===n.typeOrder&&this.matchesComparison(n.compareTo(this.value))},n.prototype.matchesComparison=function(t){switch(this.op){case qi.LESS_THAN:return t<0;case qi.LESS_THAN_OR_EQUAL:return t<=0;case qi.EQUAL:return 0===t;case qi.GREATER_THAN:return t>0;case qi.GREATER_THAN_OR_EQUAL:return t>=0;default:return f("Unknown FieldFilter operator: "+this.op)}},n.prototype.isInequality=function(){return[qi.LESS_THAN,qi.LESS_THAN_OR_EQUAL,qi.GREATER_THAN,qi.GREATER_THAN_OR_EQUAL].indexOf(this.op)>=0},n.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},n.prototype.isEqual=function(t){return t instanceof n&&this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value)},n.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},n}((function(){})),zi=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.matches=function(t){var n=at.comparator(t.key,this.value.key);return this.matchesComparison(n)},n}(Bi),Vi=function(t){function n(n,e){var i=t.call(this,n,qi.IN,e)||this;return i.value=e,i}return b.__extends(n,t),n.prototype.matches=function(t){return this.value.internalValue.some((function(n){return t.key.isEqual(n.key)}))},n}(Bi),Wi=function(t){function n(n,e){return t.call(this,n,qi.ARRAY_CONTAINS,e)||this}return b.__extends(n,t),n.prototype.matches=function(t){var n=t.field(this.field);return n instanceof $n&&n.contains(this.value)},n}(Bi),Gi=function(t){function n(n,e){var i=t.call(this,n,qi.IN,e)||this;return i.value=e,i}return b.__extends(n,t),n.prototype.matches=function(t){var n=this.value,e=t.field(this.field);return null!==e&&n.contains(e)},n}(Bi),Qi=function(t){function n(n,e){var i=t.call(this,n,qi.ARRAY_CONTAINS_ANY,e)||this;return i.value=e,i}return b.__extends(n,t),n.prototype.matches=function(t){var n=this,e=t.field(this.field);return e instanceof $n&&e.internalValue.some((function(t){return n.value.contains(t)}))},n}(Bi),Yi=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t.ASCENDING=new t("asc"),t.DESCENDING=new t("desc"),t}(),Hi=function(){function t(t,n){this.position=t,this.before=n}return t.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",n=0,e=this.position;n<e.length;n++)t+=e[n].toString();return t},t.prototype.sortsBeforeDocument=function(t,n){l(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var e=0,i=0;i<this.position.length;i++){var r=t[i],u=this.position[i];if(r.field.isKeyField())l(u instanceof Fn,"Bound has a non-key value where the key path is being used."),e=at.comparator(u.key,n.key);else{var s=n.field(r.field);l(null!==s,"Field should exist since document matched the orderBy already."),e=u.compareTo(s)}if(r.dir===Yi.DESCENDING&&(e*=-1),0!==e)break}return this.before?e<=0:e<0},t.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var n=0;n<this.position.length;n++)if(!this.position[n].isEqual(t.position[n]))return!1;return!0},t}(),Ji=function(){function t(t,n){this.field=t,void 0===n&&(n=Yi.ASCENDING),this.dir=n,this.isKeyOrderBy=t.isKeyField()}return t.prototype.compare=function(t,n){var e=this.isKeyOrderBy?qn.compareByKey(t,n):qn.compareByField(this.field,t,n);switch(this.dir){case Yi.ASCENDING:return e;case Yi.DESCENDING:return-1*e;default:return f("Unknown direction: "+this.dir)}},t.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},t.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},t.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},t}(),Ki=new Ji(ot.keyField(),Yi.ASCENDING),Xi=new Ji(ot.keyField(),Yi.DESCENDING),Zi=function(){function t(){}return t.prototype.applyToLocalView=function(t,n){return new Cn(n,t)},t.prototype.applyToRemoteDocument=function(t,n){return n},t.prototype.computeBaseValue=function(){return null},t.prototype.isEqual=function(n){return n instanceof t},t.instance=new t,t}(),tr=function(){function t(t){this.elements=t}return t.prototype.applyToLocalView=function(t){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t){return this.apply(t)},t.prototype.apply=function(t){for(var n=ir(t),e=function(t){n.find((function(n){return n.isEqual(t)}))||n.push(t)},i=0,r=this.elements;i<r.length;i++)e(r[i]);return new $n(n)},t.prototype.computeBaseValue=function(){return null},t.prototype.isEqual=function(n){return n instanceof t&&Q(n.elements,this.elements)},t}(),nr=function(){function t(t){this.elements=t}return t.prototype.applyToLocalView=function(t){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t){return this.apply(t)},t.prototype.apply=function(t){for(var n=ir(t),e=function(t){n=n.filter((function(n){return!n.isEqual(t)}))},i=0,r=this.elements;i<r.length;i++)e(r[i]);return new $n(n)},t.prototype.computeBaseValue=function(){return null},t.prototype.isEqual=function(n){return n instanceof t&&Q(n.elements,this.elements)},t}(),er=function(){function t(t){this.operand=t}return t.prototype.applyToLocalView=function(t){var n=this.computeBaseValue(t);return n instanceof An&&this.operand instanceof An?new An(n.internalValue+this.operand.internalValue):new Tn(n.internalValue+this.operand.internalValue)},t.prototype.applyToRemoteDocument=function(t,n){return l(null!==n,"Didn't receive transformResult for NUMERIC_ADD transform"),n},t.prototype.computeBaseValue=function(t){return t instanceof In?t:new An(0)},t.prototype.isEqual=function(n){return n instanceof t&&this.operand.isEqual(n.operand)},t}();function ir(t){return t instanceof $n?t.internalValue.slice():[]}var rr,ur,sr=function(){function t(t){this.count=t}return t.prototype.isEqual=function(t){return t&&t.count===this.count},t}(),or=((rr={})[Yi.ASCENDING.name]="ASCENDING",rr[Yi.DESCENDING.name]="DESCENDING",rr),ar=((ur={})[qi.LESS_THAN.name]="LESS_THAN",ur[qi.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",ur[qi.GREATER_THAN.name]="GREATER_THAN",ur[qi.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",ur[qi.EQUAL.name]="EQUAL",ur[qi.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",ur[qi.IN.name]="IN",ur[qi.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",ur),cr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function hr(t,n){l(!ei(t),n+" is missing")}function fr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):f("can't parse "+t)}var lr=function(){function t(t,n){this.databaseId=t,this.options=n}return t.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},t.prototype.unsafeCastProtoByteString=function(t){return t},t.prototype.fromRpcStatus=function(t){var n=void 0===t.code?m.UNKNOWN:gi(t.code);return new w(n,t.message||"")},t.prototype.toInt32Value=function(t){return ei(t)?void 0:{value:t}},t.prototype.fromInt32Value=function(t){var n;return ei(n="object"==typeof t?t.value:t)?null:n},t.prototype.toTimestamp=function(t){return{seconds:""+t.seconds,nanos:t.nanoseconds}},t.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);l(!!t,"Cannot deserialize null or undefined timestamp.");var n=fr(t.seconds||"0");return new yt(n,t.nanos||0)},t.prototype.fromIso8601String=function(t){var n=0,e=cr.exec(t);if(l(!!e,"invalid timestamp: "+t),e[1]){var i=e[1];i=(i+"000000000").substr(0,9),n=Number(i)}var r=new Date(t),u=Math.floor(r.getTime()/1e3);return new yt(u,n)},t.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},t.prototype.fromBlob=function(t){return"string"==typeof t?(l(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),X.fromBase64String(t)):(l(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),X.fromUint8Array(t))},t.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},t.prototype.fromVersion=function(t){return l(!!t,"Trying to deserialize version that isn't set"),_t.fromTimestamp(this.fromTimestamp(t))},t.prototype.toResourceName=function(t,n){return this.fullyQualifiedPrefixPath(t).child("documents").child(n).canonicalString()},t.prototype.fromResourceName=function(t){var n=ut.fromString(t);return l(this.isValidResourceName(n),"Tried to deserialize invalid key "+n.toString()),n},t.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},t.prototype.fromName=function(t){var n=this.fromResourceName(t);return l(n.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+n.get(1)+" vs "+this.databaseId.projectId),l(!n.get(3)&&!this.databaseId.database||n.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+n.get(3)+" vs "+this.databaseId.database),new at(this.extractLocalPathFromResourceName(n))},t.prototype.toQueryPath=function(t){return this.toResourceName(this.databaseId,t)},t.prototype.fromQueryPath=function(t){var n=this.fromResourceName(t);return 4===n.length?ut.EMPTY_PATH:this.extractLocalPathFromResourceName(n)},Object.defineProperty(t.prototype,"encodedDatabaseId",{get:function(){return new ut(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),t.prototype.fullyQualifiedPrefixPath=function(t){return new ut(["projects",t.projectId,"databases",t.database])},t.prototype.extractLocalPathFromResourceName=function(t){return l(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},t.prototype.isValidResourceName=function(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)},t.prototype.toValue=function(t){if(t instanceof En)return{nullValue:"NULL_VALUE"};if(t instanceof Dn)return{booleanValue:t.value()};if(t instanceof An)return{integerValue:""+t.value()};if(t instanceof Tn){var n=t.value();if(this.options.useProto3Json){if(isNaN(n))return{doubleValue:"NaN"};if(n===1/0)return{doubleValue:"Infinity"};if(n===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof Nn?{stringValue:t.value()}:t instanceof Un?{mapValue:this.toMapValue(t)}:t instanceof $n?{arrayValue:this.toArrayValue(t)}:t instanceof xn?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof Pn?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof Rn?{bytesValue:this.toBytes(t.value())}:t instanceof Fn?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:f("Unknown FieldValue "+JSON.stringify(t))},t.prototype.fromValue=function(t){var n=this;if("nullValue"in t)return En.INSTANCE;if("booleanValue"in t)return Dn.of(t.booleanValue);if("integerValue"in t)return new An(fr(t.integerValue));if("doubleValue"in t){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return Tn.NAN;if("Infinity"===t.doubleValue)return Tn.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return Tn.NEGATIVE_INFINITY}return new Tn(t.doubleValue)}if("stringValue"in t)return new Nn(t.stringValue);if("mapValue"in t)return this.fromFields(t.mapValue.fields||{});if("arrayValue"in t)return hr(t.arrayValue,"arrayValue"),new $n((t.arrayValue.values||[]).map((function(t){return n.fromValue(t)})));if("timestampValue"in t)return hr(t.timestampValue,"timestampValue"),new xn(this.fromTimestamp(t.timestampValue));if("geoPointValue"in t)return hr(t.geoPointValue,"geoPointValue"),new Pn(new $i(t.geoPointValue.latitude||0,t.geoPointValue.longitude||0));if("bytesValue"in t){hr(t.bytesValue,"bytesValue");var e=this.fromBlob(t.bytesValue);return new Rn(e)}if("referenceValue"in t){hr(t.referenceValue,"referenceValue");var i=this.fromResourceName(t.referenceValue),r=new et(i.get(1),i.get(3)),u=new at(this.extractLocalPathFromResourceName(i));return new Fn(r,u)}return f("Unknown Value proto "+JSON.stringify(t))},t.prototype.toMutationDocument=function(t,n){return{name:this.toName(t),fields:this.toFields(n)}},t.prototype.toDocument=function(t){return l(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data()),updateTime:this.toTimestamp(t.version.toTimestamp())}},t.prototype.fromDocument=function(t,n){var e=this,i=this.fromName(t.name),r=this.fromVersion(t.updateTime);return new qn(i,r,{hasCommittedMutations:!!n},void 0,t,(function(t){return e.fromValue(t)}))},t.prototype.toFields=function(t){var n=this,e={};return t.forEach((function(t,i){e[t]=n.toValue(i)})),e},t.prototype.fromFields=function(t){var n=this,e=Un.EMPTY;return k(t,(function(t,i){e=e.set(new ot([t]),n.fromValue(i))})),e},t.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},t.prototype.toArrayValue=function(t){var n=this,e=[];return t.forEach((function(t){e.push(n.toValue(t))})),{values:e}},t.prototype.fromFound=function(t){var n=this;l(!!t.found,"Tried to deserialize a found document from a missing document."),hr(t.found.name,"doc.found.name"),hr(t.found.updateTime,"doc.found.updateTime");var e=this.fromName(t.found.name),i=this.fromVersion(t.found.updateTime);return new qn(e,i,{},void 0,t.found,(function(t){return n.fromValue(t)}))},t.prototype.fromMissing=function(t){l(!!t.missing,"Tried to deserialize a missing document from a found document."),l(!!t.readTime,"Tried to deserialize a missing document without a read time.");var n=this.fromName(t.missing),e=this.fromVersion(t.readTime);return new Bn(n,e)},t.prototype.fromMaybeDocument=function(t){return"found"in t?this.fromFound(t):"missing"in t?this.fromMissing(t):f("invalid batch get response: "+JSON.stringify(t))},t.prototype.toWatchTargetChangeState=function(t){switch(t){case ji.Added:return"ADD";case ji.Current:return"CURRENT";case ji.NoChange:return"NO_CHANGE";case ji.Removed:return"REMOVE";case ji.Reset:return"RESET";default:return f("Unknown WatchTargetChangeState: "+t)}},t.prototype.toTestWatchChange=function(t){if(t instanceof Ai)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof Mi){var n;if(t.newDoc instanceof qn)return{documentChange:{document:{name:this.toName((n=t.newDoc).key),fields:this.toFields(n.data()),updateTime:this.toVersion(n.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}};if(t.newDoc instanceof Bn)return{documentDelete:{document:this.toName((n=t.newDoc).key),readTime:this.toVersion(n.version),removedTargetIds:t.removedTargetIds}};if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Ni){var e=void 0;return t.cause&&(e={code:yi(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:e}}}return f("Unrecognized watch change: "+JSON.stringify(t))},t.prototype.fromWatchChange=function(t){var n,e=this;if("targetChange"in t){hr(t.targetChange,"targetChange");var i=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),r=t.targetChange.targetIds||[],u=t.targetChange.resumeToken||this.emptyByteString(),s=t.targetChange.cause,o=s&&this.fromRpcStatus(s);n=new Ni(i,r,u,o||null)}else if("documentChange"in t){hr(t.documentChange,"documentChange"),hr(t.documentChange.document,"documentChange.name"),hr(t.documentChange.document.name,"documentChange.document.name"),hr(t.documentChange.document.updateTime,"documentChange.document.updateTime");var a=t.documentChange,c=this.fromName(a.document.name),h=this.fromVersion(a.document.updateTime),l=new qn(c,h,{},void 0,a.document,(function(t){return e.fromValue(t)}));n=new Mi(a.targetIds||[],a.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){hr(t.documentDelete,"documentDelete"),hr(t.documentDelete.document,"documentDelete.document");var d=t.documentDelete;c=this.fromName(d.document),h=d.readTime?this.fromVersion(d.readTime):_t.forDeletedDoc(),l=new Bn(c,h),n=new Mi([],d.removedTargetIds||[],l.key,l)}else if("documentRemove"in t){hr(t.documentRemove,"documentRemove"),hr(t.documentRemove.document,"documentRemove");var v=t.documentRemove;c=this.fromName(v.document),n=new Mi([],v.removedTargetIds||[],c,null)}else{if(!("filter"in t))return f("Unknown change type "+JSON.stringify(t));hr(t.filter,"filter"),hr(t.filter.targetId,"filter.targetId");var m=t.filter,w=new sr(m.count||0);n=new Ai(m.targetId,w)}return n},t.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?ji.NoChange:"ADD"===t?ji.Added:"REMOVE"===t?ji.Removed:"CURRENT"===t?ji.Current:"RESET"===t?ji.Reset:f("Got unexpected TargetChange.state: "+t)},t.prototype.versionFromListenResponse=function(t){if(!("targetChange"in t))return _t.MIN;var n=t.targetChange;return n.targetIds&&n.targetIds.length?_t.MIN:n.readTime?this.fromVersion(n.readTime):_t.MIN},t.prototype.toMutation=function(t){var n,e=this;if(t instanceof yn)n={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof kn)n={delete:this.toName(t.key)};else if(t instanceof _n)n={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof On))return f("Unknown mutation type "+t.type);n={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map((function(t){return e.toFieldTransform(t)}))}}}return t.precondition.isNone||(n.currentDocument=this.toPrecondition(t.precondition)),n},t.prototype.fromMutation=function(t){var n=this,e=t.currentDocument?this.fromPrecondition(t.currentDocument):pn.NONE;if(t.update){hr(t.update.name,"name");var i=this.fromName(t.update.name),r=this.fromFields(t.update.fields||{});if(t.updateMask){var u=this.fromDocumentMask(t.updateMask);return new _n(i,r,u,e)}return new yn(i,r,e)}if(t.delete)return i=this.fromName(t.delete),new kn(i,e);if(t.transform){i=this.fromName(t.transform.document);var s=t.transform.fieldTransforms.map((function(t){return n.fromFieldTransform(t)}));return l(!0===e.exists,'Transforms only support precondition "exists == true"'),new On(i,s)}return f("unknown mutation proto: "+JSON.stringify(t))},t.prototype.toPrecondition=function(t){return l(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:f("Unknown precondition")},t.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?pn.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?pn.exists(t.exists):pn.NONE},t.prototype.fromWriteResult=function(t,n){var e=this,i=this.fromVersion(t.updateTime?t.updateTime:n),r=null;return t.transformResults&&t.transformResults.length>0&&(r=t.transformResults.map((function(t){return e.fromValue(t)}))),new mn(i,r)},t.prototype.fromWriteResults=function(t,n){var e=this;return t&&t.length>0?(l(void 0!==n,"Received a write result without a commit time"),t.map((function(t){return e.fromWriteResult(t,n)}))):[]},t.prototype.toFieldTransform=function(t){var n=this,e=t.transform;if(e instanceof Zi)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(e instanceof tr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:e.elements.map((function(t){return n.toValue(t)}))}};if(e instanceof nr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:e.elements.map((function(t){return n.toValue(t)}))}};if(e instanceof er)return{fieldPath:t.field.canonicalString(),increment:this.toValue(e.operand)};throw f("Unknown transform: "+t.transform)},t.prototype.fromFieldTransform=function(t){var n=this,e=null;if("setToServerValue"in t)l("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),e=Zi.instance;else if("appendMissingElements"in t)e=new tr((t.appendMissingElements.values||[]).map((function(t){return n.fromValue(t)})));else if("removeAllFromArray"in t)e=new nr((t.removeAllFromArray.values||[]).map((function(t){return n.fromValue(t)})));else if("increment"in t){var i=this.fromValue(t.increment);l(i instanceof In,"NUMERIC_ADD transform requires a NumberValue"),e=new er(i)}else f("Unknown transform proto: "+JSON.stringify(t));var r=ot.fromServerFormat(t.fieldPath);return new vn(r,e)},t.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},t.prototype.fromDocumentsTarget=function(t){var n=t.documents.length;return l(1===n,"DocumentsTarget contained other than 1 document: "+n),Li.atPath(this.fromQueryPath(t.documents[0]))},t.prototype.toQueryTarget=function(t){var n={structuredQuery:{}},e=t.path;null!==t.collectionGroup?(l(e.length%2==0,"Collection Group queries should be within a document path or root."),n.parent=this.toQueryPath(e),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(l(e.length%2!=0,"Document queries with filters are not supported."),n.parent=this.toQueryPath(e.popLast()),n.structuredQuery.from=[{collectionId:e.lastSegment()}]);var i=this.toFilter(t.filters);i&&(n.structuredQuery.where=i);var r=this.toOrder(t.orderBy);r&&(n.structuredQuery.orderBy=r);var u=this.toInt32Value(t.limit);return void 0!==u&&(n.structuredQuery.limit=u),t.startAt&&(n.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(n.structuredQuery.endAt=this.toCursor(t.endAt)),n},t.prototype.fromQueryTarget=function(t){var n=this.fromQueryPath(t.parent),e=t.structuredQuery,i=e.from?e.from.length:0,r=null;if(i>0){l(1===i,"StructuredQuery.from with more than one collection is not supported.");var u=e.from[0];u.allDescendants?r=u.collectionId:n=n.child(u.collectionId)}var s=[];e.where&&(s=this.fromFilter(e.where));var o=[];e.orderBy&&(o=this.fromOrder(e.orderBy));var a=null;e.limit&&(a=this.fromInt32Value(e.limit));var c=null;e.startAt&&(c=this.fromCursor(e.startAt));var h=null;return e.endAt&&(h=this.fromCursor(e.endAt)),new Li(n,r,o,s,a,c,h)},t.prototype.toListenRequestLabels=function(t){var n=this.toLabel(t.purpose);return null==n?null:{"goog-listen-tags":n}},t.prototype.toLabel=function(t){switch(t){case be.Listen:return null;case be.ExistenceFilterMismatch:return"existence-filter-mismatch";case be.LimboResolution:return"limbo-document";default:return f("Unrecognized query purpose: "+t)}},t.prototype.toTarget=function(t){var n,e=t.query;return(n=e.isDocumentQuery()?{documents:this.toDocumentsTarget(e)}:{query:this.toQueryTarget(e)}).targetId=t.targetId,t.resumeToken.length>0&&(n.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),n},t.prototype.toFilter=function(t){var n=this;if(0!==t.length){var e=t.map((function(t){return t instanceof Bi?n.toUnaryOrFieldFilter(t):f("Unrecognized filter: "+JSON.stringify(t))}));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}},t.prototype.fromFilter=function(t){var n=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromFieldFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((function(t){return n.fromFilter(t)})).reduce((function(t,n){return t.concat(n)})):f("Unknown filter: "+JSON.stringify(t)):[]},t.prototype.toOrder=function(t){var n=this;if(0!==t.length)return t.map((function(t){return n.toPropertyOrder(t)}))},t.prototype.fromOrder=function(t){var n=this;return t.map((function(t){return n.fromPropertyOrder(t)}))},t.prototype.toCursor=function(t){var n=this;return{before:t.before,values:t.position.map((function(t){return n.toValue(t)}))}},t.prototype.fromCursor=function(t){var n=this,e=!!t.before,i=t.values.map((function(t){return n.fromValue(t)}));return new Hi(i,e)},t.prototype.toDirection=function(t){return or[t.name]},t.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return Yi.ASCENDING;case"DESCENDING":return Yi.DESCENDING;default:return}},t.prototype.toOperatorName=function(t){return ar[t.name]},t.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return qi.EQUAL;case"GREATER_THAN":return qi.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return qi.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return qi.LESS_THAN;case"LESS_THAN_OR_EQUAL":return qi.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return qi.ARRAY_CONTAINS;case"IN":return qi.IN;case"ARRAY_CONTAINS_ANY":return qi.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return f("Unspecified operator");default:return f("Unknown operator")}},t.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},t.prototype.fromFieldPathReference=function(t){return ot.fromServerFormat(t.fieldPath)},t.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},t.prototype.fromPropertyOrder=function(t){return new Ji(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},t.prototype.fromFieldFilter=function(t){return Bi.create(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},t.prototype.toUnaryOrFieldFilter=function(t){if(t.op===qi.EQUAL){if(t.value.isEqual(Tn.NAN))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}};if(t.value.isEqual(En.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}},t.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var n=this.fromFieldPathReference(t.unaryFilter.field);return Bi.create(n,qi.EQUAL,Tn.NAN);case"IS_NULL":var e=this.fromFieldPathReference(t.unaryFilter.field);return Bi.create(e,qi.EQUAL,En.INSTANCE);case"OPERATOR_UNSPECIFIED":return f("Unspecified filter");default:return f("Unknown filter")}},t.prototype.toDocumentMask=function(t){var n=[];return t.fields.forEach((function(t){return n.push(t.canonicalString())})),{fieldPaths:n}},t.prototype.fromDocumentMask=function(t){var n=(t.fieldPaths||[]).map((function(t){return ot.fromServerFormat(t)}));return dn.fromArray(n)},t}(),dr=function(){this.viewSnap=null,this.targetId=0,this.listeners=[]},vr=function(){function t(t){this.syncEngine=t,this.queries=new Vn((function(t){return t.canonicalId()})),this.onlineState=ci.Unknown,this.snapshotsInSyncListeners=new Set,this.syncEngine.subscribe(this)}return t.prototype.listen=function(t){var n=t.query,e=!1,i=this.queries.get(n);return i||(e=!0,i=new dr,this.queries.set(n,i)),i.listeners.push(t),l(!t.applyOnlineStateChange(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),i.viewSnap&&t.onViewSnapshot(i.viewSnap)&&this.raiseSnapshotsInSyncEvent(),e?this.syncEngine.listen(n).then((function(t){return i.targetId=t,t})):Promise.resolve(i.targetId)},t.prototype.unlisten=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e,i,r;return b.__generator(this,(function(){return e=!1,(i=this.queries.get(n=t.query))&&(r=i.listeners.indexOf(t))>=0&&(i.listeners.splice(r,1),e=0===i.listeners.length),e?(this.queries.delete(n),[2,this.syncEngine.unlisten(n)]):[2]}))}))},t.prototype.onWatchChange=function(t){for(var n=!1,e=0,i=t;e<i.length;e++){var r=i[e],u=this.queries.get(r.query);if(u){for(var s=0,o=u.listeners;s<o.length;s++)o[s].onViewSnapshot(r)&&(n=!0);u.viewSnap=r}}n&&this.raiseSnapshotsInSyncEvent()},t.prototype.onWatchError=function(t,n){var e=this.queries.get(t);if(e)for(var i=0,r=e.listeners;i<r.length;i++)r[i].onError(n);this.queries.delete(t)},t.prototype.onOnlineStateChange=function(t){this.onlineState=t;var n=!1;this.queries.forEach((function(e,i){for(var r=0,u=i.listeners;r<u.length;r++)u[r].applyOnlineStateChange(t)&&(n=!0)})),n&&this.raiseSnapshotsInSyncEvent()},t.prototype.addSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.add(t),t.next()},t.prototype.removeSnapshotsInSyncListener=function(t){this.snapshotsInSyncListeners.delete(t)},t.prototype.raiseSnapshotsInSyncEvent=function(){this.snapshotsInSyncListeners.forEach((function(t){t.next()}))},t}(),mr=function(){function t(t,n,e){this.query=t,this.queryObserver=n,this.raisedInitialEvent=!1,this.snap=null,this.onlineState=ci.Unknown,this.options=e||{}}return t.prototype.onViewSnapshot=function(t){if(l(t.docChanges.length>0||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var n=[],e=0,i=t.docChanges;e<i.length;e++){var r=i[e];r.type!==_i.Metadata&&n.push(r)}t=new Ei(t.query,t.docs,t.oldDocs,n,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}var u=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(t)&&(this.queryObserver.next(t),u=!0):this.shouldRaiseInitialEvent(t,this.onlineState)&&(this.raiseInitialEvent(t),u=!0),this.snap=t,u},t.prototype.onError=function(t){this.queryObserver.error(t)},t.prototype.applyOnlineStateChange=function(t){this.onlineState=t;var n=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&(this.raiseInitialEvent(this.snap),n=!0),n},t.prototype.shouldRaiseInitialEvent=function(t,n){return l(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache||(this.options.waitForSyncWhenOnline&&n!==ci.Offline?(l(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||n===ci.Offline)},t.prototype.shouldRaiseEvent=function(t){return t.docChanges.length>0||!!(t.syncStateChanged||this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites)&&!0===this.options.includeMetadataChanges},t.prototype.raiseInitialEvent=function(t){l(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=Ei.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},t}(),wr=function(){function t(t,n,e){this.targetId=t,this.addedKeys=n,this.removedKeys=e}return t.fromSnapshot=function(n,e){for(var i=Ft(),r=Ft(),u=0,s=e.docChanges;u<s.length;u++){var o=s[u];switch(o.type){case _i.Added:i=i.add(o.doc.key);break;case _i.Removed:r=r.add(o.doc.key)}}return new t(n,i,r)},t}(),br=function(t){this.key=t},pr=function(t){this.key=t},gr=function(){function t(t,n){this.query=t,this._syncedDocuments=n,this.syncState=null,this.current=!1,this.limboDocuments=Ft(),this.mutatedKeys=Ft(),this.documentSet=new ki(t.docComparator.bind(t))}return Object.defineProperty(t.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),t.prototype.computeDocChanges=function(t,n){var e=this,i=n?n.changeSet:new Si,r=n?n.documentSet:this.documentSet,u=n?n.mutatedKeys:this.mutatedKeys,s=r,o=!1,a=this.query.hasLimit()&&r.size===this.query.limit?r.last():null;if(t.inorderTraversal((function(t,n){var c=r.get(t),h=n instanceof qn?n:null;h&&(l(t.isEqual(h.key),"Mismatching keys found in document changes: "+t+" != "+h.key),h=e.query.matches(h)?h:null);var f=!!c&&e.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||e.mutatedKeys.has(h.key)&&h.hasCommittedMutations),v=!1;c&&h?c.data().isEqual(h.data())?f!==d&&(i.track({type:_i.Metadata,doc:h}),v=!0):e.shouldWaitForSyncedDocument(c,h)||(i.track({type:_i.Modified,doc:h}),v=!0,a&&e.query.docComparator(h,a)>0&&(o=!0)):!c&&h?(i.track({type:_i.Added,doc:h}),v=!0):c&&!h&&(i.track({type:_i.Removed,doc:c}),v=!0,a&&(o=!0)),v&&(h?(s=s.add(h),u=d?u.add(t):u.delete(t)):(s=s.delete(t),u=u.delete(t)))})),this.query.hasLimit())for(;s.size>this.query.limit;){var c=s.last();s=s.delete(c.key),u=u.delete(c.key),i.track({type:_i.Removed,doc:c})}return l(!o||!n,"View was refilled using docs that themselves needed refilling."),{documentSet:s,changeSet:i,needsRefill:o,mutatedKeys:u}},t.prototype.shouldWaitForSyncedDocument=function(t,n){return t.hasLocalMutations&&n.hasCommittedMutations&&!n.hasLocalMutations},t.prototype.applyChanges=function(t,n,e){var i=this;l(!t.needsRefill,"Cannot apply changes that need a refill");var r=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var u=t.changeSet.getChanges();u.sort((function(t,n){return function(t,n){var e=function(t){switch(t){case _i.Added:return 1;case _i.Modified:case _i.Metadata:return 2;case _i.Removed:return 0;default:return f("Unknown ChangeType: "+t)}};return e(t)-e(n)}(t.type,n.type)||i.query.docComparator(t.doc,n.doc)})),this.applyTargetChange(e);var s=n?this.updateLimboDocuments():[],o=0===this.limboDocuments.size&&this.current?Oi.Synced:Oi.Local,a=o!==this.syncState;return this.syncState=o,0!==u.length||a?{snapshot:new Ei(this.query,t.documentSet,r,u,t.mutatedKeys,o===Oi.Local,a,!1),limboChanges:s}:{limboChanges:s}},t.prototype.applyOnlineStateChange=function(t){return this.current&&t===ci.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Si,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},t.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations},t.prototype.applyTargetChange=function(t){var n=this;t&&(t.addedDocuments.forEach((function(t){return n._syncedDocuments=n._syncedDocuments.add(t)})),t.modifiedDocuments.forEach((function(t){return l(n._syncedDocuments.has(t),"Modified document "+t+" not found in view.")})),t.removedDocuments.forEach((function(t){return n._syncedDocuments=n._syncedDocuments.delete(t)})),this.current=t.current)},t.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var n=this.limboDocuments;this.limboDocuments=Ft(),this.documentSet.forEach((function(n){t.shouldBeInLimbo(n.key)&&(t.limboDocuments=t.limboDocuments.add(n.key))}));var e=[];return n.forEach((function(n){t.limboDocuments.has(n)||e.push(new pr(n))})),this.limboDocuments.forEach((function(t){n.has(t)||e.push(new br(t))})),e},t.prototype.synchronizeWithPersistedState=function(t,n){this._syncedDocuments=n,this.limboDocuments=Ft();var e=this.computeDocChanges(t);return this.applyChanges(e,!0)},t.prototype.computeInitialSnapshot=function(){return Ei.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Oi.Local)},t}(),yr=5,_r=function(){function t(t,n,e,i){this.asyncQueue=t,this.remoteStore=n,this.updateFunction=e,this.deferred=i,this.retries=yr,this.backoff=new ai(this.asyncQueue,K.RetryTransaction)}return t.prototype.run=function(){this.runWithBackOff()},t.prototype.runWithBackOff=function(){var t=this;this.backoff.backoffAndRun((function(){return b.__awaiter(t,void 0,void 0,(function(){var t,n,e=this;return b.__generator(this,(function(){return t=this.remoteStore.createTransaction(),(n=this.tryRunUpdateFunction(t))&&n.then((function(n){e.asyncQueue.enqueueAndForget((function(){return t.commit().then((function(){e.deferred.resolve(n)})).catch((function(t){e.handleTransactionError(t)}))}))})).catch((function(t){e.handleTransactionError(t)})),[2]}))}))}))},t.prototype.tryRunUpdateFunction=function(t){try{var n=this.updateFunction(t);return!ei(n)&&n.catch&&n.then?n:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}},t.prototype.handleTransactionError=function(t){var n=this;this.retries>0&&this.isRetryableTransactionError(t)?(this.retries-=1,this.asyncQueue.enqueueAndForget((function(){return n.runWithBackOff(),Promise.resolve()}))):this.deferred.reject(t)},t.prototype.isRetryableTransactionError=function(t){if("FirebaseError"===t.name){var n=t.code;return"aborted"===n||"failed-precondition"===n||!pi(n)}return!1},t}(),Or=function(t,n,e){this.query=t,this.targetId=n,this.view=e},kr=function(t){this.key=t,this.receivedDocument=!1},jr=function(){function t(t,n,e,i){this.localStore=t,this.remoteStore=n,this.sharedClientState=e,this.currentUser=i,this.syncEngineListener=null,this.queryViewsByQuery=new Vn((function(t){return t.canonicalId()})),this.queryViewsByTarget={},this.limboTargetsByKey=new Ot(at.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new Be,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=Kt.forSyncEngine(),this.isPrimary=void 0,this.onlineState=ci.Unknown}return Object.defineProperty(t.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t){l(null!==t,"SyncEngine listener cannot be null"),l(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},t.prototype.listen=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e,i,r,u;return b.__generator(this,(function(s){switch(s.label){case 0:return this.assertSubscribed("listen()"),(i=this.queryViewsByQuery.get(t))?(this.sharedClientState.addLocalQueryTarget(n=i.targetId),e=i.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(t)];case 2:return r=s.sent(),u=this.sharedClientState.addLocalQueryTarget(r.targetId),n=r.targetId,[4,this.initializeViewAndComputeSnapshot(r,"current"===u)];case 3:e=s.sent(),this.isPrimary&&this.remoteStore.listen(r),s.label=4;case 4:return this.syncEngineListener.onWatchChange([e]),[2,n]}}))}))},t.prototype.initializeViewAndComputeSnapshot=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e,i,r,u,s,o,a,c;return b.__generator(this,(function(h){switch(h.label){case 0:return[4,this.localStore.executeQuery(e=t.query)];case 1:return i=h.sent(),[4,this.localStore.remoteDocumentKeys(t.targetId)];case 2:return r=h.sent(),u=new gr(e,r),s=u.computeDocChanges(i),o=Ii.createSynthesizedTargetChangeForCurrentChange(t.targetId,n&&this.onlineState!==ci.Offline),l(0===(a=u.applyChanges(s,!0===this.isPrimary,o)).limboChanges.length,"View returned limbo docs before target ack from the server."),l(!!a.snapshot,"applyChanges for new view should always return a snapshot"),c=new Or(e,t.targetId,u),this.queryViewsByQuery.set(e,c),this.queryViewsByTarget[t.targetId]=c,[2,a.snapshot]}}))}))},t.prototype.synchronizeViewAndComputeSnapshot=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e,i;return b.__generator(this,(function(r){switch(r.label){case 0:return[4,this.localStore.executeQuery(t.query)];case 1:return n=r.sent(),[4,this.localStore.remoteDocumentKeys(t.targetId)];case 2:return e=r.sent(),i=t.view.synchronizeWithPersistedState(n,e),this.isPrimary&&this.updateTrackedLimbos(t.targetId,i.limboChanges),[2,i]}}))}))},t.prototype.unlisten=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e=this;return b.__generator(this,(function(i){switch(i.label){case 0:return this.assertSubscribed("unlisten()"),l(!!(n=this.queryViewsByQuery.get(t)),"Trying to unlisten on query not found:"+t),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(n.targetId),this.sharedClientState.isActiveQueryTarget(n.targetId)?[3,2]:[4,this.localStore.releaseQuery(t,!1).then((function(){e.sharedClientState.clearQueryState(n.targetId),e.remoteStore.unlisten(n.targetId),e.removeAndCleanupQuery(n)})).catch(Fe)]):[3,3];case 1:i.sent(),i.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(n),[4,this.localStore.releaseQuery(t,!0)];case 4:i.sent(),i.label=5;case 5:return[2]}}))}))},t.prototype.write=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e;return b.__generator(this,(function(i){switch(i.label){case 0:return this.assertSubscribed("write()"),[4,this.localStore.localWrite(t)];case 1:return e=i.sent(),this.sharedClientState.addPendingMutation(e.batchId),this.addMutationCallback(e.batchId,n),[4,this.emitNewSnapsAndNotifyLocalStore(e.changes)];case 2:return i.sent(),[4,this.remoteStore.fillWritePipeline()];case 3:return i.sent(),[2]}}))}))},t.prototype.runTransaction=function(t,n,e){new _r(t,this.remoteStore,n,e).run()},t.prototype.applyRemoteEvent=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e=this;return b.__generator(this,(function(i){switch(i.label){case 0:this.assertSubscribed("applyRemoteEvent()"),i.label=1;case 1:return i.trys.push([1,4,,6]),[4,this.localStore.applyRemoteEvent(t)];case 2:return n=i.sent(),k(t.targetChanges,(function(t,n){var i=e.limboResolutionsByTarget[Number(t)];i&&(l(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),n.addedDocuments.size>0?i.receivedDocument=!0:n.modifiedDocuments.size>0?l(i.receivedDocument,"Received change for limbo target document without add."):n.removedDocuments.size>0&&(l(i.receivedDocument,"Received remove for limbo target document without add."),i.receivedDocument=!1))})),[4,this.emitNewSnapsAndNotifyLocalStore(n,t)];case 3:return i.sent(),[3,6];case 4:return[4,Fe(i.sent())];case 5:return i.sent(),[3,6];case 6:return[2]}}))}))},t.prototype.applyOnlineStateChange=function(t,n){if(this.isPrimary&&n===hi.RemoteStore||!this.isPrimary&&n===hi.SharedClientState){this.assertSubscribed("applyOnlineStateChange()");var e=[];this.queryViewsByQuery.forEach((function(n,i){var r=i.view.applyOnlineStateChange(t);l(0===r.limboChanges.length,"OnlineState should not affect limbo documents."),r.snapshot&&e.push(r.snapshot)})),this.syncEngineListener.onOnlineStateChange(t),this.syncEngineListener.onWatchChange(e),this.onlineState=t,this.isPrimary&&this.sharedClientState.setOnlineState(t)}},t.prototype.rejectListen=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e,i,r,u,s,o,a=this;return b.__generator(this,(function(c){switch(c.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(t,"rejected",n),(i=(e=this.limboResolutionsByTarget[t])&&e.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(i),delete this.limboResolutionsByTarget[t],r=(r=new Ot(at.comparator)).insert(i,new Bn(i,_t.forDeletedDoc())),u=Ft().add(i),s=new Di(_t.MIN,{},new Et(G),r,u),[2,this.applyRemoteEvent(s)]):[3,1];case 1:return l(!!(o=this.queryViewsByTarget[t]),"Unknown targetId: "+t),[4,this.localStore.releaseQuery(o.query,!1).then((function(){return a.removeAndCleanupQuery(o)})).catch(Fe)];case 2:c.sent(),this.syncEngineListener.onWatchError(o.query,n),c.label=3;case 3:return[2]}}))}))},t.prototype.applyBatchState=function(t,n,e){return b.__awaiter(this,void 0,void 0,(function(){var i;return b.__generator(this,(function(r){switch(r.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(t)];case 1:return null===(i=r.sent())?(a("SyncEngine","Cannot apply mutation batch with id: "+t),[2]):"pending"!==n?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return r.sent(),[3,4];case 3:"acknowledged"===n||"rejected"===n?(this.processUserCallback(t,e||null),this.localStore.removeCachedMutationBatchMetadata(t)):f("Unknown batchState: "+n),r.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(i)];case 5:return r.sent(),[2]}}))}))},t.prototype.applySuccessfulWrite=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e;return b.__generator(this,(function(i){switch(i.label){case 0:this.assertSubscribed("applySuccessfulWrite()"),this.processUserCallback(n=t.batch.batchId,null),this.triggerPendingWritesCallbacks(n),i.label=1;case 1:return i.trys.push([1,4,,6]),[4,this.localStore.acknowledgeBatch(t)];case 2:return e=i.sent(),this.sharedClientState.updateMutationState(n,"acknowledged"),[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 3:return i.sent(),[3,6];case 4:return[4,Fe(i.sent())];case 5:return i.sent(),[3,6];case 6:return[2]}}))}))},t.prototype.rejectFailedWrite=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e;return b.__generator(this,(function(i){switch(i.label){case 0:this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(t,n),this.triggerPendingWritesCallbacks(t),i.label=1;case 1:return i.trys.push([1,4,,6]),[4,this.localStore.rejectBatch(t)];case 2:return e=i.sent(),this.sharedClientState.updateMutationState(t,"rejected",n),[4,this.emitNewSnapsAndNotifyLocalStore(e)];case 3:return i.sent(),[3,6];case 4:return[4,Fe(i.sent())];case 5:return i.sent(),[3,6];case 6:return[2]}}))}))},t.prototype.registerPendingWritesCallback=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e;return b.__generator(this,(function(i){switch(i.label){case 0:return this.remoteStore.canUseNetwork()||a("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.localStore.getHighestUnacknowledgedBatchId()];case 1:return-1===(n=i.sent())?(t.resolve(),[2]):((e=this.pendingWritesCallbacks.get(n)||[]).push(t),this.pendingWritesCallbacks.set(n,e),[2])}}))}))},t.prototype.triggerPendingWritesCallbacks=function(t){(this.pendingWritesCallbacks.get(t)||[]).forEach((function(t){t.resolve()})),this.pendingWritesCallbacks.delete(t)},t.prototype.rejectOutstandingPendingWritesCallbacks=function(t){this.pendingWritesCallbacks.forEach((function(n){n.forEach((function(n){n.reject(new w(m.CANCELLED,t))}))})),this.pendingWritesCallbacks.clear()},t.prototype.addMutationCallback=function(t,n){var e=this.mutationUserCallbacks[this.currentUser.toKey()];e||(e=new Ot(G)),e=e.insert(t,n),this.mutationUserCallbacks[this.currentUser.toKey()]=e},t.prototype.processUserCallback=function(t,n){var e=this.mutationUserCallbacks[this.currentUser.toKey()];if(e){var i=e.get(t);i&&(l(t===e.minKey(),"Mutation callbacks processed out-of-order?"),n?i.reject(n):i.resolve(),e=e.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=e}},t.prototype.removeAndCleanupQuery=function(t){var n=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var e=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),e.forEach((function(t){n.limboDocumentRefs.containsKey(t)||n.removeLimboTarget(t)}))}},t.prototype.removeLimboTarget=function(t){var n=this.limboTargetsByKey.get(t);null!==n&&(this.remoteStore.unlisten(n),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[n])},t.prototype.updateTrackedLimbos=function(t,n){for(var e=0,i=n;e<i.length;e++){var r=i[e];r instanceof br?(this.limboDocumentRefs.addReference(r.key,t),this.trackLimboChange(r)):r instanceof pr?(a("SyncEngine","Document no longer in limbo: "+r.key),this.limboDocumentRefs.removeReference(r.key,t),this.limboDocumentRefs.containsKey(r.key)||this.removeLimboTarget(r.key)):f("Unknown limbo change: "+JSON.stringify(r))}},t.prototype.trackLimboChange=function(t){var n=t.key;if(!this.limboTargetsByKey.get(n)){a("SyncEngine","New document in limbo: "+n);var e=this.limboTargetIdGenerator.next(),i=Li.atPath(n.path);this.limboResolutionsByTarget[e]=new kr(n),this.remoteStore.listen(new ke(i,e,be.LimboResolution,it.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(n,e)}},t.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},t.prototype.emitNewSnapsAndNotifyLocalStore=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e,i,r,u=this;return b.__generator(this,(function(s){switch(s.label){case 0:return e=[],i=[],r=[],this.queryViewsByQuery.forEach((function(s,o){r.push(Promise.resolve().then((function(){var n=o.view.computeDocChanges(t);return n.needsRefill?u.localStore.executeQuery(o.query).then((function(t){return o.view.computeDocChanges(t,n)})):n})).then((function(t){var r=o.view.applyChanges(t,!0===u.isPrimary,n&&n.targetChanges[o.targetId]);if(u.updateTrackedLimbos(o.targetId,r.limboChanges),r.snapshot){u.isPrimary&&u.sharedClientState.updateQueryState(o.targetId,r.snapshot.fromCache?"not-current":"current"),e.push(r.snapshot);var s=wr.fromSnapshot(o.targetId,r.snapshot);i.push(s)}})))})),[4,Promise.all(r)];case 1:return s.sent(),this.syncEngineListener.onWatchChange(e),[4,this.localStore.notifyLocalViewChanges(i)];case 2:return s.sent(),[2]}}))}))},t.prototype.assertSubscribed=function(t){l(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},t.prototype.handleCredentialChange=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e;return b.__generator(this,(function(i){switch(i.label){case 0:return n=!this.currentUser.isEqual(t),this.currentUser=t,n?(this.rejectOutstandingPendingWritesCallbacks("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.localStore.handleUserChange(t)]):[3,3];case 1:return e=i.sent(),this.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(e.affectedDocuments)];case 2:i.sent(),i.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return i.sent(),[2]}}))}))},t.prototype.applyPrimaryState=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e,i,r,u,s,o=this;return b.__generator(this,(function(a){switch(a.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return a.sent(),n=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(n.toArray())];case 2:for(e=a.sent(),i=0,r=e;i<r.length;i++)this.remoteStore.listen(r[i]);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,u=[],s=Promise.resolve(),O(this.queryViewsByTarget,(function(t,n){o.sharedClientState.isLocalQueryTarget(t)?u.push(t):s=s.then((function(){return o.unlisten(n.query)})),o.remoteStore.unlisten(n.targetId)})),[4,s]);case 4:return a.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(u)];case 5:return a.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:a.sent(),a.label=7;case 7:return[2]}}))}))},t.prototype.resetLimboDocuments=function(){var t=this;O(this.limboResolutionsByTarget,(function(n){t.remoteStore.unlisten(n)})),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Ot(at.comparator)},t.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){return b.__awaiter(this,void 0,void 0,(function(){var n,e,i,r,u,s,o,a,c;return b.__generator(this,(function(h){switch(h.label){case 0:n=[],e=[],i=0,r=t,h.label=1;case 1:return i<r.length?(s=void 0,(o=this.queryViewsByTarget[u=r[i]])?[4,this.localStore.releaseQuery(o.query,!0)]:[3,5]):[3,11];case 2:return h.sent(),[4,this.localStore.allocateQuery(o.query)];case 3:return s=h.sent(),[4,this.synchronizeViewAndComputeSnapshot(o)];case 4:return(a=h.sent()).snapshot&&e.push(a.snapshot),[3,9];case 5:return l(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(u)];case 6:return l(!!(c=h.sent()),"Query data for target "+u+" not found"),[4,this.localStore.allocateQuery(c)];case 7:return s=h.sent(),[4,this.initializeViewAndComputeSnapshot(s,!1)];case 8:h.sent(),h.label=9;case 9:n.push(s),h.label=10;case 10:return i++,[3,1];case 11:return this.syncEngineListener.onWatchChange(e),[2,n]}}))}))},t.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},t.prototype.applyTargetState=function(t,n,e){return b.__awaiter(this,void 0,void 0,(function(){var i,r,u,s,o;return b.__generator(this,(function(c){switch(c.label){case 0:if(this.isPrimary)return a("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[t])return[3,11];switch(n){case"current":case"not-current":return[3,1];case"rejected":return[3,8]}return[3,10];case 1:return c.trys.push([1,4,,8]),[4,this.localStore.getNewDocumentChanges()];case 2:return i=c.sent(),r=Di.createSynthesizedRemoteEventForCurrentChange(t,"current"===n),[4,this.emitNewSnapsAndNotifyLocalStore(i,r)];case 3:return c.sent(),[3,11];case 4:return(h=u=c.sent()).code!==m.DATA_LOSS||h.message!==Gn?[3,6]:(s=[],O(this.queryViewsByTarget,(function(t){return s.push(t)})),[4,this.synchronizeQueryViewsAndRaiseSnapshots(s)]);case 5:return c.sent(),[3,7];case 6:throw u;case 7:return[3,8];case 8:return this.removeAndCleanupQuery(o=this.queryViewsByTarget[t]),[4,this.localStore.releaseQuery(o.query,!0)];case 9:return c.sent(),this.syncEngineListener.onWatchError(o.query,e),[3,11];case 10:f("Unexpected target state: "+n),c.label=11;case 11:return[2]}var h}))}))},t.prototype.applyActiveTargetsChange=function(t,n){return b.__awaiter(this,void 0,void 0,(function(){var e,i,r,u,s,o,a,c,h,f=this;return b.__generator(this,(function(d){switch(d.label){case 0:if(!this.isPrimary)return[2];e=0,i=t,d.label=1;case 1:return e<i.length?(l(!this.queryViewsByTarget[h=i[e]],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(h)]):[3,6];case 2:return l(!!(r=d.sent()),"Query data for active target "+h+" not found"),[4,this.localStore.allocateQuery(r)];case 3:return u=d.sent(),[4,this.initializeViewAndComputeSnapshot(u,!1)];case 4:d.sent(),this.remoteStore.listen(u),d.label=5;case 5:return e++,[3,1];case 6:s=function(t){var n;return b.__generator(this,(function(e){switch(e.label){case 0:return(n=o.queryViewsByTarget[t])?[4,o.localStore.releaseQuery(n.query,!1).then((function(){f.remoteStore.unlisten(t),f.removeAndCleanupQuery(n)})).catch(Fe)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))},o=this,a=0,c=n,d.label=7;case 7:return a<c.length?[5,s(h=c[a])]:[3,10];case 8:d.sent(),d.label=9;case 9:return a++,[3,7];case 10:return[2]}}))}))},t.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},t.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},t.prototype.getRemoteKeysForTarget=function(t){var n=this.limboResolutionsByTarget[t];return n&&n.receivedDocument?Ft().add(n.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:Ft()},t}(),Sr=function(){function t(t){this.uid=t}return t.prototype.isAuthenticated=function(){return null!=this.uid},t.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t.UNAUTHENTICATED=new t(null),t.GOOGLE_CREDENTIALS=new t("google-credentials-uid"),t.FIRST_PARTY=new t("first-party-uid"),t}(),Er="SharedClientState",Dr="firestore_clients",Ir="firestore_mutations",Mr="firestore_targets",Ar="firestore_online_state",Tr="firestore_sequence_number",Nr=function(){function t(t,n,e,i){this.user=t,this.batchId=n,this.state=e,this.error=i,l(void 0!==i==("rejected"===e),"MutationMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(n,e,i){var r=JSON.parse(i),u="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),s=void 0;return u&&r.error&&(u="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new w(r.error.code,r.error.message)),u?new t(n,e,r.state,s):(c(Er,"Failed to parse mutation state for ID '"+e+"': "+i),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),xr=function(){function t(t,n,e){this.targetId=t,this.state=n,this.error=e,l(void 0!==e==("rejected"===n),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(n,e){var i=JSON.parse(e),r="object"==typeof i&&-1!==["not-current","current","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),u=void 0;return r&&i.error&&(r="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(u=new w(i.error.code,i.error.message)),r?new t(n,i.state,u):(c(Er,"Failed to parse target state for ID '"+n+"': "+e),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),Cr=function(){function t(t,n){this.clientId=t,this.activeTargetIds=n}return t.fromWebStorageEntry=function(n,e){for(var i=JSON.parse(e),r="object"==typeof i&&i.activeTargetIds instanceof Array,u=Ut(),s=0;r&&s<i.activeTargetIds.length;++s)r=ii(i.activeTargetIds[s]),u=u.add(i.activeTargetIds[s]);return r?new t(n,u):(c(Er,"Failed to parse client data for instance '"+n+"': "+e),null)},t}(),Rr=function(){function t(t,n){this.clientId=t,this.onlineState=n}return t.fromWebStorageEntry=function(n){var e=JSON.parse(n);return"object"==typeof e&&e.onlineState in ci&&"string"==typeof e.clientId?new t(e.clientId,ci[e.onlineState]):(c(Er,"Failed to parse online state: "+n),null)},t}(),Fr=function(){function t(){this.activeTargetIds=Ut()}return t.prototype.addQueryTarget=function(t){l(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),Pr=function(){function t(n,e,i,r,u){if(this.queue=n,this.platform=e,this.persistenceKey=i,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!t.isAvailable(this.platform))throw new w(m.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var s=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=u,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey=Tr+"_"+i,this.activeClients[this.localClientId]=new Fr,this.clientStateKeyRe=new RegExp("^"+Dr+"_"+s+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Ir+"_"+s+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+Mr+"_"+s+"_(\\d+)$"),this.onlineStateKey=Ar+"_"+i,this.platform.window.addEventListener("storage",this.storageListener)}return t.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},t.prototype.start=function(){return b.__awaiter(this,void 0,void 0,(function(){var t,n,e,i,r,u,s,o,a,c,h=this;return b.__generator(this,(function(f){switch(f.label){case 0:return l(!this.started,"WebStorageSharedClientState already started"),l(null!==this.syncEngine,"syncEngine property must be set before calling start()"),l(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(t=f.sent(),n=0,e=t;n<e.length;n++)(i=e[n])!==this.localClientId&&(r=this.getItem(this.toWebStorageClientStateKey(i)))&&(u=Cr.fromWebStorageEntry(i,r))&&(this.activeClients[u.clientId]=u);for(this.persistClientState(),(s=this.storage.getItem(this.onlineStateKey))&&(o=this.fromWebStorageOnlineState(s))&&this.handleOnlineStateEvent(o),a=0,c=this.earlyEvents;a<c.length;a++)this.handleWebStorageEvent(c[a]);return this.earlyEvents=[],this.platform.window.addEventListener("unload",(function(){return h.shutdown()})),this.started=!0,[2]}}))}))},t.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},t.prototype.getAllActiveQueryTargets=function(){var t=Ut();return k(this.activeClients,(function(n,e){t=t.unionWith(e.activeTargetIds)})),t},t.prototype.isActiveQueryTarget=function(t){for(var n in this.activeClients)if(this.activeClients.hasOwnProperty(n)&&this.activeClients[n].activeTargetIds.has(t))return!0;return!1},t.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},t.prototype.updateMutationState=function(t,n,e){this.persistMutationState(t,n,e),this.removeMutationState(t)},t.prototype.addLocalQueryTarget=function(t){var n="not-current";if(this.isActiveQueryTarget(t)){var e=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(e){var i=xr.fromWebStorageEntry(t,e);i&&(n=i.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),n},t.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},t.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},t.prototype.updateQueryState=function(t,n,e){this.persistQueryTargetState(t,n,e)},t.prototype.handleUserChange=function(t,n,e){var i=this;n.forEach((function(t){i.removeMutationState(t)})),this.currentUser=t,e.forEach((function(t){i.addPendingMutation(t)}))},t.prototype.setOnlineState=function(t){this.persistOnlineState(t)},t.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},t.prototype.getItem=function(t){var n=this.storage.getItem(t);return a(Er,"READ",t,n),n},t.prototype.setItem=function(t,n){a(Er,"SET",t,n),this.storage.setItem(t,n)},t.prototype.removeItem=function(t){a(Er,"REMOVE",t),this.storage.removeItem(t)},t.prototype.handleWebStorageEvent=function(t){var n=this;if(t.storageArea===this.storage){if(a(Er,"EVENT",t.key,t.newValue),t.key===this.localClientStorageKey)return void c("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget((function(){return b.__awaiter(n,void 0,void 0,(function(){var n,e,i,r,u,s;return b.__generator(this,(function(){if(!this.started)return this.earlyEvents.push(t),[2];if(null===t.key)return[2];if(this.clientStateKeyRe.test(t.key)){if(null==t.newValue)return e=this.fromWebStorageClientStateKey(t.key),[2,this.handleClientStateEvent(e,null)];if(n=this.fromWebStorageClientState(t.key,t.newValue))return[2,this.handleClientStateEvent(n.clientId,n)]}else if(this.mutationBatchKeyRe.test(t.key)){if(null!==t.newValue&&(i=this.fromWebStorageMutationMetadata(t.key,t.newValue)))return[2,this.handleMutationBatchEvent(i)]}else if(this.queryTargetKeyRe.test(t.key)){if(null!==t.newValue&&(r=this.fromWebStorageQueryTargetMetadata(t.key,t.newValue)))return[2,this.handleQueryTargetEvent(r)]}else if(t.key===this.onlineStateKey){if(null!==t.newValue&&(u=this.fromWebStorageOnlineState(t.newValue)))return[2,this.handleOnlineStateEvent(u)]}else t.key===this.sequenceNumberKey&&(l(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(s=function(t){var n=it.INVALID;if(null!=t)try{var e=JSON.parse(t);l("number"==typeof e,"Found non-numeric sequence number"),n=e}catch(t){c(Er,"Failed to read sequence number from WebStorage",t)}return n}(t.newValue))!==it.INVALID&&this.sequenceNumberHandler(s));return[2]}))}))}))}},Object.defineProperty(t.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),t.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},t.prototype.persistMutationState=function(t,n,e){var i=new Nr(this.currentUser,t,n,e),r=this.toWebStorageMutationBatchKey(t);this.setItem(r,i.toWebStorageJSON())},t.prototype.removeMutationState=function(t){var n=this.toWebStorageMutationBatchKey(t);this.removeItem(n)},t.prototype.persistOnlineState=function(t){this.storage.setItem(this.onlineStateKey,JSON.stringify({clientId:this.localClientId,onlineState:ci[t]}))},t.prototype.persistQueryTargetState=function(t,n,e){var i=this.toWebStorageQueryTargetMetadataKey(t),r=new xr(t,n,e);this.setItem(i,r.toWebStorageJSON())},t.prototype.toWebStorageClientStateKey=function(t){return l(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),Dr+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageQueryTargetMetadataKey=function(t){return Mr+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageMutationBatchKey=function(t){var n=Ir+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(n+="_"+this.currentUser.uid),n},t.prototype.fromWebStorageClientStateKey=function(t){var n=this.clientStateKeyRe.exec(t);return n?n[1]:null},t.prototype.fromWebStorageClientState=function(t,n){var e=this.fromWebStorageClientStateKey(t);return l(null!==e,"Cannot parse client state key '"+t+"'"),Cr.fromWebStorageEntry(e,n)},t.prototype.fromWebStorageMutationMetadata=function(t,n){var e=this.mutationBatchKeyRe.exec(t);l(null!==e,"Cannot parse mutation batch key '"+t+"'");var i=Number(e[1]);return Nr.fromWebStorageEntry(new Sr(void 0!==e[2]?e[2]:null),i,n)},t.prototype.fromWebStorageQueryTargetMetadata=function(t,n){var e=this.queryTargetKeyRe.exec(t);l(null!==e,"Cannot parse query target key '"+t+"'");var i=Number(e[1]);return xr.fromWebStorageEntry(i,n)},t.prototype.fromWebStorageOnlineState=function(t){return Rr.fromWebStorageEntry(t)},t.prototype.handleMutationBatchEvent=function(t){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return t.user.uid!==this.currentUser.uid?(a(Er,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]}))}))},t.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},t.prototype.handleClientStateEvent=function(t,n){var e=this,i=this.getAllActiveQueryTargets();n?this.activeClients[t]=n:delete this.activeClients[t];var r=this.getAllActiveQueryTargets(),u=[],s=[];return r.forEach((function(t){return b.__awaiter(e,void 0,void 0,(function(){return b.__generator(this,(function(){return i.has(t)||u.push(t),[2]}))}))})),i.forEach((function(t){return b.__awaiter(e,void 0,void 0,(function(){return b.__generator(this,(function(){return r.has(t)||s.push(t),[2]}))}))})),this.syncEngine.applyActiveTargetsChange(u,s)},t.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},t}(),Ur=function(){function t(){this.localState=new Fr,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return t.prototype.addPendingMutation=function(){},t.prototype.updateMutationState=function(){},t.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},t.prototype.updateQueryState=function(t,n){this.queryState[t]=n},t.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},t.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){delete this.queryState[t]},t.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},t.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.start=function(){return this.localState=new Fr,Promise.resolve()},t.prototype.handleUserChange=function(){},t.prototype.setOnlineState=function(){},t.prototype.shutdown=function(){},t.prototype.writeSequenceNumber=function(){},t}(),$r=function(){function t(t,n){this.cacheSizeBytes=t,this.synchronizeTabs=n}return t.prototype.lruParams=function(){return Ie.withCacheSize(this.cacheSizeBytes)},t}(),Lr=function(){},qr=function(){function t(t,n,e,i){this.platform=t,this.databaseInfo=n,this.credentials=e,this.asyncQueue=i,this.clientId=W.newId()}return t.prototype.start=function(t){var n=this;this.verifyNotTerminated();var e=new ct,i=new ct,r=!1;return this.credentials.setChangeListener((function(u){r?n.asyncQueue.enqueueAndForget((function(){return n.handleCredentialChange(u)})):(r=!0,n.initializePersistence(t,i,u).then((function(t){return n.initializeRest(u,t)})).then(e.resolve,e.reject))})),this.asyncQueue.enqueueAndForget((function(){return e.promise})),i.promise},t.prototype.enableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return t.syncEngine.enableNetwork()}))},t.prototype.initializePersistence=function(t,n,e){var i=this;return t instanceof $r?this.startIndexedDbPersistence(e,t).then((function(t){return n.resolve(),t})).catch((function(t){if(n.reject(t),!i.canFallback(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),i.startMemoryPersistence()})):(n.resolve(),this.startMemoryPersistence())},t.prototype.canFallback=function(t){return t instanceof w?t.code===m.FAILED_PRECONDITION||t.code===m.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code},t.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new w(m.FAILED_PRECONDITION,"The client has already been terminated.")},t.prototype.startIndexedDbPersistence=function(t,n){var e=this,i=Re.buildStoragePrefix(this.databaseInfo),r=new lr(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then((function(){return b.__awaiter(e,void 0,void 0,(function(){var e,u;return b.__generator(this,(function(s){switch(s.label){case 0:if(n.synchronizeTabs&&!Pr.isAvailable(this.platform))throw new w(m.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return e=n.lruParams(),this.sharedClientState=n.synchronizeTabs?new Pr(this.asyncQueue,this.platform,i,this.clientId,t):new Ur,[4,Re.createIndexedDbPersistence({allowTabSynchronization:n.synchronizeTabs,persistenceKey:i,clientId:this.clientId,platform:this.platform,queue:this.asyncQueue,serializer:r,lruParams:e,sequenceNumberSyncer:this.sharedClientState})];case 1:return u=s.sent(),this.persistence=u,[2,u.referenceDelegate.garbageCollector]}}))}))}))},t.prototype.startMemoryPersistence=function(){return this.persistence=Ye.createEagerPersistence(this.clientId),this.sharedClientState=new Ur,Promise.resolve(null)},t.prototype.initializeRest=function(t,n){var e=this;return a("FirestoreClient","Initializing. user=",t.uid),this.platform.loadConnection(this.databaseInfo).then((function(i){return b.__awaiter(e,void 0,void 0,(function(){var e,r,u,s,o=this;return b.__generator(this,(function(a){switch(a.label){case 0:return this.localStore=new Ve(this.persistence,t),n&&(this.lruScheduler=new Me(n,this.asyncQueue,this.localStore)),e=this.platform.newConnectivityMonitor(),r=this.platform.newSerializer(this.databaseInfo.databaseId),u=new vi(this.asyncQueue,i,this.credentials,r),s=function(t){return o.syncEngine.applyOnlineStateChange(t,hi.SharedClientState)},this.remoteStore=new Ui(this.localStore,u,this.asyncQueue,(function(t){return o.syncEngine.applyOnlineStateChange(t,hi.RemoteStore)}),e),this.syncEngine=new jr(this.localStore,this.remoteStore,this.sharedClientState,t),this.sharedClientState.onlineStateHandler=s,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new vr(this.syncEngine),[4,this.sharedClientState.start()];case 1:return a.sent(),[4,this.remoteStore.start()];case 2:return a.sent(),[4,this.persistence.setPrimaryStateListener((function(t){return b.__awaiter(o,void 0,void 0,(function(){return b.__generator(this,(function(n){switch(n.label){case 0:return[4,this.syncEngine.applyPrimaryState(t)];case 1:return n.sent(),this.lruScheduler&&(t&&!this.lruScheduler.started?this.lruScheduler.start():t||this.lruScheduler.stop()),[2]}}))}))}))];case 3:return a.sent(),[4,this.persistence.setDatabaseDeletedListener((function(){return b.__awaiter(o,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return[4,this.terminate()];case 1:return t.sent(),[2]}}))}))}))];case 4:return a.sent(),[2]}}))}))}))},t.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),a("FirestoreClient","Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},t.prototype.disableNetwork=function(){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return t.syncEngine.disableNetwork()}))},t.prototype.terminate=function(){var t=this;return this.asyncQueue.enqueueAndInitiateShutdown((function(){return b.__awaiter(t,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return t.sent(),[4,this.sharedClientState.shutdown()];case 2:return t.sent(),[4,this.persistence.shutdown()];case 3:return t.sent(),this.credentials.removeChangeListener(),[2]}}))}))}))},t.prototype.waitForPendingWrites=function(){var t=this;this.verifyNotTerminated();var n=new ct;return this.asyncQueue.enqueueAndForget((function(){return t.syncEngine.registerPendingWritesCallback(n)})),n.promise},t.prototype.listen=function(t,n,e){var i=this;this.verifyNotTerminated();var r=new mr(t,n,e);return this.asyncQueue.enqueueAndForget((function(){return i.eventMgr.listen(r)})),r},t.prototype.unlisten=function(t){var n=this;this.clientTerminated||this.asyncQueue.enqueueAndForget((function(){return n.eventMgr.unlisten(t)}))},t.prototype.getDocumentFromLocalCache=function(t){var n=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return n.localStore.readDocument(t)})).then((function(t){if(t instanceof qn)return t;if(t instanceof Bn)return null;throw new w(m.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")}))},t.prototype.getDocumentsFromLocalCache=function(t){var n=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return n.localStore.executeQuery(t)})).then((function(n){var e=Ft(),i=new gr(t,e),r=i.computeDocChanges(n);return i.applyChanges(r,!1).snapshot}))},t.prototype.write=function(t){var n=this;this.verifyNotTerminated();var e=new ct;return this.asyncQueue.enqueueAndForget((function(){return n.syncEngine.write(t,e)})),e.promise},t.prototype.databaseId=function(){return this.databaseInfo.databaseId},t.prototype.addSnapshotsInSyncListener=function(t){var n=this;this.verifyNotTerminated(),this.asyncQueue.enqueueAndForget((function(){return n.eventMgr.addSnapshotsInSyncListener(t),Promise.resolve()}))},t.prototype.removeSnapshotsInSyncListener=function(t){this.clientTerminated||this.eventMgr.removeSnapshotsInSyncListener(t)},Object.defineProperty(t.prototype,"clientTerminated",{get:function(){return this.asyncQueue.isShuttingDown},enumerable:!0,configurable:!0}),t.prototype.transaction=function(t){var n=this;this.verifyNotTerminated();var e=new ct;return this.asyncQueue.enqueueAndForget((function(){return n.syncEngine.runTransaction(n.asyncQueue,t,e),Promise.resolve()})),e.promise},t}(),Br=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},t.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},t.prototype.mute=function(){this.muted=!0},t.prototype.scheduleEvent=function(t,n){var e=this;this.muted||setTimeout((function(){e.muted||t(n)}),0)},t}(),zr=function(){function t(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];!function(t,n){if(!(n instanceof Array)||n.length<1)throw new w(m.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least "+V(1,"element")+".")}(0,t);for(var e=0;e<t.length;++e)if(T("FieldPath","string",e,t[e]),0===t[e].length)throw new w(m.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ot(t)}return t.documentId=function(){return t._DOCUMENT_ID},t.prototype.isEqual=function(n){if(!(n instanceof t))throw B("isEqual","FieldPath",1,n);return this._internalPath.isEqual(n._internalPath)},t._DOCUMENT_ID=new t(ot.keyField().canonicalString()),t}(),Vr=new RegExp("[~\\*/\\[\\]]"),Wr=function(t,n){this.user=n,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}},Gr=function(){function t(){this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t){l(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,t(Sr.UNAUTHENTICATED)},t.prototype.removeChangeListener=function(){l(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},t}(),Qr=function(){function t(t){var n=this;this.app=t,this.tokenListener=null,this.currentUser=Sr.UNAUTHENTICATED,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){n.tokenCounter++,n.currentUser=n.getUser(),n.changeListener&&n.changeListener(n.currentUser)},this.currentUser=this.getUser(),this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return t.prototype.getToken=function(){var t=this;l(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.tokenCounter,e=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(e).then((function(e){if(t.tokenCounter!==n)throw new w(m.ABORTED,"getToken aborted due to token change.");return e?(l("string"==typeof e.accessToken,"Invalid tokenData returned from getToken():"+e),new Wr(e.accessToken,t.currentUser)):null}))},t.prototype.invalidateToken=function(){this.forceRefresh=!0},t.prototype.setChangeListener=function(t){l(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,t(this.currentUser)},t.prototype.removeChangeListener=function(){l(null!=this.tokenListener,"removeChangeListener() called twice"),l(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},t.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return l(null===t||"string"==typeof t,"Received invalid UID: "+t),new Sr(t)},t}(),Yr=function(){function t(t,n){this.gapi=t,this.sessionIndex=n,this.type="FirstParty",this.user=Sr.FIRST_PARTY}return Object.defineProperty(t.prototype,"authHeaders",{get:function(){var t={"X-Goog-AuthUser":this.sessionIndex},n=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return n&&(t.Authorization=n),t},enumerable:!0,configurable:!0}),t}(),Hr=function(){function t(t,n){this.gapi=t,this.sessionIndex=n}return t.prototype.getToken=function(){return Promise.resolve(new Yr(this.gapi,this.sessionIndex))},t.prototype.setChangeListener=function(t){t(Sr.FIRST_PARTY)},t.prototype.removeChangeListener=function(){},t.prototype.invalidateToken=function(){},t}();function Jr(t){if(!t)return new Gr;switch(t.type){case"gapi":var n=t.client;return l(!("object"!=typeof n||null===n||!n.auth||!n.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new Hr(n,t.sessionIndex||"0");case"provider":return t.client;default:throw new w(m.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}function Kr(t){return function(t){if("object"!=typeof t||null===t)return!1;for(var n=t,e=0,i=["next","error","complete"];e<i.length;e++){var r=i[e];if(r in n&&"function"==typeof n[r])return!0}return!1}(t)}var Xr,Zr=function(){function t(t){this._methodName=t}return t.delete=function(){return D("FieldValue.delete",arguments),tu.instance},t.serverTimestamp=function(){return D("FieldValue.serverTimestamp",arguments),nu.instance},t.arrayUnion=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return M("FieldValue.arrayUnion",arguments,1),new eu(t)},t.arrayRemove=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return M("FieldValue.arrayRemove",arguments,1),new iu(t)},t.increment=function(t){return T("FieldValue.increment","number",1,t),I("FieldValue.increment",arguments,1),new ru(t)},t.prototype.isEqual=function(t){return this===t},t}(),tu=function(t){function n(){return t.call(this,"FieldValue.delete")||this}return b.__extends(n,t),n.instance=new n,n}(Zr),nu=function(t){function n(){return t.call(this,"FieldValue.serverTimestamp")||this}return b.__extends(n,t),n.instance=new n,n}(Zr),eu=function(t){function n(n){var e=t.call(this,"FieldValue.arrayUnion")||this;return e._elements=n,e}return b.__extends(n,t),n}(Zr),iu=function(t){function n(n){var e=t.call(this,"FieldValue.arrayRemove")||this;return e._elements=n,e}return b.__extends(n,t),n}(Zr),ru=function(t){function n(n){var e=t.call(this,"FieldValue.increment")||this;return e._operand=n,e}return b.__extends(n,t),n}(Zr),uu=g(Zr,"Use FieldValue.<field>() instead."),su=/^__.*__$/,ou=function(){function t(t,n,e){this.data=t,this.fieldMask=n,this.fieldTransforms=e}return t.prototype.toMutations=function(t,n){var e=[];return e.push(null!==this.fieldMask?new _n(t,this.data,this.fieldMask,n):new yn(t,this.data,n)),this.fieldTransforms.length>0&&e.push(new On(t,this.fieldTransforms)),e},t}(),au=function(){function t(t,n,e){this.data=t,this.fieldMask=n,this.fieldTransforms=e}return t.prototype.toMutations=function(t,n){var e=[new _n(t,this.data,this.fieldMask,n)];return this.fieldTransforms.length>0&&e.push(new On(t,this.fieldTransforms)),e},t}();function cu(t){switch(t){case Xr.Set:case Xr.MergeSet:case Xr.Update:return!0;case Xr.Argument:return!1;default:throw f("Unexpected case for UserDataSource: "+t)}}!function(t){t[t.Set=0]="Set",t[t.Update=1]="Update",t[t.MergeSet=2]="MergeSet",t[t.Argument=3]="Argument"}(Xr||(Xr={}));var hu=function(){function t(t,n,e,i,r,u){this.dataSource=t,this.methodName=n,this.path=e,this.arrayElement=i,void 0===r&&this.validatePath(),this.arrayElement=void 0!==i&&i,this.fieldTransforms=r||[],this.fieldMask=u||[]}return t.prototype.childContextForField=function(n){var e=null==this.path?null:this.path.child(n),i=new t(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return i.validatePathSegment(n),i},t.prototype.childContextForFieldPath=function(n){var e=null==this.path?null:this.path.child(n),i=new t(this.dataSource,this.methodName,e,!1,this.fieldTransforms,this.fieldMask);return i.validatePath(),i},t.prototype.childContextForArray=function(){return new t(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},t.prototype.createError=function(t){var n=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new w(m.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+n)},t.prototype.contains=function(t){return void 0!==this.fieldMask.find((function(n){return t.isPrefixOf(n)}))||void 0!==this.fieldTransforms.find((function(n){return t.isPrefixOf(n.field)}))},t.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},t.prototype.validatePathSegment=function(t){if(cu(this.dataSource)&&su.test(t))throw this.createError("Document fields cannot begin and end with __")},t}(),fu=function(t,n){this.databaseId=t,this.key=n},lu=function(){function t(t){this.preConverter=t}return t.prototype.parseSetData=function(t,n){var e=new hu(Xr.Set,t,ot.EMPTY_PATH);vu("Data must be an object, but it was:",e,n);var i=this.parseData(n,e);return new ou(i,null,e.fieldTransforms)},t.prototype.parseMergeData=function(t,n,e){var i=new hu(Xr.MergeSet,t,ot.EMPTY_PATH);vu("Data must be an object, but it was:",i,n);var r,u,s=this.parseData(n,i);if(e){for(var o=new Et(ot.comparator),a=0,c=e;a<c.length;a++){var h=c[a],l=void 0;if(h instanceof zr)l=h._internalPath;else{if("string"!=typeof h)throw f("Expected stringOrFieldPath to be a string or a FieldPath");l=wu(t,h)}if(!i.contains(l))throw new w(m.INVALID_ARGUMENT,"Field '"+l+"' is specified in your field mask but missing from your input data.");o=o.add(l)}r=dn.fromSet(o),u=i.fieldTransforms.filter((function(t){return r.covers(t.field)}))}else r=dn.fromArray(i.fieldMask),u=i.fieldTransforms;return new ou(s,r,u)},t.prototype.parseUpdateData=function(t,n){var e=this,i=new hu(Xr.Update,t,ot.EMPTY_PATH);vu("Data must be an object, but it was:",i,n);var r=new Et(ot.comparator),u=Un.EMPTY;k(n,(function(n,s){var o=wu(t,n),a=i.childContextForFieldPath(o);if((s=e.runPreConverter(s,a))instanceof tu)r=r.add(o);else{var c=e.parseData(s,a);null!=c&&(r=r.add(o),u=u.set(o,c))}}));var s=dn.fromSet(r);return new au(u,s,i.fieldTransforms)},t.prototype.parseUpdateVarargs=function(t,n,e,i){var r=new hu(Xr.Update,t,ot.EMPTY_PATH),u=[mu(t,n)],s=[e];if(i.length%2!=0)throw new w(m.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var o=0;o<i.length;o+=2)u.push(mu(t,i[o])),s.push(i[o+1]);var a=new Et(ot.comparator),c=Un.EMPTY;for(o=0;o<u.length;++o){var h=u[o],f=r.childContextForFieldPath(h),l=this.runPreConverter(s[o],f);if(l instanceof tu)a=a.add(h);else{var d=this.parseData(l,f);null!=d&&(a=a.add(h),c=c.set(h,d))}}var v=dn.fromSet(a);return new au(c,v,r.fieldTransforms)},t.prototype.parseQueryValue=function(t,n){var e=new hu(Xr.Argument,t,ot.EMPTY_PATH),i=this.parseData(n,e);return l(null!=i,"Parsed data should not be null."),l(0===e.fieldTransforms.length,"Field transforms should have been disallowed."),i},t.prototype.runPreConverter=function(t,n){try{return this.preConverter(t)}catch(t){var e=bu(t);throw n.createError(e)}},t.prototype.parseData=function(t,n){if(du(t=this.runPreConverter(t,n)))return vu("Unsupported field value:",n,t),this.parseObject(t,n);if(t instanceof Zr)return this.parseSentinelFieldValue(t,n),null;if(n.path&&n.fieldMask.push(n.path),t instanceof Array){if(n.arrayElement)throw n.createError("Nested arrays are not supported");return this.parseArray(t,n)}return this.parseScalarValue(t,n)},t.prototype.parseObject=function(t,n){var e=this,i=new Ot(G);return E(t)?n.path&&n.path.length>0&&n.fieldMask.push(n.path):k(t,(function(t,r){var u=e.parseData(r,n.childContextForField(t));null!=u&&(i=i.insert(t,u))})),new Un(i)},t.prototype.parseArray=function(t,n){for(var e=[],i=0,r=0,u=t;r<u.length;r++){var s=this.parseData(u[r],n.childContextForArray(i));null==s&&(s=En.INSTANCE),e.push(s),i++}return new $n(e)},t.prototype.parseSentinelFieldValue=function(t,n){if(!cu(n.dataSource))throw n.createError(t._methodName+"() can only be used with update() and set()");if(null===n.path)throw n.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof tu){if(n.dataSource!==Xr.MergeSet)throw n.dataSource===Xr.Update?(l(n.path.length>0,"FieldValue.delete() at the top level should have already been handled."),n.createError("FieldValue.delete() can only appear at the top level of your update data")):n.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");n.fieldMask.push(n.path)}else if(t instanceof nu)n.fieldTransforms.push(new vn(n.path,Zi.instance));else if(t instanceof eu){var e=this.parseArrayTransformElements(t._methodName,t._elements),i=new tr(e);n.fieldTransforms.push(new vn(n.path,i))}else if(t instanceof iu){e=this.parseArrayTransformElements(t._methodName,t._elements);var r=new nr(e);n.fieldTransforms.push(new vn(n.path,r))}else if(t instanceof ru){var u=this.parseQueryValue("FieldValue.increment",t._operand),s=new er(u);n.fieldTransforms.push(new vn(n.path,s))}else f("Unknown FieldValue type: "+t)},t.prototype.parseScalarValue=function(t,n){if(null===t)return En.INSTANCE;if("number"==typeof t)return ii(t)?new An(t):new Tn(t);if("boolean"==typeof t)return Dn.of(t);if("string"==typeof t)return new Nn(t);if(t instanceof Date)return new xn(yt.fromDate(t));if(t instanceof yt)return new xn(new yt(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof $i)return new Pn(t);if(t instanceof X)return new Rn(t);if(t instanceof fu)return new Fn(t.databaseId,t.key);throw n.createError("Unsupported field value: "+$(t))},t.prototype.parseArrayTransformElements=function(t,n){var e=this;return n.map((function(n,i){var r=new hu(Xr.Argument,t,ot.EMPTY_PATH);return e.parseData(n,r.childContextForArray(i))}))},t}();function du(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof yt||t instanceof $i||t instanceof X||t instanceof fu||t instanceof Zr)}function vu(t,n,e){if(!du(e)||!U(e)){var i=$(e);throw n.createError("an object"===i?t+" a custom object":t+" "+i)}}function mu(t,n){if(n instanceof zr)return n._internalPath;if("string"==typeof n)return wu(t,n);throw new w(m.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function wu(t,n){try{return function(t){if(t.search(Vr)>=0)throw new w(m.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(zr.bind.apply(zr,[void 0].concat(t.split("."))))}catch(n){throw new w(m.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(n)._internalPath}catch(n){var e=bu(n);throw new w(m.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+e)}}function bu(t){return t instanceof Error?t.message:t.toString()}var pu="firestore.googleapis.com",gu=!0,yu=!0,_u=!1,Ou=Ie.COLLECTION_DISABLED,ku=function(){function t(t){if(void 0===t.host){if(void 0!==t.ssl)throw new w(m.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=pu,this.ssl=gu}else x("settings","non-empty string","host",t.host),this.host=t.host,C("settings","boolean","ssl",t.ssl),this.ssl=_(t.ssl,gu);if(q("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),C("settings","object","credentials",t.credentials),this.credentials=t.credentials,C("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?c("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&c("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=_(t.timestampsInSnapshots,yu),C("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=Ie.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==Ou&&t.cacheSizeBytes<Ie.MINIMUM_CACHE_SIZE_BYTES)throw new w(m.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+Ie.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}C("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0===t.experimentalForceLongPolling?_u:t.experimentalForceLongPolling}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling},t}(),ju=function(){function t(n){var e=this;if(this._firebaseApp=null,this._queue=new ft,this.INTERNAL={delete:function(){return b.__awaiter(e,void 0,void 0,(function(){return b.__generator(this,(function(t){switch(t.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.terminate()];case 1:return t.sent(),[2]}}))}))}},"object"==typeof n.options){var i=n;this._firebaseApp=i,this._databaseId=t.databaseIdFromApp(i),this._persistenceKey=i.name,this._credentials=new Qr(i)}else{var r=n;if(!r.projectId)throw new w(m.INVALID_ARGUMENT,"Must provide projectId");this._databaseId=new et(r.projectId,r.database),this._persistenceKey="[DEFAULT]",this._credentials=new Gr}this._settings=new ku({}),this._dataConverter=this.createDataConverter(this._databaseId)}return t.prototype.settings=function(t){if(I("Firestore.settings",arguments,1),T("Firestore.settings","object",1,t),y(t,"persistence"))throw new w(m.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var n=new ku(t);if(this._firestoreClient&&!this._settings.isEqual(n))throw new w(m.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._settings=n,void 0!==n.credentials&&(this._credentials=Jr(n.credentials))},t.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},t.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},t.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new w(m.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var n=!1;return t&&(void 0!==t.experimentalTabSynchronization&&c("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),n=_(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,!1)),this.configureClient(new $r(this._settings.cacheSizeBytes,n))},t.prototype.clearPersistence=function(){var t=this,n=Re.buildStoragePrefix(this.makeDatabaseInfo()),e=new ct;return this._queue.enqueueAndForgetEvenAfterShutdown((function(){return b.__awaiter(t,void 0,void 0,(function(){var t;return b.__generator(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientTerminated)throw new w(m.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,Re.clearPersistence(n)];case 1:return i.sent(),e.resolve(),[3,3];case 2:return t=i.sent(),e.reject(t),[3,3];case 3:return[2]}}))}))})),e.promise},t.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty(t.prototype,"_isTerminated",{get:function(){return this.ensureClientConfigured(),this._firestoreClient.clientTerminated},enumerable:!0,configurable:!0}),t.prototype.waitForPendingWrites=function(){return this.ensureClientConfigured(),this._firestoreClient.waitForPendingWrites()},t.prototype._onSnapshotsInSync=function(t){return this.ensureClientConfigured(),Kr(t)?this.onSnapshotsInSyncInternal(t):(T("Firestore.onSnapshotsInSync","function",1,t),this.onSnapshotsInSyncInternal({next:t}))},t.prototype.onSnapshotsInSyncInternal=function(t){var n=this,e=new Br({next:function(){t.next&&t.next()},error:function(){throw f("Uncaught Error in onSnapshotsInSync")}});return this._firestoreClient.addSnapshotsInSyncListener(e),function(){e.mute(),n._firestoreClient.removeSnapshotsInSyncListener(e)}},t.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Lr),this._firestoreClient},t.prototype.makeDatabaseInfo=function(){return new tt(this._databaseId,this._persistenceKey,this._settings.host,this._settings.ssl,this._settings.forceLongPolling)},t.prototype.configureClient=function(t){l(!!this._settings.host,"FirestoreSettings.host is not set"),l(!this._firestoreClient,"configureClient() called multiple times");var n=this.makeDatabaseInfo();return this._firestoreClient=new qr(d.getPlatform(),n,this._credentials,this._queue),this._firestoreClient.start(t)},t.prototype.createDataConverter=function(t){return new lu((function(n){if(n instanceof Du){var e=t,i=n.firestore._databaseId;if(!i.isEqual(e))throw new w(m.INVALID_ARGUMENT,"Document reference is for database "+i.projectId+"/"+i.database+" but should be for database "+e.projectId+"/"+e.database);return new fu(t,n._key)}return n}))},t.databaseIdFromApp=function(t){var n=t.options;if(!y(n,"projectId"))throw new w(m.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var e=n.projectId;if(!e||"string"!=typeof e)throw new w(m.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new et(e)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this._firebaseApp)throw new w(m.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._firebaseApp},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){return I("Firestore.collection",arguments,1),T("Firestore.collection","non-empty string",1,t),this.ensureClientConfigured(),new xu(ut.fromString(t),this)},t.prototype.doc=function(t){return I("Firestore.doc",arguments,1),T("Firestore.doc","non-empty string",1,t),this.ensureClientConfigured(),Du.forPath(ut.fromString(t),this)},t.prototype.collectionGroup=function(t){if(I("Firestore.collectionGroup",arguments,1),T("Firestore.collectionGroup","non-empty string",1,t),t.indexOf("/")>=0)throw new w(m.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new Tu(new Li(ut.EMPTY_PATH,t),this)},t.prototype.runTransaction=function(t){var n=this;return I("Firestore.runTransaction",arguments,1),T("Firestore.runTransaction","function",1,t),this.ensureClientConfigured().transaction((function(e){return t(new Su(n,e))}))},t.prototype.batch=function(){return this.ensureClientConfigured(),new Eu(this)},Object.defineProperty(t,"logLevel",{get:function(){switch(s()){case e.DEBUG:return"debug";case e.ERROR:return"error";case e.SILENT:return"silent";default:return f("Unknown log level: "+s())}},enumerable:!0,configurable:!0}),t.setLogLevel=function(t){switch(I("Firestore.setLogLevel",arguments,1),T("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":o(e.DEBUG);break;case"error":o(e.ERROR);break;case"silent":o(e.SILENT);break;default:throw new w(m.INVALID_ARGUMENT,"Invalid log level: "+t)}},t.prototype._areTimestampsInSnapshotsEnabled=function(){return this._settings.timestampsInSnapshots},t}(),Su=function(){function t(t,n){this._firestore=t,this._transaction=n}return t.prototype.get=function(t){var n=this;I("Transaction.get",arguments,1);var e=Pu("Transaction.get",t,this._firestore);return this._transaction.lookup([e._key]).then((function(t){if(!t||1!==t.length)return f("Mismatch in docs returned from document lookup.");var i=t[0];if(i instanceof Bn)return new Mu(n._firestore,e._key,null,!1,!1);if(i instanceof qn)return new Mu(n._firestore,e._key,i,!1,!1);throw f("BatchGetDocumentsRequest returned unexpected document type: "+i.constructor.name)}))},t.prototype.set=function(t,n,e){A("Transaction.set",arguments,2,3);var i=Pu("Transaction.set",t,this._firestore),r=(e=Cu("Transaction.set",e)).merge||e.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",n,e.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",n);return this._transaction.set(i._key,r),this},t.prototype.update=function(t,n,e){for(var i,r,u=[],s=3;s<arguments.length;s++)u[s-3]=arguments[s];return"string"==typeof n||n instanceof zr?(M("Transaction.update",arguments,3),i=Pu("Transaction.update",t,this._firestore),r=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",n,e,u)):(I("Transaction.update",arguments,2),i=Pu("Transaction.update",t,this._firestore),r=this._firestore._dataConverter.parseUpdateData("Transaction.update",n)),this._transaction.update(i._key,r),this},t.prototype.delete=function(t){I("Transaction.delete",arguments,1);var n=Pu("Transaction.delete",t,this._firestore);return this._transaction.delete(n._key),this},t}(),Eu=function(){function t(t){this._firestore=t,this._mutations=[],this._committed=!1}return t.prototype.set=function(t,n,e){A("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var i=Pu("WriteBatch.set",t,this._firestore),r=(e=Cu("WriteBatch.set",e)).merge||e.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",n,e.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",n);return this._mutations=this._mutations.concat(r.toMutations(i._key,pn.NONE)),this},t.prototype.update=function(t,n,e){for(var i,r,u=[],s=3;s<arguments.length;s++)u[s-3]=arguments[s];return this.verifyNotCommitted(),"string"==typeof n||n instanceof zr?(M("WriteBatch.update",arguments,3),i=Pu("WriteBatch.update",t,this._firestore),r=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",n,e,u)):(I("WriteBatch.update",arguments,2),i=Pu("WriteBatch.update",t,this._firestore),r=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",n)),this._mutations=this._mutations.concat(r.toMutations(i._key,pn.exists(!0))),this},t.prototype.delete=function(t){I("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var n=Pu("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new kn(n._key,pn.NONE)),this},t.prototype.commit=function(){return b.__awaiter(this,void 0,void 0,(function(){return b.__generator(this,(function(){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]}))}))},t.prototype.verifyNotCommitted=function(){if(this._committed)throw new w(m.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}(),Du=function(){function t(t,n){this._key=t,this.firestore=n,this._firestoreClient=this.firestore.ensureClientConfigured()}return t.forPath=function(n,e){if(n.length%2!=0)throw new w(m.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+n.canonicalString()+" has "+n.length);return new t(new at(n),e)},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new xu(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(I("DocumentReference.collection",arguments,1),T("DocumentReference.collection","non-empty string",1,t),!t)throw new w(m.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var n=ut.fromString(t);return new xu(this._key.path.child(n),this.firestore)},t.prototype.isEqual=function(n){if(!(n instanceof t))throw B("isEqual","DocumentReference",1,n);return this.firestore===n.firestore&&this._key.isEqual(n._key)},t.prototype.set=function(t,n){A("DocumentReference.set",arguments,1,2);var e=(n=Cu("DocumentReference.set",n)).merge||n.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,n.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(e.toMutations(this._key,pn.NONE))},t.prototype.update=function(t,n){for(var e,i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return"string"==typeof t||t instanceof zr?(M("DocumentReference.update",arguments,2),e=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,n,i)):(I("DocumentReference.update",arguments,1),e=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(e.toMutations(this._key,pn.exists(!0)))},t.prototype.delete=function(){return I("DocumentReference.delete",arguments,0),this._firestoreClient.write([new kn(this._key,pn.NONE)])},t.prototype.onSnapshot=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];A("DocumentReference.onSnapshot",arguments,1,4);var e,i={includeMetadataChanges:!1},r=0;"object"!=typeof t[r]||Kr(t[r])||(q("DocumentReference.onSnapshot",i=t[r],["includeMetadataChanges"]),C("DocumentReference.onSnapshot","boolean","includeMetadataChanges",i.includeMetadataChanges),r++);var u={includeMetadataChanges:i.includeMetadataChanges};return Kr(t[r])?e=t[r]:(T("DocumentReference.onSnapshot","function",r,t[r]),N("DocumentReference.onSnapshot","function",r+1,t[r+1]),N("DocumentReference.onSnapshot","function",r+2,t[r+2]),e={next:t[r],error:t[r+1],complete:t[r+2]}),this.onSnapshotInternal(u,e)},t.prototype.onSnapshotInternal=function(t,n){var e=this,i=function(t){console.error("Uncaught Error in onSnapshot:",t)};n.error&&(i=n.error.bind(n));var r=new Br({next:function(t){if(n.next){l(t.docs.size<=1,"Too many documents returned on a document query");var i=t.docs.get(e._key);n.next(new Mu(e.firestore,e._key,i,t.fromCache,t.hasPendingWrites))}},error:i}),u=this._firestoreClient.listen(Li.atPath(this._key.path),r,t);return function(){r.mute(),e._firestoreClient.unlisten(u)}},t.prototype.get=function(t){var n=this;return A("DocumentReference.get",arguments,0,1),Fu("DocumentReference.get",t),new Promise((function(e,i){t&&"cache"===t.source?n.firestore.ensureClientConfigured().getDocumentFromLocalCache(n._key).then((function(t){e(new Mu(n.firestore,n._key,t,!0,t instanceof qn&&t.hasLocalMutations))}),i):n.getViaSnapshotListener(e,i,t)}))},t.prototype.getViaSnapshotListener=function(t,n,e){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(r){i(),!r.exists&&r.metadata.fromCache?n(new w(m.UNAVAILABLE,"Failed to get document because the client is offline.")):r.exists&&r.metadata.fromCache&&e&&"server"===e.source?n(new w(m.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(r)},error:n})},t}(),Iu=function(){function t(t,n){this.hasPendingWrites=t,this.fromCache=n}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),Mu=function(){function t(t,n,e,i,r){this._firestore=t,this._key=n,this._document=e,this._fromCache=i,this._hasPendingWrites=r}return t.prototype.data=function(t){return A("DocumentSnapshot.data",arguments,0,1),t=Ru("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data(),jn.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},t.prototype.get=function(t,n){if(A("DocumentSnapshot.get",arguments,1,2),n=Ru("DocumentSnapshot.get",n),this._document){var e=this._document.data().field(mu("DocumentSnapshot.get",t));if(null!==e)return this.convertValue(e,jn.fromSnapshotOptions(n,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new Du(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return new Iu(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(n){if(!(n instanceof t))throw B("isEqual","DocumentSnapshot",1,n);return this._firestore===n._firestore&&this._fromCache===n._fromCache&&this._key.isEqual(n._key)&&(null===this._document?null===n._document:this._document.isEqual(n._document))},t.prototype.convertObject=function(t,n){var e=this,i={};return t.forEach((function(t,r){i[t]=e.convertValue(r,n)})),i},t.prototype.convertValue=function(t,n){if(t instanceof Un)return this.convertObject(t,n);if(t instanceof $n)return this.convertArray(t,n);if(t instanceof Fn){var e=t.value(n),i=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(i)||c("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+i.projectId+"/"+i.database+") instead."),new Du(e,this._firestore)}return t.value(n)},t.prototype.convertArray=function(t,n){var e=this;return t.internalValue.map((function(t){return e.convertValue(t,n)}))},t}(),Au=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return b.__extends(n,t),n.prototype.data=function(n){var e=t.prototype.data.call(this,n);return l("object"==typeof e,"Document in a QueryDocumentSnapshot should exist"),e},n}(Mu),Tu=function(){function t(t,n){this._query=t,this.firestore=n}return t.prototype.where=function(n,e,i){if(I("Query.where",arguments,3),L("Query.where",3,i),"in"!==e&&"array-contains-any"!==e){var r=["<","<=","==",">=",">","array-contains"];F("Query.where",r,2,e)}var u,s=mu("Query.where",n),o=qi.fromString(e);if(s.isKeyField()){if(o===qi.ARRAY_CONTAINS||o===qi.ARRAY_CONTAINS_ANY)throw new w(m.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+o.toString()+"' queries on FieldPath.documentId().");if(o===qi.IN){this.validateDisjunctiveFilterElements(i,o);for(var a=[],c=0,h=i;c<h.length;c++){var f=h[c];a.push(this.parseDocumentIdValue(f))}u=new $n(a)}else u=this.parseDocumentIdValue(i)}else o!==qi.IN&&o!==qi.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(i,o),u=this.firestore._dataConverter.parseQueryValue("Query.where",i);var l=Bi.create(s,o,u);return this.validateNewFilter(l),new t(this._query.addFilter(l),this.firestore)},t.prototype.orderBy=function(n,e){var i;if(A("Query.orderBy",arguments,1,2),N("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)i=Yi.ASCENDING;else{if("desc"!==e)throw new w(m.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+e+"', expected 'asc' or 'desc'.");i=Yi.DESCENDING}if(null!==this._query.startAt)throw new w(m.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new w(m.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var r=mu("Query.orderBy",n),u=new Ji(r,i);return this.validateNewOrderBy(u),new t(this._query.addOrderBy(u),this.firestore)},t.prototype.limit=function(n){if(I("Query.limit",arguments,1),T("Query.limit","number",1,n),n<=0)throw new w(m.INVALID_ARGUMENT,"Invalid Query. Query limit ("+n+") is invalid. Limit must be positive.");return new t(this._query.withLimit(n),this.firestore)},t.prototype.startAt=function(n){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];M("Query.startAt",arguments,1);var r=this.boundFromDocOrFields("Query.startAt",n,e,!0);return new t(this._query.withStartAt(r),this.firestore)},t.prototype.startAfter=function(n){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];M("Query.startAfter",arguments,1);var r=this.boundFromDocOrFields("Query.startAfter",n,e,!1);return new t(this._query.withStartAt(r),this.firestore)},t.prototype.endBefore=function(n){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];M("Query.endBefore",arguments,1);var r=this.boundFromDocOrFields("Query.endBefore",n,e,!0);return new t(this._query.withEndAt(r),this.firestore)},t.prototype.endAt=function(n){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];M("Query.endAt",arguments,1);var r=this.boundFromDocOrFields("Query.endAt",n,e,!1);return new t(this._query.withEndAt(r),this.firestore)},t.prototype.isEqual=function(n){if(!(n instanceof t))throw B("isEqual","Query",1,n);return this.firestore===n.firestore&&this._query.isEqual(n._query)},t.prototype.boundFromDocOrFields=function(t,n,e,i){if(L(t,1,n),n instanceof Mu){if(e.length>0)throw new w(m.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var r=n;if(!r.exists)throw new w(m.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,r._document,i)}var u=[n].concat(e);return this.boundFromFields(t,u,i)},t.prototype.boundFromDocument=function(t,n,e){for(var i=[],r=0,u=this._query.orderBy;r<u.length;r++){var s=u[r];if(s.field.isKeyField())i.push(new Fn(this.firestore._databaseId,n.key));else{var o=n.field(s.field);if(o instanceof Cn)throw new w(m.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+s.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===o){var a=s.field.canonicalString();throw new w(m.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+a+"' (used as the orderBy) does not exist.")}i.push(o)}}return new Hi(i,e)},t.prototype.boundFromFields=function(t,n,e){var i=this._query.explicitOrderBy;if(n.length>i.length)throw new w(m.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var r=[],u=0;u<n.length;u++){var s=n[u];if(i[u].field.isKeyField()){if("string"!=typeof s)throw new w(m.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof s);if(!this._query.isCollectionGroupQuery()&&-1!==s.indexOf("/"))throw new w(m.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+t+"() must be a plain document ID, but '"+s+"' contains a slash.");var o=this._query.path.child(ut.fromString(s));if(!at.isDocumentKey(o))throw new w(m.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+t+"() must result in a valid document path, but '"+o+"' is not because it contains an odd number of segments.");var a=new at(o);r.push(new Fn(this.firestore._databaseId,a))}else{var c=this.firestore._dataConverter.parseQueryValue(t,s);r.push(c)}}return new Hi(r,e)},t.prototype.onSnapshot=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];A("Query.onSnapshot",arguments,1,4);var e,i={},r=0;return"object"!=typeof t[r]||Kr(t[r])||(q("Query.onSnapshot",i=t[r],["includeMetadataChanges"]),C("Query.onSnapshot","boolean","includeMetadataChanges",i.includeMetadataChanges),r++),Kr(t[r])?e=t[r]:(T("Query.onSnapshot","function",r,t[r]),N("Query.onSnapshot","function",r+1,t[r+1]),N("Query.onSnapshot","function",r+2,t[r+2]),e={next:t[r],error:t[r+1],complete:t[r+2]}),this.onSnapshotInternal(i,e)},t.prototype.onSnapshotInternal=function(t,n){var e=this,i=function(t){console.error("Uncaught Error in onSnapshot:",t)};n.error&&(i=n.error.bind(n));var r=new Br({next:function(t){n.next&&n.next(new Nu(e.firestore,e._query,t))},error:i}),u=this.firestore.ensureClientConfigured(),s=u.listen(this._query,r,t);return function(){r.mute(),u.unlisten(s)}},t.prototype.get=function(t){var n=this;return A("Query.get",arguments,0,1),Fu("Query.get",t),new Promise((function(e,i){t&&"cache"===t.source?n.firestore.ensureClientConfigured().getDocumentsFromLocalCache(n._query).then((function(t){e(new Nu(n.firestore,n._query,t))}),i):n.getViaSnapshotListener(e,i,t)}))},t.prototype.getViaSnapshotListener=function(t,n,e){var i=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(r){i(),r.metadata.fromCache&&e&&"server"===e.source?n(new w(m.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(r)},error:n})},t.prototype.parseDocumentIdValue=function(t){if("string"==typeof t){if(""===t)throw new w(m.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==t.indexOf("/"))throw new w(m.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+t+"' contains a '/' character.");var n=this._query.path.child(ut.fromString(t));if(!at.isDocumentKey(n))throw new w(m.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+n+"' is not because it has an odd number of segments ("+n.length+").");return new Fn(this.firestore._databaseId,new at(n))}if(t instanceof Du)return new Fn(this.firestore._databaseId,t._key);throw new w(m.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+$(t)+".")},t.prototype.validateDisjunctiveFilterElements=function(t,n){if(!Array.isArray(t)||0===t.length)throw new w(m.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+n.toString()+"' filters.");if(t.length>10)throw new w(m.INVALID_ARGUMENT,"Invalid Query. '"+n.toString()+"' filters support a maximum of 10 elements in the value array.");if(t.indexOf(null)>=0)throw new w(m.INVALID_ARGUMENT,"Invalid Query. '"+n.toString()+"' filters cannot contain 'null' in the value array.");if(t.filter((function(t){return Number.isNaN(t)})).length>0)throw new w(m.INVALID_ARGUMENT,"Invalid Query. '"+n.toString()+"' filters cannot contain 'NaN' in the value array.")},t.prototype.validateNewFilter=function(t){if(t instanceof Bi){var n=[qi.ARRAY_CONTAINS,qi.ARRAY_CONTAINS_ANY],e=[qi.IN,qi.ARRAY_CONTAINS_ANY],i=n.indexOf(t.op)>=0,r=e.indexOf(t.op)>=0;if(t.isInequality()){var u=this._query.getInequalityFilterField();if(null!==u&&!u.isEqual(t.field))throw new w(m.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+u.toString()+"' and '"+t.field.toString()+"'");var s=this._query.getFirstOrderByField();null!==s&&this.validateOrderByAndInequalityMatch(t.field,s)}else if(r||i){var o=null;if(r&&(o=this._query.findFilterOperator(e)),null===o&&i&&(o=this._query.findFilterOperator(n)),null!=o)throw new w(m.INVALID_ARGUMENT,o===t.op?"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter.":"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+o.toString()+"' filters.")}}},t.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var n=this._query.getInequalityFilterField();null!==n&&this.validateOrderByAndInequalityMatch(n,t.field)}},t.prototype.validateOrderByAndInequalityMatch=function(t,n){if(!n.isEqual(t))throw new w(m.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+n.toString()+"' instead.")},t}(),Nu=function(){function t(t,n,e){this._firestore=t,this._originalQuery=n,this._snapshot=e,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new Iu(e.hasPendingWrites,e.fromCache)}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach((function(n){return t.push(n)})),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,n){var e=this;A("QuerySnapshot.forEach",arguments,1,2),T("QuerySnapshot.forEach","function",1,t),this._snapshot.docs.forEach((function(i){t.call(n,e.convertToDocumentImpl(i))}))},Object.defineProperty(t.prototype,"query",{get:function(){return new Tu(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(t){t&&(q("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),C("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var n=!(!t||!t.includeMetadataChanges);if(n&&this._snapshot.excludesMetadataChanges)throw new w(m.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===n||(this._cachedChanges=function(t,n,e){if(e.oldDocs.isEmpty()){var i,r=0;return e.docChanges.map((function(n){var u=new Au(t,n.doc.key,n.doc,e.fromCache,e.mutatedKeys.has(n.doc.key));return l(n.type===_i.Added,"Invalid event type for first snapshot"),l(!i||e.query.docComparator(i,n.doc)<0,"Got added events in wrong order"),i=n.doc,{type:"added",doc:u,oldIndex:-1,newIndex:r++}}))}var u=e.oldDocs;return e.docChanges.filter((function(t){return n||t.type!==_i.Metadata})).map((function(n){var i=new Au(t,n.doc.key,n.doc,e.fromCache,e.mutatedKeys.has(n.doc.key)),r=-1,s=-1;return n.type!==_i.Added&&(l((r=u.indexOf(n.doc.key))>=0,"Index for document not found"),u=u.delete(n.doc.key)),n.type!==_i.Removed&&(s=(u=u.add(n.doc)).indexOf(n.doc.key)),{type:Uu(n.type),doc:i,oldIndex:r,newIndex:s}}))}(this._firestore,n,this._snapshot),this._cachedChangesIncludeMetadataChanges=n),this._cachedChanges},t.prototype.isEqual=function(n){if(!(n instanceof t))throw B("isEqual","QuerySnapshot",1,n);return this._firestore===n._firestore&&this._originalQuery.isEqual(n._originalQuery)&&this._snapshot.isEqual(n._snapshot)},t.prototype.convertToDocumentImpl=function(t){return new Au(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},t}();["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach((function(t){try{Object.defineProperty(Nu.prototype.docChanges,t,{get:function(){return function(){throw new w(m.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}}));var xu=function(t){function n(n,e){var i=t.call(this,Li.atPath(n),e)||this;if(n.length%2!=1)throw new w(m.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+n.canonicalString()+" has "+n.length);return i}return b.__extends(n,t),Object.defineProperty(n.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new Du(new at(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),n.prototype.doc=function(t){if(A("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=W.newId()),T("CollectionReference.doc","non-empty string",1,t),""===t)throw new w(m.INVALID_ARGUMENT,"Document path must be a non-empty string");var n=ut.fromString(t);return Du.forPath(this._query.path.child(n),this.firestore)},n.prototype.add=function(t){I("CollectionReference.add",arguments,1),T("CollectionReference.add","object",1,t);var n=this.doc();return n.set(t).then((function(){return n}))},n}(Tu);function Cu(t,n){if(void 0===n)return{merge:!1};if(q(t,n,["merge","mergeFields"]),C(t,"boolean","merge",n.merge),function(t,n,e,i,r){void 0!==i&&function(t,n,e,i,r){if(!(i instanceof Array))throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" option to be an array, but it was: "+$(i));for(var u=0;u<i.length;++u)if(!r(i[u]))throw new w(m.INVALID_ARGUMENT,"Function "+t+"() requires all "+n+" elements to be "+e+", but the value at index "+u+" was: "+$(i[u]))}(t,n,e,i,r)}(t,"mergeFields","a string or a FieldPath",n.mergeFields,(function(t){return"string"==typeof t||t instanceof zr})),void 0!==n.mergeFields&&void 0!==n.merge)throw new w(m.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return n}function Ru(t,n){return void 0===n?{}:(q(t,n,["serverTimestamps"]),R(t,0,"serverTimestamps",n.serverTimestamps,["estimate","previous","none"]),n)}function Fu(t,n){N(t,"object",1,n),n&&(q(t,n,["source"]),R(t,0,"source",n.source,["default","server","cache"]))}function Pu(t,n,e){if(n instanceof Du){if(n.firestore!==e)throw new w(m.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}throw B(t,"DocumentReference",1,n)}function Uu(t){switch(t){case _i.Added:return"added";case _i.Modified:case _i.Metadata:return"modified";case _i.Removed:return"removed";default:return f("Unknown change type: "+t)}}var $u=g(ju,"Use firebase.firestore() instead."),Lu=g(Su,"Use firebase.firestore().runTransaction() instead."),qu=g(Eu,"Use firebase.firestore().batch() instead."),Bu=g(Du,"Use firebase.firestore().doc() instead."),zu=g(Mu),Vu=g(Au),Wu=g(Tu),Gu=g(Nu),Qu=g(xu,"Use firebase.firestore().collection() instead."),Yu={Firestore:$u,GeoPoint:$i,Timestamp:yt,Blob:Z,Transaction:Lu,WriteBatch:qu,DocumentReference:Bu,DocumentSnapshot:zu,Query:Wu,QueryDocumentSnapshot:Vu,QuerySnapshot:Gu,CollectionReference:Qu,FieldPath:zr,FieldValue:uu,setLogLevel:ju.setLogLevel,CACHE_SIZE_UNLIMITED:Ou};var Hu=function(){function t(){}return t.prototype.addCallback=function(){},t.prototype.shutdown=function(){},t}(),Ju=function(){function t(){var t=this;this.networkAvailableListener=function(){return t.onNetworkAvailable()},this.networkUnavailableListener=function(){return t.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}return t.prototype.addCallback=function(t){this.callbacks.push(t)},t.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},t.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},t.prototype.onNetworkAvailable=function(){a("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(var t=0,n=this.callbacks;t<n.length;t++)(0,n[t])(0)},t.prototype.onNetworkUnavailable=function(){a("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(var t=0,n=this.callbacks;t<n.length;t++)(0,n[t])(1)},t.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},t}(),Ku=function(){function t(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}return t.prototype.onOpen=function(t){l(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},t.prototype.onClose=function(t){l(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},t.prototype.onMessage=function(t){l(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},t.prototype.close=function(){this.closeFn()},t.prototype.send=function(t){this.sendFn(t)},t.prototype.callOnOpen=function(){l(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},t.prototype.callOnClose=function(t){l(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},t.prototype.callOnMessage=function(t){l(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},t}(),Xu="Connection",Zu={BatchGetDocuments:"batchGet",Commit:"commit"},ts="gl-js/ fire/"+r,ns=function(){function t(t){this.databaseId=t.databaseId,this.baseUrl=(t.ssl?"https":"http")+"://"+t.host,this.forceLongPolling=t.forceLongPolling}return t.prototype.modifyHeadersForRequest=function(t,n){if(n)for(var e in n.authHeaders)n.authHeaders.hasOwnProperty(e)&&(t[e]=n.authHeaders[e]);t["X-Goog-Api-Client"]=ts},t.prototype.invokeRPC=function(t,n,e){var i=this,r=this.makeUrl(t);return new Promise((function(u,s){var o=new Ti.XhrIo;o.listenOnce(Ti.EventType.COMPLETE,(function(){try{switch(o.getLastErrorCode()){case Ti.ErrorCode.NO_ERROR:var n=o.getResponseJson();a(Xu,"XHR received:",JSON.stringify(n)),u(n);break;case Ti.ErrorCode.TIMEOUT:a(Xu,'RPC "'+t+'" timed out'),s(new w(m.DEADLINE_EXCEEDED,"Request time out"));break;case Ti.ErrorCode.HTTP_ERROR:var e=o.getStatus();if(a(Xu,'RPC "'+t+'" failed with status:',e,"response text:",o.getResponseText()),e>0){var i=o.getResponseJson().error;if(i&&i.status&&i.message){var r=(c=i.status.toLowerCase().replace("_","-"),Object.values(m).indexOf(c)>=0?c:m.UNKNOWN);s(new w(r,i.message))}else s(new w(m.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(Xu,'RPC "'+t+'" failed'),s(new w(m.UNAVAILABLE,"Connection failed."));break;default:f('RPC "'+t+'" failed with unanticipated webchannel error '+o.getLastErrorCode()+": "+o.getLastError()+", giving up.")}}finally{a(Xu,'RPC "'+t+'" completed.')}var c}));var c=JSON.stringify(n);a(Xu,"XHR sending: ",r+" "+c);var h={"Content-Type":"text/plain"};i.modifyHeadersForRequest(h,e),o.send(r,"POST",c,h,15)}))},t.prototype.invokeStreamingRPC=function(t,n,e){return this.invokeRPC(t,n,e)},t.prototype.openStream=function(t,n){var e=[this.baseUrl,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=Ti.createWebChannelTransport(),r={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(r.initMessageHeaders,n),p.isReactNative()||(r.httpHeadersOverwriteParam="$httpHeaders");var u=e.join("");a(Xu,"Creating WebChannel: "+u+" "+r);var s=i.createWebChannel(u,r),o=!1,c=!1,h=new Ku({sendFn:function(t){c?a(Xu,"Not sending because WebChannel is closed:",t):(o||(a(Xu,"Opening WebChannel transport."),s.open(),o=!0),a(Xu,"WebChannel sending:",t),s.send(t))},closeFn:function(){return s.close()}}),f=function(t,n){s.listen(t,(function(t){try{n(t)}catch(t){setTimeout((function(){throw t}),0)}}))};return f(Ti.WebChannel.EventType.OPEN,(function(){c||a(Xu,"WebChannel transport opened.")})),f(Ti.WebChannel.EventType.CLOSE,(function(){c||(c=!0,a(Xu,"WebChannel transport closed"),h.callOnClose())})),f(Ti.WebChannel.EventType.ERROR,(function(t){c||(c=!0,a(Xu,"WebChannel transport errored:",t),h.callOnClose(new w(m.UNAVAILABLE,"The operation could not be completed")))})),f(Ti.WebChannel.EventType.MESSAGE,(function(t){if(!c){var n=t.data[0];l(!!n,"Got a webchannel message without data.");var e=n.error||n[0]&&n[0].error;if(e){a(Xu,"WebChannel received error:",e);var i=e.status,r=function(t){var n=wi[t];if(void 0!==n)return gi(n)}(i),u=e.message;void 0===r&&(r=m.INTERNAL,u="Unknown error status: "+i+" with message "+e.message),c=!0,h.callOnClose(new w(r,u)),s.close()}else a(Xu,"WebChannel received:",n),h.callOnMessage(n)}})),setTimeout((function(){h.callOnOpen()}),0),h},t.prototype.makeUrl=function(t){var n=Zu[t];l(void 0!==n,"Unknown REST mapping for: "+t);var e=[this.baseUrl,"/","v1"];return e.push("/projects/"),e.push(this.databaseId.projectId),e.push("/databases/"),e.push(this.databaseId.database),e.push("/documents"),e.push(":"),e.push(n),e.join("")},t}(),es=function(){function t(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(t.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),t.prototype.loadConnection=function(t){return Promise.resolve(new ns(t))},t.prototype.newConnectivityMonitor=function(){return Ju.isAvailable()?new Ju:new Hu},t.prototype.newSerializer=function(t){return new lr(t,{useProto3Json:!0})},t.prototype.formatJSON=function(t){return JSON.stringify(t)},t.prototype.atob=function(t){return atob(t)},t.prototype.btoa=function(t){return btoa(t)},t}();function is(t){!function(t){t.INTERNAL.registerService("firestore",(function(t){return new ju(t)}),function(t){l(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var n={};for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e]);return n}(Yu))}(t)}d.setPlatform(new es),is(i),n.registerFirestore=is}))),h(f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});var e=S&&"object"==typeof S&&"default"in S?S.default:S,i={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},r=function(t){function n(e,i,r){var u=t.call(this,i)||this;return Object.setPrototypeOf(u,n.prototype),u.code=e,u.details=r,u}return b.__extends(n,t),n}(Error),u=function(){function t(t){this.app=t}return t.prototype.getAuthToken=function(){return b.__awaiter(this,void 0,void 0,(function(){var t;return b.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.app.INTERNAL.getToken()];case 1:return(t=n.sent())?[2,t.accessToken]:[2,void 0];case 2:return n.sent(),[2,void 0];case 3:return[2]}}))}))},t.prototype.getInstanceIdToken=function(){return b.__awaiter(this,void 0,void 0,(function(){var t;return b.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),this.app.messaging?[4,this.app.messaging().getToken()]:[2,void 0];case 1:return(t=n.sent())?[2,t]:[2,void 0];case 2:return n.sent(),[2,void 0];case 3:return[2]}}))}))},t.prototype.getContext=function(){return b.__awaiter(this,void 0,void 0,(function(){var t,n;return b.__generator(this,(function(e){switch(e.label){case 0:return[4,this.getAuthToken()];case 1:return t=e.sent(),[4,this.getInstanceIdToken()];case 2:return n=e.sent(),[2,{authToken:t,instanceIdToken:n}]}}))}))},t}();function s(t,n){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=n(t[i]));return e}var o=function(){function t(){}return t.prototype.encode=function(t){var n=this;if(null==t)return null;if(t instanceof Number&&(t=t.valueOf()),"number"==typeof t&&isFinite(t))return t;if(!0===t||!1===t)return t;if("[object String]"===Object.prototype.toString.call(t))return t;if(Array.isArray(t))return t.map((function(t){return n.encode(t)}));if("function"==typeof t||"object"==typeof t)return s(t,(function(t){return n.encode(t)}));throw new Error("Data cannot be encoded in JSON: "+t)},t.prototype.decode=function(t){var n=this;if(null==t)return t;if(t["@type"])switch(t["@type"]){case"type.googleapis.com/google.protobuf.Int64Value":case"type.googleapis.com/google.protobuf.UInt64Value":var e=Number(t.value);if(isNaN(e))throw new Error("Data cannot be decoded from JSON: "+t);return e;default:throw new Error("Data cannot be decoded from JSON: "+t)}return Array.isArray(t)?t.map((function(t){return n.decode(t)})):"function"==typeof t||"object"==typeof t?s(t,(function(t){return n.decode(t)})):t},t}(),a=function(){function t(t,n){var e=this;void 0===n&&(n="us-central1"),this.app_=t,this.region_=n,this.serializer=new o,this.emulatorOrigin=null,this.INTERNAL={delete:function(){return e.deleteService()}},this.contextProvider=new u(t),this.cancelAllRequests=new Promise((function(t){e.deleteService=function(){return t()}}))}return Object.defineProperty(t.prototype,"app",{get:function(){return this.app_},enumerable:!0,configurable:!0}),t.prototype._url=function(t){var n=this.app_.options.projectId,e=this.region_;return null!==this.emulatorOrigin?this.emulatorOrigin+"/"+n+"/"+e+"/"+t:"https://"+e+"-"+n+".cloudfunctions.net/"+t},t.prototype.useFunctionsEmulator=function(t){this.emulatorOrigin=t},t.prototype.httpsCallable=function(t,n){var e=this;return function(i){return e.call(t,i,n||{})}},t.prototype.postJSON=function(t,n,e){return b.__awaiter(this,void 0,void 0,(function(){var i,r;return b.__generator(this,(function(u){switch(u.label){case 0:e.append("Content-Type","application/json"),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,fetch(t,{method:"POST",body:JSON.stringify(n),headers:e})];case 2:return i=u.sent(),[3,4];case 3:return u.sent(),[2,{status:0,json:null}];case 4:r=null,u.label=5;case 5:return u.trys.push([5,7,,8]),[4,i.json()];case 6:return r=u.sent(),[3,8];case 7:return u.sent(),[3,8];case 8:return[2,{status:i.status,json:r}]}}))}))},t.prototype.call=function(t,n,e){return b.__awaiter(this,void 0,void 0,(function(){var u,s,o,a,c,h,f,l;return b.__generator(this,(function(d){switch(d.label){case 0:return u=this._url(t),n=this.serializer.encode(n),s={data:n},o=new Headers,[4,this.contextProvider.getContext()];case 1:return(a=d.sent()).authToken&&o.append("Authorization","Bearer "+a.authToken),a.instanceIdToken&&o.append("Firebase-Instance-ID-Token",a.instanceIdToken),c=e.timeout||7e4,[4,Promise.race([this.postJSON(u,s,o),(v=c,new Promise((function(t,n){setTimeout((function(){n(new r("deadline-exceeded","deadline-exceeded"))}),v)}))),this.cancelAllRequests])];case 2:if(!(h=d.sent()))throw new r("cancelled","Firebase Functions instance was deleted.");if(f=function(t,n,e){var u=function(t){if(t>=200&&t<300)return"ok";switch(t){case 0:return"internal";case 400:return"invalid-argument";case 401:return"unauthenticated";case 403:return"permission-denied";case 404:return"not-found";case 409:return"aborted";case 429:return"resource-exhausted";case 499:return"cancelled";case 500:return"internal";case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline-exceeded"}return"unknown"}(t),s=u,o=void 0;try{var a=n&&n.error;if(a){var c=a.status;if("string"==typeof c){if(!i[c])return new r("internal","internal");u=i[c],s=c}var h=a.message;"string"==typeof h&&(s=h),void 0!==(o=a.details)&&(o=e.decode(o))}}catch(t){}return"ok"===u?null:new r(u,s,o)}(h.status,h.json,this.serializer))throw f;if(!h.json)throw new r("internal","Response is not valid JSON object.");if(void 0===(l=h.json.data)&&(l=h.json.result),void 0===l)throw new r("internal","Response is missing data field.");return[2,{data:this.serializer.decode(l)}]}var v}))}))},t}(),c="functions";function h(t,n,e){return new a(t,e)}function f(t){t.INTERNAL.registerService(c,h,{Functions:a},void 0,!0)}f(e),n.registerFunctions=f})));const Ni=I.initializeApp({apiKey:"AIzaSyA42mJ5aKLQI-8kFt24thcEVIoInKkEQDk",authDomain:"fontumibots.firebaseapp.com",databaseURL:"https://fontumibots.firebaseio.com",projectId:"fontumibots",storageBucket:"fontumibots.appspot.com",messagingSenderId:"1047975832929",appId:"1:1047975832929:web:3778f496fc1321d8"}),xi=Ni.firestore(),Ci=Ni.functions();let Ri,Fi;const Pi=document.createElement("audio");Pi.loop=!0,Pi.src="//www.fontumi.co/fontumibots/ringtone.mp3";const Ui=()=>{Ri&&Ri.isRegistered&&(Ri.makeCall({media:{audio:!0,video:!1},username:Fi,contact:{isRoom:!1}}),Pi.play(),Ri.onCallConnected=()=>Pi.pause())},$i=()=>{Ri&&(Ri.endCall(),Pi.pause())},Li=class{constructor(n){t(this,n),this.messages=[],this.actualQuestionType="text",this.inCall=!1,this.phoneReady=!1,this.call=async()=>{this.inCall||(Ui(),setTimeout(()=>{this.hangup(),Ui(),this.inCall=!0},1e3),Ri.onCallEnd=()=>{this.hangup()})},this.hangup=()=>{$i(),this.inCall=!1},this.answer=t=>{this.addMessage(t.detail,!0),"yesno"===this.actualQuestionType?this.controller.next("No"===t.detail?1:0):this.controller.next(),this.ask()}}async callOutside(){return this.call()}async ask(){if(this.addMessage(this.controller.actualBlock.question().value,!1),this.actualQuestionType=this.controller.actualBlock.question().type,"end"===this.actualQuestionType)try{const{data:t}=await Ci.httpsCallable("sendMail")({messages:this.messages,to:this.bot.email,name:this.bot.name});console.log(t)}catch(t){console.log(t)}}initChatController(){this.controller=new a(this.bot.escene.links,this.bot.escene.blocks),this.ask(),this.controller.next(),this.ask()}addMessage(t,n){this.messages=[...this.messages,{id:Date.now(),message:t,user:n}]}componentWillLoad(){this.initChatController()}componentDidLoad(){}render(){const t=r(this.bot.colors.a),n=r(this.bot.colors.b),i=this.bot.colors.a,u=this.bot.colors.b;return e("div",{id:"fontumibots-chat-container",class:"uk-card uk-card-default uk-card-hover uk-width-5-6 uk-width-1-4@m"},e("div",{class:"uk-card-header",style:{background:i,padding:"15px 20px"}},e("div",{class:"uk-grid uk-grid-small uk-flex-middle"},e("div",{class:"uk-width-expand"},e("h3",{class:"uk-card-title uk-margin-remove-bottom",style:{color:t}},this.bot.name),e("p",{class:"uk-text-meta uk-margin-remove-top",style:{color:t}},this.bot.email)),this.bot.sip.on&&this.phoneReady?e("div",{class:"uk-width-auto"},this.inCall?e("fontumibots-icon-end-call",{fill:t,onClick:this.hangup}):e("fontumibots-icon-call",{fill:t,onClick:this.call})):e("div",null))),e("div",{id:"fontumibots-chat-container-body",class:"uk-card-body uk-padding-small"},this.messages.map(r=>(({id:r,message:s,user:o})=>e("div",{id:`message-${r}-${o}`,class:`uk-text-${o?"right":"left"} fontumibots-message`},e("div",{style:{background:o?u:i}},e("p",{class:"uk-text-break",style:{color:o?n:t}},s))))(r))),e("div",{class:"uk-card-footer"},"end"===this.actualQuestionType?e("div",null):e("fontumibots-chat-input",{type:this.actualQuestionType,props:this.controller.actualBlock.props()||[],style:{width:"100px"},onSendMessage:this.answer}),e("div",{class:"uk-grid uk-flex-center"},e("img",{src:"https://www.fontumi.co/empresas/logos/byfontumilogo.png",alt:"",style:{width:"100px",marginBottom:"10px"}}))))}static get style(){return"#fontumibots-chat-container{border-radius:var(--fontumibots-border);max-height:calc(100vh - (var(--fontumibots-chat-borders) + 95px));position:fixed;right:var(--fontumibots-chat-borders);margin-left:10px;bottom:calc(10px + 55px + var(--fontumibots-chat-borders));z-index:var(--fontumibots-z-index)}#fontumibots-chat-container>.uk-card-body{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;overflow:scroll;overflow-x:hidden;max-height:calc(100vh - 330px)}#fontumibots-chat-container>.uk-card-footer{padding:6px 10px}fontumibots-chat-input .uk-inline{width:100%}#fontumibots-chat-container-input{border-radius:30px}.fontumibots-message>div>p{margin:7px 10px}.fontumibots-message>div{display:-ms-inline-flexbox;display:inline-flex;max-width:90%;border-radius:20px;margin-bottom:5px}.uk-button{border-radius:30px}"}};var qi=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.toDate=function(t){if(t instanceof Date)return t;if("string"!=typeof t)return null;const n=new Date(t);return"Invalid Date"===n.toString()?null:n}}));h(qi);var Bi=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.toString=function(t){return null==t||t.constructor===Object?null:String(t)}}));h(Bi);var zi=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=["true","1",1],i=["false","0",0];n.toBoolean=function(t){return"boolean"==typeof t?t:!!e.includes(t)||!i.includes(t)&&null}}));h(zi);var Vi=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.toInt=function(t,n=!1){if("number"==typeof t)return n?t:Math.trunc(t);if("string"!=typeof t)return null;const e=Number(t);return isNaN(e)?null:n?e:Math.trunc(e)}}));h(Vi);var Wi=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.cast=function(t,n,e){if(typeof t===n)return t;let i=null;switch(n){case"float":i=Vi.toInt(t,!0);break;case"string":i=Bi.toString(t);break;case"integer":i=Vi.toInt(t);break;case"date":i=qi.toDate(t);break;case"boolean":i=zi.toBoolean(t)}if(null===i&&e)throw new Error(e);return i}}));h(Wi);var Gi=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.ensureLength=function(t,n,e=1){if(t.length<e)throw new Error(n)}}));h(Gi);var Qi,Yi="Expected a function",Hi=1/0,Ji="[object Function]",Ki="[object GeneratorFunction]",Xi="[object Symbol]",Zi=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,tr=/^\w*$/,nr=/^\./,er=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ir=/\\(\\)?/g,rr=/^\[object .+?Constructor\]$/,ur="object"==typeof c&&c&&c.Object===Object&&c,sr="object"==typeof self&&self&&self.Object===Object&&self,or=ur||sr||Function("return this")(),ar=Array.prototype,cr=Function.prototype,hr=Object.prototype,fr=or["__core-js_shared__"],lr=(Qi=/[^.]+$/.exec(fr&&fr.keys&&fr.keys.IE_PROTO||""))?"Symbol(src)_1."+Qi:"",dr=cr.toString,vr=hr.hasOwnProperty,mr=hr.toString,wr=RegExp("^"+dr.call(vr).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),br=or.Symbol,pr=ar.splice,gr=Ir(or,"Map"),yr=Ir(Object,"create"),_r=br?br.prototype:void 0,Or=_r?_r.toString:void 0;function kr(t){var n=-1,e=t?t.length:0;for(this.clear();++n<e;){var i=t[n];this.set(i[0],i[1])}}function jr(t){var n=-1,e=t?t.length:0;for(this.clear();++n<e;){var i=t[n];this.set(i[0],i[1])}}function Sr(t){var n=-1,e=t?t.length:0;for(this.clear();++n<e;){var i=t[n];this.set(i[0],i[1])}}function Er(t,n){for(var e,i,r=t.length;r--;)if((e=t[r][0])===(i=n)||e!=e&&i!=i)return r;return-1}function Dr(t,n){var e,i,r=t.__data__;return("string"==(i=typeof(e=n))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==e:null===e)?r["string"==typeof n?"string":"hash"]:r.map}function Ir(t,n){var e=function(t,n){return null==t?void 0:t[n]}(t,n);return function(t){return!(!xr(t)||(n=t,lr&&lr in n))&&(function(t){var n=xr(t)?mr.call(t):"";return n==Ji||n==Ki}(t)||function(t){var n=!1;if(null!=t&&"function"!=typeof t.toString)try{n=!!(t+"")}catch(t){}return n}(t)?wr:rr).test(function(t){if(null!=t){try{return dr.call(t)}catch(t){}try{return t+""}catch(t){}}return""}(t));var n}(e)?e:void 0}kr.prototype.clear=function(){this.__data__=yr?yr(null):{}},kr.prototype.delete=function(t){return this.has(t)&&delete this.__data__[t]},kr.prototype.get=function(t){var n=this.__data__;if(yr){var e=n[t];return"__lodash_hash_undefined__"===e?void 0:e}return vr.call(n,t)?n[t]:void 0},kr.prototype.has=function(t){var n=this.__data__;return yr?void 0!==n[t]:vr.call(n,t)},kr.prototype.set=function(t,n){return this.__data__[t]=yr&&void 0===n?"__lodash_hash_undefined__":n,this},jr.prototype.clear=function(){this.__data__=[]},jr.prototype.delete=function(t){var n=this.__data__,e=Er(n,t);return!(e<0||(e==n.length-1?n.pop():pr.call(n,e,1),0))},jr.prototype.get=function(t){var n=this.__data__,e=Er(n,t);return e<0?void 0:n[e][1]},jr.prototype.has=function(t){return Er(this.__data__,t)>-1},jr.prototype.set=function(t,n){var e=this.__data__,i=Er(e,t);return i<0?e.push([t,n]):e[i][1]=n,this},Sr.prototype.clear=function(){this.__data__={hash:new kr,map:new(gr||jr),string:new kr}},Sr.prototype.delete=function(t){return Dr(this,t).delete(t)},Sr.prototype.get=function(t){return Dr(this,t).get(t)},Sr.prototype.has=function(t){return Dr(this,t).has(t)},Sr.prototype.set=function(t,n){return Dr(this,t).set(t,n),this};var Mr=Tr((function(t){var n;t=null==(n=t)?"":function(t){if("string"==typeof t)return t;if(Cr(t))return Or?Or.call(t):"";var n=t+"";return"0"==n&&1/t==-Hi?"-0":n}(n);var e=[];return nr.test(t)&&e.push(""),t.replace(er,(function(t,n,i,r){e.push(i?r.replace(ir,"$1"):n||t)})),e}));function Ar(t){if("string"==typeof t||Cr(t))return t;var n=t+"";return"0"==n&&1/t==-Hi?"-0":n}function Tr(t,n){if("function"!=typeof t||n&&"function"!=typeof n)throw new TypeError(Yi);var e=function(){var i=arguments,r=n?n.apply(this,i):i[0],u=e.cache;if(u.has(r))return u.get(r);var s=t.apply(this,i);return e.cache=u.set(r,s),s};return e.cache=new(Tr.Cache||Sr),e}Tr.Cache=Sr;var Nr=Array.isArray;function xr(t){var n=typeof t;return!!t&&("object"==n||"function"==n)}function Cr(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&mr.call(t)==Xi}var Rr=function(t,n,e){var i=null==t?void 0:function(t,n){for(var e,i=0,r=(n=function(t,n){if(Nr(t))return!1;var e=typeof t;return!("number"!=e&&"symbol"!=e&&"boolean"!=e&&null!=t&&!Cr(t))||(tr.test(t)||!Zi.test(t)||null!=n&&t in Object(n))}(n,t)?[n]:Nr(e=n)?e:Mr(e)).length;null!=t&&i<r;)t=t[Ar(n[i++])];return i&&i==r?t:void 0}(t,n);return void 0===i?e:i},Fr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.getValue=function(t,n){return n.startsWith("/")?Rr(t.original,n.substr(1)):t.tip[n]}}));h(Fr);var Pr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.patchValue=function(t,n,e){t.tip[n]=e,"::tip::"===n&&(t.parentArray[t.currentIndex]=e)}}));h(Pr);var Ur=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.skippable=(t,n,e)=>"::tip::"!==n&&(e.existyStrict?void 0===t:"string"==typeof t?0===t.trim().length:null==t)}));h(Ur);var $r=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.cast=Wi.cast,n.ensureLength=Gi.ensureLength,n.getValue=Fr.getValue,n.patchValue=Pr.patchValue,n.skippable=Ur.skippable}));h($r);var Lr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.above=(t,n)=>t>n}));h(Lr);var qr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"above:make sure to define minValue",1),[$r.cast(t[0],"integer","above:min value must be defined as an integer")]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||Lr.above(r,e)}}}));h(qr);var Br=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.existy=t=>"string"==typeof t?t.trim().length>0:null!=t}));h(Br);var zr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.truthy=t=>Br.existy(t)&&!1!==t&&0!==t}));h(zr);var Vr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||zr.truthy(r)}}}));h(Vr);var Wr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/^[a-z]+$/i;n.alpha=t=>"string"==typeof t&&e.test(t)}));h(Wr);var Gr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||Wr.alpha(r)}}}));h(Gr);var Qr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/^[a-z0-9]+$/i;n.alphaNumeric=t=>"string"==typeof t&&e.test(t)}));h(Qr);var Yr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||Qr.alphaNumeric(r)}}}));h(Yr);var Hr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n)=>{const e=$r.getValue(t,n);return $r.skippable(e,n,{existyStrict:!0})||Array.isArray(e)}}}));h(Hr);var Jr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.cast(r,"boolean");return null!==u&&($r.patchValue(t,n,u),!0)}}}));h(Jr);var Kr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.same=(t,n)=>t===n}));h(Kr);var Xr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=typeof r;let s=$r.getValue(t,`${n}_confirmation`);return typeof s!==u&&(s=function(t,n){return"string"===n?$r.cast(t,"string"):"number"===n?$r.cast(t,"integer"):t}(s,u)),Kr.same(r,s)}}}));h(Xr);var Zr=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=["yes","true","y","ok","okay"];n.affirmative=t=>"A"===t||!0===t||e.indexOf(t.toLowerCase())>-1}));h(Zr);var tu=function(t){var n=new Date(t.getTime()),e=n.getTimezoneOffset();return n.setSeconds(0,0),6e4*e+n.getTime()%6e4},nu=function(t){return t instanceof Date},eu=/[T ]/,iu=/:/,ru=/^(\d{2})$/,uu=[/^([+-]\d{2})$/,/^([+-]\d{3})$/,/^([+-]\d{4})$/],su=/^(\d{4})/,ou=[/^([+-]\d{4})/,/^([+-]\d{5})/,/^([+-]\d{6})/],au=/^-(\d{2})$/,cu=/^-?(\d{3})$/,hu=/^-?(\d{2})-?(\d{2})$/,fu=/^-?W(\d{2})$/,lu=/^-?W(\d{2})-?(\d{1})$/,du=/^(\d{2}([.,]\d*)?)$/,vu=/^(\d{2}):?(\d{2}([.,]\d*)?)$/,mu=/^(\d{2}):?(\d{2}):?(\d{2}([.,]\d*)?)$/,wu=/([Z+-].*)$/,bu=/^(Z)$/,pu=/^([+-])(\d{2})$/,gu=/^([+-])(\d{2}):?(\d{2})$/;function yu(t,n,e){n=n||0,e=e||0;var i=new Date(0);i.setUTCFullYear(t,0,4);var r=7*n+e+1-(i.getUTCDay()||7);return i.setUTCDate(i.getUTCDate()+r),i}var _u,Ou=function(t,n){if(nu(t))return new Date(t.getTime());if("string"!=typeof t)return new Date(t);var e=(n||{}).additionalDigits;e=null==e?2:Number(e);var i,r,u=function(t){var n,e={},i=t.split(eu);if(iu.test(i[0])?(e.date=null,n=i[0]):(e.date=i[0],n=i[1]),n){var r=wu.exec(n);r?(e.time=n.replace(r[1],""),e.timezone=r[1]):e.time=n}return e}(t),s=function(t,n){var e,i=uu[n],r=ou[n];if(e=su.exec(t)||r.exec(t)){var u=e[1];return{year:parseInt(u,10),restDateString:t.slice(u.length)}}if(e=ru.exec(t)||i.exec(t)){var s=e[1];return{year:100*parseInt(s,10),restDateString:t.slice(s.length)}}return{year:null}}(u.date,e),o=function(t,n){if(null===n)return null;var e,i,r;if(0===t.length)return(i=new Date(0)).setUTCFullYear(n),i;if(e=au.exec(t))return i=new Date(0),r=parseInt(e[1],10)-1,i.setUTCFullYear(n,r),i;if(e=cu.exec(t)){i=new Date(0);var u=parseInt(e[1],10);return i.setUTCFullYear(n,0,u),i}if(e=hu.exec(t)){i=new Date(0),r=parseInt(e[1],10)-1;var s=parseInt(e[2],10);return i.setUTCFullYear(n,r,s),i}return(e=fu.exec(t))?yu(n,parseInt(e[1],10)-1):(e=lu.exec(t))?yu(n,parseInt(e[1],10)-1,parseInt(e[2],10)-1):null}(s.restDateString,s.year);if(o){var a,c=o.getTime(),h=0;if(u.time&&(h=(r=du.exec(i=u.time))?parseFloat(r[1].replace(",","."))%24*36e5:(r=vu.exec(i))?parseInt(r[1],10)%24*36e5+6e4*parseFloat(r[2].replace(",",".")):(r=mu.exec(i))?parseInt(r[1],10)%24*36e5+6e4*parseInt(r[2],10)+1e3*parseFloat(r[3].replace(",",".")):null),u.timezone)a=6e4*function(t){var n,e;return(n=bu.exec(t))?0:(n=pu.exec(t))?(e=60*parseInt(n[2],10),"+"===n[1]?-e:e):(n=gu.exec(t))?(e=60*parseInt(n[2],10)+parseInt(n[3],10),"+"===n[1]?-e:e):0}(u.timezone);else{var f=c+h,l=new Date(f);a=tu(l);var d=new Date(f);d.setDate(l.getDate()+1);var v=tu(d)-tu(l);v>0&&(a+=v)}return new Date(c+h+a)}return new Date(t)},ku=function(t,n){var e=Ou(t),i=Number(n);return e.setDate(e.getDate()+i),e},ju=function(t,n){var e=Ou(t).getTime(),i=Number(n);return new Date(e+i)},Su=function(t,n){var e=n&&Number(n.weekStartsOn)||0,i=Ou(t),r=i.getDay(),u=(r<e?7:0)+r-e;return i.setDate(i.getDate()-u),i.setHours(0,0,0,0),i},Eu=function(t){return Su(t,{weekStartsOn:1})},Du=function(t){var n=Ou(t),e=n.getFullYear(),i=new Date(0);i.setFullYear(e+1,0,4),i.setHours(0,0,0,0);var r=Eu(i),u=new Date(0);u.setFullYear(e,0,4),u.setHours(0,0,0,0);var s=Eu(u);return n.getTime()>=r.getTime()?e+1:n.getTime()>=s.getTime()?e:e-1},Iu=function(t){var n=Du(t),e=new Date(0);return e.setFullYear(n,0,4),e.setHours(0,0,0,0),Eu(e)},Mu=function(t){var n=Ou(t);return n.setHours(0,0,0,0),n},Au=function(t,n){var e=Mu(t),i=Mu(n),r=e.getTime()-6e4*e.getTimezoneOffset(),u=i.getTime()-6e4*i.getTimezoneOffset();return Math.round((r-u)/864e5)},Tu=function(t){var n=Ou(t),e=n.getFullYear(),i=n.getMonth(),r=new Date(0);return r.setFullYear(e,i+1,0),r.setHours(0,0,0,0),r.getDate()},Nu=function(t,n){var e=Ou(t),i=Number(n),r=e.getMonth()+i,u=new Date(0);u.setFullYear(e.getFullYear(),r,1),u.setHours(0,0,0,0);var s=Tu(u);return e.setMonth(r,Math.min(s,e.getDate())),e},xu=["M","MM","Q","D","DD","DDD","DDDD","d","E","W","WW","YY","YYYY","GG","GGGG","H","HH","h","hh","m","mm","s","ss","S","SS","SSS","Z","ZZ","X","x"],Cu=function(t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push(e);var i=xu.concat(n).sort().reverse();return new RegExp("(\\[[^\\[]*\\])|(\\\\)?("+i.join("|")+"|.)","g")},Ru={distanceInWords:(_u={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},{localize:function(t,n,e){var i;return e=e||{},i="string"==typeof _u[t]?_u[t]:1===n?_u[t].one:_u[t].other.replace("{{count}}",n),e.addSuffix?e.comparison>0?"in "+i:i+" ago":i}}),format:function(){var t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=["January","February","March","April","May","June","July","August","September","October","November","December"],e=["Su","Mo","Tu","We","Th","Fr","Sa"],i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],u=["AM","PM"],s=["am","pm"],o=["a.m.","p.m."],a={MMM:function(n){return t[n.getMonth()]},MMMM:function(t){return n[t.getMonth()]},dd:function(t){return e[t.getDay()]},ddd:function(t){return i[t.getDay()]},dddd:function(t){return r[t.getDay()]},A:function(t){return t.getHours()/12>=1?u[1]:u[0]},a:function(t){return t.getHours()/12>=1?s[1]:s[0]},aa:function(t){return t.getHours()/12>=1?o[1]:o[0]}};return["M","D","DDD","d","Q","W"].forEach((function(t){a[t+"o"]=function(n,e){return function(t){var n=t%100;if(n>20||n<10)switch(n%10){case 1:return t+"st";case 2:return t+"nd";case 3:return t+"rd"}return t+"th"}(e[t](n))}})),{formatters:a,formattingTokensRegExp:Cu(a)}}()},Fu=function(t){var n=Ou(t),e=new Date(0);return e.setFullYear(n.getFullYear(),0,1),e.setHours(0,0,0,0),e},Pu=function(t){var n=Ou(t);return Au(n,Fu(n))+1},Uu=function(t){var n=Ou(t),e=Eu(n).getTime()-Iu(n).getTime();return Math.round(e/6048e5)+1},$u=function(t){if(nu(t))return!isNaN(t);throw new TypeError(toString.call(t)+" is not an instance of Date")},Lu={M:function(t){return t.getMonth()+1},MM:function(t){return Bu(t.getMonth()+1,2)},Q:function(t){return Math.ceil((t.getMonth()+1)/3)},D:function(t){return t.getDate()},DD:function(t){return Bu(t.getDate(),2)},DDD:function(t){return Pu(t)},DDDD:function(t){return Bu(Pu(t),3)},d:function(t){return t.getDay()},E:function(t){return t.getDay()||7},W:function(t){return Uu(t)},WW:function(t){return Bu(Uu(t),2)},YY:function(t){return Bu(t.getFullYear(),4).substr(2)},YYYY:function(t){return Bu(t.getFullYear(),4)},GG:function(t){return String(Du(t)).substr(2)},GGGG:function(t){return Du(t)},H:function(t){return t.getHours()},HH:function(t){return Bu(t.getHours(),2)},h:function(t){var n=t.getHours();return 0===n?12:n>12?n%12:n},hh:function(t){return Bu(Lu.h(t),2)},m:function(t){return t.getMinutes()},mm:function(t){return Bu(t.getMinutes(),2)},s:function(t){return t.getSeconds()},ss:function(t){return Bu(t.getSeconds(),2)},S:function(t){return Math.floor(t.getMilliseconds()/100)},SS:function(t){return Bu(Math.floor(t.getMilliseconds()/10),2)},SSS:function(t){return Bu(t.getMilliseconds(),3)},Z:function(t){return qu(t.getTimezoneOffset(),":")},ZZ:function(t){return qu(t.getTimezoneOffset())},X:function(t){return Math.floor(t.getTime()/1e3)},x:function(t){return t.getTime()}};function qu(t,n){n=n||"";var e=t>0?"-":"+",i=Math.abs(t),r=i%60;return e+Bu(Math.floor(i/60),2)+n+Bu(r,2)}function Bu(t,n){for(var e=Math.abs(t).toString();e.length<n;)e="0"+e;return e}var zu=ku,Vu=ju,Wu=Nu,Gu=function(t,n,e){var i=n?String(n):"YYYY-MM-DDTHH:mm:ss.SSSZ",r=(e||{}).locale,u=Ru.format.formatters,s=Ru.format.formattingTokensRegExp;r&&r.format&&r.format.formatters&&(u=r.format.formatters,r.format.formattingTokensRegExp&&(s=r.format.formattingTokensRegExp));var o=Ou(t);return $u(o)?function(t,n,e){var i,r,u=t.match(e),s=u.length;for(i=0;i<s;i++)u[i]=n[u[i]]||Lu[u[i]]||((r=u[i]).match(/\[[\s\S]/)?r.replace(/^\[|]$/g,""):r.replace(/\\/g,""));return function(t){for(var n="",e=0;e<s;e++)u[e]instanceof Function?n+=u[e](t,Lu):n+=u[e];return n}}(i,u,s)(o):"Invalid Date"},Qu=function(t,n){var e=Ou(t),i=Ou(n);return e.getTime()>i.getTime()},Yu=function(t,n){var e=Ou(t),i=Ou(n);return e.getTime()<i.getTime()},Hu=function(t){return Ou(t).getTime()>(new Date).getTime()},Ju=function(t){return Ou(t).getTime()<(new Date).getTime()},Ku=function(t){return Mu(t).getTime()===Mu(new Date).getTime()},Xu=function(t){var n=new Date;return n.setDate(n.getDate()+1),Mu(t).getTime()===Mu(n).getTime()},Zu=function(t,n,e){var i=Ou(t).getTime(),r=Ou(n).getTime(),u=Ou(e).getTime();if(r>u)throw new Error("The start of the range cannot be after the end of the range");return i>=r&&i<=u},ts=function(t){var n=new Date;return n.setDate(n.getDate()-1),Mu(t).getTime()===Mu(n).getTime()},ns=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.after=Qu}));h(ns);var es=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.array=t=>Array.isArray(t)}));h(es);var is=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.between=(t,[n,e])=>t>n&&t<e}));h(is);var rs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isBoolean=t=>"boolean"==typeof t}));h(rs);var us=f((function(t,n){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(t){var n;if(!("string"==typeof t||t instanceof String))throw n=null===t?"null":"object"===(n=e(t))&&t.constructor&&t.constructor.hasOwnProperty("name")?t.constructor.name:"a ".concat(n),new TypeError("Expected string but received ".concat(n,"."))},t.exports=n.default,t.exports.default=n.default}));h(us);var ss=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(t){(0,i.default)(t);var n=t.replace(/[- ]+/g,"");if(!r.test(n))return!1;for(var e,u,s,o=0,a=n.length-1;a>=0;a--)e=n.substring(a,a+1),u=parseInt(e,10),o+=s&&(u*=2)>=10?u%10+1:u,s=!s;return!(o%10!=0||!n)};var e,i=(e=us)&&e.__esModule?e:{default:e},r=/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|(222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11}|6[27][0-9]{14})$/;t.exports=n.default,t.exports.default=n.default}));h(ss);var os=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.creditCard=t=>ss.default(t)}));h(os);var as=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.date=t=>t instanceof Date==1}));h(as);var cs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/^[a-z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)*$/i;n.email=t=>e.test(t)}));h(cs);var hs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.empty=t=>!Br.existy(t)||!(t instanceof Date)&&"object"==typeof t&&0===Object.keys(t).length}));h(hs);var fs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.even=t=>t%2==0}));h(fs);var ls=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.falsy=t=>!zr.truthy(t)}));h(ls);var ds=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.inArray=(t,n)=>!!Array.isArray(n)&&n.indexOf(t)>-1}));h(ds);var vs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.intersectAll=(t,n)=>!(!Array.isArray(t)||!Array.isArray(n))&&t.filter(t=>n.indexOf(t)>-1).length===t.length}));h(vs);var ms=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.intersectAny=(t,n)=>!(!Array.isArray(t)||!Array.isArray(n))&&t.filter(t=>n.indexOf(t)>-1).length>0}));h(ms);var ws=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/^(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])(?:\.(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])){3}$/;n.ipv4=t=>e.test(t)}));h(ws);var bs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/^(?:(?:[0-9a-fA-F:]){1,4}(?:(?::(?:[0-9a-fA-F]){1,4}|:)){2,7})+$/;n.ipv6=t=>e.test(t)}));h(bs);var ps=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.ip=t=>ws.ipv4(t)||bs.ipv6(t)}));h(ps);var gs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isFunction=t=>"function"==typeof t}));h(gs);var ys=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.json=t=>{if("string"!=typeof t)return!1;try{return!!JSON.parse(t)}catch(t){return!1}}}));h(ys);var _s=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.positive=t=>t>=0}));h(_s);var Os=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.negative=t=>!_s.positive(t)}));h(Os);var ks=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isNull=t=>null===t}));h(ks);var js=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isNumber=t=>"number"==typeof t&&!isNaN(t)}));h(js);var Ss=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isObject=t=>t instanceof Object&&!Array.isArray(t)}));h(Ss);var Es=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.odd=t=>!fs.even(t)}));h(Es);var Ds=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/;n.phone=t=>e.test(t)}));h(Ds);var Is=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.matches=(t,n)=>n.test(t)}));h(Is);var Ms=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.sameType=(t,n)=>typeof t==typeof n}));h(Ms);var As=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.sorted=t=>{if(!Array.isArray(t))return!1;let n=!1,e=0;for(;e<t.length;){const i=Number(t[e++]),r=Number(t[e-2]);if(r&&r>i){n=!0;break}}return!n}}));h(As);var Ts=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.subset=(t,n)=>!(!Array.isArray(t)||!Array.isArray(n))&&t.every(t=>n.includes(t))}));h(Ts);var Ns=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isString=t=>"string"==typeof t}));h(Ns);var xs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.under=(t,n)=>t<n}));h(xs);var Cs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/https?:\/\/(www\.)?([-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-z]{2,63}|localhost)\b([-a-zA-Z0-9@:%_+.~#?&\/\/=]*)/i;n.url=t=>e.test(t)}));h(Cs);var Rs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.today=Ku}));h(Rs);var Fs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.yesterday=ts}));h(Fs);var Ps=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.tomorrow=Xu}));h(Ps);var Us=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.past=Ju}));h(Us);var $s=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.future=Hu}));h($s);var Ls=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.inDateRange=Zu}));h(Ls);var qs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e={years:t=>12*t,quarters:t=>3*t,months:t=>t},i={weeks:t=>7*t,days:t=>t},r={hours:t=>36e5*t,minutes:t=>6e4*t,seconds:t=>1e3*t,milliseconds:t=>t};n.calcUnits=(t,n,u)=>e[n]?Wu(new Date,"-"===u?-e[n](t):e[n](t)):i[n]?zu(new Date,"-"===u?-i[n](t):i[n](t)):r[n]?Vu(new Date,"-"===u?-r[n](t):r[n](t)):void 0,n.dateOffsetKeys=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"]}));h(qs);var Bs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.afterOffsetOf=(t,n,e)=>{const i=qs.calcUnits(n,e,"+");return!!i&&ns.after(t,i)}}));h(Bs);var zs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.before=Yu}));h(zs);var Vs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.beforeOffsetOf=(t,n,e)=>{const i=qs.calcUnits(n,e,"-");return!!i&&zs.before(t,i)}}));h(Vs);var Ws=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.dateFormat=(t,n)=>(Array.isArray(n)?n:[n]).some(n=>{let e=t,i=!1;n.endsWith("ZZ")?(e=t.replace(/(\+|-)\d{4}$/,""),n=n.replace(/ZZ$/,""),i=!0):n.endsWith("Z")&&(e=t.replace(/Z$/,"").replace(/(\+|-)\d{2}:\d{2}$/,""),n=n.replace(/Z$/,""),i=!0);const r=Gu(e,n);return"Invalid Date"!==r&&(i?r===e&&e!==t:r===t)})}));h(Ws);var Gs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.above=Lr.above,n.affirmative=Zr.affirmative,n.after=ns.after,n.alpha=Wr.alpha,n.alphaNumeric=Qr.alphaNumeric,n.array=es.array,n.between=is.between,n.boolean=rs.isBoolean,n.creditCard=os.creditCard,n.date=as.date,n.email=cs.email,n.empty=hs.empty,n.even=fs.even,n.existy=Br.existy,n.falsy=ls.falsy,n.inArray=ds.inArray,n.intersectAll=vs.intersectAll,n.intersectAny=ms.intersectAny,n.ip=ps.ip,n.ipv4=ws.ipv4,n.ipv6=bs.ipv6,n.isFunction=gs.isFunction,n.json=ys.json,n.negative=Os.negative,n.isNull=ks.isNull,n.isNumber=js.isNumber,n.isObject=Ss.isObject,n.odd=Es.odd,n.phone=Ds.phone,n.positive=_s.positive,n.matches=Is.matches,n.same=Kr.same,n.sameType=Ms.sameType,n.sorted=As.sorted,n.subset=Ts.subset,n.isString=Ns.isString,n.truthy=zr.truthy,n.under=xs.under,n.url=Cs.url,n.today=Rs.today,n.yesterday=Fs.yesterday,n.tomorrow=Ps.tomorrow,n.past=Us.past,n.future=$s.future,n.inDateRange=Ls.inDateRange,n.afterOffsetOf=Bs.afterOffsetOf,n.beforeOffsetOf=Vs.beforeOffsetOf,n.before=zs.before,n.dateFormat=Ws.dateFormat}));h(Gs);var Qs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"different:make sure to define target field for comparison",1),[String(t[0])]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.getValue(t,e);return!Gs.existy(u)||u!==r}}}));h(Qs);var Ys=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||cs.email(r)}}}));h(Ys);var Hs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"endsWith:make sure to define substring",1),[String(t[0])]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return!!$r.skippable(r,n,i)||"string"==typeof r&&r.endsWith(e)}}}));h(Hs);var Js=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"equals:make sure to define the comparison string",1),[t[0]]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||e==r}}}));h(Js);var Ks=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"in:make sure to define search collection",1),t),validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||ds.inArray(r,e)}}}));h(Ks);var Xs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"includes:make sure to define substring to match",1),[String(t[0])]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return!!$r.skippable(r,n,i)||"string"==typeof r&&r.includes(e)}}}));h(Xs);var Zs=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{let r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.cast(r,"integer");return null!==u&&u===$r.cast(r,"float")&&($r.patchValue(t,n,u),!0)}}}));h(Zs);var to=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{let r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.cast(r,"float");return null!==u&&($r.patchValue(t,n,u),!0)}}}));h(to);var no=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||ps.ip(r)}}}));h(no);var eo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||ws.ipv4(r)}}}));h(eo);var io=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||bs.ipv6(r)}}}));h(io);var ro=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||ys.json(r)}}}));h(ro);var uo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"max: make sure to define max length",1),[$r.cast(t[0],"integer","max: length must be defined as an integer")]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return!!$r.skippable(r,n,i)||!(!Array.isArray(r)&&"string"!=typeof r)&&r.length<=e}}}));h(uo);var so=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"min: make sure to define min length",1),[$r.cast(t[0],"integer","min: length must be defined as an integer")]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return!!$r.skippable(r,n,i)||!(!Array.isArray(r)&&"string"!=typeof r)&&r.length>=e}}}));h(so);var oo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"notEquals:make sure to define comparison value",1),[t[0]]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||e!=r}}}));h(oo);var ao=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"notIn:make sure to define search collection",1),t),validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||!ds.inArray(r,e)}}}));h(ao);var co=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{let r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.cast(r,"float");return!(null===u||u<0||($r.patchValue(t,n,u),0))}}}));h(co);var ho=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||Ss.isObject(r)}}}));h(ho);var fo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e="range:min and max values must be defined as integers";n.default={async:!1,compile:t=>($r.ensureLength(t,"range:make sure to define min and max values",2),[$r.cast(t[0],"float",e),$r.cast(t[1],"float",e)]),validate:(t,n,[e,i],r)=>{const u=$r.getValue(t,n);return $r.skippable(u,n,r)||u>=e&&u<=i}}}));h(fo);var lo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"regex:make sure to define regex pattern",1),[t[0]instanceof RegExp?t[0]:new RegExp(t[0],t[1])]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||e.test(r)}}}));h(lo);var vo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n)=>Br.existy($r.getValue(t,n))}}));h(vo);var mo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"requiredIf:make sure to define target field",1),[String(t[0])]),validate:(t,n,[e])=>!Br.existy($r.getValue(t,e))||!hs.empty($r.getValue(t,n))}}));h(mo);var wo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"requiredWhen:make sure to define target field and it's expected value",2),[String(t[0]),t[1]]),validate:(t,n,[e,i])=>{const r=$r.getValue(t,e);return!(!hs.empty(r)&&i==r&&hs.empty($r.getValue(t,n)))}}}));h(wo);var bo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"requiredWithAll:make sure to define one or more target fields",1),t.map(t=>String(t))),validate:(t,n,e)=>!!e.some(n=>!Br.existy($r.getValue(t,n)))||!hs.empty($r.getValue(t,n))}}));h(bo);var po=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"requiredWithAny:make sure to define one or more target fields",1),t.map(t=>String(t))),validate:(t,n,e)=>!e.some(n=>Br.existy($r.getValue(t,n)))||!hs.empty($r.getValue(t,n))}}));h(po);var go=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"requiredWithoutAll:make sure to define one or more target fields",1),t.map(t=>String(t))),validate:(t,n,e)=>!!e.some(n=>Br.existy($r.getValue(t,n)))||!hs.empty($r.getValue(t,n))}}));h(go);var yo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"requiredWithoutAny:make sure to define one or more target fields",1),t.map(t=>String(t))),validate:(t,n,e)=>!e.some(n=>!Br.existy($r.getValue(t,n)))||!hs.empty($r.getValue(t,n))}}));h(yo);var _o=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"same:make sure to define target field for comparison",1),[String(t[0])]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.getValue(t,e);return!Br.existy(u)||u===r}}}));h(_o);var Oo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"startsWith:make sure to define substring",1),[String(t[0])]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return!!$r.skippable(r,n,i)||"string"==typeof r&&r.startsWith(e)}}}));h(Oo);var ko=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return!!$r.skippable(r,n,i)||"string"==typeof r}}}));h(ko);var jo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"subset:make sure to define subset collection",1),t.map(t=>$r.cast(t,"string"))),validate:(t,n,e,i)=>{let r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;if(Ns.isString(r))r=r.split(",").map(t=>t.trim());else{if(!Array.isArray(r))return!1;r=r.map(t=>$r.cast(t,"string"))}return!!Ts.subset(r,e)&&($r.patchValue(t,n,r),!0)}}}));h(jo);var So=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"under:make sure to define max value",1),[$r.cast(t[0],"float","under:max value must be defined as an integer")]),validate:(t,n,[e],i)=>{let r=$r.getValue(t,n);return $r.skippable(r,n,i)||xs.under(r,e)}}}));h(So);var Eo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||Cs.url(r)}}}));h(Eo);var Do=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"after:make sure to define the after date",1),[$r.cast(t[0],"date","after:after date must be defined as string or date object")]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||ns.after(r,e)}}}));h(Do);var Io=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"before:make sure to define the before date",1),[$r.cast(t[0],"date","before:before date must be defined as string or date object")]),validate:(t,n,[e],i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||zs.before(r,e)}}}));h(Io);var Mo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,validate:(t,n,e,i)=>{const r=$r.getValue(t,n);if($r.skippable(r,n,i))return!0;const u=$r.cast(r,"date");return null!==u&&($r.patchValue(t,n,u),!0)}}}));h(Mo);var Ao=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile:t=>($r.ensureLength(t,"dateFormat:make sure to define atleast one date format",1),t.map(t=>String(t))),validate:(t,n,e,i)=>{const r=$r.getValue(t,n);return $r.skippable(r,n,i)||Ws.dateFormat(r,e)}}}));h(Ao);var To=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile(t){$r.ensureLength(t,"beforeOffsetOf:make sure to define offset unit and key",2);const n=$r.cast(t[0],"integer","beforeOffsetOf:1st argument must be a number"),e=t[1];if(!qs.dateOffsetKeys.includes(e))throw new Error("beforeOffsetOf:2nd argument must be a valid calc key");return[Number(n),e]},validate:(t,n,[e,i],r)=>{const u=$r.getValue(t,n);return $r.skippable(u,n,r)||Vs.beforeOffsetOf(u,e,i)}}}));h(To);var No=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={async:!1,compile(t){$r.ensureLength(t,"afterOffsetOf:make sure to define offset unit and key",2);const n=$r.cast(t[0],"integer","afterOffsetOf:1st argument must be a number"),e=t[1];if(!qs.dateOffsetKeys.includes(e))throw new Error("afterOffsetOf:2nd argument must be a valid calc key");return[Number(n),e]},validate:(t,n,[e,i],r)=>{const u=$r.getValue(t,n);return $r.skippable(u,n,r)||Bs.afterOffsetOf(u,e,i)}}}));h(No);var xo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.above=qr.default,n.accepted=Vr.default,n.alpha=Gr.default,n.alphaNumeric=Yr.default,n.array=Hr.default,n.boolean=Jr.default,n.confirmed=Xr.default,n.different=Qs.default,n.email=Ys.default,n.endsWith=Hs.default,n.equals=Js.default,n.in=Ks.default,n.includes=Xs.default,n.integer=Zs.default,n.float=to.default,n.ip=no.default,n.ipv4=eo.default,n.ipv6=io.default,n.json=ro.default,n.max=uo.default,n.min=so.default,n.notEquals=oo.default,n.notIn=ao.default,n.number=co.default,n.object=ho.default,n.range=fo.default,n.regex=lo.default,n.required=vo.default,n.requiredIf=mo.default,n.requiredWhen=wo.default,n.requiredWithAll=bo.default,n.requiredWithAny=po.default,n.requiredWithoutAll=go.default,n.requiredWithoutAny=yo.default,n.same=_o.default,n.startsWith=Oo.default,n.string=ko.default,n.subset=jo.default,n.under=So.default,n.url=Eo.default,n.after=Do.default,n.before=Io.default,n.date=Mo.default,n.dateFormat=Ao.default,n.beforeOffsetOf=To.default,n.afterOffsetOf=No.default}));h(xo);var Co=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n){let e=$r.getValue(t,n);"string"==typeof e&&(e=e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),$r.patchValue(t,n,e))}}}));h(Co);var Ro=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n,e=[]){let i=$r.getValue(t,n);"string"==typeof i&&$r.patchValue(t,n,i.toLocaleLowerCase(e[0]))}}}));h(Ro);var Fo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;for(var e in n)void 0===t[e]&&(t[e]=n[e]);return t},t.exports=n.default,t.exports.default=n.default}));h(Fo);var Po=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(t,n){n=(0,i.default)(n,r);var e=t.split("@"),h=e.pop(),f=[e.join("@"),h];if(f[1]=f[1].toLowerCase(),"gmail.com"===f[1]||"googlemail.com"===f[1]){if(n.gmail_remove_subaddress&&(f[0]=f[0].split("+")[0]),n.gmail_remove_dots&&(f[0]=f[0].replace(/\.+/g,c)),!f[0].length)return!1;(n.all_lowercase||n.gmail_lowercase)&&(f[0]=f[0].toLowerCase()),f[1]=n.gmail_convert_googlemaildotcom?"gmail.com":f[1]}else if(u.indexOf(f[1])>=0){if(n.icloud_remove_subaddress&&(f[0]=f[0].split("+")[0]),!f[0].length)return!1;(n.all_lowercase||n.icloud_lowercase)&&(f[0]=f[0].toLowerCase())}else if(s.indexOf(f[1])>=0){if(n.outlookdotcom_remove_subaddress&&(f[0]=f[0].split("+")[0]),!f[0].length)return!1;(n.all_lowercase||n.outlookdotcom_lowercase)&&(f[0]=f[0].toLowerCase())}else if(o.indexOf(f[1])>=0){if(n.yahoo_remove_subaddress){var l=f[0].split("-");f[0]=l.length>1?l.slice(0,-1).join("-"):l[0]}if(!f[0].length)return!1;(n.all_lowercase||n.yahoo_lowercase)&&(f[0]=f[0].toLowerCase())}else a.indexOf(f[1])>=0?((n.all_lowercase||n.yandex_lowercase)&&(f[0]=f[0].toLowerCase()),f[1]="yandex.ru"):n.all_lowercase&&(f[0]=f[0].toLowerCase());return f.join("@")};var e,i=(e=Fo)&&e.__esModule?e:{default:e},r={all_lowercase:!0,gmail_lowercase:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0,gmail_convert_googlemaildotcom:!0,outlookdotcom_lowercase:!0,outlookdotcom_remove_subaddress:!0,yahoo_lowercase:!0,yahoo_remove_subaddress:!0,yandex_lowercase:!0,icloud_lowercase:!0,icloud_remove_subaddress:!0},u=["icloud.com","me.com"],s=["hotmail.at","hotmail.be","hotmail.ca","hotmail.cl","hotmail.co.il","hotmail.co.nz","hotmail.co.th","hotmail.co.uk","hotmail.com","hotmail.com.ar","hotmail.com.au","hotmail.com.br","hotmail.com.gr","hotmail.com.mx","hotmail.com.pe","hotmail.com.tr","hotmail.com.vn","hotmail.cz","hotmail.de","hotmail.dk","hotmail.es","hotmail.fr","hotmail.hu","hotmail.id","hotmail.ie","hotmail.in","hotmail.it","hotmail.jp","hotmail.kr","hotmail.lv","hotmail.my","hotmail.ph","hotmail.pt","hotmail.sa","hotmail.sg","hotmail.sk","live.be","live.co.uk","live.com","live.com.ar","live.com.mx","live.de","live.es","live.eu","live.fr","live.it","live.nl","msn.com","outlook.at","outlook.be","outlook.cl","outlook.co.il","outlook.co.nz","outlook.co.th","outlook.com","outlook.com.ar","outlook.com.au","outlook.com.br","outlook.com.gr","outlook.com.pe","outlook.com.tr","outlook.com.vn","outlook.cz","outlook.de","outlook.dk","outlook.es","outlook.fr","outlook.hu","outlook.id","outlook.ie","outlook.in","outlook.it","outlook.jp","outlook.kr","outlook.lv","outlook.my","outlook.ph","outlook.pt","outlook.sa","outlook.sg","outlook.sk","passport.com"],o=["rocketmail.com","yahoo.ca","yahoo.co.uk","yahoo.com","yahoo.de","yahoo.fr","yahoo.in","yahoo.it","ymail.com"],a=["yandex.ru","yandex.ua","yandex.kz","yandex.com","yandex.by","ya.ru"];function c(t){return t.length>1?t:""}t.exports=n.default,t.exports.default=n.default}));h(Po);var Uo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n,e=[]){let i=$r.getValue(t,n);"string"==typeof i&&$r.patchValue(t,n,Po(i,e[0]))}}}));h(Uo);var $o=f((function(t){t.exports=function(){var t=[],n=[],e={},i={},r={};function u(t){return"string"==typeof t?new RegExp("^"+t+"$","i"):t}function s(t,n){return t===n?n:t===t.toLowerCase()?n.toLowerCase():t===t.toUpperCase()?n.toUpperCase():t[0]===t[0].toUpperCase()?n.charAt(0).toUpperCase()+n.substr(1).toLowerCase():n.toLowerCase()}function o(t,n){return t.replace(/\$(\d{1,2})/g,(function(t,e){return n[e]||""}))}function a(t,n){return t.replace(n[0],(function(e,i){var r=o(n[1],arguments);return s(""===e?t[i-1]:e,r)}))}function c(t,n,i){if(!t.length||e.hasOwnProperty(t))return n;for(var r=i.length;r--;){var u=i[r];if(u[0].test(n))return a(n,u)}return n}function h(t,n,e){return function(i){var r=i.toLowerCase();return n.hasOwnProperty(r)?s(i,r):t.hasOwnProperty(r)?s(i,t[r]):c(r,i,e)}}function f(t,n,e){return function(i){var r=i.toLowerCase();return!!n.hasOwnProperty(r)||!t.hasOwnProperty(r)&&c(r,r,e)===r}}function l(t,n,e){return(e?n+" ":"")+(1===n?l.singular(t):l.plural(t))}return l.plural=h(r,i,t),l.isPlural=f(r,i,t),l.singular=h(i,r,n),l.isSingular=f(i,r,n),l.addPluralRule=function(n,e){t.push([u(n),e])},l.addSingularRule=function(t,e){n.push([u(t),e])},l.addUncountableRule=function(t){"string"!=typeof t?(l.addPluralRule(t,"$0"),l.addSingularRule(t,"$0")):e[t.toLowerCase()]=!0},l.addIrregularRule=function(t,n){n=n.toLowerCase(),t=t.toLowerCase(),r[t]=n,i[n]=t},[["I","we"],["me","us"],["he","they"],["she","they"],["them","them"],["myself","ourselves"],["yourself","yourselves"],["itself","themselves"],["herself","themselves"],["himself","themselves"],["themself","themselves"],["is","are"],["was","were"],["has","have"],["this","these"],["that","those"],["echo","echoes"],["dingo","dingoes"],["volcano","volcanoes"],["tornado","tornadoes"],["torpedo","torpedoes"],["genus","genera"],["viscus","viscera"],["stigma","stigmata"],["stoma","stomata"],["dogma","dogmata"],["lemma","lemmata"],["schema","schemata"],["anathema","anathemata"],["ox","oxen"],["axe","axes"],["die","dice"],["yes","yeses"],["foot","feet"],["eave","eaves"],["goose","geese"],["tooth","teeth"],["quiz","quizzes"],["human","humans"],["proof","proofs"],["carve","carves"],["valve","valves"],["looey","looies"],["thief","thieves"],["groove","grooves"],["pickaxe","pickaxes"],["passerby","passersby"]].forEach((function(t){return l.addIrregularRule(t[0],t[1])})),[[/s?$/i,"s"],[/[^\u0000-\u007F]$/i,"$0"],[/([^aeiou]ese)$/i,"$1"],[/(ax|test)is$/i,"$1es"],[/(alias|[^aou]us|t[lm]as|gas|ris)$/i,"$1es"],[/(e[mn]u)s?$/i,"$1s"],[/([^l]ias|[aeiou]las|[ejzr]as|[iu]am)$/i,"$1"],[/(alumn|syllab|vir|radi|nucle|fung|cact|stimul|termin|bacill|foc|uter|loc|strat)(?:us|i)$/i,"$1i"],[/(alumn|alg|vertebr)(?:a|ae)$/i,"$1ae"],[/(seraph|cherub)(?:im)?$/i,"$1im"],[/(her|at|gr)o$/i,"$1oes"],[/(agend|addend|millenni|dat|extrem|bacteri|desiderat|strat|candelabr|errat|ov|symposi|curricul|automat|quor)(?:a|um)$/i,"$1a"],[/(apheli|hyperbat|periheli|asyndet|noumen|phenomen|criteri|organ|prolegomen|hedr|automat)(?:a|on)$/i,"$1a"],[/sis$/i,"ses"],[/(?:(kni|wi|li)fe|(ar|l|ea|eo|oa|hoo)f)$/i,"$1$2ves"],[/([^aeiouy]|qu)y$/i,"$1ies"],[/([^ch][ieo][ln])ey$/i,"$1ies"],[/(x|ch|ss|sh|zz)$/i,"$1es"],[/(matr|cod|mur|sil|vert|ind|append)(?:ix|ex)$/i,"$1ices"],[/\b((?:tit)?m|l)(?:ice|ouse)$/i,"$1ice"],[/(pe)(?:rson|ople)$/i,"$1ople"],[/(child)(?:ren)?$/i,"$1ren"],[/eaux$/i,"$0"],[/m[ae]n$/i,"men"],["thou","you"]].forEach((function(t){return l.addPluralRule(t[0],t[1])})),[[/s$/i,""],[/(ss)$/i,"$1"],[/(wi|kni|(?:after|half|high|low|mid|non|night|[^\w]|^)li)ves$/i,"$1fe"],[/(ar|(?:wo|[ae])l|[eo][ao])ves$/i,"$1f"],[/ies$/i,"y"],[/\b([pl]|zomb|(?:neck|cross)?t|coll|faer|food|gen|goon|group|lass|talk|goal|cut)ies$/i,"$1ie"],[/\b(mon|smil)ies$/i,"$1ey"],[/\b((?:tit)?m|l)ice$/i,"$1ouse"],[/(seraph|cherub)im$/i,"$1"],[/(x|ch|ss|sh|zz|tto|go|cho|alias|[^aou]us|t[lm]as|gas|(?:her|at|gr)o|[aeiou]ris)(?:es)?$/i,"$1"],[/(analy|diagno|parenthe|progno|synop|the|empha|cri|ne)(?:sis|ses)$/i,"$1sis"],[/(movie|twelve|abuse|e[mn]u)s$/i,"$1"],[/(test)(?:is|es)$/i,"$1is"],[/(alumn|syllab|vir|radi|nucle|fung|cact|stimul|termin|bacill|foc|uter|loc|strat)(?:us|i)$/i,"$1us"],[/(agend|addend|millenni|dat|extrem|bacteri|desiderat|strat|candelabr|errat|ov|symposi|curricul|quor)a$/i,"$1um"],[/(apheli|hyperbat|periheli|asyndet|noumen|phenomen|criteri|organ|prolegomen|hedr|automat)a$/i,"$1on"],[/(alumn|alg|vertebr)ae$/i,"$1a"],[/(cod|mur|sil|vert|ind)ices$/i,"$1ex"],[/(matr|append)ices$/i,"$1ix"],[/(pe)(rson|ople)$/i,"$1rson"],[/(child)ren$/i,"$1"],[/(eau)x?$/i,"$1"],[/men$/i,"man"]].forEach((function(t){return l.addSingularRule(t[0],t[1])})),["adulthood","advice","agenda","aid","aircraft","alcohol","ammo","analytics","anime","athletics","audio","bison","blood","bream","buffalo","butter","carp","cash","chassis","chess","clothing","cod","commerce","cooperation","corps","debris","diabetes","digestion","elk","energy","equipment","excretion","expertise","firmware","flounder","fun","gallows","garbage","graffiti","hardware","headquarters","health","herpes","highjinks","homework","housework","information","jeans","justice","kudos","labour","literature","machinery","mackerel","mail","media","mews","moose","music","mud","manga","news","only","personnel","pike","plankton","pliers","police","pollution","premises","rain","research","rice","salmon","scissors","series","sewage","shambles","shrimp","software","species","staff","swine","tennis","traffic","transportation","trout","tuna","wealth","welfare","whiting","wildebeest","wildlife","you",/pok[e]mon$/i,/[^aeiou]ese$/i,/deer$/i,/fish$/i,/measles$/i,/o[iu]s$/i,/pox$/i,/sheep$/i].forEach(l.addUncountableRule),l}()})),Lo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n){let e=$r.getValue(t,n);"string"==typeof e&&$r.patchValue(t,n,$o(e))}}}));h(Lo);var qo=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n){let e=$r.getValue(t,n);"string"==typeof e&&$r.patchValue(t,n,$o.singular(e))}}}));h(qo);var Bo,zo=1/0,Vo="[object Symbol]",Wo=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Go=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Qo="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Yo="["+Qo+"]",Ho="\\d+",Jo="[a-z\\xdf-\\xf6\\xf8-\\xff]",Ko="[^\\ud800-\\udfff"+Qo+Ho+"\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde]",Xo="(?:\\ud83c[\\udde6-\\uddff]){2}",Zo="[\\ud800-\\udbff][\\udc00-\\udfff]",ta="[A-Z\\xc0-\\xd6\\xd8-\\xde]",na="(?:"+Jo+"|"+Ko+")",ea="(?:"+ta+"|"+Ko+")",ia="(?:[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|\\ud83c[\\udffb-\\udfff])?",ra="[\\ufe0e\\ufe0f]?"+ia+"(?:\\u200d(?:"+["[^\\ud800-\\udfff]",Xo,Zo].join("|")+")[\\ufe0e\\ufe0f]?"+ia+")*",ua="(?:"+["[\\u2700-\\u27bf]",Xo,Zo].join("|")+")"+ra,sa=RegExp("[']","g"),oa=RegExp("[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]","g"),aa=RegExp([ta+"?"+Jo+"+(?:['](?:d|ll|m|re|s|t|ve))?(?="+[Yo,ta,"$"].join("|")+")",ea+"+(?:['](?:D|LL|M|RE|S|T|VE))?(?="+[Yo,ta+na,"$"].join("|")+")",ta+"?"+na+"+(?:['](?:d|ll|m|re|s|t|ve))?",ta+"+(?:['](?:D|LL|M|RE|S|T|VE))?",Ho,ua].join("|"),"g"),ca=/[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,ha="object"==typeof c&&c&&c.Object===Object&&c,fa="object"==typeof self&&self&&self.Object===Object&&self,la=ha||fa||Function("return this")(),da=function(t){return function(n){return null==t?void 0:t[n]}}({"":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"a","":"a","":"a","":"a","":"a","":"C","":"c","":"D","":"d","":"E","":"E","":"E","":"E","":"e","":"e","":"e","":"e","":"I","":"I","":"I","":"I","":"i","":"i","":"i","":"i","":"N","":"n","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"U","":"U","":"U","":"U","":"u","":"u","":"u","":"u","":"Y","":"y","":"y","":"Ae","":"ae","":"Th","":"th","":"ss","":"A","":"A","":"A","":"a","":"a","":"a","":"C","":"C","":"C","":"C","":"c","":"c","":"c","":"c","":"D","":"D","":"d","":"d","":"E","":"E","":"E","":"E","":"E","":"e","":"e","":"e","":"e","":"e","":"G","":"G","":"G","":"G","":"g","":"g","":"g","":"g","":"H","":"H","":"h","":"h","":"I","":"I","":"I","":"I","":"I","":"i","":"i","":"i","":"i","":"i","":"J","":"j","":"K","":"k","":"k","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"l","":"l","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"O","":"O","":"O","":"o","":"o","":"o","":"R","":"R","":"R","":"r","":"r","":"r","":"S","":"S","":"S","":"S","":"s","":"s","":"s","":"s","":"T","":"T","":"T","":"t","":"t","":"t","":"U","":"U","":"U","":"U","":"U","":"U","":"u","":"u","":"u","":"u","":"u","":"u","":"W","":"w","":"Y","":"y","":"Y","":"Z","":"Z","":"Z","":"z","":"z","":"z","":"IJ","":"ij","":"Oe","":"oe","":"'n","":"ss"}),va=Object.prototype.toString,ma=la.Symbol,wa=ma?ma.prototype:void 0,ba=wa?wa.toString:void 0;function pa(t){return null==t?"":function(t){if("string"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&va.call(t)==Vo}(t))return ba?ba.call(t):"";var n=t+"";return"0"==n&&1/t==-zo?"-0":n}(t)}var ga=(Bo=function(t,n,e){return t+(e?"-":"")+n.toLowerCase()},function(t){return function(t,n,e){for(var i=-1,r=t?t.length:0;++i<r;)e=n(e,t[i],i,t);return e}(function(t,n){return t=pa(t),void 0===(n=n)?function(t){return ca.test(t)}(t)?function(t){return t.match(aa)||[]}(t):function(t){return t.match(Wo)||[]}(t):t.match(n)||[]}(function(t){return(t=pa(t))&&t.replace(Go,da).replace(oa,"")}(t).replace(sa,"")),Bo,"")});var ya=function(t,n){if(null==t)throw new TypeError("Cannot convert first argument to object");for(var e=Object(t),i=1;i<arguments.length;i++){var r=arguments[i];if(null!=r)for(var u=Object.keys(Object(r)),s=0,o=u.length;s<o;s++){var a=u[s],c=Object.getOwnPropertyDescriptor(r,a);void 0!==c&&c.enumerable&&(e[a]=r[a])}}return e},_a=ya({"":"A","":"A","":"A","":"A","":"A","":"A","":"AE","":"C","":"E","":"E","":"E","":"E","":"I","":"I","":"I","":"I","":"D","":"N","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"U","":"U","":"U","":"U","":"U","":"Y","":"TH","":"Y","":"ss","":"a","":"a","":"a","":"a","":"a","":"a","":"ae","":"c","":"e","":"e","":"e","":"e","":"i","":"i","":"i","":"i","":"d","":"n","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"u","":"u","":"u","":"u","":"u","":"y","":"th","":"y"},{"":"(c)","":"oe","":"OE","":"sum","":"(r)","":"+","":'"',"":'"',"":"'","":"'","":"d","":"f","":"tm","":"sm","":"...","":"o","":"o","":"a","":"*","":"delta","":"infinity","":"love","&":"and","|":"or","<":"less",">":"greater","@":"at"},{"":"a","":"b","":"g","":"d","":"e","":"z","":"h","":"8","":"i","":"k","":"l","":"m","":"n","":"3","":"o","":"p","":"r","":"s","":"t","":"y","":"f","":"x","":"ps","":"w","":"a","":"e","":"i","":"o","":"y","":"h","":"w","":"s","":"i","":"y","":"y","":"i","":"A","":"B","":"G","":"D","":"E","":"Z","":"H","":"8","":"I","":"K","":"L","":"M","":"N","":"3","":"O","":"P","":"R","":"S","":"T","":"Y","":"F","":"X","":"PS","":"W","":"A","":"E","":"I","":"O","":"Y","":"H","":"W","":"I","":"Y"},{"":"s","":"S","":"i","":"I","":"c","":"C","":"u","":"U","":"o","":"O","":"g","":"G"},{"":"a","":"i","":"s","":"t","":"a","":"A","":"I","":"S","":"T","":"A"},{"":"a","":"b","":"v","":"g","":"d","":"e","":"yo","":"zh","":"z","":"i","":"j","":"k","":"l","":"m","":"n","":"o","":"p","":"r","":"s","":"t","":"u","":"f","":"h","":"c","":"ch","":"sh","":"sh","":"","":"y","":"","":"e","":"yu","":"ya","":"A","":"B","":"V","":"G","":"D","":"E","":"Yo","":"Zh","":"Z","":"I","":"J","":"K","":"L","":"M","":"N","":"O","":"P","":"R","":"S","":"T","":"U","":"F","":"H","":"C","":"Ch","":"Sh","":"Sh","":"","":"Y","":"","":"E","":"Yu","":"Ya"},{"":"Ye","":"I","":"Yi","":"G","":"ye","":"i","":"yi","":"g"},{"":"c","":"d","":"e","":"n","":"r","":"s","":"t","":"u","":"z","":"C","":"D","":"E","":"N","":"R","":"S","":"T","":"U","":"Z"},{"":"a","":"a","":"c","":"d","":"e","":"i","":"l","":"l","":"n","":"o","":"o","":"r","":"s","":"t","":"u","":"y","":"z","":"a","":"A","":"C","":"D","":"E","":"I","":"L","":"L","":"N","":"O","":"O","":"R","":"S","":"T","":"U","":"Y","":"Z"},{"":"a","":"c","":"e","":"l","":"n","":"o","":"s","":"z","":"z","":"A","":"C","":"E","":"L","":"N","":"O","":"S","":"Z","":"Z"},{"":"a","":"c","":"e","":"g","":"i","":"k","":"l","":"n","":"s","":"u","":"z","":"A","":"C","":"E","":"G","":"I","":"K","":"L","":"N","":"S","":"U","":"Z"},{"":"a","":"b","":"t","":"th","":"g","":"h","":"kh","":"d","":"th","":"r","":"z","":"s","":"sh","":"s","":"d","":"t","":"th","":"aa","":"gh","":"f","":"k","":"k","":"l","":"m","":"n","":"h","":"o","":"y"},{"":"a","":"c","":"e","":"e","":"i","":"s","":"u","":"u","":"z","":"A","":"C","":"E","":"E","":"I","":"S","":"U","":"U","":"Z"},{"":"dj","":"j","":"lj","":"nj","":"c","":"dz","":"dj","":"Dj","":"j","":"Lj","":"Nj","":"C","":"Dz","":"Dj"},{"":"c","":"e","":"g","":"i","":"o","":"s","":"u","":"C","":"E","":"G","":"I","":"O","":"S","":"U"},{"":"a","":"b","":"g","":"d","":"e","":"v","":"z","":"t","":"i","":"k","":"l","":"m","":"n","":"o","":"p","":"j","":"r","":"s","":"t","":"u","":"f","":"q","":"g","":"y","":"sh","":"ch","":"c","":"dz","":"w","":"ch","":"x","":"j","":"h"},{"":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"I","":"I","":"I","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"Y","":"Y","":"Y","":"Y","":"D","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"i","":"i","":"i","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"y","":"y","":"y","":"y","":"d"},{"":"euro","":"cruzeiro","":"french franc","":"pound","":"lira","":"mill","":"naira","":"peseta","":"rupee","":"won","":"new shequel","":"dong","":"kip","":"tugrik","":"drachma","":"penny","":"peso","":"guarani","":"austral","":"hryvnia","":"cedi","":"cent","":"yen","":"yuan","":"yen","":"rial","":"ecu","":"currency","":"baht",$:"dollar","":"indian rupee"});function Oa(t){if(void 0===t)return"";for(var n="",e=0;e<t.length;e++){var i=t[e];n+=void 0!==_a[i]?_a[i]:i}return n}Oa.extends=function(t){ya(_a,t)};var ka=Oa;function ja(t){return void 0===t?"":ga(function(t){for(var n="",e=0;e<=t.length;e++)t.charCodeAt(e)<128&&(n+=t[e]);return n}(ka(t.toString())))}ja.extends=function(t){ka.extends(t)};var Sa=ja,Ea=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n){let e=$r.getValue(t,n);"string"==typeof e&&$r.patchValue(t,n,Sa(e))}}}));h(Ea);var Da=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=/<a\b[^>]*>(.*?)<\/a>/g;n.default={sanitize(t,n){let i=$r.getValue(t,n);"string"==typeof i&&$r.patchValue(t,n,i.replace(e,(t,n)=>n.trim()))}}}));h(Da);var Ia=f((function(t){!function(n){if("function"!=typeof e){var e=function(t){return t};e.nonNative=!0}const i=e("plaintext"),r=e("html"),u=e("comment"),s=/<(\w*)>/g,o=/<\/?([^\s\/>]+)/;function a(t,n,e){return h(t=t||"",c(n=n||[],e=e||""))}function c(t,n){return{allowable_tags:t=function(t){let n=new Set;if("string"==typeof t){let e;for(;e=s.exec(t);)n.add(e[1])}else e.nonNative||"function"!=typeof t[e.iterator]?"function"==typeof t.forEach&&t.forEach(n.add,n):n=new Set(t);return n}(t),tag_replacement:n,state:i,tag_buffer:"",depth:0,in_quote_char:""}}function h(t,n){let e=n.allowable_tags,s=n.tag_replacement,o=n.state,a=n.tag_buffer,c=n.depth,h=n.in_quote_char,l="";for(let n=0,d=t.length;n<d;n++){let d=t[n];if(o===i)switch(d){case"<":o=r,a+=d;break;default:l+=d}else if(o===r)switch(d){case"<":if(h)break;c++;break;case">":if(h)break;if(c){c--;break}h="",o=i,e.has(f(a+=">"))?l+=a:l+=s,a="";break;case'"':case"'":h=d===h?"":h||d,a+=d;break;case"-":"<!-"===a&&(o=u),a+=d;break;case" ":case"\n":if("<"===a){o=i,l+="< ",a="";break}a+=d;break;default:a+=d}else if(o===u)switch(d){case">":"--"==a.slice(-2)&&(o=i),a="";break;default:a+=d}}return n.state=o,n.tag_buffer=a,n.depth=c,n.in_quote_char=h,l}function f(t){let n=o.exec(t);return n?n[1].toLowerCase():null}a.init_streaming_mode=function(t,n){let e=c(t=t||[],n=n||"");return function(t){return h(t||"",e)}},t.exports?t.exports=a:n.striptags=a}(c)})),Ma=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n,e=[]){let i=$r.getValue(t,n);"string"==typeof i&&$r.patchValue(t,n,Ia(i,e))}}}));h(Ma);var Aa=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n){let e=$r.getValue(t,n);"string"==typeof e&&$r.patchValue(t,n,e.trim())}}}));h(Aa);var Ta=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default={sanitize(t,n,e=[]){let i=$r.getValue(t,n);"string"==typeof i&&$r.patchValue(t,n,i.toLocaleUpperCase(e[0]))}}}));h(Ta);var Na=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.escape=Co.default,n.lowerCase=Ro.default,n.normalizeEmail=Uo.default,n.plural=Lo.default,n.singular=qo.default,n.slug=Ea.default,n.stripLinks=Da.default,n.stripTags=Ma.default,n.trim=Aa.default,n.upperCase=Ta.default}));h(Na);var xa=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.validations=xo,n.sanitizations=Na,n.raw=Gs}));h(xa);var Ca=function(t,n){n.add();for(var e=t.length,i=0,r="name";i<e;){var u=t[i++],s=u.charCodeAt(0);58===s||44===s?(r="arg",n.shiftValue()):124===s?(r="name",n.add()):"arg"===r?n.appendValue(u):n.appendKey(u,s)}return n.toJSON()},Ra=function(){return{nodes:[],currentNode:null,add:function(){this.currentNode={name:"",args:[]},this.nodes.push(this.currentNode)},appendKey:function(t,n){32!==n&&(this.currentNode.name+=t)},appendValue:function(t){this.currentNode.args[this.currentNode.args.length-1]+=t},shiftValue:function(){this.currentNode.args.push("")},toJSON:function(){return this.nodes}}},Fa=f((function(t,n){var e=c&&c.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});const i=e(Ca),r=e(Ra);function u(t){return t.replace(/_(\w)/g,(t,n)=>n.toUpperCase())}n.rulesParser=function(t){return Object.keys(t).reduce((n,e)=>{const s=t[e];let o=[];if(!s)throw new Error(`make sure to define rules for ${e}`);return o="string"==typeof s?new i.default(s,new r.default).map(t=>({name:u(t.name),args:t.args})):s,function t(n,e,i,r=0){const u=n[r++],s=n.length===r,o=/^\d+$/.test(n[r]),a="*"===n[r]||o;return"*"===u||/^\d+$/.test(u)?s?void(i.each[u].rules=e):t(n,e,i.each[u].children,r):s?void function(t,n,e){const i=t[n]||{type:"literal"};i.rules=e,t[n]=i}(i,u,e):t(n,e,a?function(t,n,e){if(t[n]&&"object"===t[n].type)throw new Error(`cannot reshape ${n} object to an array`);const i=t[n]||{rules:[]};return i.each=i.each||{},i.each[e]=i.each[e]||{children:{},rules:[]},i.type="array",t[n]=i,i}(i,u,o?n[r]:"*"):function(t,n){if(t[n]&&"array"===t[n].type)throw new Error(`cannot reshape ${n} array to an object`);const e=t[n]||{rules:[]};return e.type="object",e.children=e.children||{},t[n]=e,e}(i,u).children,r)}(e.split("."),o,n),n},{})},n.messagesParser=function(t){return Object.keys(t).reduce((n,e)=>{const i=t[e],r=e.split("."),s=u(r.pop());if(!r.length)return n.rules[s]=i,n;const o=r.join(".");return n.fields[o]=n.fields[o]||{},n.fields[o][s]=i,n},{fields:{},rules:{}})}}));h(Fa);var Pa=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.rulesParser=Fa.rulesParser,n.messagesParser=Fa.messagesParser}));h(Pa);var Ua=f((function(t,n){var e=c&&c.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});const i=e(Rr);n.ArrayWrapper=class{constructor(t,n,e,i){this._field=t,this._index=n,this._childValidators=e,this._dotPath=i,this._pointer=this._dotPath.concat(this._field).join("."),this.async=!!this._childValidators.find(t=>t.async)}_getDataCopy(t){const n=i.default(t.tip,this._pointer);return Array.isArray(n)?{original:t.original,pointer:"",tip:null,parentArray:n,currentIndex:"*"===this._index?0:Number(this._index),arrayPointer:t.arrayPointer?`${t.arrayPointer}.${t.currentIndex}.${this._pointer}`:this._pointer}:null}_executeValidations(t,n,e,i){let r=!1;for(let u of this._childValidators)if(!u.exec(t,n,e,i)&&(r=!0,i))break;return!r}async _executeAsyncValidations(t,n,e,i){let r=!1;for(let u of this._childValidators){let s=!0;if(!(s=u.async?await u.execAsync(t,n,e,i):u.exec(t,n,e,i))&&(r=!0,i))break}return!r}exec(t,n,e,i=!1){const r=this._getDataCopy(t);if(!r)return!0;if("*"!==this._index)return r.tip=r.parentArray[r.currentIndex],this._executeValidations(r,n,e,i);let u=0,s=!1;for(let t of r.parentArray){r.tip=t,r.currentIndex=u;let o=!0;if(!(o=this._executeValidations(r,n,e,i))&&(s=!0,i))break;u++}return!s}async execAsync(t,n,e,i=!1){const r=this._getDataCopy(t);if(!r)return!0;if("*"!==this._index)return r.tip=r.parentArray[r.currentIndex],this._executeAsyncValidations(r,n,e,i);let u=0,s=!1;for(let t of r.parentArray){if(r.tip=t,r.currentIndex=u,!await this._executeAsyncValidations(r,n,e,i)&&(s=!0,i))break;u++}return!s}}}));function $a(t){return null!=t&&"object"==typeof t&&!1===Array.isArray(t)}h(Ua);var La=f((function(t,n){var e=c&&c.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});const i=e(Rr),r=e($a);n.ValidationsRunner=class{constructor(t,n,e,i,r,u,s){this._field=t,this._type=n,this._dotPath=e,this._fieldMessages=u,this._genericMessages=s,this.async=!1,this._validations=[],this._pointer=this._dotPath.concat(this._field).join("."),this._computeValidations(r,i)}_computeValidations(t,n){this._validations=n.map(n=>{const e=t[n.name];if(!e)throw new Error(`${n.name} is not a registered as a validation`);if("function"!=typeof e.validate)throw new Error(`${n.name} is missing validate function`);return"function"==typeof e.compile&&(n.args=e.compile(n.args)),e.async&&(this.async=!0),{rule:n,fn:e.validate,async:e.async}})}_getDataCopy(t){const n=this._dotPath.length?i.default(t.tip,this._dotPath):t.tip;return Object.assign({},t,{tip:"::tip::"===this._field?{[this._field]:n}:n,pointer:t.arrayPointer?`${t.arrayPointer}.${t.currentIndex}.${this._pointer}`:this._pointer})}_reportValueToCollector(t,n,e){t&&"literal"===this._type&&e.setValue(n.pointer,n.tip[this._field])}_reportErrorToCollector(t,n,e,i){e.setError(t,n,i||this._fieldMessages[n.name]||this._genericMessages[n.name])}exec(t,n,e,i=!1){const u=this._getDataCopy(t);if(!r.default(u.tip))return!0;let s=!1;for(let t of this._validations){let r=null,o=!0;try{o=t.fn(u,this._field,t.rule.args,e)}catch(t){r=t,o=!1}if(!o&&(s=!0,this._reportErrorToCollector(u.pointer,t.rule,n,r),i))break}return this._reportValueToCollector(!s,u,n),!s}async execAsync(t,n,e,i=!1){const u=this._getDataCopy(t);if(!r.default(u.tip))return!0;let s=!1;for(let t of this._validations){let r=null,o=!0;try{o=t.async?await t.fn(u,this._field,t.rule.args,e):t.fn(u,this._field,t.rule.args,e)}catch(t){o=!1,r=t}if(!o&&(s=!0,this._reportErrorToCollector(u.pointer,t.rule,n,r),i))break}return this._reportValueToCollector(!s,u,n),!s}}}));h(La);var qa=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.TreeWalker=class{constructor(t,n){this._consumerFn=t,this._arrayWrapper=n}_processLiteralNode(t,n,e,i){const r=i.concat(e).concat(t).join(".");return this._consumerFn(t,n.type,n.rules,e,r)}_processObjectNode(t,n,e,i){let r=[];if(n.rules.length){const u=i.concat(e).concat(t).join(".");r.push(this._consumerFn(t,n.type,n.rules,e,u))}return r.concat(this.walk(n.children,e.concat(t),i))}_processArrayNode(t,n,e,i){let r=[];const u=i.concat(e).concat(t);if(n.rules.length){const i=u.join(".");r.push(this._consumerFn(t,n.type,n.rules,e,i))}return Object.keys(n.each).forEach(i=>{let s=[];if(n.each[i].rules.length){const t=u.concat(i).join(".");s.push(this._consumerFn("::tip::","literal",n.each[i].rules,e,t))}s=s.concat(this.walk(n.each[i].children,[],u.concat(i))),r=r.concat(this._arrayWrapper(i,t,s,e))}),r}walk(t,n=[],e=[]){return Object.keys(t).reduce((i,r)=>{const u=t[r];return"literal"===u.type&&(i=i.concat(this._processLiteralNode(r,u,n,e))),"object"===u.type&&(i=i.concat(this._processObjectNode(r,u,n,e))),"array"===u.type&&(i=i.concat(this._processArrayNode(r,u,n,e))),i},[])}}}));h(qa);var Ba=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.Compiler=class{constructor(t,n,e){this._validations=e,this._parsedSchema=Pa.rulesParser(t),this._parsedMessages=Pa.messagesParser(n)}compile(){return new qa.TreeWalker((t,n,e,i,r)=>new La.ValidationsRunner(t,n,i,e,this._validations,this._parsedMessages.fields[r]||{},this._parsedMessages.rules),(t,n,e,i)=>new Ua.ArrayWrapper(n,t,e,i)).walk(this._parsedSchema)}}}));h(Ba);var za="Expected a function",Va=1/0,Wa=9007199254740991,Ga="[object Function]",Qa="[object GeneratorFunction]",Ya="[object Symbol]",Ha=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ja=/^\w*$/,Ka=/^\./,Xa=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Za=/\\(\\)?/g,tc=/^\[object .+?Constructor\]$/,nc=/^(?:0|[1-9]\d*)$/,ec="object"==typeof c&&c&&c.Object===Object&&c,ic="object"==typeof self&&self&&self.Object===Object&&self,rc=ec||ic||Function("return this")(),uc=Array.prototype,sc=Function.prototype,oc=Object.prototype,ac=rc["__core-js_shared__"],cc=function(){var t=/[^.]+$/.exec(ac&&ac.keys&&ac.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}(),hc=sc.toString,fc=oc.hasOwnProperty,lc=oc.toString,dc=RegExp("^"+hc.call(fc).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),vc=rc.Symbol,mc=uc.splice,wc=Ec(rc,"Map"),bc=Ec(Object,"create"),pc=vc?vc.prototype:void 0,gc=pc?pc.toString:void 0;function yc(t){var n=-1,e=t?t.length:0;for(this.clear();++n<e;){var i=t[n];this.set(i[0],i[1])}}function _c(t){var n=-1,e=t?t.length:0;for(this.clear();++n<e;){var i=t[n];this.set(i[0],i[1])}}function Oc(t){var n=-1,e=t?t.length:0;for(this.clear();++n<e;){var i=t[n];this.set(i[0],i[1])}}function kc(t,n,e){var i=t[n];fc.call(t,n)&&Tc(i,e)&&(void 0!==e||n in t)||(t[n]=e)}function jc(t,n){for(var e=t.length;e--;)if(Tc(t[e][0],n))return e;return-1}function Sc(t,n){var e,i,r=t.__data__;return("string"==(i=typeof(e=n))||"number"==i||"symbol"==i||"boolean"==i?"__proto__"!==e:null===e)?r["string"==typeof n?"string":"hash"]:r.map}function Ec(t,n){var e=function(t,n){return null==t?void 0:t[n]}(t,n);return function(t){return!(!xc(t)||(n=t,cc&&cc in n))&&(function(t){var n=xc(t)?lc.call(t):"";return n==Ga||n==Qa}(t)||function(t){var n=!1;if(null!=t&&"function"!=typeof t.toString)try{n=!!(t+"")}catch(t){}return n}(t)?dc:tc).test(function(t){if(null!=t){try{return hc.call(t)}catch(t){}try{return t+""}catch(t){}}return""}(t));var n}(e)?e:void 0}function Dc(t,n){return!!(n=null==n?Wa:n)&&("number"==typeof t||nc.test(t))&&t>-1&&t%1==0&&t<n}yc.prototype.clear=function(){this.__data__=bc?bc(null):{}},yc.prototype.delete=function(t){return this.has(t)&&delete this.__data__[t]},yc.prototype.get=function(t){var n=this.__data__;if(bc){var e=n[t];return"__lodash_hash_undefined__"===e?void 0:e}return fc.call(n,t)?n[t]:void 0},yc.prototype.has=function(t){var n=this.__data__;return bc?void 0!==n[t]:fc.call(n,t)},yc.prototype.set=function(t,n){return this.__data__[t]=bc&&void 0===n?"__lodash_hash_undefined__":n,this},_c.prototype.clear=function(){this.__data__=[]},_c.prototype.delete=function(t){var n=this.__data__,e=jc(n,t);return!(e<0||(e==n.length-1?n.pop():mc.call(n,e,1),0))},_c.prototype.get=function(t){var n=this.__data__,e=jc(n,t);return e<0?void 0:n[e][1]},_c.prototype.has=function(t){return jc(this.__data__,t)>-1},_c.prototype.set=function(t,n){var e=this.__data__,i=jc(e,t);return i<0?e.push([t,n]):e[i][1]=n,this},Oc.prototype.clear=function(){this.__data__={hash:new yc,map:new(wc||_c),string:new yc}},Oc.prototype.delete=function(t){return Sc(this,t).delete(t)},Oc.prototype.get=function(t){return Sc(this,t).get(t)},Oc.prototype.has=function(t){return Sc(this,t).has(t)},Oc.prototype.set=function(t,n){return Sc(this,t).set(t,n),this};var Ic=Ac((function(t){var n;t=null==(n=t)?"":function(t){if("string"==typeof t)return t;if(Cc(t))return gc?gc.call(t):"";var n=t+"";return"0"==n&&1/t==-Va?"-0":n}(n);var e=[];return Ka.test(t)&&e.push(""),t.replace(Xa,(function(t,n,i,r){e.push(i?r.replace(Za,"$1"):n||t)})),e}));function Mc(t){if("string"==typeof t||Cc(t))return t;var n=t+"";return"0"==n&&1/t==-Va?"-0":n}function Ac(t,n){if("function"!=typeof t||n&&"function"!=typeof n)throw new TypeError(za);var e=function(){var i=arguments,r=n?n.apply(this,i):i[0],u=e.cache;if(u.has(r))return u.get(r);var s=t.apply(this,i);return e.cache=u.set(r,s),s};return e.cache=new(Ac.Cache||Oc),e}function Tc(t,n){return t===n||t!=t&&n!=n}Ac.Cache=Oc;var Nc=Array.isArray;function xc(t){var n=typeof t;return!!t&&("object"==n||"function"==n)}function Cc(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&lc.call(t)==Ya}var Rc=function(t,n,e){return null==t?t:function(t,n,e,i){if(!xc(t))return t;for(var r=-1,u=(n=function(t,n){if(Nc(t))return!1;var e=typeof t;return!("number"!=e&&"symbol"!=e&&"boolean"!=e&&null!=t&&!Cc(t))||(Ja.test(t)||!Ha.test(t)||null!=n&&t in Object(n))}(n,t)?[n]:function(t){return Nc(t)?t:Ic(t)}(n)).length,s=u-1,o=t;null!=o&&++r<u;){var a=Mc(n[r]),c=e;if(r!=s){var h=o[a];void 0===(c=i?i(h,a,o):void 0)&&(c=xc(h)?h:Dc(n[r+1])?[]:{})}kc(o,a,c),o=o[a]}return t}(t,n,e)},Fc=f((function(t,n){var e=c&&c.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});const i=e(Rc);n.Collector=class{constructor(t,n){this.formatter=t,this._generateTree=n,this.tree={},this.hasErrors=!1}setValue(t,n){this._generateTree&&void 0!==n&&!this.hasErrors&&(t=t.replace(".::tip::",""),i.default(this.tree,t,n))}getData(){return this.tree}getErrors(){return this.formatter.toJSON()}setError(t,n,e){this.hasErrors=!0,e="function"==typeof(e=e||`${n.name} validation failed on ${t}`)?e(t,n.name,n.args):e,this.formatter.addError(e,t,n.name,n.args)}}}));h(Fc);var Pc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.Executor=class{constructor(t){this._fns=t}async exec(t,n,e,i,r){const u={tip:t,original:t,pointer:""},s=new Fc.Collector(new n,r);for(let t of this._fns){let n=!1;if(!(n=t.async?await t.execAsync(u,s,e,i):t.exec(u,s,e,i))&&i)break}const o=s.getErrors();if(!o)return r?s.getData():t;throw o}}}));h(Pc);var Uc=f((function(t,n){var e=c&&c.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});const i=e(Rr);n.ArrayWrapper=class{constructor(t,n,e,i){this._field=t,this._index=n,this._childSanitizations=e,this._dotPath=i,this._pointer=this._dotPath.concat(this._field).join(".")}_getDataCopy(t){const n=i.default(t.tip,this._pointer);return Array.isArray(n)?{original:t.original,tip:null,parentArray:n,currentIndex:"*"===this._index?0:Number(this._index)}:null}_executeSanitizations(t,n){this._childSanitizations.forEach(e=>e.exec(t,n))}exec(t,n){const e=this._getDataCopy(t);return!e||("*"!==this._index?(e.tip=e.parentArray[e.currentIndex],this._executeSanitizations(e,n)):void e.parentArray.forEach((t,i)=>{e.tip=t,e.currentIndex=i,this._executeSanitizations(e,n)}))}}}));h(Uc);var $c=f((function(t,n){var e=c&&c.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(n,"__esModule",{value:!0});const i=e(Rr),r=e($a);n.SanitizationsRunner=class{constructor(t,n,e,i){this._field=t,this._dotPath=n,this._sanitizations=[],this._computeSanitizations(i,e)}_computeSanitizations(t,n){this._sanitizations=n.map(n=>{const e=t[n.name];if(!e)throw new Error(`${n.name} is not a registered as a sanitization`);if("function"!=typeof e.sanitize)throw new Error(`${n.name} is missing sanitize function`);return"function"==typeof e.compile&&(n.args=e.compile(n.args)),{rule:n,fn:e.sanitize}})}_getDataCopy(t){const n=this._dotPath.length?i.default(t.tip,this._dotPath):t.tip;return Object.assign({},t,{tip:"::tip::"===this._field?{[this._field]:n}:n})}exec(t,n){const e=this._getDataCopy(t);if(!r.default(e.tip))return!0;this._sanitizations.forEach(t=>{t.fn(e,this._field,t.rule.args,n)})}}}));h($c);var Lc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.Compiler=class{constructor(t,n){this._sanitizations=n,this._parsedSchema=Pa.rulesParser(t)}compile(){return new qa.TreeWalker((t,n,e,i)=>new $c.SanitizationsRunner(t,i,e,this._sanitizations),(t,n,e,i)=>new Uc.ArrayWrapper(n,t,e,i)).walk(this._parsedSchema)}}}));h(Lc);var qc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.Executor=class{constructor(t){this._fns=t}exec(t,n){const e={tip:t,original:t};return this._fns.forEach(t=>t.exec(e,n)),t}}}));h(qc);var Bc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.ValidatorCompiler=Ba.Compiler,n.ValidatorExecutor=Pc.Executor,n.SanitizerCompiler=Lc.Compiler,n.SanitizerExecutor=qc.Executor}));h(Bc);var zc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.CacheManager=class{constructor(){this._cache=new Map}set(t,n){this._cache.set(t,n)}get(t){return this._cache.get(t)}}}));h(zc);var Vc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.VanillaFormatter=class{constructor(){this.errors=[]}addError(t,n,e){let i="",r=e;t instanceof Error?(i=t.message,r="ENGINE_EXCEPTION"):i=t,this.errors.push({message:i,validation:r,field:n})}toJSON(){return this.errors.length?this.errors:null}}}));h(Vc);var Wc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.JsonApiFormatter=class{constructor(){this.errors=[]}addError(t,n,e,i){let r="",u=e;t instanceof Error?(r=t.message,u="ENGINE_EXCEPTION"):r=t,this.errors.push({source:{pointer:n},title:u,detail:r,meta:{args:i}})}toJSON(){return this.errors.length?{errors:this.errors}:null}}}));h(Wc);var Gc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.VanillaFormatter=Vc.VanillaFormatter,n.JsonApiFormatter=Wc.JsonApiFormatter}));h(Gc);var Qc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.config={existyStrict:!1,formatter:Gc.VanillaFormatter,removeAdditional:!1}}));h(Qc);var Yc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=new zc.CacheManager;function i(t,n,i){if(!i.cacheKey){const e=new Bc.ValidatorCompiler(t,n,xa.validations);return new Bc.ValidatorExecutor(e.compile())}if(!e.get(i.cacheKey)){const r=new Bc.ValidatorCompiler(t,n,xa.validations);e.set(i.cacheKey,r.compile())}return new Bc.ValidatorExecutor(e.get(i.cacheKey))}n.validate=(t,n,e,r)=>i(n,e||{},r=Object.assign({},Qc.config,r)).exec(t,r.formatter,r,!0,r.removeAdditional),n.validateAll=(t,n,e,r)=>i(n,e||{},r=Object.assign({},Qc.config,r)).exec(t,r.formatter,r,!1,r.removeAdditional)}));h(Yc);var Hc=f((function(t,n){function e(t){Object.assign(Qc.config,t)}Object.defineProperty(n,"__esModule",{value:!0}),n.configure=e,e.DEFAULTS=Object.assign({},Qc.config)}));h(Hc);var Jc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.validations={above:([t])=>({name:"above",args:[t]}),accepted:()=>({name:"accepted",args:[]}),alpha:()=>({name:"alpha",args:[]}),alphaNumeric:()=>({name:"alphaNumeric",args:[]}),array:()=>({name:"array",args:[]}),boolean:()=>({name:"boolean",args:[]}),confirmed:()=>({name:"confirmed",args:[]}),different:t=>({name:"different",args:t||[]}),email:()=>({name:"email",args:[]}),endsWith:t=>({name:"endsWith",args:t||[]}),equals:t=>({name:"equals",args:t||[]}),in:t=>({name:"in",args:t||[]}),includes:t=>({name:"includes",args:t||[]}),integer:()=>({name:"integer",args:[]}),float:()=>({name:"float",args:[]}),ip:()=>({name:"ip",args:[]}),ipv4:()=>({name:"ipv4",args:[]}),ipv6:()=>({name:"ipv6",args:[]}),json:()=>({name:"json",args:[]}),max:t=>({name:"max",args:t||[]}),min:t=>({name:"min",args:t||[]}),notEquals:t=>({name:"notEquals",args:t||[]}),notIn:t=>({name:"notIn",args:t||[]}),number:()=>({name:"number",args:[]}),object:()=>({name:"object",args:[]}),range:t=>({name:"range",args:t||[]}),regex:t=>({name:"regex",args:t||[]}),required:()=>({name:"required",args:[]}),requiredIf:t=>({name:"requiredIf",args:t||[]}),requiredWhen:t=>({name:"requiredWhen",args:t||[]}),requiredWithAll:t=>({name:"requiredWithAll",args:t||[]}),requiredWithAny:t=>({name:"requiredWithAny",args:t||[]}),requiredWithoutAll:t=>({name:"requiredWithoutAll",args:t||[]}),requiredWithoutAny:t=>({name:"requiredWithoutAny",args:t||[]}),same:t=>({name:"same",args:t||[]}),startsWith:t=>({name:"startsWith",args:t||[]}),string:()=>({name:"string",args:[]}),subset:t=>({name:"subset",args:t||[]}),under:t=>({name:"under",args:t||[]}),url:()=>({name:"url",args:[]}),after:t=>({name:"after",args:t||[]}),before:t=>({name:"before",args:t||[]}),date:()=>({name:"date",args:[]}),dateFormat:t=>({name:"dateFormat",args:t||[]}),beforeOffsetOf:t=>({name:"beforeOffsetOf",args:t||[]}),afterOffsetOf:t=>({name:"afterOffsetOf",args:t||[]})}}));h(Jc);var Kc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.extend=function(t,n){xa.validations[t]=n,Jc.validations[t]=function(n){return{name:t,args:n||[]}}}}));h(Kc);var Xc=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.validate=Yc.validate,n.validateAll=Yc.validateAll,n.configure=Hc.configure,n.extend=Kc.extend,n.validations=Jc.validations}));h(Xc);var Zc=Xc.validate,th=Xc.extend,nh=Xc.validations,eh=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0});const e=new zc.CacheManager;n.sanitize=(t,n,i)=>(function(t,n){if(!n.cacheKey){const n=new Bc.SanitizerCompiler(t,xa.sanitizations);return new Bc.SanitizerExecutor(n.compile())}if(!e.get(n.cacheKey)){const i=new Bc.SanitizerCompiler(t,xa.sanitizations);e.set(n.cacheKey,i.compile())}return new Bc.SanitizerExecutor(e.get(n.cacheKey))})(n,i=i||{}).exec(t,i)}));h(eh);var ih=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.sanitizations={escape:()=>({name:"escape",args:[]}),lowerCase:t=>({name:"lowerCase",args:t||[]}),normalizeEmail:t=>({name:"normalizeEmail",args:t||[]}),plural:()=>({name:"plural",args:[]}),singular:()=>({name:"singular",args:[]}),slug:()=>({name:"slug",args:[]}),stripLinks:()=>({name:"stripLinks",args:[]}),stripTags:t=>({name:"stripTags",args:t||[]}),trim:()=>({name:"trim",args:[]}),upperCase:t=>({name:"upperCase",args:t||[]})}}));h(ih);var rh=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.extend=function(t,n){xa.sanitizations[t]=n,ih.sanitizations[t]=function(n){return{name:t,args:n||[]}}}}));h(rh);var uh=f((function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.sanitize=eh.sanitize,n.extend=rh.extend,n.sanitizations=ih.sanitizations}));h(uh);var sh=uh.sanitize,oh=uh.sanitizations;th("phone",{async:!1,compile:t=>t,validate:t=>t.original.message.replace(/ +/g,"").match(/^[0-9]*$/)});const ah={email:()=>[nh.email()],number:({min:t,max:n,integer:e})=>{const i=[nh.number()];return e&&i.push(nh.integer()),t&&i.push(nh.min(t)),n&&i.push(nh.max(n)),i},phone:()=>[nh.phone()]},ch=()=>[nh.required()],hh=()=>[oh.trim()],fh=class{constructor(e){t(this,e),this.validMessage=!0,this.handleInput=t=>this.message=t.target.value,this.handleKeyPress=t=>"enter"==t.key||"Enter"==t.key?this.sendMessage():this.validMessage=!0,this.sendMessageEvent=n(this,"sendMessage",7)}async sendMessage(){try{await(async(t,n,e={required:!0,min:null,max:null,integer:!1})=>{const i={message:this.message},r=[...hh()];"email"===t&&r.push(oh.normalizeEmail()),sh(i,{message:r});let u=[];return e.required&&(u=[...u,...ch()]),ah[t]&&(u=[...u,...ah[t](e)]),Zc(i,{message:u})})(this.type),this.sendMessageEvent.emit(this.message),this.message=""}catch(t){console.log(t),this.validMessage=!1}}render(){return e("div",{class:"uk-margin"},e("div",{class:"uk-inline"},(()=>{switch(this.type){case"email":return e("input",{id:"fontumibots-chat-container-input",class:{"uk-input uk-text-center":!0,"uk-form-danger":!this.validMessage},type:"email",placeholder:"E-Mail",value:this.message,onInput:this.handleInput,onKeyPress:this.handleKeyPress});case"number":return e("input",{id:"fontumibots-chat-container-input",class:{"uk-input uk-text-center":!0,"uk-form-danger":!this.validMessage},type:"number",min:this.props.min.value,max:this.props.max.value,placeholder:"Respuesta numrica",value:this.message,onInput:this.handleInput,onKeyPress:this.handleKeyPress});case"phone":return e("input",{id:"fontumibots-chat-container-input",class:{"uk-input uk-text-center":!0,"uk-form-danger":!this.validMessage},type:"tel",placeholder:"Nmero de celular",minLength:5,maxlength:13,value:this.message,onInput:this.handleInput,onKeyPress:this.handleKeyPress});case"yesno":return e("div",{class:"uk-flex uk-flex-center"},e("button",{class:"uk-button uk-button-secondary",onClick:()=>{this.message="Si",this.sendMessage()}},"S"),e("button",{class:"uk-button uk-margin-left uk-button-danger",onClick:()=>{this.message="No",this.sendMessage()}},"No"))}return e("input",{id:"fontumibots-chat-container-input",class:{"uk-input uk-text-center":!0,"uk-form-danger":!this.validMessage},type:"text",placeholder:"Enviar un mensaje...",value:this.message,onInput:this.handleInput,onKeyPress:this.handleKeyPress})})()))}},lh=class{constructor(n){t(this,n),this.fill="white"}render(){return e("svg",{fill:this.fill,width:30,height:30,version:"1.1",id:"Capa_1",xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",viewBox:"0 0 481.168 481.168",style:{"enable-background":"new 0 0 481.168 481.168;"}},e("g",null,e("path",{d:"M410.639,70.5c-94-94-246.3-94-340.2,0c-90.4,90.4-93.8,235-10.1,329.5l2.5,2c-9.1,19.6-24.7,43.8-49.5,56\r\n\t\tc-8.2,4-6.3,16.2,2.7,17.6c27.1,4.2,66-0.5,102.3-27.9l0.5,0.4c92.2,54.2,212.8,41.8,292-37.4\r\n\t\tC504.639,316.8,504.639,164.4,410.639,70.5z M319.839,343.5c-5.3,5.4-10.9,10.4-15.9,16c-7.3,8.2-16.5,10.8-26.9,10.2\r\n\t\tc-15.2-0.8-29.3-5.9-42.8-12.5c-30.1-14.6-55.8-34.9-77.3-60.5c-15.9-18.9-29-39.5-37.7-62.8c-4.2-11.3-7.2-22.8-6.3-35\r\n\t\tc0.6-7.5,3.4-13.9,8.9-19.2c6-5.7,11.6-11.6,17.5-17.4c7.7-7.6,17.3-7.5,25,0c4.8,4.7,9.4,9.4,14.1,14.1c4.6,4.6,9.2,9.1,13.7,13.7\r\n\t\tc8,8.1,8,17.5,0,25.6c-5.7,5.8-11.4,11.6-17.3,17.2c-1.5,1.5-1.7,2.7-0.9,4.6c3.8,9.2,9.4,17.4,15.6,25\r\n\t\tc12.5,15.4,26.7,29.1,43.7,39.7c3.6,2.3,7.6,3.9,11.4,6c1.9,1.1,3.3,0.7,4.8-0.9c5.7-5.9,11.6-11.7,17.4-17.5\r\n\t\tc7.7-7.6,17.3-7.6,24.9,0c9.4,9.3,18.7,18.6,28,28C327.739,326,327.739,335.6,319.839,343.5z M231.139,188.1l3-21.4\r\n\t\tc20.7,2.9,39.5,12.3,54.3,27.1c14.1,14.1,23.3,31.8,26.6,51.3l-21.3,3.7c-2.6-15.1-9.7-28.8-20.6-39.7\r\n\t\tC261.639,197.6,247.139,190.3,231.139,188.1z M349.839,245.1c-4.8-28-18-53.4-38.1-73.6c-21.2-21.2-48.1-34.6-77.8-38.8l3-21.4\r\n\t\tc34.3,4.8,65.5,20.3,90,44.9c23.3,23.3,38.6,52.8,44.2,85.2L349.839,245.1z"})),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null))}},dh=class{constructor(n){t(this,n),this.height=30,this.width=30,this.fill="black"}render(){return e("svg",{xmlns:"http://www.w3.org/2000/svg",width:this.width,height:this.height,fill:this.fill,viewBox:"0 0 17 17",style:{marginTop:"-4px"}},e("path",{d:"M9.207 8.5l6.646 6.646-.707.707L8.5 9.207l-6.646 6.646-.707-.707L7.793 8.5 1.146 1.854l.707-.707L8.5 7.793l6.646-6.646.707.707L9.207 8.5z"}))}},vh=class{constructor(n){t(this,n),this.fill="white"}render(){return e("svg",{width:30,height:30,fill:this.fill,version:"1.1",id:"Capa_1",xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",viewBox:"0 0 318.454 318.454",style:{"enable-background":"new 0 0 318.454 318.454;"}},e("g",null,e("g",null,e("g",null,e("path",{fill:this.fill,d:"M312.169,256.07l-50.241-50.279c-3.927-3.905-9.377-6.054-15.354-6.054\r\n                                c-6.309,0-12.379,2.458-16.676,6.755l-27.168,27.163l-7.343-4.068c-16.143-8.953-38.258-21.229-61.619-44.617\r\n                                c-23.448-23.421-35.729-45.59-44.715-61.799l-4.009-7.136l27.201-27.201c9.002-9.029,9.306-23.393,0.68-32.042L62.662,6.542\r\n                                c-3.905-3.905-9.361-6.065-15.333-6.065c-6.298,0-12.374,2.464-16.676,6.772L18.307,19.661l-1.153,1.893\r\n                                c-4.596,5.891-8.36,12.521-11.166,19.733c-2.611,6.88-4.242,13.413-4.993,19.967C-5.489,115.111,19.351,164.557,86.73,231.92\r\n                                c79.856,79.851,146.588,86.057,165.141,86.057c3.182,0,5.102-0.174,5.635-0.228c6.864-0.832,13.418-2.486,20.038-5.053\r\n                                c7.142-2.785,13.75-6.516,19.619-11.112l2.812-2.208l11.547-11.324C320.507,279.055,320.795,264.707,312.169,256.07z"})),e("g",null,e("polygon",{fill:this.fill,points:"229.484,115.339 278.022,66.812 258.969,47.732 210.42,96.275 161.893,47.737 142.823,66.806 191.351,115.339 142.813,163.877 161.904,182.925 210.42,134.409 258.942,182.925 278.033,163.877"})))),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null),e("g",null))}},mh=class{constructor(n){t(this,n),this.height=30,this.width=30,this.fill="black"}render(){return e("svg",{version:"1.0",xmlns:"http://www.w3.org/2000/svg",width:this.width,height:this.height,fill:this.fill,viewBox:"0 0 96.000000 96.000000",preserveAspectRatio:"xMidYMid meet",style:{marginTop:"-4px"}},e("g",{transform:"translate(0.000000,96.000000) scale(0.100000,-0.100000)",fill:this.fill,stroke:"none"},e("path",{d:"M105 855 l-25 -24 0 -278 0 -277 63 62 63 62 212 0 c283 0 262 -19 262 240 0 189 0 191 -25 215 l-24 25 -251 0 -251 0 -24 -25z"}),e("path",{d:"M720 569 c0 -197 -16 -209 -269 -209 l-171 0 0 -55 c0 -46 4 -60 25 -80 l24 -25 218 0 217 0 58 -57 58 -57 0 272 0 273 -25 24 c-20 21 -34 25 -80 25 l-55 0 0 -111z"})))}},wh=class{constructor(n){t(this,n),this.opened=!1,this.error=!0,this.phoneReady=!1,this.toggle=()=>this.opened=!this.opened,this.toggleAndCall=()=>{this.phoneReady&&this.widgetElement.shadowRoot.querySelector("fontumibots-chat-container").callOutside(),this.toggle()}}async componentWillLoad(){let t,n;const e=async t=>{t.on&&t.login&&t.password&&t.to&&(await(async({login:t,password:n,to:e})=>(Ri=new window.FontumiClient({login:t,password:n}),Fi=e,Ri.onError=()=>{Pi.pause(),$i()},Ri))(t),Ri.onRegistered=()=>this.phoneReady=!0)},i=document.createElement("script"),r=document.createElement("script");return r.src="//www.fontumi.co/cdn/fontumi-sdk/1.0.0/plugins.webrtc.min.js",i.src="//www.fontumi.co/cdn/fontumi-sdk/1.0.0/main.js",new Promise(async(u,s)=>{try{const s=await(()=>{const t=new Map;return async n=>{const e=await xi.collection("bots").doc(n).get();return t.get(n)||t.set(n,e),t.get(n)}})()(this.botId);if(s.exists){const{name:o,email:a,description:c,escene:h,user_id:f,colors:l,sip:d}=s.data();return r.onload=()=>(t=!0)&&n&&e(d),i.onload=()=>(n=!0,t&&n&&e(d)),this.bot={name:o,email:a,description:c,escene:h,user_id:f,colors:l,sip:d},this.error=!1,document.head.appendChild(i),document.head.appendChild(r),u()}}catch(t){return s(t)}return s(`FONTUMIBOT: Bot with id: ${this.botId} doesnt exists.`)})}render(){return this.error?e("div",null):e("div",{id:"fontumibots-widget"},e("fontumibots-chat-container",{style:{visibility:this.opened?"visible":"hidden",padding:"10px"},bot:this.bot,phoneReady:this.phoneReady}),e("div",{id:"fontumibots-buttons-container"},e("fontumibots-bubble-button",{onToggled:this.toggleAndCall,style:{display:this.opened&&this.bot.sip.on?"none":this.phoneReady?"flex":"none"},color:this.bot.colors.a,icon:"call"}),e("fontumibots-bubble-button",{onToggled:this.toggle,style:{display:this.opened?"none":"flex"},color:this.bot.colors.a,icon:"message"}),e("fontumibots-bubble-button",{style:{display:this.opened?"flex":"none"},onToggled:this.toggle,color:this.bot.colors.a,icon:"close"})))}get widgetElement(){return i(this)}static get style(){return"\@import url(\"https://cdnjs.cloudflare.com/ajax/libs/uikit/3.1.5/css/uikit.min.css\");:host{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-size:16px;font-weight:400;line-height:1.5;-webkit-text-size-adjust:100%;background:#fff;color:#666;--fontumibots-border:3px;--fontumibots-z-index:99999999;--fontumibots-shadow:0 5px 15px rgba(0,0,0,0.08);--fontumibots-chat-borders:25px;--fontumibots-color-a:red;--fontumibots-color-b:#00f}#fontumibots-buttons-container{position:fixed;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;bottom:var(--fontumibots-chat-borders);right:var(--fontumibots-chat-borders);z-index:var(--fontumibots-z-index)}"}};export{u as fontumibots_bubble_button,Li as fontumibots_chat_container,fh as fontumibots_chat_input,lh as fontumibots_icon_call,dh as fontumibots_icon_close,vh as fontumibots_icon_end_call,mh as fontumibots_icon_messages,wh as fontumibots_widget};